From chiselwright at mail.berlios.de  Tue Apr  3 21:46:59 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 3 Apr 2007 21:46:59 +0200
Subject: [Parley-svn] r267 - / trunk trunk/lib trunk/lib/Parley/Controller
	trunk/lib/Parley/Schema trunk/root/base/thread
Message-ID: <200704031946.l33JkxNl009499@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-03 21:46:58 +0200 (Tue, 03 Apr 2007)
New Revision: 267

Modified:
   /
   trunk/Changes
   trunk/lib/Parley.pm
   trunk/lib/Parley/Controller/Thread.pm
   trunk/lib/Parley/Controller/User.pm
   trunk/lib/Parley/Schema/Post.pm
   trunk/lib/Parley/Schema/ThreadView.pm
   trunk/root/base/thread/view
Log:
 r3022 at wiggin:  chisel | 2007-03-29 20:08:06 +0100
 + thread-watchers now get an email queued to tell them there's something to read
 / login_if_required() now uses detach() instead of redirect()
 / last_post_in_list() [Schema::Post] no longer uses slice()
 + try to display user avatar image in a [% TRY/CATCH %] block, showing nothing if it fails (i.e. user has no avatar)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:2983
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3022
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes
===================================================================
--- trunk/Changes	2007-03-26 21:42:01 UTC (rev 266)
+++ trunk/Changes	2007-04-03 19:46:58 UTC (rev 267)
@@ -1,5 +1,11 @@
 This file documents the revision history for Parley.
 
+    - thread-watchers now get an email queued to tell them there's something to
+      read
+    - login_if_required() now uses detach() instead of redirect()
+    - last_post_in_list() [Schema::Post] no longer uses slice()
+    - try to display user avatar image in a [% TRY/CATCH %] block, showing
+      nothing if it fails (i.e. user has no avatar)
     - update DFV profile for DFV 4.50
     - logged-in users get bounced from user/signup to the default_uri
     - moved send_email() out to Parley::Communication::Email

Modified: trunk/lib/Parley/Controller/Thread.pm
===================================================================
--- trunk/lib/Parley/Controller/Thread.pm	2007-03-26 21:42:01 UTC (rev 266)
+++ trunk/lib/Parley/Controller/Thread.pm	2007-04-03 19:46:58 UTC (rev 267)
@@ -5,6 +5,8 @@
 use base 'Catalyst::Controller';
 use Data::SpreadPagination;
 
+use Parley::App::Notification qw( :watch );
+
 # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 # Global class data
 # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
@@ -286,6 +288,9 @@
     # set the current post
     $c->_current_post( $new_reply );
 
+    # let interested parties know about the new post
+    notify_watchers( $c, $new_reply );
+
     # view the "next post" in the new thread
     $c->detach('next_post');
 }
@@ -547,6 +552,7 @@
     $last_post = $c->model('ParleyDB')->resultset('Post')->last_post_in_list(
         $c->stash->{post_list}
     );
+
     # get the timestamp of the last post
     $last_post_timestamp = $last_post->created();
     $c->log->debug( qq{\$last_post_timestamp = $last_post_timestamp} );

Modified: trunk/lib/Parley/Controller/User.pm
===================================================================
--- trunk/lib/Parley/Controller/User.pm	2007-03-26 21:42:01 UTC (rev 266)
+++ trunk/lib/Parley/Controller/User.pm	2007-04-03 19:46:58 UTC (rev 267)
@@ -12,6 +12,8 @@
     $c->stash->{'message'} = 'Please enter your username and password';
     # if we have a custom message to use ..
     $c->stash->{'login_message'} = delete( $c->session->{login_message} );
+    # make sure we use the correct template - we sometimes detach() here
+    $c->stash->{template} = 'user/login';
 
     # if we have a username, try to log the user in
     if ( $c->request->param('username') ) {

Modified: trunk/lib/Parley/Schema/Post.pm
===================================================================
--- trunk/lib/Parley/Schema/Post.pm	2007-03-26 21:42:01 UTC (rev 266)
+++ trunk/lib/Parley/Schema/Post.pm	2007-04-03 19:46:58 UTC (rev 267)
@@ -94,24 +94,21 @@
 
 
 
-
+# we used to use ->slice() but it sopped working on page #2 (!!)
+# this may be slower [not benchmarked] but it works
 sub last_post_in_list : ResultSet {
     my ($self, $post_list) = @_;
+    my ($current_post);
 
-    my $posts_in_list = $post_list->count();
-    my $splice_position = $posts_in_list - 1;
-
-    # get the last post on the page
-    my $slice = $post_list->slice(
-        $splice_position,
-        $splice_position,
-    );
-
-    if (defined $slice->first()) {
-        return $slice->first();
+    while (my $tmp = $post_list->next()) {
+        # do nothing, we're just iterating the list
+        $current_post = $tmp;
+        #warn qq{LOOP: } . ref($current_post);
     }
-
-    return;
+    # return the current post, which is the last one we saw
+    # i.e. the last one in the list
+    #warn qq{CURRENT: } . ref($current_post);
+    return $current_post;
 }
 
 

Modified: trunk/lib/Parley/Schema/ThreadView.pm
===================================================================
--- trunk/lib/Parley/Schema/ThreadView.pm	2007-03-26 21:42:01 UTC (rev 266)
+++ trunk/lib/Parley/Schema/ThreadView.pm	2007-04-03 19:46:58 UTC (rev 267)
@@ -6,6 +6,7 @@
 use warnings;
 
 use base 'DBIx::Class';
+use DateTime::Format::Pg;
 
 __PACKAGE__->load_components('ResultSetManager', "PK::Auto", "Core");
 __PACKAGE__->table("thread_view");
@@ -88,5 +89,55 @@
     return $thread_view->watched();
 }
 
+sub notification_list : ResultSet {
+    my ($self, $post) = @_;
+    my ($schema);
+
+    if (not defined $post) {
+        warn 'undefined value passed as $post in notification_list()';
+        return;
+    }
+
+    # make sure we have full object details
+    # [we don't seem to get all the default column data for a new create()]
+    $schema = $self->result_source()->schema();
+    $post = $schema->resultset('Post')->find(
+        post_id => $post->id()
+    );
+    if (not defined $post) {
+        warn 'failed to re-fetch post in notification_list()';
+        return;
+    }
+
+    # find the list of people to notify about this update
+    my $notification_list = $self->search(
+        {
+            # the thread the post belongs to
+            thread          => $post->thread()->id(),
+            # only interested in records where a person is watching
+            watched         => 1,
+            # and they last viewed the thread before the last post
+            timestamp       => {
+                '<',
+                DateTime::Format::Pg->format_datetime(
+                    $post->created()
+                )
+            },
+            # and they've not been notified
+            last_notified   => [
+                {   '=',    undef   },
+                   \'< timestamp'    ,
+            ],
+            # and they aren't the person that created the post itself
+            person          => {
+                '!=',
+                $post->creator()->id(),
+            },
+        }
+    );
+
+    return $notification_list;
+}
+
 1;
 

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2007-03-26 21:42:01 UTC (rev 266)
+++ trunk/lib/Parley.pm	2007-04-03 19:46:58 UTC (rev 267)
@@ -109,7 +109,7 @@
             $c->session->{login_message} = $message;
         }
         # send the user to the login screen
-        $c->response->redirect( $c->uri_for('/user/login') );
+        $c->detach( '/user/login' );
         return;
     }
 }

Modified: trunk/root/base/thread/view
===================================================================
--- trunk/root/base/thread/view	2007-03-26 21:42:01 UTC (rev 266)
+++ trunk/root/base/thread/view	2007-04-03 19:46:58 UTC (rev 267)
@@ -610,7 +610,14 @@
                     <tr>
                       <td align="center">
                         <a href="">
-                          <img class="picborder" src="/static/user_file/[% post.creator.id %]/avatar.jpg" border="0" width="100" height="100" alt="Avatar" />
+                        [% avatar_file = c.path_to('root') _ "/static/user_file/${post.creator.id}/avatar.jpg" %]
+                        [% TRY %]
+                            [% USE avatar = Image(avatar_file) %]
+                            [% tmp = avatar.attr %]
+                            <img class="picborder" src="/static/user_file/[% post.creator.id %]/avatar.jpg" border="0" [% avatar.attr %] alt="Avatar" />
+                        [% CATCH %]
+                            <!-- No User Avatar -->
+                        [% END %]
                         </a>
                       </td>
                     </tr>



From chiselwright at mail.berlios.de  Tue Apr  3 21:47:09 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 3 Apr 2007 21:47:09 +0200
Subject: [Parley-svn] r268 - / trunk/root/base/thread
Message-ID: <200704031947.l33Jl9ca009576@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-03 21:47:09 +0200 (Tue, 03 Apr 2007)
New Revision: 268

Modified:
   /
   trunk/root/base/thread/view
Log:
 r3023 at wiggin:  chisel | 2007-03-29 20:11:01 +0100
 - removed spurious [% post.id %] from thread/view



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3022
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3023
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/thread/view
===================================================================
--- trunk/root/base/thread/view	2007-04-03 19:46:58 UTC (rev 267)
+++ trunk/root/base/thread/view	2007-04-03 19:47:09 UTC (rev 268)
@@ -638,8 +638,6 @@
                 [% post.creator.post_count %]
                 post[% IF (post.creator.post_count != 1) %]s[% END %]
                 <br />
-                [% post.id %]
-                <br />
               </td>
               
               <td class="post" bgcolor="#ffffff" valign="top">



From chiselwright at mail.berlios.de  Tue Apr  3 21:47:19 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 3 Apr 2007 21:47:19 +0200
Subject: [Parley-svn] r269 - / trunk/root/email_templates
Message-ID: <200704031947.l33JlJWq009648@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-03 21:47:19 +0200 (Tue, 03 Apr 2007)
New Revision: 269

Added:
   trunk/root/email_templates/thread_update_notify.eml
Modified:
   /
Log:
 r3024 at wiggin:  chisel | 2007-04-03 08:19:13 +0100
 + added template for thread-update notification message



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3023
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3024
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/root/email_templates/thread_update_notify.eml
===================================================================
--- trunk/root/email_templates/thread_update_notify.eml	2007-04-03 19:47:09 UTC (rev 268)
+++ trunk/root/email_templates/thread_update_notify.eml	2007-04-03 19:47:19 UTC (rev 269)
@@ -0,0 +1,16 @@
+[% person.first_name %],
+
+The thread "[% post.thread.subject %]"
+has received a new reply by [% post.creator.forum_name %].
+
+Click here to continue reading the thread:
+
+ [% c.req.base %]thread/next_post?thread=[% post.thread.id %]
+
+Click here to view the latest post in the thread:
+
+ [% c.req.base %]post/view?post=[% post.id %]
+
+Regards,
+
+The [% c.config.name %] team.



From chiselwright at mail.berlios.de  Tue Apr  3 21:47:28 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 3 Apr 2007 21:47:28 +0200
Subject: [Parley-svn] r270 - / trunk/root/base
Message-ID: <200704031947.l33JlSSP009719@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-03 21:47:28 +0200 (Tue, 03 Apr 2007)
New Revision: 270

Modified:
   /
   trunk/root/base/header
Log:
 r3025 at wiggin:  chisel | 2007-04-03 19:02:44 +0100
 / fixed path to dojo.js



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3024
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3025
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/header
===================================================================
--- trunk/root/base/header	2007-04-03 19:47:19 UTC (rev 269)
+++ trunk/root/base/header	2007-04-03 19:47:28 UTC (rev 270)
@@ -37,7 +37,7 @@
         <script type="text/javascript" src="dragdrop.js"></script>
 
         <!-- Dojo Magic -->
-        <script type="text/javascript" src="static/magic/dojo.js"></script>
+        <script type="text/javascript" src="/static/magic/dojo.js"></script>
         <script type="text/javascript">
             dojo.require("dojo.lfx.*");         // animations and eye candy
             dojo.require("dojo.widget.Dialog");



From chiselwright at mail.berlios.de  Tue Apr  3 21:47:39 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 3 Apr 2007 21:47:39 +0200
Subject: [Parley-svn] r271 - / trunk/root/base/menu
Message-ID: <200704031947.l33Jlc8u009879@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-03 21:47:38 +0200 (Tue, 03 Apr 2007)
New Revision: 271

Modified:
   /
   trunk/root/base/menu/statusbar
Log:
 r3026 at wiggin:  chisel | 2007-04-03 19:04:26 +0100
 - removed empty <style> block
 + added login-dialog setup
 - removed old login popup
 / updated login link to use new dialog
 + added include directive for new login dialog src



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3025
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3026
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/menu/statusbar
===================================================================
--- trunk/root/base/menu/statusbar	2007-04-03 19:47:28 UTC (rev 270)
+++ trunk/root/base/menu/statusbar	2007-04-03 19:47:38 UTC (rev 271)
@@ -1,8 +1,5 @@
 <!-- status bar : start -->
 
-<style type="text/css">
-</style>
-
 <script type="text/javascript">
 	function showLoginBox(start){
         var popUp = dojo.lfx.explode(start, 'loginbox', 250, function(n) {
@@ -14,6 +11,19 @@
 	}
 </script>
 
+<!-- dojo dialog-setup -->
+<script type="text/javascript">
+    var login_dialog;
+    function init(e) {
+        login_dialog = dojo.widget.byId("login_dialog");
+        var timer = document.getElementById("login_dialog_timer");
+        login_dialog.setTimerNode(timer);
+        var btn = document.getElementById("login_dialog_hider");
+        login_dialog.setCloseControl(btn);
+    }
+    dojo.addOnLoad(init);
+</script>
+
 <table width="100%">
         <tr>
                 <td width="60%" class="left">
@@ -39,27 +49,7 @@
                         ]</i>
                         [% ELSE %]
             <i>[
-
-            <!-- loginbox -->
-            <div id="loginbox">
-                <form action="user/login" method="post" name="login_form" class="loginbox">
-                    <fieldset>
-                        <label for="username"><b>Username:</b></label>
-                        <input type="text" id="username" name="username" style="width: 15em;" class="input_text" />
-                        <br />
-                        <label for="password"><b>Password:</b></label>
-                        <input type="password" id="password" name="password" style="width: 15em;" class="input_text" />
-                        <br />
-                        <button type="submit" value="log in" class="input_button" style="margin-left: 170px;"/>log in</button>
-
-                        <p>
-                        <a href="user/password/forgotten">Forgotten Password</a>
-                        </p>
-                    </fieldset>
-                </form>
-            </div>
-            <a href="javascript:;" onclick="showLoginBox(this)">Login</a>
-            <!-- loginbox -->
+            <a href="javascript:;" onclick="login_dialog.show(); return false;">Login</a>
             |
             <a href="user/signup">Signup</a>
             ]</i>
@@ -73,22 +63,6 @@
         </tr>
 </table>
 
-<!-- status bar : end -->
+[% INCLUDE shared/login_dialog %]
 
-<!--
-<script type="text/javascript">
-var dlg0, dlg1, dlg2, dlg3;
-function init(e) {
-	dlg1 = dojo.widget.byId("dialog1");
-	var timer = document.getElementById("timer1");
-	dlg1.setTimerNode(timer);
-	var btn = document.getElementById("hider1");
-	dlg1.setCloseControl(btn);
-}
-dojo.addOnLoad(init);
-</script>
-
-<div dojoType="dialog" id="dialog1" bgColor="red" bgOpacity="0.1" toggle="fade" toggleDuration="250" lifetime="5000">
-	Disappearing in <span id="timer1">3</span>... <a id="hider1" href="#">[X]</a>
-</div>
--->
+<!-- status bar : end -->



From chiselwright at mail.berlios.de  Tue Apr  3 21:47:52 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 3 Apr 2007 21:47:52 +0200
Subject: [Parley-svn] r272 - / trunk/root/base/shared
Message-ID: <200704031947.l33JlqAj010059@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-03 21:47:52 +0200 (Tue, 03 Apr 2007)
New Revision: 272

Added:
   trunk/root/base/shared/login_dialog
Modified:
   /
Log:
 r3027 at wiggin:  chisel | 2007-04-03 19:05:04 +0100
 + html markup for (new) login dialog



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3026
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3027
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/root/base/shared/login_dialog
===================================================================
--- trunk/root/base/shared/login_dialog	2007-04-03 19:47:38 UTC (rev 271)
+++ trunk/root/base/shared/login_dialog	2007-04-03 19:47:52 UTC (rev 272)
@@ -0,0 +1,21 @@
+<!-- login dialog -->
+<div dojoType="dialog" id="login_dialog" bgColor="#606060" bgOpacity="0.4" toggle="fade" toggleDuration="250">
+    <form action="user/login" method="post" name="login_form" class="login_dialog_form">
+        <fieldset>
+            <label for="username"><b>Username:</b></label>
+            <input type="text" id="username" name="username" style="width: 15em;" class="input_text" />
+            <br />
+            <label for="password"><b>Password:</b></label>
+            <input type="password" id="password" name="password" style="width: 15em;" class="input_text" />
+            <br />
+            <button type="submit" value="log in" class="input_button" style="margin-left: 170px;"/>log in</button>
+
+            <p align="right">
+            <a href="user/password/forgotten">Forgotten Password</a>
+            |
+            <a id="login_dialog_hider" href="javascript:;">Close</a><br />
+            </p>
+        </fieldset>
+    </form>
+</div>
+<!-- /login-dialog -->



From chiselwright at mail.berlios.de  Tue Apr  3 21:48:05 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 3 Apr 2007 21:48:05 +0200
Subject: [Parley-svn] r273 - / trunk/root/css
Message-ID: <200704031948.l33Jm542010222@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-03 21:48:05 +0200 (Tue, 03 Apr 2007)
New Revision: 273

Modified:
   /
   trunk/root/css/default.css
Log:
 r3028 at wiggin:  chisel | 2007-04-03 19:06:26 +0100
 / css changes for the new login dialog
 - removed old [and hopefully] redundant styles for fieldsets and old login popup



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3027
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3028
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/css/default.css
===================================================================
--- trunk/root/css/default.css	2007-04-03 19:47:52 UTC (rev 272)
+++ trunk/root/css/default.css	2007-04-03 19:48:05 UTC (rev 273)
@@ -369,170 +369,68 @@
 }
 
 
-
-form {  /* set width in form, not fieldset (still takes up more room w/ fieldset width */
-  margin: 0;
-  padding: 0;
-  min-width: 500px;
-  max-width: 600px;
-  width: 560px; 
+a.button:visited, a.button:link, a.button:active, .button, a.button {
+    border:             2px solid;
+    border-color:       #FC9 #630 #330 #F96;
+    padding:            2px 7px 2px 7px;
+    font:               bold 0.8em verdana,sans-serif;
+    color:              #000;
+    background:         #ccc;
+    text-decoration:    none;
+    margin:             0;
 }
 
-form fieldset {
-  / * clear: both; note that this clear causes inputs to break to left in ie5.x mac, commented out */
-  border-color: #000;
-  border-width: 1px;
-  border-style: solid;
-  padding: 10px;        /* padding in fieldset support spotty in IE */
-  margin: 0;
-}
 
-form fieldset legend {
-	font-size:1.1em; /* bump up legend font size, not too large or it'll overwrite border on left */
-                       /* be careful with padding, it'll shift the nice offset on top of border  */
+/* login dialog styling */
+#login_dialog form {  /* set width in form, not fieldset (still takes up more room w/ fieldset width */
+    margin: 0;
+    padding: 0;
+    min-width: 400px;
+    max-width: 600px;
 }
-
-form label { 
-	display: block;  /* block float the labels to left column, set a width */
-	float: left; 
-	width: 150px; 
-	padding: 0; 
-	margin: 5px 0 0; /* set top margin same as form input - textarea etc. elements */
-	text-align: right; 
+#login_dialog form fieldset {
+    / * clear: both; note that this clear causes inputs to break to left in ie5.x mac, commented out */
+    border-color: #000;
+    border-width: 1px;
+    border-style: solid;
+    padding: 10px;        /* padding in fieldset support spotty in IE */
+    margin: 0;
+}
+#login_dialog form label { 
+    display: block;  /* block float the labels to left column, set a width */
+    float: left; 
+    width: 150px; 
+    padding: 0; 
+    margin: 5px 0 0; /* set top margin same as form input - textarea etc. elements */
+    text-align: right; 
     font-weight: bold;
+    margin-bottom : 0;
 }
-
-form fieldset label:first-letter { /* use first-letter pseudo-class to underline accesskey, note that */
-	text-decoration:none;    /* Firefox 1.07 WIN and Explorer 5.2 Mac don't support first-letter */
-                                    /* pseudo-class on legend elements, but do support it on label elements */
-                                    /* we instead underline first letter on each label element and accesskey */
-                                    /* each input. doing only legends would  lessens cognitive load */
-                                   /* opera breaks after first letter underlined legends but not labels */
-}
-
-form input, form textarea {
-	/* display: inline; inline display must not be set or will hide submit buttons in IE 5x mac */
-	width:auto;      /* set width of form elements to auto-size, otherwise watch for wrap on resize */
-	margin:5px 0 0 10px; /* set margin on left of form elements rather than right of
+#login_dialog form input, form textarea {
+    /* display: inline; inline display must not be set or will hide submit buttons in IE 5x mac */
+    width:auto;      /* set width of form elements to auto-size, otherwise watch for wrap on resize */
+    margin:5px 0 0 10px; /* set margin on left of form elements rather than right of
                               label aligns textarea better in IE */
 }
-
-form input#reset {
-	margin-left:0px; /* set margin-left back to zero on reset button (set above) */
+#login_dialog form p {
+    font-size: 0.8em;
 }
 
-textarea { overflow: auto; }
+ 
 
-form small {
-	display: block;
-	margin: 0 0 5px 160px; /* instructions/comments left margin set to align w/ right column inputs */
-	padding: 1px 3px;
-	font-size: 88%;
-}
 
-form .required{font-weight:bold;} /* uses class instead of div, more efficient */
 
-form br {
-	clear:left; /* setting clear on inputs didn't work consistently, so brs added for degrade */
-}
 
 
-#Xloginbox {
-    border: 1px solid #ccc;
-    width: 250px;
-    float: right;
-    background-color: #f8f8f8;
-    padding: 5px;
-    margin-top: 1.5em;
-    margin-right: 3em;
-    font-size:      0.8em;
+/* dojo dialog styling - initially taken from dojo demo */
+.dojoDialog {
+    background : #eee;
+    border : 1px solid #999;
+    -moz-border-radius : 5px;
+    padding : 4px;
 }
 
-#loginbox {
-    position : absolute;
-    left : 200px;
-    top : 100px;
-    display : none;
-
-    border: 1px solid #000;
-    width: 250px;
-    font-size:      0.8em;
-    background-color: #f8f8f8;
-    background-color: #ccc;
-    padding: 5px;
+form {
+    margin-bottom : 0;
 }
 
-#searchbox {
-    border: 1px solid #ccc;
-    /*width: 400px;*/
-    float: right;
-    background-color: #f8f8f8;
-    padding: 5px;
-    /*
-    margin-top: 1.5em;
-    margin-right: 13em;
-    */
-    font-size:      0.8em;
-    position: relative;
-    top: -10px;
-}
-
-
-
-form.searchbox {
-    min-width: 0px;
-    max-width: 35em;
-}
-
-form.searchbox fieldset label {
-    margin-left: 0;
-    padding-top: 8px;
-    padding-right: 5px;
-    margin: 0;
-    width: auto;
-    text-align: left;
-}
-form.searchbox fieldset input {
-    margin: 0;
-    width: 20em;
-}
-form.searchbox fieldset button {
-    margin-left: auto;
-    margin-right: auto;
-    display: inline;
-}
-
-
-form.loginbox {
-    min-width: 0px;
-    max-width: 250px;
-}
-form.loginbox fieldset label, form.loginbox fieldset input{  /* set width in form, not fieldset (still takes up more room w/ fieldset width */
-    padding: 0px;
-    margin: 5px 0 0 10px;
-    width: 8em;
-}
-
-form fieldset p {
-    text-align: left;
-}
-
-form fieldset button {
-	margin:5px 0 0 10px;
-    margin-left: auto;
-    margin-right: auto;
-    display: block;
-}
-
-
-a.button:visited, a.button:link, a.button:active, .button, a.button {
-    border:             2px solid;
-    border-color:       #FC9 #630 #330 #F96;
-    padding:            2px 7px 2px 7px;
-    font:               bold 0.8em verdana,sans-serif;
-    color:              #000;
-    background:         #ccc;
-    text-decoration:    none;
-    margin:             0;
-}
-



From chiselwright at mail.berlios.de  Tue Apr  3 21:48:15 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 3 Apr 2007 21:48:15 +0200
Subject: [Parley-svn] r274 - / trunk/root/static
Message-ID: <200704031948.l33JmFAp010391@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-03 21:48:15 +0200 (Tue, 03 Apr 2007)
New Revision: 274

Added:
   trunk/root/static/user_file/
Modified:
   /
Log:
 r3029 at wiggin:  chisel | 2007-04-03 19:07:04 +0100
 + this is a static directory for things like avatars to reside in



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3028
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3029
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222



From chiselwright at mail.berlios.de  Tue Apr  3 21:48:30 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 3 Apr 2007 21:48:30 +0200
Subject: [Parley-svn] r275 - / trunk
Message-ID: <200704031948.l33JmUMv010542@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-03 21:48:29 +0200 (Tue, 03 Apr 2007)
New Revision: 275

Modified:
   /
   trunk/parley.yml
Log:
 r3030 at wiggin:  chisel | 2007-04-03 19:08:54 +0100
 / make it so we don't ignore html ... otherwise dojo magic (e.g. buttons) doesn't work properly



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3029
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3030
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/parley.yml
===================================================================
--- trunk/parley.yml	2007-04-03 19:48:15 UTC (rev 274)
+++ trunk/parley.yml	2007-04-03 19:48:29 UTC (rev 275)
@@ -56,3 +56,8 @@
     # comment out the following line to enable Template::Timer output in your
     # template source
     CONTEXT:        ''
+
+static:
+    ignore_extensions:
+        - asp
+        - php



From chiselwright at mail.berlios.de  Tue Apr  3 21:48:39 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 3 Apr 2007 21:48:39 +0200
Subject: [Parley-svn] r276 - / trunk/lib/Parley/App
Message-ID: <200704031948.l33Jmd7R010655@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-03 21:48:38 +0200 (Tue, 03 Apr 2007)
New Revision: 276

Added:
   trunk/lib/Parley/App/Notification.pm
Modified:
   /
Log:
 r3031 at wiggin:  chisel | 2007-04-03 19:10:56 +0100
 + notification functionality



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3030
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3031
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/lib/Parley/App/Notification.pm
===================================================================
--- trunk/lib/Parley/App/Notification.pm	2007-04-03 19:48:29 UTC (rev 275)
+++ trunk/lib/Parley/App/Notification.pm	2007-04-03 19:48:38 UTC (rev 276)
@@ -0,0 +1,86 @@
+package Parley::App::Notification;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use Perl6::Export::Attrs;
+
+sub notify_watchers :Export( :watch ) {
+    my ($c, $post) = @_;
+    my ($send_status);
+
+    # get a list of people we want to inform
+    my $notification_list = $c->model('ParleyDB')->resultset('ThreadView')
+        ->notification_list( $post )
+    ;
+    $c->log->debug( q{No. WATCHERS: } . $notification_list->count() );
+
+    # loop through the list [resultset], queue and email
+    # and update the time they were last notified
+    while (my $thread_view_row = $notification_list->next()) {
+        $c->log->debug( q{NOTIFY: } . $thread_view_row->person()->id() );
+        $c->log->debug( q{NOTIFY: } . $thread_view_row->person()->forum_name() );
+
+        # send email
+        $send_status = $c->send_email(
+            {
+                template        => {
+                    text    => q{thread_update_notify.eml},
+                },
+                person          => $thread_view_row->person(),
+                headers         => {
+                    from    => $c->application_email_address(),
+                    subject => qq{New Reply: } . $post->thread()->subject(),
+                },
+                template_data   => {
+                    post    => $post,
+                },
+            }
+        );
+
+        # update thread_view record for thread-person
+        my $thread_view_record = $c->model('ParleyDB')->resultset('ThreadView')
+            ->find(
+                person  => $thread_view_row->person()->id(),
+                thread  => $post->thread()->id(),
+            )
+        ;
+        $thread_view_record->last_notified(
+            #$thread_view_record->timestamp()
+            Time::Piece->new(time)->datetime,
+        );
+        $thread_view_record->update();
+    }
+
+    return;
+}
+
+
+1;
+
+__END__
+
+=head1 NAME
+
+Parley::App::Notification - notification helper functions
+
+=head1 SYNOPSIS
+
+  use Parley::App::Notification;
+
+  $c->notify_watchers($post);
+
+=head1 SEE ALSO
+
+L<Parley::Controller::Root>, L<Catalyst::Plugin::Email>, L<Catalyst>
+
+=head1 AUTHOR
+
+Chisel Wright C<< <chisel at herlpacker.co.uk> >>
+
+=head1 LICENSE
+
+This library is free software, you can redistribute it and/or modify
+it under the same terms as Perl itself.
+
+=cut



From chiselwright at mail.berlios.de  Wed Apr  4 23:08:26 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 4 Apr 2007 23:08:26 +0200
Subject: [Parley-svn] r277 - / trunk/script
Message-ID: <200704042108.l34L8QJZ028893@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-04 23:08:26 +0200 (Wed, 04 Apr 2007)
New Revision: 277

Added:
   trunk/script/parley_email_engine.pl
Modified:
   /
Log:
 r3042 at wiggin:  chisel | 2007-04-04 22:07:54 +0100
 + email sending daemon/engine [first attempt]



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3031
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3042
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/script/parley_email_engine.pl
===================================================================
--- trunk/script/parley_email_engine.pl	2007-04-03 19:48:38 UTC (rev 276)
+++ trunk/script/parley_email_engine.pl	2007-04-04 21:08:26 UTC (rev 277)
@@ -0,0 +1,253 @@
+#!/usr/bin/env perl
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+BEGIN {
+}
+
+# use the lib directory relative to ourself
+use FindBin;
+use lib "$FindBin::Bin/../lib";
+
+# for building email(s)
+use MIME::Lite;
+
+# since we're going to be a daemon ...
+use Proc::Daemon;
+use Proc::PID::File;
+
+# somewhere to send stuff
+use Sys::Syslog qw( :DEFAULT :standard :macros );
+
+# our in to the database ...
+use Parley::Schema;
+
+# whether we should be exiting
+our $exit = 0;
+
+# prepare syslog for use
+openlog(
+    q{parley_email_engine},
+    q{ndelay,pid},
+    LOG_USER
+)
+    or die $!;
+syslog( LOG_INFO, q{script started} )
+    or die $!;
+
+# have we been asked to stop running?
+if (@ARGV && $ARGV[0] eq q{stop}) {
+    # we need to quit!
+
+    # get the pid file ...
+    my $pid = Proc::PID::File->running(
+        debug   => 0,
+        name    => q{parley_email_engine},
+        dir     => q{/tmp},
+    );
+    if (not $pid) {
+        syslog( LOG_INFO, qq{daemon not running!} );
+        exit;
+    }
+
+    # send a kill signal
+    kill( 2, $pid );
+    syslog( LOG_INFO, qq{STOP signal sent!\n} );
+    exit;
+}
+
+# connect to the schema
+my $schema = schema_connect();
+
+# daemon
+my $pid;
+if ($pid = Proc::Daemon::Fork) { # parent
+    # nothing here
+}
+else { # child
+    Proc::Daemon::Init;
+
+    openlog(
+        q{parley_email_engine},
+        q{ndelay,pid},
+        LOG_USER
+    )
+        or die $!;
+    syslog( LOG_INFO, q{child process created} );
+
+    # how to deal with given signals
+    $SIG{TERM}  = sub { $exit = 1 };
+    $SIG{INT}   = sub { $exit = 1 };
+    $SIG{CHLD}  = q{IGNORE};
+    $SIG{HUP}   = q{IGNORE};
+
+    my $status_ok;
+    $status_ok = open(STDOUT, '>>', '/tmp/parley_email_engine.log');
+    if (not $status_ok) {
+        syslog( LOG_ERR, "failed to reopen STDOUT: $!" );
+        exit;
+    }
+    $status_ok = open(STDERR, '>&STDOUT');
+    if (not $status_ok) {
+        syslog( LOG_ERR, "failed to re-open STDERR to STDOUT: $!" );
+        exit;
+    }
+
+    # make sure we aren't already running
+    if (Proc::PID::File->running(
+            debug   => 0,
+            name    => q{parley_email_engine},
+            dir     => q{/tmp},
+        )
+    ) {
+        syslog( LOG_INFO, qq{Already Running!} );
+        exit;
+    }
+
+    while (1) {
+        child_process($schema);
+        sleep(1);
+    }
+}
+
+sub child_process {
+    my $schema = shift;
+
+    # get the oldest unsent email in the queue
+    my $rs = $schema->resultset('EmailQueue')->search(
+        {
+            attempted_delivery => 0,
+        },
+        {
+            # oldest first
+            order_by    => 'queued ASC',
+            # one result
+            rows        => 1,
+        }
+    );
+
+    # if we have anything waiting to be sent ...
+    if ($rs->count()) {
+        my $queue_item = $rs->first();
+        send_email( $queue_item );
+    }
+
+    # have we been asked to stop?
+    if ($exit) {
+        syslog(
+            LOG_INFO,
+            q{STOP signal recieved}
+        );
+        exit;
+    }
+}
+
+sub schema_connect {
+    my $schema;
+    eval {
+        $schema = Parley::Schema->connect(
+            q{dbi:Pg:dbname=parley},
+            q{parley},
+            undef,
+            { RaiseError => 0, PrintError => 0 },
+        );
+    };
+    if ($@) {
+        syslog( LOG_INFO, $@ );
+        exit;
+    }
+    if (not defined $schema) {
+        syslog( LOG_INFO, $! );
+        exit;
+    }
+
+    return $schema;
+}
+
+sub send_email {
+    my $queue_item = shift;
+    my ($email);
+
+    # are we text/plain or multipart/alternative?
+    if (defined $queue_item->html_content()) {
+        $email = build_multipart_email( $queue_item );
+    }
+    else {
+        $email = build_text_email( $queue_item );
+    }
+
+    # print the email out for now, no need to send anything
+    $email->send();
+    # update the table to say we've attempted delivery
+    $queue_item->attempted_delivery(1);
+    $queue_item->update();
+
+    return;
+}
+
+sub build_text_email {
+    my $queue_item = shift;
+    my ($msg);
+
+    # create a straight-forward text email
+    $msg = MIME::Lite->new(
+        From            => $queue_item->sender(),
+        To              => nice_to_header( $queue_item->recipient() ),
+        Subject         => $queue_item->subject(),
+        'X-Application' => 'parley_email_engine',
+        Encoding        => 'quoted-printable',
+
+        Type        => 'TEXT',
+        Data        => $queue_item->text_content(),
+    )
+        or die $!;
+
+    return $msg;
+}
+
+sub build_multipart_email {
+    my $queue_item = shift;
+    my ($msg);
+
+    # create the multipart container
+    $msg = MIME::Lite->new(
+        From            => $queue_item->sender(),
+        To              => nice_to_header( $queue_item->recipient() ),
+        Subject         => $queue_item->subject(),
+        'X-Application' => 'parley_email_engine',
+
+        Type    => 'multipart/alternative',
+    )
+        or die $!;
+
+    # add the text part
+    $msg->attach(
+        Type    => 'text/plain',
+        Data    => $queue_item->text_content(),
+    );
+    # add the html part
+    $msg->attach(
+        Type    => 'text/html',
+        Data    => $queue_item->html_content(),
+    );
+
+    return $msg;
+}
+
+
+
+sub nice_to_header {
+    my $recipient = shift;
+
+    my $string =
+          $recipient->first_name()
+        . q{ }
+        . $recipient->last_name()
+        . q{ <}
+        . $recipient->email()
+        . q{>}
+    ;
+
+    return $string;
+}


Property changes on: trunk/script/parley_email_engine.pl
___________________________________________________________________
Name: svn:executable
   + *



From chiselwright at mail.berlios.de  Wed Apr  4 23:22:22 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 4 Apr 2007 23:22:22 +0200
Subject: [Parley-svn] r278 - / trunk/lib/Parley/App/Communication
Message-ID: <200704042122.l34LMMPe029904@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-04 23:22:22 +0200 (Wed, 04 Apr 2007)
New Revision: 278

Modified:
   /
   trunk/lib/Parley/App/Communication/Email.pm
Log:
 r3044 at wiggin:  chisel | 2007-04-04 22:14:42 +0100
 + updates to deal with html content in email messages



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3042
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3044
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/App/Communication/Email.pm
===================================================================
--- trunk/lib/Parley/App/Communication/Email.pm	2007-04-04 21:08:26 UTC (rev 277)
+++ trunk/lib/Parley/App/Communication/Email.pm	2007-04-04 21:22:22 UTC (rev 278)
@@ -14,6 +14,7 @@
             recipient       => $options->{recipient}->id()      || 0,
             subject         => $options->{headers}{subject}     || q{Subject Line Missing},
             text_content    => $options->{text_content}         || q{Email Body Text Missing},
+            html_content    => $options->{html_content}         || undef,
         }
     );
     return 1; # success
@@ -59,6 +60,23 @@
         }
     );
 
+    # if we have html_content, prepare that for queueing
+    if (defined $options->{template}{html}) {
+        $html_content = $c->view('Plain')->render(
+            $c,
+            $options->{template}{html},
+            {
+                additional_template_paths => [ $c->config->{root} . q{/email_templates}],
+
+                # automatically make the person data available
+                person => $options->{person},
+
+                # pass through extra TT data
+                %{ $options->{template_data} || {} },
+            }
+        );
+    }
+
     # queue the message
     $email_status = $c->queue_email(
         {
@@ -71,6 +89,7 @@
 
             recipient       => $options->{person},
             text_content    => $text_content,
+            html_content    => $html_content,
         },
     );
 



From chiselwright at mail.berlios.de  Wed Apr  4 23:22:30 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 4 Apr 2007 23:22:30 +0200
Subject: [Parley-svn] r279 - / trunk/lib/Parley/App
Message-ID: <200704042122.l34LMUhc029974@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-04 23:22:30 +0200 (Wed, 04 Apr 2007)
New Revision: 279

Modified:
   /
   trunk/lib/Parley/App/Notification.pm
Log:
 r3045 at wiggin:  chisel | 2007-04-04 22:17:29 +0100
 / use html template in thread-watch notification



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3044
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3045
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/App/Notification.pm
===================================================================
--- trunk/lib/Parley/App/Notification.pm	2007-04-04 21:22:22 UTC (rev 278)
+++ trunk/lib/Parley/App/Notification.pm	2007-04-04 21:22:30 UTC (rev 279)
@@ -26,6 +26,7 @@
             {
                 template        => {
                     text    => q{thread_update_notify.eml},
+                    html    => q{thread_update_notify.html},
                 },
                 person          => $thread_view_row->person(),
                 headers         => {



From chiselwright at mail.berlios.de  Wed Apr  4 23:22:39 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 4 Apr 2007 23:22:39 +0200
Subject: [Parley-svn] r280 - / trunk/root/email_templates
Message-ID: <200704042122.l34LMd3P030048@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-04 23:22:39 +0200 (Wed, 04 Apr 2007)
New Revision: 280

Added:
   trunk/root/email_templates/thread_update_notify.html
Modified:
   /
   trunk/root/email_templates/thread_update_notify.eml
Log:
 r3046 at wiggin:  chisel | 2007-04-04 22:22:07 +0100
 + updated text template to tell reader that they won't get any updates until they revisit the thread
 + added html notification template to use in multipart email



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3045
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3046
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/email_templates/thread_update_notify.eml
===================================================================
--- trunk/root/email_templates/thread_update_notify.eml	2007-04-04 21:22:30 UTC (rev 279)
+++ trunk/root/email_templates/thread_update_notify.eml	2007-04-04 21:22:39 UTC (rev 280)
@@ -11,6 +11,9 @@
 
  [% c.req.base %]post/view?post=[% post.id %]
 
+Please note: You will not receive any further notifications for this
+thread until you view the post above or any posts created after it.
+
 Regards,
 
 The [% c.config.name %] team.

Added: trunk/root/email_templates/thread_update_notify.html
===================================================================
--- trunk/root/email_templates/thread_update_notify.html	2007-04-04 21:22:30 UTC (rev 279)
+++ trunk/root/email_templates/thread_update_notify.html	2007-04-04 21:22:39 UTC (rev 280)
@@ -0,0 +1,30 @@
+<html>
+    <head>
+        <title>Thread Update Notification</title>
+    </head>
+
+    <body>
+        <p>[% person.first_name %],</p>
+
+        <p>The thread "[% post.thread.subject %]"
+        has received a new reply by [% post.creator.forum_name %].</p>
+
+        <p>Choose one of the following actions:
+        <ul>
+            <li>
+            <a href="[% c.req.base %]thread/next_post?thread=[% post.thread.id %]">Continue reading "[% post.thread.subject %]" from your last position</a>
+            </li>
+            <li>
+            <a href="[% c.req.base %]post/view?post=[% post.id %]">View "[% post.thread.subject %]" from the new post</a>
+            </li>
+        </ul>
+        </p>
+
+        <p>Please note: You <b>will not</b> receive any further notifications for this thread until you view the post above
+        or any posts created after it.</p>
+
+        <p>Regards,</p>
+
+        <p>The [% c.config.name %] team.</p>
+    </body>
+</html>



From chiselwright at mail.berlios.de  Thu Apr  5 10:44:18 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 5 Apr 2007 10:44:18 +0200
Subject: [Parley-svn] r281 - / trunk/script
Message-ID: <200704050844.l358iISK030998@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-05 10:44:18 +0200 (Thu, 05 Apr 2007)
New Revision: 281

Modified:
   /
   trunk/script/parley_email_engine.pl
Log:
 r3050 at wiggin:  chisel | 2007-04-05 08:26:30 +0100
 / moved use() into BEGIN{}
 + added script version number
 / include script version in X-Application
 + added _common_mail_options()
 / replaced common MIME::Lite options in ->new() calls with %{ _common_mail_options() }



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3046
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3050
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/script/parley_email_engine.pl
===================================================================
--- trunk/script/parley_email_engine.pl	2007-04-04 21:22:39 UTC (rev 280)
+++ trunk/script/parley_email_engine.pl	2007-04-05 08:44:18 UTC (rev 281)
@@ -4,24 +4,25 @@
 use warnings;
 
 BEGIN {
-}
+    # use the lib directory relative to ourself
+    use FindBin;
+    use lib "$FindBin::Bin/../lib";
 
-# use the lib directory relative to ourself
-use FindBin;
-use lib "$FindBin::Bin/../lib";
+    # for building email(s)
+    use MIME::Lite;
 
-# for building email(s)
-use MIME::Lite;
+    # since we're going to be a daemon ...
+    use Proc::Daemon;
+    use Proc::PID::File;
 
-# since we're going to be a daemon ...
-use Proc::Daemon;
-use Proc::PID::File;
+    # somewhere to send stuff
+    use Sys::Syslog qw( :DEFAULT :standard :macros );
 
-# somewhere to send stuff
-use Sys::Syslog qw( :DEFAULT :standard :macros );
+    # our in to the database ...
+    use Parley::Schema;
+}
 
-# our in to the database ...
-use Parley::Schema;
+use version; our $VERSION = qv('0.0.1');
 
 # whether we should be exiting
 our $exit = 0;
@@ -186,20 +187,31 @@
     return;
 }
 
+sub _common_mail_options {
+    my $queue_item = shift;
+
+    my %options = (
+        From            => $queue_item->sender(),
+        To              => nice_to_header( $queue_item->recipient() ),
+        Subject         => $queue_item->subject(),
+        'X-Application' => qq{parley_email_engine ($VERSION)},
+    );
+
+    return \%options;
+}
+
+
 sub build_text_email {
     my $queue_item = shift;
     my ($msg);
 
     # create a straight-forward text email
     $msg = MIME::Lite->new(
-        From            => $queue_item->sender(),
-        To              => nice_to_header( $queue_item->recipient() ),
-        Subject         => $queue_item->subject(),
-        'X-Application' => 'parley_email_engine',
-        Encoding        => 'quoted-printable',
+        %{ _common_mail_options($queue_item) },
 
         Type        => 'TEXT',
         Data        => $queue_item->text_content(),
+        Encoding    => 'quoted-printable',
     )
         or die $!;
 
@@ -212,10 +224,7 @@
 
     # create the multipart container
     $msg = MIME::Lite->new(
-        From            => $queue_item->sender(),
-        To              => nice_to_header( $queue_item->recipient() ),
-        Subject         => $queue_item->subject(),
-        'X-Application' => 'parley_email_engine',
+        %{ _common_mail_options($queue_item) },
 
         Type    => 'multipart/alternative',
     )



From chiselwright at mail.berlios.de  Thu Apr  5 10:44:24 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 5 Apr 2007 10:44:24 +0200
Subject: [Parley-svn] r282 - / trunk
Message-ID: <200704050844.l358iOfu031068@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-05 10:44:24 +0200 (Thu, 05 Apr 2007)
New Revision: 282

Modified:
   /
   trunk/Changes
Log:
 r3051 at wiggin:  chisel | 2007-04-05 08:31:41 +0100
 + updated Changes file



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3050
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3051
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes
===================================================================
--- trunk/Changes	2007-04-05 08:44:18 UTC (rev 281)
+++ trunk/Changes	2007-04-05 08:44:24 UTC (rev 282)
@@ -1,5 +1,11 @@
 This file documents the revision history for Parley.
 
+0.50    Thu Apr  5 08:31:04 BST 2007
+
+    THIS RELEASE ENCOMPASSES A GROUND-UP RE-WRITE. Previous functionality may
+    not yet have been re-implemented.
+
+    - written email daemon to send queued Parley emails
     - thread-watchers now get an email queued to tell them there's something to
       read
     - login_if_required() now uses detach() instead of redirect()



From chiselwright at mail.berlios.de  Thu Apr  5 10:44:31 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 5 Apr 2007 10:44:31 +0200
Subject: [Parley-svn] r283 - / tags
Message-ID: <200704050844.l358iVJQ031146@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-05 10:44:30 +0200 (Thu, 05 Apr 2007)
New Revision: 283

Added:
   tags/parley-0.50/
Modified:
   /
Log:
 r3052 at wiggin:  chisel | 2007-04-05 08:32:44 +0100
 Tagging version 0.50. More information in Changes file.



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3051
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3052
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Copied: tags/parley-0.50 (from rev 282, trunk)



From chiselwright at mail.berlios.de  Thu Apr  5 10:44:51 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 5 Apr 2007 10:44:51 +0200
Subject: [Parley-svn] r284 - / tags/parley-0.50/lib
Message-ID: <200704050844.l358ippr031254@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-05 10:44:51 +0200 (Thu, 05 Apr 2007)
New Revision: 284

Modified:
   /
   tags/parley-0.50/lib/Parley.pm
Log:
 r3053 at wiggin:  chisel | 2007-04-05 08:34:10 +0100
 / fixed version number in tagged release



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3052
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3053
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: tags/parley-0.50/lib/Parley.pm
===================================================================
--- tags/parley-0.50/lib/Parley.pm	2007-04-05 08:44:30 UTC (rev 283)
+++ tags/parley-0.50/lib/Parley.pm	2007-04-05 08:44:51 UTC (rev 284)
@@ -29,7 +29,7 @@
 use Parley::App::Communication::Email qw( :email );
 
 
-our $VERSION = '0.50-pre';
+our $VERSION = '0.50';
 
 __PACKAGE__->config( version => $VERSION );
 __PACKAGE__->setup;



From chiselwright at mail.berlios.de  Thu Apr  5 10:44:57 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 5 Apr 2007 10:44:57 +0200
Subject: [Parley-svn] r285 - / trunk/lib/Parley/Controller trunk/t
Message-ID: <200704050844.l358ivm2031324@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-05 10:44:56 +0200 (Thu, 05 Apr 2007)
New Revision: 285

Added:
   trunk/lib/Parley/Controller/My.pm
   trunk/t/controller_My.t
Modified:
   /
Log:
 r3054 at wiggin:  chisel | 2007-04-05 08:37:05 +0100
 + added controller for /my uri-space



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3053
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3054
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/lib/Parley/Controller/My.pm
===================================================================
--- trunk/lib/Parley/Controller/My.pm	2007-04-05 08:44:51 UTC (rev 284)
+++ trunk/lib/Parley/Controller/My.pm	2007-04-05 08:44:56 UTC (rev 285)
@@ -0,0 +1,42 @@
+package Parley::Controller::My;
+
+use strict;
+use warnings;
+use base 'Catalyst::Controller';
+
+=head1 NAME
+
+Parley::Controller::My - Catalyst Controller
+
+=head1 DESCRIPTION
+
+Catalyst Controller.
+
+=head1 METHODS
+
+=cut
+
+
+=head2 index 
+
+=cut
+
+sub index : Private {
+    my ( $self, $c ) = @_;
+
+    $c->response->body('Matched Parley::Controller::My in My.');
+}
+
+
+=head1 AUTHOR
+
+Chisel Wright,,,
+
+=head1 LICENSE
+
+This library is free software, you can redistribute it and/or modify
+it under the same terms as Perl itself.
+
+=cut
+
+1;

Added: trunk/t/controller_My.t
===================================================================
--- trunk/t/controller_My.t	2007-04-05 08:44:51 UTC (rev 284)
+++ trunk/t/controller_My.t	2007-04-05 08:44:56 UTC (rev 285)
@@ -0,0 +1,10 @@
+use strict;
+use warnings;
+use Test::More tests => 3;
+
+BEGIN { use_ok 'Catalyst::Test', 'Parley' }
+BEGIN { use_ok 'Parley::Controller::My' }
+
+ok( request('/my')->is_success, 'Request should succeed' );
+
+



From chiselwright at mail.berlios.de  Wed Apr 11 00:04:39 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 11 Apr 2007 00:04:39 +0200
Subject: [Parley-svn] r286 - / tags/parley-0.50
Message-ID: <200704102204.l3AM4d39030328@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-11 00:04:38 +0200 (Wed, 11 Apr 2007)
New Revision: 286

Modified:
   /
   tags/parley-0.50/Makefile.PL
Log:
 r3066 at wiggin:  chisel | 2007-04-05 10:04:22 +0100
 / typo - grr!



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3054
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3066
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: tags/parley-0.50/Makefile.PL
===================================================================
--- tags/parley-0.50/Makefile.PL	2007-04-05 08:44:56 UTC (rev 285)
+++ tags/parley-0.50/Makefile.PL	2007-04-10 22:04:38 UTC (rev 286)
@@ -11,7 +11,7 @@
 requires 'Catalyst::Model::DBIC::Schema';
 requires 'Data::FormValidator' => '4.50';
 requires 'Email::Valid';
-requiees 'Perl6::Export::Attrs';
+requires 'Perl6::Export::Attrs';
 requires 'YAML'; # This should reflect the config file format you've chosen
                  # See Catalyst::Plugin::ConfigLoader for supported formats
 catalyst;



From chiselwright at mail.berlios.de  Fri Apr 13 22:21:57 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:21:57 +0200
Subject: [Parley-svn] r287 - / trunk/db
Message-ID: <200704132021.l3DKLvFr029017@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:21:56 +0200 (Fri, 13 Apr 2007)
New Revision: 287

Added:
   trunk/db/patch_0.50_to_0.51.psql
Modified:
   /
   trunk/db/parley.psql
Log:
 r3135 at wiggin:  chisel | 2007-04-12 18:43:19 +0100
 + add forum_moderator table



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3066
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3135
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/db/parley.psql
===================================================================
--- trunk/db/parley.psql	2007-04-10 22:04:38 UTC (rev 286)
+++ trunk/db/parley.psql	2007-04-13 20:21:56 UTC (rev 287)
@@ -197,9 +197,16 @@
 );
 
 
+-- a table of person/forum to show who's a moderator
+CREATE TABLE forum_moderator (
+    person              integer     not null    references person,
+    forum               integer     not null    references forum,
 
+    unique(person,forum)
+);
 
 
+
 --
 -- some default stuff
 --

Added: trunk/db/patch_0.50_to_0.51.psql
===================================================================
--- trunk/db/patch_0.50_to_0.51.psql	2007-04-10 22:04:38 UTC (rev 286)
+++ trunk/db/patch_0.50_to_0.51.psql	2007-04-13 20:21:56 UTC (rev 287)
@@ -0,0 +1,22 @@
+-- Patch:
+--   From: 0.09
+--   To:   0.10
+--
+-- Description:
+--  new table for tracking when a viewer has last viewed a thread
+
+BEGIN;
+
+-- patch starts here --
+
+-- a table of person/forum to show who's a moderator
+CREATE TABLE forum_moderator (
+    person              integer     not null    references person,
+    forum               integer     not null    references forum,
+
+    unique(person,forum)
+);
+
+-- patch ends here --
+
+COMMIT;



From chiselwright at mail.berlios.de  Fri Apr 13 22:22:11 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:22:11 +0200
Subject: [Parley-svn] r288 - / trunk/lib/Parley/Controller trunk/t
Message-ID: <200704132022.l3DKMBDI029143@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:22:10 +0200 (Fri, 13 Apr 2007)
New Revision: 288

Added:
   trunk/lib/Parley/Controller/Admin.pm
   trunk/t/controller_Admin.t
Modified:
   /
Log:
 r3136 at wiggin:  chisel | 2007-04-13 19:17:29 +0100
 + added some admin functionality (lock/stick)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3135
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3136
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/lib/Parley/Controller/Admin.pm
===================================================================
--- trunk/lib/Parley/Controller/Admin.pm	2007-04-13 20:21:56 UTC (rev 287)
+++ trunk/lib/Parley/Controller/Admin.pm	2007-04-13 20:22:10 UTC (rev 288)
@@ -0,0 +1,106 @@
+package Parley::Controller::Admin;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+use base 'Catalyst::Controller';
+
+sub index : Private {
+    my ( $self, $c ) = @_;
+
+    $c->response->body('Matched Parley::Controller::Admin in Admin.');
+}
+
+sub auto : Private {
+    my ($self, $c) = @_;
+    $c->log->debug( 'Admin::auto()' );
+
+    # if we're not a moderator, bounce back to where we came from
+    if (not $c->stash->{moderator}) {
+        $c->log->debug( 'not a moderator' );
+        $c->response->redirect( $c->request->referer() );
+        return 0;
+    }
+
+    # succeed
+    $c->log->debug( 'a moderator' );
+    return 1;
+}
+
+sub lock :Local {
+    my ($self, $c) = @_;
+
+    # the 'lock' parameter tells us if we're adding or removing a lock
+    # if it's not specified, default action os to ADD a lock
+    my $locked = $c->request->param('lock');
+    if (not defined $locked) {
+        $locked = 1;
+    }
+    $c->log->debug( qq{lock: $locked} );
+
+    # we should already have the thread we're locking, but let's check anyway
+    if (not defined $c->_current_thread()) {
+        $c->stash->{error}{message} = q{You must specify the thread to lock};
+        $c->log->error( q{You must specify the thread to lock} );
+        return;
+    }
+
+    # update the lock status
+    $c->_current_thread()->locked( $locked );
+    $c->_current_thread()->update();
+
+    # go back to where we came from
+    $c->response->redirect( $c->request->referer() );
+    return;
+}
+
+sub sticky :Local {
+    my ($self, $c) = @_;
+
+    # the 'sticky' parameter tells us if we're adding or removing a sticky
+    # if it's not specified, default action os to ADD a sticky
+    my $sticky = $c->request->param('sticky');
+    if (not defined $sticky) {
+        $sticky = 1;
+    }
+    $c->log->debug( qq{sticky: $sticky} );
+
+    # we should already have the thread we're sticking, but let's check anyway
+    if (not defined $c->_current_thread()) {
+        $c->stash->{error}{message} = q{You must specify the thread to stick};
+        $c->log->error( q{You must specify the thread to stick} );
+        return;
+    }
+
+    # update the stick status
+    $c->_current_thread()->sticky( $sticky );
+    $c->_current_thread()->update();
+
+    # go back to where we came from
+    $c->response->redirect( $c->request->referer() );
+    return;
+}
+
+=head1 NAME
+
+Parley::Controller::Admin - Catalyst Controller
+
+=head1 DESCRIPTION
+
+Catalyst Controller.
+
+=head1 METHODS
+
+=head2 index 
+
+=head1 AUTHOR
+
+Chisel Wright C<< <chiselwright at berlios.de> >>
+
+=head1 LICENSE
+
+This library is free software, you can redistribute it and/or modify
+it under the same terms as Perl itself.
+
+=cut
+
+1;

Added: trunk/t/controller_Admin.t
===================================================================
--- trunk/t/controller_Admin.t	2007-04-13 20:21:56 UTC (rev 287)
+++ trunk/t/controller_Admin.t	2007-04-13 20:22:10 UTC (rev 288)
@@ -0,0 +1,10 @@
+use strict;
+use warnings;
+use Test::More tests => 3;
+
+BEGIN { use_ok 'Catalyst::Test', 'Parley' }
+BEGIN { use_ok 'Parley::Controller::Admin' }
+
+ok( request('/admin')->is_success, 'Request should succeed' );
+
+



From chiselwright at mail.berlios.de  Fri Apr 13 22:22:21 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:22:21 +0200
Subject: [Parley-svn] r289 - / trunk/db trunk/lib/Parley/Schema
Message-ID: <200704132022.l3DKMLbD029244@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:22:19 +0200 (Fri, 13 Apr 2007)
New Revision: 289

Added:
   trunk/lib/Parley/Schema/ForumModerator.pm
Modified:
   /
   trunk/db/parley.psql
   trunk/db/patch_0.50_to_0.51.psql
Log:
 r3137 at wiggin:  chisel | 2007-04-13 19:18:35 +0100
 + added forum_moderator table with (person,forum) list of people allowed to moderate a forum



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3136
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3137
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/db/parley.psql
===================================================================
--- trunk/db/parley.psql	2007-04-13 20:22:10 UTC (rev 288)
+++ trunk/db/parley.psql	2007-04-13 20:22:19 UTC (rev 289)
@@ -201,6 +201,7 @@
 CREATE TABLE forum_moderator (
     person              integer     not null    references person,
     forum               integer     not null    references forum,
+    can_moderate        boolean     not null    default true,
 
     unique(person,forum)
 );

Modified: trunk/db/patch_0.50_to_0.51.psql
===================================================================
--- trunk/db/patch_0.50_to_0.51.psql	2007-04-13 20:22:10 UTC (rev 288)
+++ trunk/db/patch_0.50_to_0.51.psql	2007-04-13 20:22:19 UTC (rev 289)
@@ -13,6 +13,7 @@
 CREATE TABLE forum_moderator (
     person              integer     not null    references person,
     forum               integer     not null    references forum,
+    can_moderate        boolean     not null    default true,
 
     unique(person,forum)
 );

Added: trunk/lib/Parley/Schema/ForumModerator.pm
===================================================================
--- trunk/lib/Parley/Schema/ForumModerator.pm	2007-04-13 20:22:10 UTC (rev 288)
+++ trunk/lib/Parley/Schema/ForumModerator.pm	2007-04-13 20:22:19 UTC (rev 289)
@@ -0,0 +1,36 @@
+package Parley::Schema::ForumModerator;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+use base 'DBIx::Class';
+
+__PACKAGE__->load_components('PK::Auto', 'Core');
+__PACKAGE__->table('forum_moderator');
+__PACKAGE__->add_columns(
+    person => {
+        data_type       => "integer",
+        default_value   => undef,
+        is_nullable     => 0,
+        size            => 4
+    },
+
+    forum => {
+        data_type       => "integer",
+        default_value   => undef,
+        is_nullable     => 0,
+        size            => 4
+    },
+
+    can_moderate => {
+        data_type => "boolean",
+        default_value => "false",
+        is_nullable => 0,
+        size => 1,
+    },
+);
+
+__PACKAGE__->add_unique_constraint('forum_moderator_person_key', ['person', 'forum']);
+__PACKAGE__->belongs_to('person', 'Person', { person_id => 'person' });
+__PACKAGE__->belongs_to('forum',  'Forum',  {  forum_id => 'forum'  });
+
+1;



From chiselwright at mail.berlios.de  Fri Apr 13 22:22:29 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:22:29 +0200
Subject: [Parley-svn] r290 - / trunk/lib/Parley/Controller
Message-ID: <200704132022.l3DKMTfr029336@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:22:29 +0200 (Fri, 13 Apr 2007)
New Revision: 290

Modified:
   /
   trunk/lib/Parley/Controller/My.pm
Log:
 r3138 at wiggin:  chisel | 2007-04-13 19:19:30 +0100
 Nothing special ... just make a start on prefs working again



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3137
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3138
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/My.pm
===================================================================
--- trunk/lib/Parley/Controller/My.pm	2007-04-13 20:22:19 UTC (rev 289)
+++ trunk/lib/Parley/Controller/My.pm	2007-04-13 20:22:29 UTC (rev 290)
@@ -4,33 +4,68 @@
 use warnings;
 use base 'Catalyst::Controller';
 
-=head1 NAME
+sub auto : Private {
+    my ($self, $c) = @_;
+    # need to be logged in to perform any 'my' actions
+    my $status = $c->login_if_required(
+        q{You must be logged in before you can access this area}
+    );
+    if (not defined $status) {
+        return 0;
+    }
 
-Parley::Controller::My - Catalyst Controller
+    # undecided if you need to be authed to perform 'my' actions
+    #if (not Parley::App::Helper->is_authenticted($c)) {
+    #    $c->stash->{error}{message} = q{You need to authenticate your registration before you can start a new topic.};
+    #}
 
-=head1 DESCRIPTION
+    return 1;
+}
 
-Catalyst Controller.
 
-=head1 METHODS
+sub index : Private {
+    my ( $self, $c ) = @_;
 
-=cut
+    $c->response->body('Matched Parley::Controller::My in My.');
+}
 
 
-=head2 index 
+sub preferences : Local {
+    my ($self, $c) = @_;
+    my ($tz_categories);
 
-=cut
+    # where did we come from? it would be nice to return there when we're done
+    if ($c->request->referer() !~ m{/my/preferences}xms) {
+        $c->session->{my_pref_came_from} = $c->request->referer();
+    }
 
-sub index : Private {
-    my ( $self, $c ) = @_;
+    # what's the current time? then we can show it in the TZ area
+    $c->stash->{current_time} = DateTime->now();
 
-    $c->response->body('Matched Parley::Controller::My in My.');
+    # fetch timezone categories
+    $tz_categories = DateTime::TimeZone->categories();
+    $c->stash->{tz_categories} = $tz_categories;
+
+
+
+    return;
 }
 
+=head1 NAME
 
+Parley::Controller::My - Catalyst Controller
+
+=head1 DESCRIPTION
+
+Catalyst Controller.
+
+=head1 METHODS
+
+=head2 index 
+
 =head1 AUTHOR
 
-Chisel Wright,,,
+Chisel Wright C<< chiselwright at users.berlios.de> >>
 
 =head1 LICENSE
 



From chiselwright at mail.berlios.de  Fri Apr 13 22:22:38 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:22:38 +0200
Subject: [Parley-svn] r291 - / trunk/lib/Parley/Controller
Message-ID: <200704132022.l3DKMcV8029423@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:22:37 +0200 (Fri, 13 Apr 2007)
New Revision: 291

Modified:
   /
   trunk/lib/Parley/Controller/Root.pm
Log:
 r3139 at wiggin:  chisel | 2007-04-13 19:20:33 +0100
 + if we are logged in and if we have a current_forum, can the (current) user moderate it? ($c->stash->{moderator})



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3138
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3139
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/Root.pm
===================================================================
--- trunk/lib/Parley/Controller/Root.pm	2007-04-13 20:22:29 UTC (rev 290)
+++ trunk/lib/Parley/Controller/Root.pm	2007-04-13 20:22:37 UTC (rev 291)
@@ -121,6 +121,36 @@
         );
     }
 
+
+    ##################################################
+    # if we are logged in and if we have a current_forum, can the (current)
+    # user moderate it?
+    ##################################################
+    if (defined $c->_authed_user() and defined $c->_current_forum()) {
+        # 'topdog' user can moderate anything
+        if (0 == $c->_authed_user()->id()) {
+            $c->log->debug( q{topdog user moderates anything he wants} );
+            $c->stash->{moderator} = 1;
+        }
+        else {
+            # look up person/forum
+            my $results = $c->model('ParleyDB')->resultset('ForumModerator')->find(
+                {
+                    person  => $c->_authed_user()->id(),
+                    forum   => $c->_current_forum()->id(),
+                },
+                {
+                    key     => 'forum_moderator_person_key',
+                }
+            );
+            # if we found something, they must moderate the current forum
+            if ($results) {
+                $c->log->debug( q{user moderates this forum} );
+                $c->stash->{moderator} = 1;
+            }
+        }
+    }
+
     # let things continue ...
     return 1;
 }



From chiselwright at mail.berlios.de  Fri Apr 13 22:22:46 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:22:46 +0200
Subject: [Parley-svn] r292 - / trunk/lib/Parley/Controller
Message-ID: <200704132022.l3DKMkwo029516@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:22:45 +0200 (Fri, 13 Apr 2007)
New Revision: 292

Modified:
   /
   trunk/lib/Parley/Controller/Thread.pm
Log:
 r3140 at wiggin:  chisel | 2007-04-13 19:21:33 +0100
 + added thread/recent
 + can no longer reply to a locked thread



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3139
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3140
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/Thread.pm
===================================================================
--- trunk/lib/Parley/Controller/Thread.pm	2007-04-13 20:22:37 UTC (rev 291)
+++ trunk/lib/Parley/Controller/Thread.pm	2007-04-13 20:22:45 UTC (rev 292)
@@ -77,6 +77,44 @@
     $c->detach('/post/view');
 }
 
+sub recent : Local {
+    my ($self, $c) = @_;
+    my ($where);
+
+    # only search active forums
+    $where->{active} = 1;
+
+    if (defined $c->_current_forum()) {
+        $where->{forum} = $c->_current_forum->id();
+    }
+
+    # XXX
+    # Trying to achieve:
+    # SELECT me.thread_id, me.locked, me.creator, me.subject, me.active,
+    #   me.forum, me.created, me.last_post, me.sticky, me.post_count,
+    #   me.view_count, forum_moderator.can_moderate
+    # FROM thread me
+    # LEFT JOIN forum_moderator ON ( me.forum = forum_moderator.forum )
+    # JOIN post last_post ON ( last_post.post_id = me.last_post )
+    # ORDER BY sticky DESC, last_post.created DESC;
+
+    # get a list of threads, most recently updated first
+    $c->stash->{thread_list} = $c->model('ParleyDB')->resultset('Thread')->search(
+        $where,
+        {
+            join        => [
+                'last_post',
+                'forum_moderators',
+            ],
+            order_by    => 'last_post.created DESC',
+        }
+    );
+
+    $c->log->debug( $c->stash->{thread_list}->count() );
+
+    return;
+}
+
 sub reply : Local {
     my ($self, $c) = @_;
 
@@ -86,6 +124,13 @@
     # make sure we're authenticated
     # XXX
 
+    # can't replay to a locked thread
+    if ($c->_current_thread()->locked()) {
+        #die q{can't reply to a locked thread!};
+        $c->stash->{error}{message} = q{You can't reply to a locked thread};
+        return;
+    };
+
     # if we have a current post, then we're performing a quoted reply
     # (otherwise we should have the thread that we're adding a reply to)
     # are we quoting a post that we're replying to?



From chiselwright at mail.berlios.de  Fri Apr 13 22:22:54 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:22:54 +0200
Subject: [Parley-svn] r293 - / trunk/lib
Message-ID: <200704132022.l3DKMsM6029621@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:22:54 +0200 (Fri, 13 Apr 2007)
New Revision: 293

Modified:
   /
   trunk/lib/Parley.pm
Log:
 r3141 at wiggin:  chisel | 2007-04-13 19:22:24 +0100
 / our $VERSION = '0.51-pre';



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3140
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3141
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2007-04-13 20:22:45 UTC (rev 292)
+++ trunk/lib/Parley.pm	2007-04-13 20:22:54 UTC (rev 293)
@@ -28,9 +28,8 @@
 
 use Parley::App::Communication::Email qw( :email );
 
+our $VERSION = '0.51-pre';
 
-our $VERSION = '0.50-pre';
-
 __PACKAGE__->config( version => $VERSION );
 __PACKAGE__->setup;
 



From chiselwright at mail.berlios.de  Fri Apr 13 22:23:06 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:23:06 +0200
Subject: [Parley-svn] r294 - / trunk/lib/Parley/Schema
Message-ID: <200704132023.l3DKN6iA029742@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:23:05 +0200 (Fri, 13 Apr 2007)
New Revision: 294

Modified:
   /
   trunk/lib/Parley/Schema/Thread.pm
Log:
 r3142 at wiggin:  chisel | 2007-04-13 19:22:58 +0100
 + added has_many() for forum_moderator table



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3141
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3142
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Schema/Thread.pm
===================================================================
--- trunk/lib/Parley/Schema/Thread.pm	2007-04-13 20:22:54 UTC (rev 293)
+++ trunk/lib/Parley/Schema/Thread.pm	2007-04-13 20:23:05 UTC (rev 294)
@@ -74,6 +74,13 @@
   { "foreign.thread" => "self.thread_id" },
 );
 
+__PACKAGE__->has_many(
+    'forum_moderators',
+    'ForumModerator',
+    {
+        'foreign.forum' => 'self.forum',
+    }
+);
 
 
 foreach my $datecol (qw/created/) {



From chiselwright at mail.berlios.de  Fri Apr 13 22:23:14 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:23:14 +0200
Subject: [Parley-svn] r295 - / trunk/root/base/thread
Message-ID: <200704132023.l3DKNE78029839@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:23:14 +0200 (Fri, 13 Apr 2007)
New Revision: 295

Added:
   trunk/root/base/thread/recent
Modified:
   /
Log:
 r3143 at wiggin:  chisel | 2007-04-13 19:23:31 +0100
 + template file for thread/recent URI



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3142
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3143
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/root/base/thread/recent
===================================================================
--- trunk/root/base/thread/recent	2007-04-13 20:23:05 UTC (rev 294)
+++ trunk/root/base/thread/recent	2007-04-13 20:23:14 UTC (rev 295)
@@ -0,0 +1,75 @@
+<h1>Recently Updated Threads</h1>
+
+[%- IF thread_list.count > 0 %]
+<table>
+[% WHILE (thread = thread_list.next) %]
+    <tr>
+        <td width="36">
+        <!-- interesting things about the thread; sticky, locked, etc -->
+        [%- IF thread.sticky %]
+        <img src="static/images/sticky.png" alt="Sticky" title="Sticky Topic" width="16" height="16" />
+        [%- END %]
+        [%- IF thread.locked %]
+        <img src="static/images/locked.png" alt="Locked" title="Locked Topic" width="16" height="16" />
+        [%- END %]
+        </td>
+
+        <td>
+        <a href="thread/view?thread=[% thread.id %]" class="topic_link">[% ForumCode.escape(thread.subject) %]</a>
+        <br />
+        <span class="forum_mini_pager">
+            [%- IF authed_user || mini_pager %]
+            [
+                [%- IF authed_user %]
+                <a href="thread/next_post?thread=[% thread.id %]">Continue</a>
+                [%- END %]
+            ]
+            [%- END %]
+        </span>
+        <span class="topic_creator">created by
+            <span class="post_creator">[% thread.creator.forum_name %]</span>
+        </span>
+        </td>
+
+        <td>
+        [% nicedate(thread.last_post.created) %]
+        <br />
+        <span class="topic_creator">posted by
+            <span class="post_creator">[% thread.last_post.creator.forum_name %]</span>
+        </span>
+        </td>
+
+        <td>
+        <a href="forum/view?forum=[%thread.forum.id%]">[% thread.forum.name %]</a>
+        <br />&nbsp;
+        </td>
+
+        <td>
+            [% IF thread.forum_moderators.can_moderate %]
+            <!-- add/remove sticky -->
+            [% IF thread.sticky %]
+            <a href="admin/sticky?thread=[% thread.id %]&sticky=0">{S-}</a>
+            [% ELSE %]
+            <a href="admin/sticky?thread=[% thread.id %]">{S+}</a>
+            [% END %]
+
+            <!-- add/remove locked -->
+            [% IF thread.locked %]
+            <a href="admin/lock?thread=[% thread.id %]&lock=0">{L-}</a>
+            [% ELSE %]
+            <a href="admin/lock?thread=[% thread.id %]">{L+}</a>
+            [% END %]
+
+            <!-- add/removed active -->
+            [% IF thread.active %]{A-}[% ELSE %]{A+}[% END %]
+            [% ELSE %]
+            &nbsp;
+            [% END %]
+            <br />
+        </td>
+    </tr>
+[% END %]
+</table>
+[% ELSE %]
+  No recent threads to display
+[% END %]



From chiselwright at mail.berlios.de  Fri Apr 13 22:23:22 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:23:22 +0200
Subject: [Parley-svn] r296 - / trunk/root/base/menu/left
Message-ID: <200704132023.l3DKNMAg029926@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:23:22 +0200 (Fri, 13 Apr 2007)
New Revision: 296

Modified:
   /
   trunk/root/base/menu/left/main
Log:
 r3144 at wiggin:  chisel | 2007-04-13 19:24:13 +0100
 + added some stuff to make some testing easier



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3143
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3144
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/menu/left/main
===================================================================
--- trunk/root/base/menu/left/main	2007-04-13 20:23:14 UTC (rev 295)
+++ trunk/root/base/menu/left/main	2007-04-13 20:23:22 UTC (rev 296)
@@ -1,5 +1,16 @@
+<p>
+    <!-- General Stuff -->
+    <a href="thread/recent">Recent Threads</a>
+</p>
 
-<!-- My -->
+<p>
+    <!-- My -->
 
-<!-- Preferences -->
-<a href="my/preferences">Preferences</a>
+    <!-- Preferences -->
+    <a href="my/preferences">Preferences</a>
+</p>
+
+<p>
+    <!-- Admin -->
+    <a href="admin">Admin</a>
+</p>



From chiselwright at mail.berlios.de  Fri Apr 13 22:23:30 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:23:30 +0200
Subject: [Parley-svn] r297 - / trunk/root/base/menu
Message-ID: <200704132023.l3DKNU4H030027@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:23:29 +0200 (Fri, 13 Apr 2007)
New Revision: 297

Modified:
   /
   trunk/root/base/menu/statusbar
Log:
 r3145 at wiggin:  chisel | 2007-04-13 19:25:12 +0100
 - removed dead javascript from obselete/old login popup



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3144
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3145
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/menu/statusbar
===================================================================
--- trunk/root/base/menu/statusbar	2007-04-13 20:23:22 UTC (rev 296)
+++ trunk/root/base/menu/statusbar	2007-04-13 20:23:29 UTC (rev 297)
@@ -1,16 +1,5 @@
 <!-- status bar : start -->
 
-<script type="text/javascript">
-	function showLoginBox(start){
-        var popUp = dojo.lfx.explode(start, 'loginbox', 250, function(n) {
-            /* there's a timing issue here I think as the focus() only works if we have an alert() before it */
-            var something = dojo.byId('username');
-            something.focus();
-        });
-        popUp.play();
-	}
-</script>
-
 <!-- dojo dialog-setup -->
 <script type="text/javascript">
     var login_dialog;



From chiselwright at mail.berlios.de  Fri Apr 13 22:23:43 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:23:43 +0200
Subject: [Parley-svn] r298 - / trunk/root/base/forum trunk/root/base/thread
Message-ID: <200704132023.l3DKNhbT030132@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:23:43 +0200 (Fri, 13 Apr 2007)
New Revision: 298

Modified:
   /
   trunk/root/base/forum/view
   trunk/root/base/thread/view
Log:
 r3146 at wiggin:  chisel | 2007-04-13 19:26:06 +0100
 + added some moderator options/links for sticking and locking



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3145
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3146
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/forum/view
===================================================================
--- trunk/root/base/forum/view	2007-04-13 20:23:29 UTC (rev 297)
+++ trunk/root/base/forum/view	2007-04-13 20:23:43 UTC (rev 298)
@@ -25,6 +25,7 @@
     <th>Last Post</th>
     <th>Replies</th>
     <th>Views</th>
+    [% IF moderator %]<th>Actions</th>[% END %]
   </tr>
   [%- WHILE (thread = thread_list.next) %]
   <tr>
@@ -71,6 +72,27 @@
     <td style="text-align: center;">
       [% thread.view_count %]
     </td>
+
+    [% IF moderator %]
+    <td>
+    <!-- add/remove sticky -->
+    [% IF thread.sticky %]
+    <a href="admin/sticky?thread=[% thread.id %]&sticky=0">{S-}</a>
+    [% ELSE %]
+    <a href="admin/sticky?thread=[% thread.id %]">{S+}</a>
+    [% END %]
+
+    <!-- add/remove locked -->
+    [% IF thread.locked %]
+    <a href="admin/lock?thread=[% thread.id %]&lock=0">{L-}</a>
+    [% ELSE %]
+    <a href="admin/lock?thread=[% thread.id %]">{L+}</a>
+    [% END %]
+
+    <!-- add/removed active -->
+    [% IF thread.active %]{A-}[% ELSE %]{A+}[% END %]
+    </td>
+    [% END %]
   </tr>
   [% END %]
 </table>

Modified: trunk/root/base/thread/view
===================================================================
--- trunk/root/base/thread/view	2007-04-13 20:23:29 UTC (rev 297)
+++ trunk/root/base/thread/view	2007-04-13 20:23:43 UTC (rev 298)
@@ -581,7 +581,12 @@
                 [% INCLUDE shared/pager_advanced %]
                 </small>
                 <br />
+                [% IF current_thread.locked %]
+                <img src="static/images/locked.png" alt="Locked" title="Locked Topic" width="16" height="16" />
+                Thread Locked
+                [% ELSE %]
                 <a class="button" href="thread/reply?thread=[% current_thread.id %]">Reply</a>
+                [% END %]
               </td>
             </tr>
             
@@ -657,11 +662,13 @@
               <td class="postbit" bgcolor="#ebeef2"></td>
               <td class="post" align="right" bgcolor="#ffffff" valign="bottom">
                 <span class="small">[% nicedate(post.created) %]</span>
+                [% UNLESS current_thread.locked %]
                 <span class="small_link">
                   <strong>
                     <a class="button" href="thread/reply?post=[% post.id %]">Quote</a>
                   </strong>
                 </span>
+                [% END %]
               </td>
             </tr>
           </tbody>
@@ -669,6 +676,22 @@
 [% END %]
       </td>
     </tr>
+
+    <tr>
+        <td class="right_align" valign="top">
+        <small>
+        [% INCLUDE shared/pager_advanced %]
+        </small>
+        <br />
+        [% IF current_thread.locked %]
+        <img src="static/images/locked.png" alt="Locked" title="Locked Topic" width="16" height="16" />
+        Thread Locked
+        [% ELSE %]
+        <a class="button" href="thread/reply?thread=[% current_thread.id %]">Reply</a>
+        [% END %]
+        </td>
+    </tr>
+
   </tbody>
 </table>
 



From chiselwright at mail.berlios.de  Fri Apr 13 22:23:53 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:23:53 +0200
Subject: [Parley-svn] r299 - / trunk
Message-ID: <200704132023.l3DKNrIY030237@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:23:52 +0200 (Fri, 13 Apr 2007)
New Revision: 299

Modified:
   /
   trunk/Changes
Log:
 r3147 at wiggin:  chisel | 2007-04-13 19:27:06 +0100
 / updated change information



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3146
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3147
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes
===================================================================
--- trunk/Changes	2007-04-13 20:23:43 UTC (rev 298)
+++ trunk/Changes	2007-04-13 20:23:52 UTC (rev 299)
@@ -1,5 +1,15 @@
 This file documents the revision history for Parley.
 
+    - added initial moderator code
+    - added moderator actions on forum/thread views (lock/stick)
+    - raise error when trying to reply to a locked thread (prevent "Evil Hackers" replying)
+    - hide Reply and Quote buttons for locked thread
+    - added pager and reply button to bottom of thread/view
+    - added "Thread Locked" to thread/view if thread is locked
+    - added thread/recent for list of all recently updated threads
+    - added thread/recent?forum=X for list of all recently updated threads in a
+      given forum
+
 0.50    Thu Apr  5 08:31:04 BST 2007
 
     THIS RELEASE ENCOMPASSES A GROUND-UP RE-WRITE. Previous functionality may



From chiselwright at mail.berlios.de  Fri Apr 13 22:24:01 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 13 Apr 2007 22:24:01 +0200
Subject: [Parley-svn] r300 - / trunk
Message-ID: <200704132024.l3DKO1RG030338@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-13 22:24:01 +0200 (Fri, 13 Apr 2007)
New Revision: 300

Modified:
   /
   trunk/Makefile.PL
Log:
 r3148 at wiggin:  chisel | 2007-04-13 19:27:47 +0100
 / fixed typo



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3147
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3148
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Makefile.PL
===================================================================
--- trunk/Makefile.PL	2007-04-13 20:23:52 UTC (rev 299)
+++ trunk/Makefile.PL	2007-04-13 20:24:01 UTC (rev 300)
@@ -11,7 +11,7 @@
 requires 'Catalyst::Model::DBIC::Schema';
 requires 'Data::FormValidator' => '4.50';
 requires 'Email::Valid';
-requiees 'Perl6::Export::Attrs';
+requires 'Perl6::Export::Attrs';
 requires 'YAML'; # This should reflect the config file format you've chosen
                  # See Catalyst::Plugin::ConfigLoader for supported formats
 catalyst;



From chiselwright at mail.berlios.de  Tue Apr 17 23:32:06 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 17 Apr 2007 23:32:06 +0200
Subject: [Parley-svn] r301 - / trunk/lib/Parley/Controller
Message-ID: <200704172132.l3HLW6KD005984@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-17 23:32:05 +0200 (Tue, 17 Apr 2007)
New Revision: 301

Modified:
   /
   trunk/lib/Parley/Controller/Thread.pm
Log:
 r3163 at wiggin:  chisel | 2007-04-17 08:40:58 +0100
 / (temporarily) don't try to fetch 'can_moderate' per thread in the recent list
   - need to find DBIC syntack for version2 of sql we need (in comments)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3148
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3163
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/Thread.pm
===================================================================
--- trunk/lib/Parley/Controller/Thread.pm	2007-04-13 20:24:01 UTC (rev 300)
+++ trunk/lib/Parley/Controller/Thread.pm	2007-04-17 21:32:05 UTC (rev 301)
@@ -79,16 +79,19 @@
 
 sub recent : Local {
     my ($self, $c) = @_;
-    my ($where);
+    my ($where, @join);
 
+    # always want to join with last_post table
+    @join = qw(last_post);
+
     # only search active forums
     $where->{active} = 1;
 
+    # if we're only interested in a given forum
     if (defined $c->_current_forum()) {
         $where->{forum} = $c->_current_forum->id();
     }
 
-    # XXX
     # Trying to achieve:
     # SELECT me.thread_id, me.locked, me.creator, me.subject, me.active,
     #   me.forum, me.created, me.last_post, me.sticky, me.post_count,
@@ -97,21 +100,44 @@
     # LEFT JOIN forum_moderator ON ( me.forum = forum_moderator.forum )
     # JOIN post last_post ON ( last_post.post_id = me.last_post )
     # ORDER BY sticky DESC, last_post.created DESC;
+    #
+    # Version 2 of the SQL we're aiming for:
+    #   SELECT  thread_id,post_count,active,sticky,person,can_moderate
+    #   FROM    thread me
+    #       JOIN post last_post
+    #       ON ( last_post.post_id = me.last_post )
+    #
+    #       LEFT JOIN forum_moderator forum_moderators
+    #       ON (    forum_moderators.forum = me.forum
+    #               and
+    #               forum_moderators.person = NULL)
+    #   WHERE ( active = true );
 
+
+    # if we have an authed_user, we can see if they're a moderator for given
+    # threads
+    # XXX
+#    if (defined $c->_authed_user()) {
+#        # limit to person we're authed as
+#        $where->{'forum_moderators.person'} = $c->_authed_user()->id();
+#        # add the new join that's required
+#        push @join, 'forum_moderators';
+#    }
+#    else {
+#        $where->{'forum_moderators.person'} = undef;
+#        push @join, 'forum_moderators';
+#    }
+
     # get a list of threads, most recently updated first
     $c->stash->{thread_list} = $c->model('ParleyDB')->resultset('Thread')->search(
         $where,
         {
-            join        => [
-                'last_post',
-                'forum_moderators',
-            ],
+            join        => \@join,
             order_by    => 'last_post.created DESC',
         }
     );
 
     $c->log->debug( $c->stash->{thread_list}->count() );
-
     return;
 }
 



From chiselwright at mail.berlios.de  Tue Apr 17 23:32:14 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 17 Apr 2007 23:32:14 +0200
Subject: [Parley-svn] r302 - / trunk/root/base/shared
Message-ID: <200704172132.l3HLWEao006064@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-17 23:32:14 +0200 (Tue, 17 Apr 2007)
New Revision: 302

Modified:
   /
   trunk/root/base/shared/login_dialog
Log:
 r3164 at wiggin:  chisel | 2007-04-17 08:42:05 +0100
 / move (javascript) dialog setup into shared file with dialog markup



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3163
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3164
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/shared/login_dialog
===================================================================
--- trunk/root/base/shared/login_dialog	2007-04-17 21:32:05 UTC (rev 301)
+++ trunk/root/base/shared/login_dialog	2007-04-17 21:32:14 UTC (rev 302)
@@ -1,4 +1,18 @@
 <!-- login dialog -->
+
+<!-- dojo dialog-setup -->
+<script type="text/javascript">
+    var login_dialog;
+    function init_login_dialog(e) {
+        login_dialog = dojo.widget.byId("login_dialog");
+        var timer = document.getElementById("login_dialog_timer");
+        login_dialog.setTimerNode(timer);
+        var btn = document.getElementById("login_dialog_hider");
+        login_dialog.setCloseControl(btn);
+    }
+    dojo.addOnLoad(init_login_dialog);
+</script>
+
 <div dojoType="dialog" id="login_dialog" bgColor="#606060" bgOpacity="0.4" toggle="fade" toggleDuration="250">
     <form action="user/login" method="post" name="login_form" class="login_dialog_form">
         <fieldset>



From chiselwright at mail.berlios.de  Tue Apr 17 23:32:22 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 17 Apr 2007 23:32:22 +0200
Subject: [Parley-svn] r303 - / trunk/root/base/forum trunk/root/base/menu
	trunk/root/base/shared trunk/root/css
Message-ID: <200704172132.l3HLWMfk006144@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-17 23:32:22 +0200 (Tue, 17 Apr 2007)
New Revision: 303

Added:
   trunk/root/base/shared/search_dialog
Modified:
   /
   trunk/root/base/forum/view
   trunk/root/base/menu/statusbar
   trunk/root/css/default.css
Log:
 r3165 at wiggin:  chisel | 2007-04-17 08:44:44 +0100
 + new search link to use dojo-dialog
 - removed old search fade-in div
 - remove login dialog setup from statusbar [now in included file]
 + new search_dialog include - dojo-dialog
 + copied #login_dialog styles for #search_dialog



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3164
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3165
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/forum/view
===================================================================
--- trunk/root/base/forum/view	2007-04-17 21:32:14 UTC (rev 302)
+++ trunk/root/base/forum/view	2007-04-17 21:32:22 UTC (rev 303)
@@ -2,21 +2,8 @@
 
 <p style="font-size: small;">
 <a href="thread/add?forum=[% current_forum.id %]">[Start A New Topic]</a>
+<a href="javascript:;" onclick="search_dialog.show(); return false;">[Search]</a>
 
-<a onclick="new Effect.Appear('searchbox', { duration:0.2 }); $('username').focus(); return false;" href="forum/search">[Search]</a>
-</p>
-<!-- we have to put the div outside the table, otherwise we get trapped inside it! -->
-<div id="searchbox" style="display: none">
-    <form action="user/login" method="post" name="search_form" class="searchbox">
-        <fieldset>
-            <label for="search"><b>Find:</b></label>
-            <input type="text" id="search" name="search" class="input_text" />
-            <button type="submit" value="search" class="input_button" />search</button>
-        </fieldset>
-    </form>
-</div>
-<!-- status bar : end -->
-
 [%- IF thread_list.count > 0 %]
 <table>
   <tr>
@@ -99,3 +86,5 @@
 [% ELSE %]
   No active threads in this forum
 [% END %]
+
+[% INCLUDE shared/search_dialog %]

Modified: trunk/root/base/menu/statusbar
===================================================================
--- trunk/root/base/menu/statusbar	2007-04-17 21:32:14 UTC (rev 302)
+++ trunk/root/base/menu/statusbar	2007-04-17 21:32:22 UTC (rev 303)
@@ -1,18 +1,5 @@
 <!-- status bar : start -->
 
-<!-- dojo dialog-setup -->
-<script type="text/javascript">
-    var login_dialog;
-    function init(e) {
-        login_dialog = dojo.widget.byId("login_dialog");
-        var timer = document.getElementById("login_dialog_timer");
-        login_dialog.setTimerNode(timer);
-        var btn = document.getElementById("login_dialog_hider");
-        login_dialog.setCloseControl(btn);
-    }
-    dojo.addOnLoad(init);
-</script>
-
 <table width="100%">
         <tr>
                 <td width="60%" class="left">

Added: trunk/root/base/shared/search_dialog
===================================================================
--- trunk/root/base/shared/search_dialog	2007-04-17 21:32:14 UTC (rev 302)
+++ trunk/root/base/shared/search_dialog	2007-04-17 21:32:22 UTC (rev 303)
@@ -0,0 +1,28 @@
+<!-- SEARCH DIALOG -->
+<!-- dojo dialog-setup -->
+<script type="text/javascript">
+    var search_dialog;
+    function init_search_dialog(e) {
+        search_dialog = dojo.widget.byId("search_dialog");
+        var timer = document.getElementById("search_dialog_timer");
+        search_dialog.setTimerNode(timer);
+        var btn = document.getElementById("search_dialog_hider");
+        search_dialog.setCloseControl(btn);
+    }
+    dojo.addOnLoad(init_search_dialog);
+</script>
+
+<div dojoType="dialog" id="search_dialog" bgColor="#606060" bgOpacity="0.4" toggle="fade" toggleDuration="250">
+    <form action="search/forum" method="post" name="search_form" class="search_dialog_form">
+        <fieldset>
+            <label for="search_terms"><b>Search For:</b></label>
+            <input type="text" id="search_terms" name="search_terms" style="width: 25em;" class="input_text" />
+            <br />
+
+            <p align="right">
+                <a id="search_dialog_hider" href="javascript:;">Close</a><br />
+            </p>
+        </fieldset>
+    </form>
+</div>
+<!-- SEARCH DIALOG -->

Modified: trunk/root/css/default.css
===================================================================
--- trunk/root/css/default.css	2007-04-17 21:32:14 UTC (rev 302)
+++ trunk/root/css/default.css	2007-04-17 21:32:22 UTC (rev 303)
@@ -418,6 +418,40 @@
 
  
 
+/* search dialog styling */
+#search_dialog form {  /* set width in form, not fieldset (still takes up more room w/ fieldset width */
+    margin: 0;
+    padding: 0;
+    min-width: 400px;
+    max-width: 600px;
+}
+#search_dialog form fieldset {
+    / * clear: both; note that this clear causes inputs to break to left in ie5.x mac, commented out */
+    border-color: #000;
+    border-width: 1px;
+    border-style: solid;
+    padding: 10px;        /* padding in fieldset support spotty in IE */
+    margin: 0;
+}
+#search_dialog form label { 
+    display: block;  /* block float the labels to left column, set a width */
+    float: left; 
+    width: 150px; 
+    padding: 0; 
+    margin: 5px 0 0; /* set top margin same as form input - textarea etc. elements */
+    text-align: right; 
+    font-weight: bold;
+    margin-bottom : 0;
+}
+#search_dialog form input, form textarea {
+    /* display: inline; inline display must not be set or will hide submit buttons in IE 5x mac */
+    width:auto;      /* set width of form elements to auto-size, otherwise watch for wrap on resize */
+    margin:5px 0 0 10px; /* set margin on left of form elements rather than right of
+                              label aligns textarea better in IE */
+}
+#search_dialog form p {
+    font-size: 0.8em;
+}
 
 
 



From chiselwright at mail.berlios.de  Tue Apr 17 23:32:32 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 17 Apr 2007 23:32:32 +0200
Subject: [Parley-svn] r304 - / trunk/lib/Parley/Controller trunk/t
Message-ID: <200704172132.l3HLWWDS006217@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-17 23:32:31 +0200 (Tue, 17 Apr 2007)
New Revision: 304

Added:
   trunk/lib/Parley/Controller/Search.pm
   trunk/t/controller_Search.t
Modified:
   /
Log:
 r3166 at wiggin:  chisel | 2007-04-17 08:45:34 +0100
 + results of: ./script/parley_create.pl controller Search



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3165
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3166
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/lib/Parley/Controller/Search.pm
===================================================================
--- trunk/lib/Parley/Controller/Search.pm	2007-04-17 21:32:22 UTC (rev 303)
+++ trunk/lib/Parley/Controller/Search.pm	2007-04-17 21:32:31 UTC (rev 304)
@@ -0,0 +1,42 @@
+package Parley::Controller::Search;
+
+use strict;
+use warnings;
+use base 'Catalyst::Controller';
+
+=head1 NAME
+
+Parley::Controller::Search - Catalyst Controller
+
+=head1 DESCRIPTION
+
+Catalyst Controller.
+
+=head1 METHODS
+
+=cut
+
+
+=head2 index 
+
+=cut
+
+sub index : Private {
+    my ( $self, $c ) = @_;
+
+    $c->response->body('Matched Parley::Controller::Search in Search.');
+}
+
+
+=head1 AUTHOR
+
+Chisel Wright,,,
+
+=head1 LICENSE
+
+This library is free software, you can redistribute it and/or modify
+it under the same terms as Perl itself.
+
+=cut
+
+1;

Added: trunk/t/controller_Search.t
===================================================================
--- trunk/t/controller_Search.t	2007-04-17 21:32:22 UTC (rev 303)
+++ trunk/t/controller_Search.t	2007-04-17 21:32:31 UTC (rev 304)
@@ -0,0 +1,10 @@
+use strict;
+use warnings;
+use Test::More tests => 3;
+
+BEGIN { use_ok 'Catalyst::Test', 'Parley' }
+BEGIN { use_ok 'Parley::Controller::Search' }
+
+ok( request('/search')->is_success, 'Request should succeed' );
+
+



From chiselwright at mail.berlios.de  Tue Apr 17 23:32:41 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 17 Apr 2007 23:32:41 +0200
Subject: [Parley-svn] r305 - / trunk/lib/Parley/Controller
Message-ID: <200704172132.l3HLWf47006324@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-17 23:32:41 +0200 (Tue, 17 Apr 2007)
New Revision: 305

Modified:
   /
   trunk/lib/Parley/Controller/Search.pm
Log:
 r3167 at wiggin:  chisel | 2007-04-17 08:46:50 +0100
 / moved POD to end of file



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3166
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3167
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/Search.pm
===================================================================
--- trunk/lib/Parley/Controller/Search.pm	2007-04-17 21:32:31 UTC (rev 304)
+++ trunk/lib/Parley/Controller/Search.pm	2007-04-17 21:32:41 UTC (rev 305)
@@ -4,6 +4,12 @@
 use warnings;
 use base 'Catalyst::Controller';
 
+sub index : Private {
+    my ( $self, $c ) = @_;
+
+    $c->response->body('Matched Parley::Controller::Search in Search.');
+}
+
 =head1 NAME
 
 Parley::Controller::Search - Catalyst Controller
@@ -14,23 +20,11 @@
 
 =head1 METHODS
 
-=cut
-
-
 =head2 index 
 
-=cut
-
-sub index : Private {
-    my ( $self, $c ) = @_;
-
-    $c->response->body('Matched Parley::Controller::Search in Search.');
-}
-
-
 =head1 AUTHOR
 
-Chisel Wright,,,
+Chisel Wright C<< chiselwright at users.berlios.de> >>
 
 =head1 LICENSE
 



From chiselwright at mail.berlios.de  Thu Apr 19 18:49:23 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 19 Apr 2007 18:49:23 +0200
Subject: [Parley-svn] r306 - / trunk/lib trunk/lib/Text
	trunk/lib/Text/Search trunk/t
Message-ID: <200704191649.l3JGnNb5008670@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-19 18:49:22 +0200 (Thu, 19 Apr 2007)
New Revision: 306

Added:
   trunk/lib/Text/
   trunk/lib/Text/Search/
   trunk/lib/Text/Search/SQL.pm
   trunk/t/50.text_search.sql.t
Modified:
   /
Log:
 r3173 at wiggin:  chisel | 2007-04-18 18:54:35 +0100
 + new module (and tests) to parse [simple] search strings and provide an SQL::Abstract suitable where-clause



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3167
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3173
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/lib/Text/Search/SQL.pm
===================================================================
--- trunk/lib/Text/Search/SQL.pm	2007-04-17 21:32:41 UTC (rev 305)
+++ trunk/lib/Text/Search/SQL.pm	2007-04-19 16:49:22 UTC (rev 306)
@@ -0,0 +1,139 @@
+package Text::Search::SQL;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+use Carp;
+use Data::Dump qw(pp);
+
+sub new {
+    my ($proto, $options) = @_;
+
+    my $defaults = {
+        search_term     => undef,
+        search_fields   => [],
+    };
+
+    my $self = bless $defaults, ref($proto) || $proto;
+
+    # slip in the options passed to us
+    while (my ($k,$v) = each %{$options}) {
+        if (exists $defaults->{$k}) {
+            if (not ref($self->{$k})) {
+                $self->{$k} = $v;
+            }
+            elsif ( ref $self->{$k} and (ref($v) eq ref($self->{$k}))) {
+                $self->{$k} = $v;
+            }
+            else {
+                Carp::carp( qq{'$k' should be of type } . ref($self->{$k}) );
+            }
+        }
+        else {
+            Carp::carp( qq{unknown option '$k'} );
+        }
+    }
+
+    return $self;
+}
+
+sub set_search_term {
+    my ($self, $value) = @_;
+
+    $self->{search_term} = $value;
+}
+sub get_search_term {
+    my ($self) = @_;
+    return $self->{search_term};
+}
+
+sub set_search_fields {
+    my ($self, $value) = @_;
+
+    $self->{search_fields} = $value;
+}
+sub get_search_fields {
+    my ($self) = @_;
+    return $self->{search_fields};
+}
+
+sub set_chunks {
+    my ($self, $value) = @_;
+
+    $self->{chunks} = $value;
+}
+sub get_chunks {
+    my ($self) = @_;
+    return $self->{chunks};
+}
+
+sub set_sql_where {
+    my ($self, $value) = @_;
+
+    $self->{sql_where} = $value;
+}
+sub get_sql_where {
+    my ($self) = @_;
+    return $self->{sql_where};
+}
+
+sub parse {
+    my ($self) = @_;
+    my ($fields);
+
+    # split the search term into its relevant chunks
+    $self->set_chunks( $self->_parse_chunks( $self->{search_term} ) );
+
+    # can't do anything more if we don't have search_fields
+    $fields = $self->get_search_fields();
+    if (not @{$fields}) {
+        Carp::carp( qq{no search_fields defined, cannot prepare SQL::Abstract data} );
+        return;
+    }
+
+    foreach my $field ( @{$fields} ) {
+        $self->{sql_where}->{ $field } = $self->get_chunks();
+    }
+
+    return 1;
+}
+
+sub _parse_chunks {
+    my ($self, $string) = @_;
+    my (@chunks, @quotes);
+
+    # we only group with double quotes
+    @quotes = qw( " );
+
+    # pull out quoted groups of words
+    foreach my $quote (@quotes) {
+        while ($string =~ s{${quote}(.+?)${quote}}{ }g) {
+            push @chunks, $1;
+        }
+    }
+
+    # strip leading and trailing whitespace
+    $string =~ s{\A\s+}{};
+    $string =~ s{\s+\z}{};
+
+    # split on whitespace - how naive!
+    push @chunks, split( m{\s+}, $string );
+
+    return \@chunks;
+}
+
+
+1;
+
+__END__
+
+=pod
+
+=head1 NAME
+
+Text::Search::SQL - split search terms into something that can be used with DBIx::Class or SQL::Abstract
+
+=head1 AUTHOR
+
+Chisel Wright C< <<chisel.wright at users.berlios.de>> >
+
+=cut

Added: trunk/t/50.text_search.sql.t
===================================================================
--- trunk/t/50.text_search.sql.t	2007-04-17 21:32:41 UTC (rev 305)
+++ trunk/t/50.text_search.sql.t	2007-04-19 16:49:22 UTC (rev 306)
@@ -0,0 +1,165 @@
+#!/usr/bin/env perl
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+use Data::Dump qw(pp);
+
+use Test::More tests => 36;
+
+BEGIN {
+    use_ok('Text::Search::SQL');
+}
+
+# GLOBAL VARIABLES
+my ($sp);
+
+# make sure we offer the expected methods in the interface
+can_ok('Text::Search::SQL',
+    qw[
+        new
+        set_search_term
+        get_search_term
+        set_search_fields
+        get_search_fields
+        set_chunks
+        get_chunks
+        set_sql_where
+        get_sql_where
+        parse
+
+        _parse_chunks
+    ]
+);
+
+# get a new instance of the object, name sure it's what we're expecting
+$sp = Text::Search::SQL->new();
+isa_ok($sp, q{Text::Search::SQL});
+
+# calling with no argument means we should have default attributes
+is( $sp->{search_term}, undef, q{undefined search_term} );
+
+# create a new object with a search_term in the call to new
+$sp = Text::Search::SQL->new( { search_term => 'one man' } );
+isa_ok($sp, q{Text::Search::SQL});
+
+# calling with no argument means we should have default attributes
+is( $sp->{search_term}, q{one man}, q{search_term is 'one man'} );
+
+# using set_search_term() gives expected results
+$sp->set_search_term('went to mow');
+is( $sp->{search_term}, q{went to mow}, q{search_term is 'went to mow'} );
+
+# data to loop through for _parse_chunks() and parse() tests
+my @data = (
+    {
+        input   => q{isn't},
+        output  => [ q{isn't} ],
+
+        search_fields   => [ qw/subject/ ],
+        sql_where       => {
+            subject => [ q{isn't} ],
+        },
+    },
+    {
+        input   => q{went to mow},
+        output  => ['went', 'to', 'mow'],
+
+        search_fields   => [ qw/subject/ ],
+        sql_where       => {
+            subject => [ qw(went to mow) ],
+        },
+    },
+    {
+        input   => q{"went to" mow},
+        output  => ['went to', 'mow'],
+
+        search_fields   => [ qw/subject/ ],
+        sql_where       => {
+            subject => [ q{went to}, q{mow} ],
+        },
+    },
+    {
+        input   => q{'went to' mow},
+        output  => [ q{'went}, q{to'}, q{mow} ],
+    },
+    {
+        input   => q{'went to' "mow a meadow"},
+        output  => [ q{'went}, q{mow a meadow}, q{to'}],
+    },
+    {
+        input   => q{went to' mow a meadow"},
+        output  => [ q{a}, q{meadow"}, q{mow}, q{to'}, q{went} ],
+    },
+    {
+        input   => q{went to' mow a "meadow"'},
+        output  => [ q{'}, q{a}, q{meadow}, q{mow}, q{to'}, q{went} ],
+    },
+    {
+        input   => q{went to" mow a 'meadow'"},
+        output  => [ q{ mow a 'meadow'}, q{to}, q{went} ],
+    },
+    {
+        input   => q{isn't it nice to be here?},
+        output  => [ q{isn't}, q{it}, q{nice}, q{to}, q{be}, q{here?} ],
+    },
+    {
+        input   => q{"isn't it nice to be here?"},
+        output  => [ q{isn't it nice to be here?} ],
+    },
+
+    # some tests geared to the returned where data
+    {
+        input   => q{alpha beta},
+        output  => [ qw(alpha beta) ],
+
+        search_fields   => [ qw(subject) ],
+        sql_where       => {
+            subject => [ qw(alpha beta) ],
+        },
+    },
+    {
+        input   => q{alpha beta},
+        output  => [ qw(alpha beta) ],
+
+        search_fields   => [ qw(subject message) ],
+        sql_where       => {
+            subject => [ qw(alpha beta) ],
+            message => [ qw(alpha beta) ],
+        },
+    },
+);
+
+# tests for _parse_chunks()
+foreach my $data (@data) {
+    # _parse_chunks()
+    my $chunks = $sp->_parse_chunks( $data->{input} );
+    is_deeply(
+        [ sort @{ $data->{output} } ],
+        [ sort @{ $chunks } ],
+        qq{_parse_chunks: $data->{input}}
+    );
+
+    # check where clause meets our expectation
+    if (defined $data->{search_fields}) {
+        $sp->set_search_fields( $data->{search_fields} );
+    }
+
+    # parse()
+    $sp->set_search_term( $data->{input} );
+    $sp->parse();
+    is_deeply(
+        $sp->{chunks},
+        $chunks,
+        qq{\$sp->{chunks} matches _parse_chunks($data->{input})}
+    );
+
+    # where clause
+    if (defined $data->{sql_where}) {
+        is_deeply(
+            $sp->get_sql_where(),
+            $data->{sql_where},
+            qq{correct where data for $data->{input}},
+        );
+    }
+}
+



From chiselwright at mail.berlios.de  Thu Apr 19 18:49:39 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 19 Apr 2007 18:49:39 +0200
Subject: [Parley-svn] r307 - / trunk/lib/Parley/Controller
Message-ID: <200704191649.l3JGnd5E009294@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-19 18:49:38 +0200 (Thu, 19 Apr 2007)
New Revision: 307

Modified:
   /
   trunk/lib/Parley/Controller/Search.pm
Log:
 r3174 at wiggin:  chisel | 2007-04-18 18:56:12 +0100
 + add basic search/forum URL and functionality



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3173
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3174
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/Search.pm
===================================================================
--- trunk/lib/Parley/Controller/Search.pm	2007-04-19 16:49:22 UTC (rev 306)
+++ trunk/lib/Parley/Controller/Search.pm	2007-04-19 16:49:38 UTC (rev 307)
@@ -10,6 +10,29 @@
     $c->response->body('Matched Parley::Controller::Search in Search.');
 }
 
+sub forum :Local {
+    my ($self, $c) = @_;
+    my ($search_terms, $resultset);
+
+    # the search terms
+    $search_terms = $c->request->param('search_terms');
+
+    # save the search terms for the template to display
+    $c->stash->{search_terms}{raw} = $search_terms;
+
+    # search for any posts in the forum with the search_terms (phrase) in the
+    # subject or body
+    $resultset = $c->model('ParleyDB')->resultset('Post')->search(
+        {
+            subject     => { 'ilike' => "%$search_terms%" },
+        }
+    );
+
+    if ($resultset->count() > 0) {
+        $c->stash->{search_results} = $resultset;
+    }
+}
+
 =head1 NAME
 
 Parley::Controller::Search - Catalyst Controller



From chiselwright at mail.berlios.de  Thu Apr 19 18:49:48 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 19 Apr 2007 18:49:48 +0200
Subject: [Parley-svn] r308 - / trunk/root/base/shared
Message-ID: <200704191649.l3JGnmcb009675@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-19 18:49:47 +0200 (Thu, 19 Apr 2007)
New Revision: 308

Modified:
   /
   trunk/root/base/shared/search_dialog
Log:
 r3175 at wiggin:  chisel | 2007-04-18 18:56:46 +0100
 + pass forum id as hidden value in search form



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3174
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3175
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/shared/search_dialog
===================================================================
--- trunk/root/base/shared/search_dialog	2007-04-19 16:49:38 UTC (rev 307)
+++ trunk/root/base/shared/search_dialog	2007-04-19 16:49:47 UTC (rev 308)
@@ -14,6 +14,8 @@
 
 <div dojoType="dialog" id="search_dialog" bgColor="#606060" bgOpacity="0.4" toggle="fade" toggleDuration="250">
     <form action="search/forum" method="post" name="search_form" class="search_dialog_form">
+        <input type="hidden" name="forum" value="[% current_forum %]" />
+
         <fieldset>
             <label for="search_terms"><b>Search For:</b></label>
             <input type="text" id="search_terms" name="search_terms" style="width: 25em;" class="input_text" />



From chiselwright at mail.berlios.de  Thu Apr 19 18:50:17 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 19 Apr 2007 18:50:17 +0200
Subject: [Parley-svn] r309 - / trunk/root/base trunk/root/base/search
Message-ID: <200704191650.l3JGoHrn010375@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-19 18:50:16 +0200 (Thu, 19 Apr 2007)
New Revision: 309

Added:
   trunk/root/base/search/
   trunk/root/base/search/forum
Modified:
   /
Log:
 r3176 at wiggin:  chisel | 2007-04-18 18:57:15 +0100
 + templates for search screen(s)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3175
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3176
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/root/base/search/forum
===================================================================
--- trunk/root/base/search/forum	2007-04-19 16:49:47 UTC (rev 308)
+++ trunk/root/base/search/forum	2007-04-19 16:50:16 UTC (rev 309)
@@ -0,0 +1,11 @@
+<h1>Search Results</h1>
+
+<h2>Searching for <em>[% search_terms.raw || '[nothing]' %]</em> in <em>[% current_forum.name %]</em></h2>
+
+[% IF search_results %]
+    [% WHILE (result = search_results.next) %]
+    [% result.subject %]<br />
+    [% END %]
+[% ELSE %]
+No results found matching specified terms.
+[% END %]



From chiselwright at mail.berlios.de  Thu Apr 19 18:50:46 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 19 Apr 2007 18:50:46 +0200
Subject: [Parley-svn] r310 - / trunk/lib/Text/Search trunk/t
Message-ID: <200704191650.l3JGokEi011018@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-19 18:50:39 +0200 (Thu, 19 Apr 2007)
New Revision: 310

Modified:
   /
   trunk/lib/Text/Search/SQL.pm
   trunk/t/50.text_search.sql.t
Log:
 r3177 at wiggin:  chisel | 2007-04-19 09:17:08 +0100
 + added 'search_type' option
 + added get/set methods for search_type
 / parse() now builds a list where-clause (meaning the using application can use "-or => $clauses" and "-and => $clauses"
 / parse() auto-wraps terms in %...% if search_type is 'like' or 'ilike'
 / updated existing tests to test for new format of where-clause generated by format()



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3176
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3177
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Text/Search/SQL.pm
===================================================================
--- trunk/lib/Text/Search/SQL.pm	2007-04-19 16:50:16 UTC (rev 309)
+++ trunk/lib/Text/Search/SQL.pm	2007-04-19 16:50:39 UTC (rev 310)
@@ -10,6 +10,7 @@
 
     my $defaults = {
         search_term     => undef,
+        search_type     => '=',
         search_fields   => [],
     };
 
@@ -46,6 +47,16 @@
     return $self->{search_term};
 }
 
+sub set_search_type {
+    my ($self, $value) = @_;
+
+    $self->{search_type} = $value;
+}
+sub get_search_type {
+    my ($self) = @_;
+    return $self->{search_type};
+}
+
 sub set_search_fields {
     my ($self, $value) = @_;
 
@@ -78,8 +89,10 @@
 
 sub parse {
     my ($self) = @_;
-    my ($fields);
+    my ($fields, $clauses, $search_type, $chunks);
 
+    $search_type = $self->get_search_type();
+
     # split the search term into its relevant chunks
     $self->set_chunks( $self->_parse_chunks( $self->{search_term} ) );
 
@@ -90,10 +103,22 @@
         return;
     }
 
+    # get the chunks
+    $chunks = $self->get_chunks();
+    # if we're doing a "like" match, then wrap the terms in %...%
+    if ($search_type =~ m{\A(?:ilike|like)\z}xms) {
+        @{ $chunks } = map (qq{%$_%}, @{ $chunks });
+    }
+
+    # build there where-clause
     foreach my $field ( @{$fields} ) {
-        $self->{sql_where}->{ $field } = $self->get_chunks();
+        push @{ $clauses },
+            $field => { $search_type => $chunks }
+        ;
     }
 
+    $self->{sql_where} = $clauses;
+
     return 1;
 }
 

Modified: trunk/t/50.text_search.sql.t
===================================================================
--- trunk/t/50.text_search.sql.t	2007-04-19 16:50:16 UTC (rev 309)
+++ trunk/t/50.text_search.sql.t	2007-04-19 16:50:39 UTC (rev 310)
@@ -21,6 +21,8 @@
         get_search_term
         set_search_fields
         get_search_fields
+        set_search_type
+        get_search_type
         set_chunks
         get_chunks
         set_sql_where
@@ -39,7 +41,11 @@
 is( $sp->{search_term}, undef, q{undefined search_term} );
 
 # create a new object with a search_term in the call to new
-$sp = Text::Search::SQL->new( { search_term => 'one man' } );
+$sp = Text::Search::SQL->new(
+    {
+        search_term => 'one man'
+    }
+);
 isa_ok($sp, q{Text::Search::SQL});
 
 # calling with no argument means we should have default attributes
@@ -56,27 +62,27 @@
         output  => [ q{isn't} ],
 
         search_fields   => [ qw/subject/ ],
-        sql_where       => {
-            subject => [ q{isn't} ],
-        },
+        sql_where       => [
+            subject => { '=' => [ q{isn't} ] },
+        ],
     },
     {
         input   => q{went to mow},
         output  => ['went', 'to', 'mow'],
 
         search_fields   => [ qw/subject/ ],
-        sql_where       => {
-            subject => [ qw(went to mow) ],
-        },
+        sql_where       => [
+            subject => { '=' => [ qw(went to mow) ] },
+        ],
     },
     {
         input   => q{"went to" mow},
         output  => ['went to', 'mow'],
 
         search_fields   => [ qw/subject/ ],
-        sql_where       => {
-            subject => [ q{went to}, q{mow} ],
-        },
+        sql_where       => [
+            subject => { '=' => [ q{went to}, q{mow} ] },
+        ],
     },
     {
         input   => q{'went to' mow},
@@ -113,19 +119,19 @@
         output  => [ qw(alpha beta) ],
 
         search_fields   => [ qw(subject) ],
-        sql_where       => {
-            subject => [ qw(alpha beta) ],
-        },
+        sql_where       => [
+            subject => { '=' => [ qw(alpha beta) ] },
+        ],
     },
     {
         input   => q{alpha beta},
         output  => [ qw(alpha beta) ],
 
         search_fields   => [ qw(subject message) ],
-        sql_where       => {
-            subject => [ qw(alpha beta) ],
-            message => [ qw(alpha beta) ],
-        },
+        sql_where       => [
+            subject => { '=' => [ qw(alpha beta) ] },
+            message => { '=' => [ qw(alpha beta) ] },
+        ],
     },
 );
 



From chiselwright at mail.berlios.de  Thu Apr 19 18:51:01 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 19 Apr 2007 18:51:01 +0200
Subject: [Parley-svn] r311 - / trunk/lib/Parley/Controller
	trunk/root/base/search
Message-ID: <200704191651.l3JGp1XM011296@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-19 18:51:01 +0200 (Thu, 19 Apr 2007)
New Revision: 311

Modified:
   /
   trunk/lib/Parley/Controller/Search.pm
   trunk/root/base/search/forum
Log:
 r3178 at wiggin:  chisel | 2007-04-19 09:17:40 +0100
 / tweaks and improvements for searching



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3177
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3178
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/Search.pm
===================================================================
--- trunk/lib/Parley/Controller/Search.pm	2007-04-19 16:50:39 UTC (rev 310)
+++ trunk/lib/Parley/Controller/Search.pm	2007-04-19 16:51:01 UTC (rev 311)
@@ -4,6 +4,8 @@
 use warnings;
 use base 'Catalyst::Controller';
 
+use Text::Search::SQL;
+
 sub index : Private {
     my ( $self, $c ) = @_;
 
@@ -12,7 +14,7 @@
 
 sub forum :Local {
     my ($self, $c) = @_;
-    my ($search_terms, $resultset);
+    my ($search_terms, $resultset, $tss, $search_where, $where);
 
     # the search terms
     $search_terms = $c->request->param('search_terms');
@@ -20,12 +22,30 @@
     # save the search terms for the template to display
     $c->stash->{search_terms}{raw} = $search_terms;
 
+    # get a suitable where-clause to use based on the search terms
+    $tss = Text::Search::SQL->new(
+        {
+            search_term     => $search_terms,
+            search_type     => q{ilike},
+            search_fields   => [ qw(subject message) ],
+        }
+    );
+    $tss->parse();
+    $search_where = $tss->get_sql_where();
+    $c->log->dumper( $search_where );
+
+    # build the where clause to pass to our search
+    $where = {
+        thread  => { '>', 0 },
+        # we want to OR the items in $sql_where
+        -or => $search_where,
+    };
+    $c->log->dumper( $where );
+
     # search for any posts in the forum with the search_terms (phrase) in the
     # subject or body
     $resultset = $c->model('ParleyDB')->resultset('Post')->search(
-        {
-            subject     => { 'ilike' => "%$search_terms%" },
-        }
+        $where,
     );
 
     if ($resultset->count() > 0) {

Modified: trunk/root/base/search/forum
===================================================================
--- trunk/root/base/search/forum	2007-04-19 16:50:39 UTC (rev 310)
+++ trunk/root/base/search/forum	2007-04-19 16:51:01 UTC (rev 311)
@@ -3,8 +3,9 @@
 <h2>Searching for <em>[% search_terms.raw || '[nothing]' %]</em> in <em>[% current_forum.name %]</em></h2>
 
 [% IF search_results %]
+[% search_results.count %]<br />
     [% WHILE (result = search_results.next) %]
-    [% result.subject %]<br />
+    [% ForumCode.escape(result.subject) || ForumCode.escape(result.thread.subject) %]<br />
     [% END %]
 [% ELSE %]
 No results found matching specified terms.



From chiselwright at mail.berlios.de  Thu Apr 19 18:51:17 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 19 Apr 2007 18:51:17 +0200
Subject: [Parley-svn] r312 - / trunk/t
Message-ID: <200704191651.l3JGpHaJ011612@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-19 18:51:17 +0200 (Thu, 19 Apr 2007)
New Revision: 312

Modified:
   /
   trunk/t/50.text_search.sql.t
Log:
 r3179 at wiggin:  chisel | 2007-04-19 14:23:28 +0100
 / switched test data key from 'output' to 'parse'
 + added tests for search_type
 + added 'chunks' to test data, used in _parse_chunks() tests in preference to 'parse' (as the two are no longer the same is we do LIKE searching)
 / only compare ->parse() chunks with ->_parse_chunks() if we're NOT doing fuzzy-like matching



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3178
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3179
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/t/50.text_search.sql.t
===================================================================
--- trunk/t/50.text_search.sql.t	2007-04-19 16:51:01 UTC (rev 311)
+++ trunk/t/50.text_search.sql.t	2007-04-19 16:51:17 UTC (rev 312)
@@ -4,7 +4,7 @@
 use warnings;
 use Data::Dump qw(pp);
 
-use Test::More tests => 36;
+use Test::More tests => 42;
 
 BEGIN {
     use_ok('Text::Search::SQL');
@@ -59,7 +59,7 @@
 my @data = (
     {
         input   => q{isn't},
-        output  => [ q{isn't} ],
+        parse  => [ q{isn't} ],
 
         search_fields   => [ qw/subject/ ],
         sql_where       => [
@@ -68,7 +68,7 @@
     },
     {
         input   => q{went to mow},
-        output  => ['went', 'to', 'mow'],
+        parse  => ['went', 'to', 'mow'],
 
         search_fields   => [ qw/subject/ ],
         sql_where       => [
@@ -77,7 +77,7 @@
     },
     {
         input   => q{"went to" mow},
-        output  => ['went to', 'mow'],
+        parse  => ['went to', 'mow'],
 
         search_fields   => [ qw/subject/ ],
         sql_where       => [
@@ -86,37 +86,37 @@
     },
     {
         input   => q{'went to' mow},
-        output  => [ q{'went}, q{to'}, q{mow} ],
+        parse  => [ q{'went}, q{to'}, q{mow} ],
     },
     {
         input   => q{'went to' "mow a meadow"},
-        output  => [ q{'went}, q{mow a meadow}, q{to'}],
+        parse  => [ q{'went}, q{mow a meadow}, q{to'}],
     },
     {
         input   => q{went to' mow a meadow"},
-        output  => [ q{a}, q{meadow"}, q{mow}, q{to'}, q{went} ],
+        parse  => [ q{a}, q{meadow"}, q{mow}, q{to'}, q{went} ],
     },
     {
         input   => q{went to' mow a "meadow"'},
-        output  => [ q{'}, q{a}, q{meadow}, q{mow}, q{to'}, q{went} ],
+        parse  => [ q{'}, q{a}, q{meadow}, q{mow}, q{to'}, q{went} ],
     },
     {
         input   => q{went to" mow a 'meadow'"},
-        output  => [ q{ mow a 'meadow'}, q{to}, q{went} ],
+        parse  => [ q{ mow a 'meadow'}, q{to}, q{went} ],
     },
     {
         input   => q{isn't it nice to be here?},
-        output  => [ q{isn't}, q{it}, q{nice}, q{to}, q{be}, q{here?} ],
+        parse  => [ q{isn't}, q{it}, q{nice}, q{to}, q{be}, q{here?} ],
     },
     {
         input   => q{"isn't it nice to be here?"},
-        output  => [ q{isn't it nice to be here?} ],
+        parse  => [ q{isn't it nice to be here?} ],
     },
 
     # some tests geared to the returned where data
     {
         input   => q{alpha beta},
-        output  => [ qw(alpha beta) ],
+        parse  => [ qw(alpha beta) ],
 
         search_fields   => [ qw(subject) ],
         sql_where       => [
@@ -125,7 +125,7 @@
     },
     {
         input   => q{alpha beta},
-        output  => [ qw(alpha beta) ],
+        parse  => [ qw(alpha beta) ],
 
         search_fields   => [ qw(subject message) ],
         sql_where       => [
@@ -133,15 +133,41 @@
             message => { '=' => [ qw(alpha beta) ] },
         ],
     },
+
+    # search type tests
+    {
+        input   => q{haven't},
+        chunks  => [ q{haven't} ],
+        parse   => [ q{%haven't%} ],
+
+        search_fields   => [ qw/subject/ ],
+        search_type     => q{like},
+        sql_where       => [
+            subject => { 'like' => [ q{%haven't%} ] },
+        ],
+    },
+    {
+        input   => q{alpha beta gamma},
+        parse   => [ qw(alpha beta gamma) ],
+
+        search_fields   => [ qw(subject message) ],
+        search_type     => q{like},
+        sql_where       => [
+            subject => { 'like' => [ qw(%alpha% %beta% %gamma%) ] },
+            message => { 'like' => [ qw(%alpha% %beta% %gamma%) ] },
+        ],
+    },
 );
 
 # tests for _parse_chunks()
 foreach my $data (@data) {
     # _parse_chunks()
     my $chunks = $sp->_parse_chunks( $data->{input} );
+    my $expected = $data->{chunks} || $data->{parse};
+
     is_deeply(
-        [ sort @{ $data->{output} } ],
         [ sort @{ $chunks } ],
+        [ sort @{ $expected } ],
         qq{_parse_chunks: $data->{input}}
     );
 
@@ -152,12 +178,27 @@
 
     # parse()
     $sp->set_search_term( $data->{input} );
+    # if we have a search_type, set it
+    if (defined $data->{search_type}) {
+        $sp->set_search_type( $data->{search_type} );
+        is (
+            $sp->get_search_type(),
+            $data->{search_type},
+            qq{search_type set correctly for $data->{input}}
+        )
+    };
     $sp->parse();
-    is_deeply(
-        $sp->{chunks},
-        $chunks,
-        qq{\$sp->{chunks} matches _parse_chunks($data->{input})}
-    );
+    # if we're not doing a like search, we should have matching chunks
+    if( not defined $data->{search_type}
+            or
+        $data->{search_type} !~ m{\A(?:like|ilike)\z}xms
+    ) {
+        is_deeply(
+            $sp->{chunks},
+            $chunks,
+            qq{\$sp->{chunks} matches _parse_chunks($data->{input})}
+        );
+    }
 
     # where clause
     if (defined $data->{sql_where}) {



From chiselwright at mail.berlios.de  Wed Apr 25 10:31:29 2007
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 25 Apr 2007 10:31:29 +0200
Subject: [Parley-svn] r313 - / trunk trunk/lib/Parley/Controller
	trunk/root/base/search trunk/root/base/shared
Message-ID: <200704250831.l3P8VTAv022218@sheep.berlios.de>

Author: chiselwright
Date: 2007-04-25 10:31:28 +0200 (Wed, 25 Apr 2007)
New Revision: 313

Modified:
   /
   trunk/lib/Parley/Controller/Root.pm
   trunk/lib/Parley/Controller/Search.pm
   trunk/lib/Parley/Controller/Thread.pm
   trunk/parley.yml
   trunk/root/base/search/forum
   trunk/root/base/shared/search_dialog
Log:
 r3187 at wiggin:  chisel | 2007-04-25 08:46:40 +0100
 Search functionality extended:
 + added 'available_forums' to stash
 + automatically create pager data in end() [if we have search results]
 / extend and improve /search/forum
   + don't try to search if we have no terms
   + limit to forum specified by search_forum
   + improved join clause(s)
   + results paging
 + new config variable: search_results_per_page
 / slight improvement to search results template
 + add forum list to search dialog



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3179
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:3187
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/Root.pm
===================================================================
--- trunk/lib/Parley/Controller/Root.pm	2007-04-19 16:51:17 UTC (rev 312)
+++ trunk/lib/Parley/Controller/Root.pm	2007-04-25 08:31:28 UTC (rev 313)
@@ -18,6 +18,16 @@
 sub auto : Private {
     my ($self, $c) = @_;
 
+    # get a list of (all/available) forums
+    $c->stash->{available_forums} = $c->model('ParleyDB')->resultset('Forum')->search(
+        {
+            active  => 1,
+        },
+        {
+            order_by    => 'name ASC',
+        }
+    );
+
     ############################################################
     # if we have a user ... fetch some info (if we don't already have it)
     ############################################################

Modified: trunk/lib/Parley/Controller/Search.pm
===================================================================
--- trunk/lib/Parley/Controller/Search.pm	2007-04-19 16:51:17 UTC (rev 312)
+++ trunk/lib/Parley/Controller/Search.pm	2007-04-25 08:31:28 UTC (rev 313)
@@ -5,6 +5,8 @@
 use base 'Catalyst::Controller';
 
 use Text::Search::SQL;
+use URI;
+use URI::QueryParam;
 
 sub index : Private {
     my ( $self, $c ) = @_;
@@ -12,13 +14,34 @@
     $c->response->body('Matched Parley::Controller::Search in Search.');
 }
 
+sub end :Private {
+    my ($self, $c) = @_;
+
+    # we're likely to want pages results for numerous seaches
+    $self->_results_view_pager($c);
+
+    # finish processing the page and display
+    $c->forward('/end');
+}
+
 sub forum :Local {
     my ($self, $c) = @_;
-    my ($search_terms, $resultset, $tss, $search_where, $where);
+    my ($search_terms, $resultset, $tss, $search_where, $where, @join);
 
+    # page to show - either a param, or show the first
+    $c->stash->{current_page}= $c->request->param('page') || 1;
+
     # the search terms
     $search_terms = $c->request->param('search_terms');
 
+    # if we don't have anything to search for ..
+    if (not defined $search_terms or $search_terms =~ m{\A\s*\z}xms) {
+        return;
+    }
+
+    # start with no join(s)
+    @join = ();
+
     # save the search terms for the template to display
     $c->stash->{search_terms}{raw} = $search_terms;
 
@@ -27,25 +50,48 @@
         {
             search_term     => $search_terms,
             search_type     => q{ilike},
-            search_fields   => [ qw(subject message) ],
+            search_fields   => [ qw(me.subject me.message) ],
         }
     );
     $tss->parse();
     $search_where = $tss->get_sql_where();
-    $c->log->dumper( $search_where );
 
     # build the where clause to pass to our search
     $where = {
-        thread  => { '>', 0 },
         # we want to OR the items in $sql_where
         -or => $search_where,
     };
-    $c->log->dumper( $where );
 
+    # if we have a search_forum, limit to that
+    if (defined $c->request->param('search_forum')) {
+        my ($forum);
+        eval {
+            $forum = $c->model('ParleyDB')->resultset('Forum')->find(
+                {
+                    forum_id    => $c->request->param('search_forum'),
+                }
+            );
+        };
+
+        if (defined $forum) {
+            $where->{'thread.forum'} = $forum->id(),
+            push @join, 'thread';
+            # put in the stash
+            $c->stash->{search_forum} = $forum;
+        }
+    }
+
     # search for any posts in the forum with the search_terms (phrase) in the
     # subject or body
     $resultset = $c->model('ParleyDB')->resultset('Post')->search(
         $where,
+        {
+            join        => \@join,
+            order_by    => q{created DESC},
+            # results paging
+            rows        => $c->config->{search_results_per_page},
+            page        => $c->stash->{current_page},
+        }
     );
 
     if ($resultset->count() > 0) {
@@ -53,6 +99,35 @@
     }
 }
 
+sub _results_view_pager {
+    my ($self, $c) = @_;
+
+    if (not $c->stash->{search_results}) {
+        $c->log->debug('no results - no pager');
+        return;
+    }
+
+    $c->stash->{page} = $c->stash->{search_results}->pager();
+
+    # TODO - find a better way to do this if possible
+    # set up Data::SpreadPagination
+    my $pagination = Data::SpreadPagination->new(
+        {
+            totalEntries        => $c->stash->{page}->total_entries(),
+            entriesPerPage      => $c->config->{search_results_per_page},
+            currentPage         => $c->stash->{current_page},
+            maxPages            => 4,
+        }
+    );
+    $c->stash->{page_range_spread} = $pagination->pages_in_spread();
+
+    # extra params to use in pager links (to preserve search data)
+    my $u = URI->new("", "http");
+    $u->query_param(search_terms => $c->stash->{search_terms}{raw});
+    $u->query_param(search_forum => $c->request->param('search_forum'));
+    $c->stash->{url_extra_args} = '&' . $u->query();
+}
+
 =head1 NAME
 
 Parley::Controller::Search - Catalyst Controller

Modified: trunk/lib/Parley/Controller/Thread.pm
===================================================================
--- trunk/lib/Parley/Controller/Thread.pm	2007-04-19 16:51:17 UTC (rev 312)
+++ trunk/lib/Parley/Controller/Thread.pm	2007-04-25 08:31:28 UTC (rev 313)
@@ -186,7 +186,6 @@
 sub view : Local {
     my ($self, $c) = @_;
 
-
     # page to show - either a param, or show the first
     $c->stash->{current_page}= $c->request->param('page') || 1;
 

Modified: trunk/parley.yml
===================================================================
--- trunk/parley.yml	2007-04-19 16:51:17 UTC (rev 312)
+++ trunk/parley.yml	2007-04-25 08:31:28 UTC (rev 313)
@@ -3,6 +3,7 @@
 name:         Parley
 default_uri:  /forum/list
 posts_per_page: 10
+search_results_per_page: 25
 replies_have_own_subject: 0
 
 alerts:

Modified: trunk/root/base/search/forum
===================================================================
--- trunk/root/base/search/forum	2007-04-19 16:51:17 UTC (rev 312)
+++ trunk/root/base/search/forum	2007-04-25 08:31:28 UTC (rev 313)
@@ -1,12 +1,25 @@
 <h1>Search Results</h1>
 
-<h2>Searching for <em>[% search_terms.raw || '[nothing]' %]</em> in <em>[% current_forum.name %]</em></h2>
+<h2>Searching for <em>[% search_terms.raw || '[nothing]' %]</em> in <em>[% search_forum.name || 'all forums' %]</em></h2>
 
 [% IF search_results %]
-[% search_results.count %]<br />
+    <table>
     [% WHILE (result = search_results.next) %]
-    [% ForumCode.escape(result.subject) || ForumCode.escape(result.thread.subject) %]<br />
+    <tr>
+        <td>[% ForumCode.escape(result.subject) || ForumCode.escape(result.thread.subject) %]</td>
+    </tr>
     [% END %]
+
+    <tr>
+        <td class="right_align" valign="top">
+        <small>
+        [% INCLUDE shared/pager_advanced %]
+        </small>
+        </td>
+    </tr>
+
+
+    </table>
 [% ELSE %]
 No results found matching specified terms.
 [% END %]

Modified: trunk/root/base/shared/search_dialog
===================================================================
--- trunk/root/base/shared/search_dialog	2007-04-19 16:51:17 UTC (rev 312)
+++ trunk/root/base/shared/search_dialog	2007-04-25 08:31:28 UTC (rev 313)
@@ -14,17 +14,31 @@
 
 <div dojoType="dialog" id="search_dialog" bgColor="#606060" bgOpacity="0.4" toggle="fade" toggleDuration="250">
     <form action="search/forum" method="post" name="search_form" class="search_dialog_form">
-        <input type="hidden" name="forum" value="[% current_forum %]" />
-
         <fieldset>
             <label for="search_terms"><b>Search For:</b></label>
             <input type="text" id="search_terms" name="search_terms" style="width: 25em;" class="input_text" />
             <br />
+        </fieldset>
 
-            <p align="right">
-                <a id="search_dialog_hider" href="javascript:;">Close</a><br />
-            </p>
+        <fieldset>
+            <label for="search_forum"><em>in:</em></label>
+            <select id="search_forum" name="search_forum">
+                [% IF current_forum %]<option value="[% current_forum.id %]">Current Forum</option>[% END %]
+                <option value="">All Forums</option>
+                [% IF available_forums %]
+                [% WHILE (forum = available_forums.next) %]
+                <option value="[% forum.id %]">[% forum.name %]</option>
+                [% END %]
+                [% END %]
+            </select>
+            <br />
         </fieldset>
+
+        <input type="submit" />
+
+        <p align="right">
+            <a id="search_dialog_hider" href="javascript:;">Close</a><br />
+        </p>
     </form>
 </div>
 <!-- SEARCH DIALOG -->



