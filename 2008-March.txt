From chiselwright at mail.berlios.de  Thu Mar  6 22:01:55 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 6 Mar 2008 22:01:55 +0100
Subject: [Parley-svn] r822 - / trunk/db trunk/lib/Parley
	trunk/lib/Parley/Controller trunk/lib/Parley/Schema
	trunk/root/base trunk/root/base/user trunk/root/static/script
	trunk/t/schema
Message-ID: <200803062101.m26L1t1h000829@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-06 22:01:54 +0100 (Thu, 06 Mar 2008)
New Revision: 822

Added:
   trunk/lib/Parley/Schema/LogAdminAction.pm
   trunk/root/static/script/ajax_error_dlg.js
   trunk/root/static/script/user_suspend.js
   trunk/t/schema/logadminaction.t
Modified:
   /
   trunk/db/patch_0.58_to_0.59.psql
   trunk/lib/Parley/Controller/Site.pm
   trunk/lib/Parley/Controller/User.pm
   trunk/lib/Parley/Schema.pm
   trunk/lib/Parley/Schema/Person.pm
   trunk/lib/Parley/Schema/Thread.pm
   trunk/root/base/header
   trunk/root/base/user/profile
   trunk/t/schema/person.t
Log:
 r4725 at wiggin:  chisel | 2008-03-06 19:01:15 +0000
 Intermediate check-in along the long road of Admin Functionality:
 + new role, Suspend Account
 + new table: log_admin_action
 / improvements to user-role editing (e.g. no site_moderator suicide)
 + implement a large chunk of the user-suspend functionality
 + extended Person DBIC class with role methods: is_site_moderator(), can_suspend_account()
 + added LogAdminAction DBIC class
 / extended user profile to show suspend checkbox (for authed users)
 + added javascript to get suspension-reason and post back to server (through ajax)
 + added "ajax error dialog" - just nicer than a straight javascript alert()
 + created and extended tests



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4721
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4725
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/db/patch_0.58_to_0.59.psql
===================================================================
--- trunk/db/patch_0.58_to_0.59.psql	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/db/patch_0.58_to_0.59.psql	2008-03-06 21:01:54 UTC (rev 822)
@@ -6,6 +6,7 @@
 --  add flagging of posts edited by admin
 --  lock posts (so they can't be changed after being edited by admin)
 --  allow user accounts to be suspended
+--  logging of admin actions on users (e.g. why suspended)
 
 BEGIN;
 
@@ -26,13 +27,20 @@
     name        varchar(30) not null unique,
     description text
 );
+CREATE INDEX idx_role_name ON role(name);
+
 -- a couple of roles
 INSERT INTO role (idx, name, description) VALUES (
     0,
     'site_moderator',
-    'Site Moderator (aka Da Boss)'
+    'Site Moderator'
 );
 INSERT INTO role (idx, name, description) VALUES (
+    50,
+    'suspend_account',
+    'Suspend Account'
+);
+INSERT INTO role (idx, name, description) VALUES (
     100,
     'ip_ban_posting',
     'Restrict Posting by IP'
@@ -56,6 +64,8 @@
                             references role(id),
     UNIQUE (person_id, role_id)
 );
+CREATE INDEX idx_userroles_personid ON user_roles(person_id);
+CREATE INDEX idx_userroles_roleid   ON user_roles(role_id);
 
 -- make topdog a site_moderator
 INSERT INTO user_roles
@@ -65,6 +75,24 @@
     (SELECT id FROM role WHERE name='site_moderator')
 );
 
+-- admin action log actions/messages
+CREATE TABLE log_admin_action (
+    id          serial      primary key,
+    person_id   integer     not null
+                            references person(id),
+    admin_id    integer     not null
+                            references person(id),
+    created     timestamp   with time zone
+                            not null
+                            default CURRENT_TIMESTAMP,
+
+    message     text        not null
+                            default 'No Message Supplied'
+);
+CREATE INDEX idx_adminaction_personid ON admin_action(person_id);
+CREATE INDEX idx_adminaction_adminid  ON admin_action(admin_id);
+
+
 -- patch ends here --
 
 COMMIT;

Modified: trunk/lib/Parley/Controller/Site.pm
===================================================================
--- trunk/lib/Parley/Controller/Site.pm	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/lib/Parley/Controller/Site.pm	2008-03-06 21:01:54 UTC (rev 822)
@@ -139,13 +139,28 @@
         eval {
             $c->model('ParleyDB')->schema->txn_do(
                 sub {
-                    $c->model('ParleyDB::UserRole')->search(
+                    my $userrole = $c->model('ParleyDB::UserRole')->find(
                         {
                             person_id   => $person_id,
                             role_id     => $role_id,
                         }
-                    )
-                    ->delete;
+                    );
+
+                    # moderator suicide?
+                    if (
+                        $person_id = $c->_authed_user->id
+                            and
+                        q{site_moderator} eq $userrole->role->name
+                    ) {
+                        $return_data->{error}{message} =
+                            $c->localize(
+                                q{You can't commit moderator suicide}
+                            );
+                    }
+                    else {
+                        # remove the role
+                        $userrole->delete;
+                    }
                 }
             );
             $return_data->{updated} = 1;

Modified: trunk/lib/Parley/Controller/User.pm
===================================================================
--- trunk/lib/Parley/Controller/User.pm	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/lib/Parley/Controller/User.pm	2008-03-06 21:01:54 UTC (rev 822)
@@ -6,6 +6,8 @@
 use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
+use JSON;
+
 # deal with user login requests on user/login
 sub login : Path('/user/login') {
     my ( $self, $c ) = @_;
@@ -118,7 +120,66 @@
     }
 }
 
+sub suspend :Local {
+    my ($self, $c) = @_;
+    my ($json, $return_data, $person);
 
+    if (not $c->_authed_user->can_suspend_account) {
+        $return_data->{error}{message} =
+            $c->localize(q{You don't have the required privileges to do that});
+    }
+
+    else {
+        my ($suspended, $person);
+
+        # default to turning OFF a suspension
+        $suspended = 0;
+
+        # see if we meet the criteria for a suspend action
+        if (
+            defined $c->request->param('suspend')
+                and
+            1 == $c->request->param('suspend')
+        ) {
+            $suspended = 1;
+        }
+
+        eval {
+            # see if we can find the person to suspend
+            $person = $c->model('ParleyDB::Person')->find(
+                $c->request->param('person')
+            );
+
+            if (defined $person) {
+                $return_data->{error}{suspended} = $suspended;
+                $return_data->{error}{name} = $person->forum_name;
+
+                # suspend a person, giving a reson
+                $person->set_suspended(
+                    {
+                        value   => $suspended,
+                        reason  => $c->request->param('reason'),
+                    }
+                );
+            }
+            else {
+                $return_data->{error}{message} =
+                    $c->localize(q{We're not in Kansas any more});
+            }
+        };
+        if ($@) {
+            $return_data->{error}{message} = $@;
+            $c->log->error($@);
+        }
+    }
+
+    # return some JSON
+    $json = to_json($return_data);
+    $c->response->body( $json );
+    $c->log->info( $json );
+    return;
+}
+
 1;
 
 __END__

Added: trunk/lib/Parley/Schema/LogAdminAction.pm
===================================================================
--- trunk/lib/Parley/Schema/LogAdminAction.pm	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/lib/Parley/Schema/LogAdminAction.pm	2008-03-06 21:01:54 UTC (rev 822)
@@ -0,0 +1,42 @@
+package Parley::Schema::LogAdminAction;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
+use base 'DBIx::Class';
+use DateTime::Format::Pg;
+
+use Parley::App::DateTime qw( :interval );
+
+__PACKAGE__->load_components("PK::Auto", "Core");
+__PACKAGE__->table("log_admin_action");
+__PACKAGE__->add_columns(
+  id            => { },
+  person_id     => { },
+  admin_id      => { },
+  created       => { },
+  message       => { },
+);
+
+__PACKAGE__->set_primary_key("id");
+#__PACKAGE__->resultset_class('Parley::ResultSet::Role');
+
+__PACKAGE__->belongs_to(
+    "person" => "Person",
+    { 'foreign.id' => "self.person_id" }
+);
+__PACKAGE__->belongs_to(
+    "admin" => "Person",
+    { 'foreign.id' => "self.person_id" }
+);
+
+foreach my $datecol (qw/created/) {
+    __PACKAGE__->inflate_column($datecol, {
+        inflate => sub { DateTime::Format::Pg->parse_datetime(shift); },
+        deflate => sub { DateTime::Format::Pg->format_datetime(shift); },
+    });
+}
+
+1;

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/lib/Parley/Schema/Person.pm	2008-03-06 21:01:54 UTC (rev 822)
@@ -66,6 +66,8 @@
     is_nullable => 0,
     size => undef,
   },
+
+  suspended     => {},
 );
 
 __PACKAGE__->set_primary_key("id");
@@ -143,6 +145,9 @@
     my $record = shift;
     my @roles  = @_;
 
+    return
+        if (not @roles);
+
     my ($schema, $rs);
 
     $schema = $record->result_source()->schema();
@@ -164,4 +169,21 @@
     return ($rs->count == scalar(@roles) || 0);
 }
 
+# thin wrapper around check_user_roles() for convenience
+sub is_site_moderator {
+    my $record = shift;
+
+    return $record->check_user_roles(
+        'site_moderator'
+    );
+}
+# thin wrapper around check_user_roles() for convenience
+sub can_suspend_account {
+    my $record = shift;
+
+    return $record->check_user_roles(
+        'site_moderator'
+    );
+}
+
 1;

Modified: trunk/lib/Parley/Schema/Thread.pm
===================================================================
--- trunk/lib/Parley/Schema/Thread.pm	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/lib/Parley/Schema/Thread.pm	2008-03-06 21:01:54 UTC (rev 822)
@@ -6,6 +6,7 @@
 use warnings;
 
 use Parley::Version;  our $VERSION = $Parley::VERSION;
+use DateTime::Format::Pg;
 
 use base 'DBIx::Class';
 

Modified: trunk/lib/Parley/Schema.pm
===================================================================
--- trunk/lib/Parley/Schema.pm	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/lib/Parley/Schema.pm	2008-03-06 21:01:54 UTC (rev 822)
@@ -13,6 +13,7 @@
         'EmailQueue',
         'ForumModerator',
         'Forum',
+        'LogAdminAction',
         'PasswordReset',
         'Person',
         'Post',

Modified: trunk/root/base/header
===================================================================
--- trunk/root/base/header	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/root/base/header	2008-03-06 21:01:54 UTC (rev 822)
@@ -50,6 +50,8 @@
         <script type="text/javascript" src="[%c.request.base%]/static/yui/tabview/tabview-min.js"></script>
         <script type="text/javascript" src="[%c.uri_for('/static/yui/autocomplete/autocomplete-min.js')%]"></script>
 
+        <!-- homebrew javascript -->
+        <script type="text/javascript" src="[%c.uri_for('/static/script/ajax_error_dlg.js')%]"></script>
 
         <!-- defined styles for parley -->
         <link type="text/css" rel="stylesheet" title="Simple" href="[%c.uri_for('/static/css/parley-min.css')%]" />

Modified: trunk/root/base/user/profile
===================================================================
--- trunk/root/base/user/profile	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/root/base/user/profile	2008-03-06 21:01:54 UTC (rev 822)
@@ -42,7 +42,50 @@
 
         </div>
     </div>
+
+    [% IF authed_user.is_site_moderator || authed_user.can_suspend_account %]
+    <h2>Administration</h2>
+
+    <div class="yui-gf top_padded">
+        [% IF authed_user.can_suspend_account %]
+        <div class="yui-u first align_right">
+        Suspend Account
+        </div>
+        <div class="yui-u">
+        <input
+            type="checkbox"
+            name="suspend_account"
+            id="suspend_account"
+            value="[%profiled_user.id%]"
+            [% IF profiled_user.suspended %]checked="true"[% END %]
+        >
+        </div>
+        [% END %]
+    </div>
+
+    [% END %]
 [% ELSE %]
     <p>[%l('PROFILE NOT FOUND')%]</p>
 [% END %]
 <!-- end : user/profile -->
+
+
+<script type="text/javascript" src="[%c.uri_for('/static/script/user_suspend.js')%]"></script>
+<div id="suspend_reason_dialog">
+    <div class="hd">Please enter suspension information</div>
+    <div class="bd">
+        <form method="POST" action="assets/post.php">
+            <label for="suspension_reason">Reason for suspension:</label>
+            <br />
+            <textarea id="suspension_reason" cols="30" rows="6"></textarea>
+        </form>
+    </div>
+</div>
+
+<div id="ajax_dialog">
+    <div class="hd">AJAX Message Dialog</div>
+    <div class="bd">
+        Message
+    </div>
+</div>
+

Added: trunk/root/static/script/ajax_error_dlg.js
===================================================================
--- trunk/root/static/script/ajax_error_dlg.js	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/root/static/script/ajax_error_dlg.js	2008-03-06 21:01:54 UTC (rev 822)
@@ -0,0 +1,56 @@
+(function () {
+    var ajax_dialog_init = function() {
+        YAHOO.namespace("parley.ajax_dialog");
+
+        var handleClose = function() {
+            this.cancel();
+        };
+
+        YAHOO.parley.ajax_dialog.dlg =
+            new YAHOO.widget.Dialog(
+                "ajax_dialog",
+                {
+                    postmethod:             'none',
+                    modal: true,
+                    //width:                  '350px',
+                    fixedcenter:            true,
+                    visible:                false, 
+                    constraintoviewport:    true,
+
+                    buttons: [
+                        { text:"Close", handler:handleClose, isDefault:true }
+                    ]
+                }
+            )
+        ; // End of new()
+
+        YAHOO.parley.ajax_dialog.dlg.show_message = function(e) {
+            try {
+                // set the body of the dialog to the message, if we have one
+                if(undefined!=e && undefined!=e.message) {
+                    this.setBody(e.message);
+                }
+                else {
+                    this.setBody('No error message passed to show_message()');
+                }
+
+                // set the dialog header
+                if(undefined!=e && undefined!=e.title) {
+                    this.setHeader(e.title);
+                }
+                else {
+                    this.setHeader('Application Error');
+                }
+            } catch(e){alert(e);}
+
+            // show the dialog
+            this.show();
+        }
+
+        // Render the Dialog
+        YAHOO.parley.ajax_dialog.dlg.render();
+    };
+
+
+    YAHOO.util.Event.onDOMReady(ajax_dialog_init);
+})();

Added: trunk/root/static/script/user_suspend.js
===================================================================
--- trunk/root/static/script/user_suspend.js	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/root/static/script/user_suspend.js	2008-03-06 21:01:54 UTC (rev 822)
@@ -0,0 +1,104 @@
+YAHOO.namespace("parley.suspend_reason");
+
+function suspend_init() {
+    var YU  = YAHOO.util,
+        Dom = YAHOO.util.Dom;
+
+    var suspend_account = function() {
+        var elID = this.id,
+            checked = (this.checked ? true : false);
+
+        try {
+            // do we want to suspend the tinker?
+            if (checked) {
+                YAHOO.parley.suspend_reason.suspend_reason_dialog.show();
+            }
+
+            // do we want to un-suspend the user?
+            else {
+                //alert('un-suspend');
+            }
+        } catch(e) { alert(e); }
+    }
+
+    YU.Event.addListener(
+        'suspend_account',
+        'change',
+        suspend_account
+    );
+}
+
+
+function suspend_reason_init() {
+    var YU  = YAHOO.util,
+        Dom = YAHOO.util.Dom;
+
+    // Define various event handlers for Dialog
+    var handleSubmit = function() {
+        YAHOO.parley.small_loading.wait.show();
+
+        var checked =
+            (Dom.get('suspend_account').checked ? 1 : 0);
+
+        var person_id =
+            Dom.get('suspend_account').value;
+        var reason =
+            Dom.get('suspension_reason').value;
+
+        try {
+            var request = YU.Connect.asyncRequest(
+                'POST',
+                '/user/suspend',
+                {
+                    success: handleSuccess,
+                    failure: handleFailure,
+                    argument: {
+                        node: Dom.get('suspend_account')
+                    }
+                },
+                  'suspend='    + checked
+                + '&person='    + person_id
+                + '&reason='    + reason
+            );
+        } catch(e) { alert(e); }
+    };
+    var handleCancel = function() {
+        YAHOO.parley.small_loading.wait.hide();
+        this.cancel();
+    };
+    var handleSuccess = function(o) {
+        YAHOO.parley.small_loading.wait.hide();
+        YAHOO.parley.suspend_reason.suspend_reason_dialog.hide();
+        var response = o.responseText;
+        var data = eval('(' + o.responseText + ')');
+
+        try {
+        YAHOO.parley.ajax_dialog.dlg.show_message(data.error);
+        } catch(e) { alert(e); }
+    };
+    var handleFailure = function(o) {
+        YAHOO.parley.small_loading.wait.hide();
+        alert("Submission failed: " + o.status);
+    };
+
+    // Instantiate the Dialog
+    YAHOO.parley.suspend_reason.suspend_reason_dialog =
+        new YAHOO.widget.Dialog("suspend_reason_dialog",
+        {
+            postmethod:             'async',
+            width : "350px",
+            fixedcenter : true,
+            visible : false, 
+            constraintoviewport : true,
+            buttons : [ { text:"Submit", handler:handleSubmit, isDefault:true },
+                        { text:"Cancel", handler:handleCancel } ]
+        }
+    );
+
+    // Render the Dialog
+    YAHOO.parley.suspend_reason.suspend_reason_dialog.render();
+}
+
+YAHOO.util.Event.onDOMReady(suspend_reason_init);
+YAHOO.util.Event.onDOMReady(suspend_init);
+

Added: trunk/t/schema/logadminaction.t
===================================================================
--- trunk/t/schema/logadminaction.t	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/t/schema/logadminaction.t	2008-03-06 21:01:54 UTC (rev 822)
@@ -0,0 +1,49 @@
+#!/usr/bin/perl
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+# load the module that provides all of the common test functionality
+use FindBin qw($Bin);
+use lib $Bin;
+use SchemaTest;
+
+my $schematest = SchemaTest->new(
+    {
+        dsn       => 'dbi:Pg:dbname=parley',
+        namespace => 'Parley::Schema',
+        moniker   => 'LogAdminAction',
+    }
+);
+$schematest->methods(
+    {
+        columns => [
+            qw[
+                id
+                person_id
+                admin_id
+                created
+                message
+            ]
+        ],
+
+        relations => [
+            qw[
+                person
+                admin
+            ]
+        ],
+
+        custom => [
+            qw[
+            ]
+        ],
+
+        resultsets => [
+            qw[
+            ]
+        ],
+    }
+);
+
+$schematest->run_tests();


Property changes on: trunk/t/schema/logadminaction.t
___________________________________________________________________
Name: svn:executable
   + *

Modified: trunk/t/schema/person.t
===================================================================
--- trunk/t/schema/person.t	2008-02-28 22:32:08 UTC (rev 821)
+++ trunk/t/schema/person.t	2008-03-06 21:01:54 UTC (rev 822)
@@ -28,6 +28,7 @@
                 preference_id
                 last_post_id
                 post_count
+                suspended
             ]
         ],
 
@@ -46,6 +47,10 @@
 
         custom => [
             qw[
+                roles
+                check_user_roles
+                is_site_moderator
+                can_suspend_account
             ]
         ],
 



From chiselwright at mail.berlios.de  Thu Mar  6 22:02:03 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 6 Mar 2008 22:02:03 +0100
Subject: [Parley-svn] r823 - / trunk/db
Message-ID: <200803062102.m26L23Tw000902@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-06 22:02:03 +0100 (Thu, 06 Mar 2008)
New Revision: 823

Modified:
   /
   trunk/db/parley.psql
Log:
 r4726 at wiggin:  chisel | 2008-03-06 19:16:37 +0000
 / push changes from patch_0.58_to_0.59.psql into the main schema



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4725
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4726
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/db/parley.psql
===================================================================
--- trunk/db/parley.psql	2008-03-06 21:01:54 UTC (rev 822)
+++ trunk/db/parley.psql	2008-03-06 21:02:03 UTC (rev 823)
@@ -1,4 +1,4 @@
--- Phorum schema
+-- Parley schema
 
 -- to get your user and database:
 --  createuser -A -d parley
@@ -66,6 +66,9 @@
     authentication_id   integer
                         references authentication(id),
 
+    suspended           boolean     not null
+                        default False,
+
     UNIQUE(forum_name),
     UNIQUE(email)
 );
@@ -130,8 +133,12 @@
     creator_id      integer     not null
                     references person(id),
 
-    ip_addr         inet
+    ip_addr         inet,
 
+    admin_editor_id integer
+                    references person(id),
+    locked          boolean     not null
+                    default False
 );
 
 -- add ReplyTo information for post
@@ -243,7 +250,43 @@
     UNIQUE(person_id, terms_id)
 );
 
+-- roles / authentication
+CREATE TABLE role (
+    id              serial      primary key,
+    idx             integer     not null default 9999,
+    name            varchar(30) not null unique,
+    description     text
+);
+CREATE INDEX idx_role_name ON role(name);
 
+CREATE TABLE user_roles (
+    id              serial      primary key,
+    person_id       integer     not null
+                                references person(id),
+    role_id         integer     not null
+                                references role(id),
+    UNIQUE (person_id, role_id)
+);
+CREATE INDEX idx_userroles_personid ON user_roles(person_id);
+CREATE INDEX idx_userroles_roleid   ON user_roles(role_id);
+
+-- admin action log actions/messages
+CREATE TABLE log_admin_action (
+    id              serial      primary key,
+    person_id       integer     not null
+                                references person(id),
+    admin_id        integer     not null
+                                references person(id),
+    created         timestamp   with time zone
+                                not null
+                                default CURRENT_TIMESTAMP,
+
+    message         text        not null
+                                default 'No Message Supplied'
+);
+CREATE INDEX idx_adminaction_personid ON admin_action(person_id);
+CREATE INDEX idx_adminaction_adminid  ON admin_action(admin_id);
+
 --
 -- some default stuff
 --
@@ -270,6 +313,41 @@
 INSERT INTO forum (name, description) VALUES ('Suggestions', 'Things you think should be added');
 INSERT INTO forum (name, description) VALUES ('Bugs', 'If you find anything broken, report it here');
 
+-- some roles
+INSERT INTO role (idx, name, description) VALUES (
+    0,
+    'site_moderator',
+    'Site Moderator'
+);
+INSERT INTO role (idx, name, description) VALUES (
+    50,
+    'suspend_account',
+    'Suspend Account'
+);
+INSERT INTO role (idx, name, description) VALUES (
+    100,
+    'ip_ban_posting',
+    'Restrict Posting by IP'
+);
+INSERT INTO role (idx, name, description) VALUES (
+    100,
+    'ip_ban_signup',
+    'Restrict Sign-Up by IP'
+);
+INSERT INTO role (idx, name, description) VALUES (
+    100,
+    'ip_ban_login',
+    'Restrict Login by IP'
+);
+
+-- make topdog a site_moderator
+INSERT INTO user_roles
+    (person_id, role_id)
+VALUES (
+    0,
+    (SELECT id FROM role WHERE name='site_moderator')
+);
+
 -- commit our schema
 COMMIT;
 



From chiselwright at mail.berlios.de  Tue Mar 11 12:19:16 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 11 Mar 2008 12:19:16 +0100
Subject: [Parley-svn] r824 - / trunk/db trunk/lib/Parley
	trunk/lib/Parley/Controller trunk/lib/Parley/Schema
	trunk/root/static/script trunk/t/schema
Message-ID: <200803111119.m2BBJG2G016527@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-11 12:19:14 +0100 (Tue, 11 Mar 2008)
New Revision: 824

Added:
   trunk/lib/Parley/Schema/AdminAction.pm
   trunk/t/schema/adminaction.t
Modified:
   /
   trunk/db/parley.psql
   trunk/db/patch_0.58_to_0.59.psql
   trunk/lib/Parley/Controller/User.pm
   trunk/lib/Parley/Schema.pm
   trunk/lib/Parley/Schema/LogAdminAction.pm
   trunk/lib/Parley/Schema/Person.pm
   trunk/root/static/script/ajax_error_dlg.js
   trunk/root/static/script/user_suspend.js
   trunk/t/schema/logadminaction.t
Log:
 r4729 at wiggin:  chisel | 2008-03-11 09:19:37 +0000
 + added admin_action lookup table, with tests and DBIC schema
 / removed (test) data from user-suspend ajax call's return data
 + added set_suspended() method on Person resultset
 / some JS tweaks and improvements



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4726
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4729
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/db/parley.psql
===================================================================
--- trunk/db/parley.psql	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/db/parley.psql	2008-03-11 11:19:14 UTC (rev 824)
@@ -271,6 +271,15 @@
 CREATE INDEX idx_userroles_roleid   ON user_roles(role_id);
 
 -- admin action log actions/messages
+CREATE TABLE admin_action (
+    id              serial      primary key,
+    name            text        not null,
+
+    UNIQUE(name)
+);
+INSERT INTO admin_action (id, name) VALUES (0, 'undefined');
+INSERT INTO admin_action (name) VALUES ('suspend_user');
+
 CREATE TABLE log_admin_action (
     id              serial      primary key,
     person_id       integer     not null
@@ -281,11 +290,15 @@
                                 not null
                                 default CURRENT_TIMESTAMP,
 
+    action_id       integer     not null
+                                default 0
+                                references admin_action(id),
+
     message         text        not null
                                 default 'No Message Supplied'
 );
-CREATE INDEX idx_adminaction_personid ON admin_action(person_id);
-CREATE INDEX idx_adminaction_adminid  ON admin_action(admin_id);
+CREATE INDEX idx_adminaction_personid ON log_admin_action(person_id);
+CREATE INDEX idx_adminaction_adminid  ON log_admin_action(admin_id);
 
 --
 -- some default stuff

Modified: trunk/db/patch_0.58_to_0.59.psql
===================================================================
--- trunk/db/patch_0.58_to_0.59.psql	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/db/patch_0.58_to_0.59.psql	2008-03-11 11:19:14 UTC (rev 824)
@@ -75,6 +75,15 @@
     (SELECT id FROM role WHERE name='site_moderator')
 );
 
+CREATE TABLE admin_action (
+    id          serial      primary key,
+    name        text        not null,
+
+    UNIQUE(name)
+);
+INSERT INTO admin_action (id, name) VALUES (0, 'undefined');
+INSERT INTO admin_action (name) VALUES ('suspend_user');
+
 -- admin action log actions/messages
 CREATE TABLE log_admin_action (
     id          serial      primary key,
@@ -86,11 +95,15 @@
                             not null
                             default CURRENT_TIMESTAMP,
 
+    action_id   integer     not null
+                            default 0
+                            references admin_action(id),
+
     message     text        not null
                             default 'No Message Supplied'
 );
-CREATE INDEX idx_adminaction_personid ON admin_action(person_id);
-CREATE INDEX idx_adminaction_adminid  ON admin_action(admin_id);
+CREATE INDEX idx_adminaction_personid ON log_admin_action(person_id);
+CREATE INDEX idx_adminaction_adminid  ON log_admin_action(admin_id);
 
 
 -- patch ends here --

Modified: trunk/lib/Parley/Controller/User.pm
===================================================================
--- trunk/lib/Parley/Controller/User.pm	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/lib/Parley/Controller/User.pm	2008-03-11 11:19:14 UTC (rev 824)
@@ -151,14 +151,15 @@
             );
 
             if (defined $person) {
-                $return_data->{error}{suspended} = $suspended;
-                $return_data->{error}{name} = $person->forum_name;
+                $return_data->{data}{suspended} = $suspended;
+                $return_data->{data}{name} = $person->forum_name;
 
                 # suspend a person, giving a reson
                 $person->set_suspended(
                     {
                         value   => $suspended,
                         reason  => $c->request->param('reason'),
+                        admin   => $c->_authed_user,
                     }
                 );
             }

Added: trunk/lib/Parley/Schema/AdminAction.pm
===================================================================
--- trunk/lib/Parley/Schema/AdminAction.pm	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/lib/Parley/Schema/AdminAction.pm	2008-03-11 11:19:14 UTC (rev 824)
@@ -0,0 +1,22 @@
+package Parley::Schema::AdminAction;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
+use base 'DBIx::Class';
+use DateTime::Format::Pg;
+
+use Parley::App::DateTime qw( :interval );
+
+__PACKAGE__->load_components("PK::Auto", "Core");
+__PACKAGE__->table("admin_action");
+__PACKAGE__->add_columns(
+  id            => { },
+  name          => { },
+);
+
+__PACKAGE__->set_primary_key("id");
+
+1;

Modified: trunk/lib/Parley/Schema/LogAdminAction.pm
===================================================================
--- trunk/lib/Parley/Schema/LogAdminAction.pm	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/lib/Parley/Schema/LogAdminAction.pm	2008-03-11 11:19:14 UTC (rev 824)
@@ -18,6 +18,7 @@
   admin_id      => { },
   created       => { },
   message       => { },
+  action_id     => { },
 );
 
 __PACKAGE__->set_primary_key("id");
@@ -31,6 +32,10 @@
     "admin" => "Person",
     { 'foreign.id' => "self.person_id" }
 );
+__PACKAGE__->belongs_to(
+    "action" => "AdminAction",
+    { 'foreign.id' => "self.action_id" }
+);
 
 foreach my $datecol (qw/created/) {
     __PACKAGE__->inflate_column($datecol, {

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/lib/Parley/Schema/Person.pm	2008-03-11 11:19:14 UTC (rev 824)
@@ -4,6 +4,7 @@
 
 use strict;
 use warnings;
+use Carp;
 
 use Parley::Version;  our $VERSION = $Parley::VERSION;
 
@@ -169,6 +170,58 @@
     return ($rs->count == scalar(@roles) || 0);
 }
 
+# suspend a user (and log a message at the same time)
+sub set_suspended {
+    my ($record, $args) = @_;
+    my ($value, $reason, $admin_id);
+    $value      = $args->{value};
+    $reason     = $args->{reason};
+    $admin_id   = $args->{admin}->id;
+
+    my $schema = $record->result_source()->schema();
+
+    if (not defined $value) {
+        Carp::carp('no value passed to set_suspended()');
+        return;
+    }
+
+    if (not defined $reason) {
+        $reason = q{None Given};
+    }
+
+    # suspend the user and add a log action
+    eval {
+        $schema->txn_do(
+            sub {
+                # set the value of suspended
+                $record->update({suspended => $value});
+                # add a log message
+                $schema->resultset('LogAdminAction')->create(
+                    {
+                        person_id   => $record->id,
+                        admin_id    => $admin_id,
+                        message     => $reason,
+
+                        action => {
+                            name => 'suspend_user',
+                        },
+                    }
+                );
+                return;
+            }
+        )
+    };
+    if ($@) {                                   # Transaction failed
+        die "something terrible has happened!"  #
+            if ($@ =~ /Rollback failed/);       # Rollback failed
+
+        #$return_data->{error}{message} =
+            #qq{Database transaction failed: $@};
+        #$c->log->error( $@ );
+        die $@;
+    }
+}
+
 # thin wrapper around check_user_roles() for convenience
 sub is_site_moderator {
     my $record = shift;

Modified: trunk/lib/Parley/Schema.pm
===================================================================
--- trunk/lib/Parley/Schema.pm	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/lib/Parley/Schema.pm	2008-03-11 11:19:14 UTC (rev 824)
@@ -9,6 +9,7 @@
 # explicitly load Parley::Schema classes
 __PACKAGE__->load_classes(
     [
+        'AdminAction',
         'Authentication',
         'EmailQueue',
         'ForumModerator',

Modified: trunk/root/static/script/ajax_error_dlg.js
===================================================================
--- trunk/root/static/script/ajax_error_dlg.js	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/root/static/script/ajax_error_dlg.js	2008-03-11 11:19:14 UTC (rev 824)
@@ -12,7 +12,6 @@
                 {
                     postmethod:             'none',
                     modal: true,
-                    //width:                  '350px',
                     fixedcenter:            true,
                     visible:                false, 
                     constraintoviewport:    true,
@@ -26,25 +25,37 @@
 
         YAHOO.parley.ajax_dialog.dlg.show_message = function(e) {
             try {
-                // set the body of the dialog to the message, if we have one
-                if(undefined!=e && undefined!=e.message) {
-                    this.setBody(e.message);
+                // default title and body
+                this.setHeader('Application Error');
+                this.setBody('No error message passed to show_message()');
+
+                // check for undefined input
+                if(undefined==e) {
+                    this.setBody('No data passed to show_message()');
                 }
                 else {
-                    this.setBody('No error message passed to show_message()');
-                }
+                    // if we appear to have been passed a request-error object
+                    if(undefined!=e.statusText) {
+                        this.setHeader('Error');
+                        this.setBody(e.status + ' ' + e.statusText);
+                    }
+                    else { // should be custom user data
+                        // set the body of the dialog to the message, if we have one
+                        if(undefined!=e.message) {
+                            this.setBody(e.message);
+                        }
 
-                // set the dialog header
-                if(undefined!=e && undefined!=e.title) {
-                    this.setHeader(e.title);
+                        // set the dialog header
+                        if(undefined!=e.title) {
+                            this.setHeader(e.title);
+                        }
+                    }
                 }
-                else {
-                    this.setHeader('Application Error');
-                }
-            } catch(e){alert(e);}
 
-            // show the dialog
-            this.show();
+                // show the dialog
+                this.render();
+                this.show();
+            } catch(e){alert('show_message: ' + e);}
         }
 
         // Render the Dialog

Modified: trunk/root/static/script/user_suspend.js
===================================================================
--- trunk/root/static/script/user_suspend.js	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/root/static/script/user_suspend.js	2008-03-11 11:19:14 UTC (rev 824)
@@ -9,15 +9,8 @@
             checked = (this.checked ? true : false);
 
         try {
-            // do we want to suspend the tinker?
-            if (checked) {
-                YAHOO.parley.suspend_reason.suspend_reason_dialog.show();
-            }
-
-            // do we want to un-suspend the user?
-            else {
-                //alert('un-suspend');
-            }
+            Dom.get('suspension_reason').value = '';
+            YAHOO.parley.suspend_reason.suspend_reason_dialog.show();
         } catch(e) { alert(e); }
     }
 
@@ -64,6 +57,10 @@
     };
     var handleCancel = function() {
         YAHOO.parley.small_loading.wait.hide();
+        // reset the checkbox
+        Dom.get('suspend_account').checked =
+            ! (Dom.get('suspend_account').checked);
+        // cancel the dialog
         this.cancel();
     };
     var handleSuccess = function(o) {
@@ -71,14 +68,12 @@
         YAHOO.parley.suspend_reason.suspend_reason_dialog.hide();
         var response = o.responseText;
         var data = eval('(' + o.responseText + ')');
-
-        try {
-        YAHOO.parley.ajax_dialog.dlg.show_message(data.error);
-        } catch(e) { alert(e); }
     };
     var handleFailure = function(o) {
         YAHOO.parley.small_loading.wait.hide();
-        alert("Submission failed: " + o.status);
+        try {
+            YAHOO.parley.ajax_dialog.dlg.show_message( o );
+        } catch(e) { alert('handleFailure: ' + e); }
     };
 
     // Instantiate the Dialog

Added: trunk/t/schema/adminaction.t
===================================================================
--- trunk/t/schema/adminaction.t	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/t/schema/adminaction.t	2008-03-11 11:19:14 UTC (rev 824)
@@ -0,0 +1,44 @@
+#!/usr/bin/perl
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+# load the module that provides all of the common test functionality
+use FindBin qw($Bin);
+use lib $Bin;
+use SchemaTest;
+
+my $schematest = SchemaTest->new(
+    {
+        dsn       => 'dbi:Pg:dbname=parley',
+        namespace => 'Parley::Schema',
+        moniker   => 'AdminAction',
+    }
+);
+$schematest->methods(
+    {
+        columns => [
+            qw[
+                id
+                name
+            ]
+        ],
+
+        relations => [
+            qw[
+            ]
+        ],
+
+        custom => [
+            qw[
+            ]
+        ],
+
+        resultsets => [
+            qw[
+            ]
+        ],
+    }
+);
+
+$schematest->run_tests();


Property changes on: trunk/t/schema/adminaction.t
___________________________________________________________________
Name: svn:executable
   + *

Modified: trunk/t/schema/logadminaction.t
===================================================================
--- trunk/t/schema/logadminaction.t	2008-03-06 21:02:03 UTC (rev 823)
+++ trunk/t/schema/logadminaction.t	2008-03-11 11:19:14 UTC (rev 824)
@@ -24,6 +24,7 @@
                 admin_id
                 created
                 message
+                action_id
             ]
         ],
 
@@ -31,6 +32,7 @@
             qw[
                 person
                 admin
+                action
             ]
         ],
 



From chiselwright at mail.berlios.de  Tue Mar 11 12:19:25 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 11 Mar 2008 12:19:25 +0100
Subject: [Parley-svn] r825 - / trunk/root/base/shared
Message-ID: <200803111119.m2BBJP6u016662@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-11 12:19:24 +0100 (Tue, 11 Mar 2008)
New Revision: 825

Added:
   trunk/root/base/shared/ajax_dialog
Modified:
   /
Log:
 r4730 at wiggin:  chisel | 2008-03-11 09:29:52 +0000
 / factored ajax_dialog markup into a separate tt-include file



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4729
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4730
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/root/base/shared/ajax_dialog
===================================================================
--- trunk/root/base/shared/ajax_dialog	2008-03-11 11:19:14 UTC (rev 824)
+++ trunk/root/base/shared/ajax_dialog	2008-03-11 11:19:24 UTC (rev 825)
@@ -0,0 +1,6 @@
+<div id="ajax_dialog">
+    <div class="hd">AJAX Message Dialog</div>
+    <div class="bd">
+        Message
+    </div>
+</div>



From chiselwright at mail.berlios.de  Tue Mar 11 12:19:31 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 11 Mar 2008 12:19:31 +0100
Subject: [Parley-svn] r826 - / trunk trunk/lib/Parley/I18N
	trunk/root/base/user
Message-ID: <200803111119.m2BBJVxN016773@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-11 12:19:31 +0100 (Tue, 11 Mar 2008)
New Revision: 826

Modified:
   /
   trunk/Changes.i18n
   trunk/lib/Parley/I18N/i_default.po
   trunk/root/base/user/profile
Log:
 r4731 at wiggin:  chisel | 2008-03-11 09:33:01 +0000
 + added some i_default i18n strings



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4730
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4731
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-03-11 11:19:24 UTC (rev 825)
+++ trunk/Changes.i18n	2008-03-11 11:19:31 UTC (rev 826)
@@ -19,6 +19,10 @@
             - "We're not in Kansas any more"
             - "Invalid %1"
             - "Invalid requested value"
+            - "Administration"
+            - "Suspend Account"
+            - "Please enter suspension information"
+            - "Reason for suspension"
 
     it.po:
         - added:

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-03-11 11:19:24 UTC (rev 825)
+++ trunk/lib/Parley/I18N/i_default.po	2008-03-11 11:19:31 UTC (rev 826)
@@ -52,6 +52,9 @@
 msgid "ADMIN SPECIFY STICK THREAD"
 msgstr "You must specify the thread to stick"
 
+msgid "Administration"
+msgstr "Administration"
+
 msgid "ago"
 msgstr "ago"
 
@@ -462,6 +465,9 @@
 msgid "Please choose a language"
 msgstr "Please choose a language"
 
+msgid "Please enter suspension information"
+msgstr "Please enter suspension information"
+
 msgid "Please enter your information"
 msgstr "Please enter your information"
 
@@ -516,6 +522,9 @@
 msgid "Quote"
 msgstr "Quote"
 
+msgid "Reason for suspension"
+msgstr "Reason for suspension"
+
 msgid "Recently Updated Threads"
 msgstr "Recently Updated Threads"
 
@@ -642,6 +651,9 @@
 msgid "Summary of Changes"
 msgstr "Summary of Changes"
 
+msgid "Suspend Account"
+msgstr "Suspend Account"
+
 msgid "TERMS ADD NEW"
 msgstr "Add New Site Terms &amp; Conditions"
 

Modified: trunk/root/base/user/profile
===================================================================
--- trunk/root/base/user/profile	2008-03-11 11:19:24 UTC (rev 825)
+++ trunk/root/base/user/profile	2008-03-11 11:19:31 UTC (rev 826)
@@ -44,12 +44,12 @@
     </div>
 
     [% IF authed_user.is_site_moderator || authed_user.can_suspend_account %]
-    <h2>Administration</h2>
+    <h2>[%l('Administration')%]</h2>
 
     <div class="yui-gf top_padded">
         [% IF authed_user.can_suspend_account %]
         <div class="yui-u first align_right">
-        Suspend Account
+        [%l('Suspend Account')%]
         </div>
         <div class="yui-u">
         <input
@@ -75,17 +75,11 @@
     <div class="hd">Please enter suspension information</div>
     <div class="bd">
         <form method="POST" action="assets/post.php">
-            <label for="suspension_reason">Reason for suspension:</label>
+            <label for="suspension_reason">[%l('Reason for suspension')%]:</label>
             <br />
             <textarea id="suspension_reason" cols="30" rows="6"></textarea>
         </form>
     </div>
 </div>
 
-<div id="ajax_dialog">
-    <div class="hd">AJAX Message Dialog</div>
-    <div class="bd">
-        Message
-    </div>
-</div>
-
+[% PROCESS shared/ajax_dialog %]



From chiselwright at mail.berlios.de  Tue Mar 11 12:19:38 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 11 Mar 2008 12:19:38 +0100
Subject: [Parley-svn] r827 - / trunk trunk/lib/Parley/I18N
Message-ID: <200803111119.m2BBJcpO016888@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-11 12:19:37 +0100 (Tue, 11 Mar 2008)
New Revision: 827

Modified:
   /
   trunk/Changes.i18n
   trunk/lib/Parley/I18N/i_default.po
Log:
 r4732 at wiggin:  chisel | 2008-03-11 09:35:01 +0000
 + added another i_default i18n phrase



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4731
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4732
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-03-11 11:19:31 UTC (rev 826)
+++ trunk/Changes.i18n	2008-03-11 11:19:37 UTC (rev 827)
@@ -23,6 +23,7 @@
             - "Suspend Account"
             - "Please enter suspension information"
             - "Reason for suspension"
+            - "You don't have the required privileges to do that"
 
     it.po:
         - added:

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-03-11 11:19:31 UTC (rev 826)
+++ trunk/lib/Parley/I18N/i_default.po	2008-03-11 11:19:37 UTC (rev 827)
@@ -795,6 +795,9 @@
 msgid "You are watching this thread"
 msgstr "You are watching this thread"
 
+msgid "You don't have the required privileges to do that"
+msgstr "You don't have the required privileges to do that"
+
 msgid "Your Details"
 msgstr "Your Details"
 



From chiselwright at mail.berlios.de  Thu Mar 13 13:33:42 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 13 Mar 2008 13:33:42 +0100
Subject: [Parley-svn] r828 - / trunk trunk/lib/Parley/I18N
	trunk/root/base/user
Message-ID: <200803131233.m2DCXgfm020674@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-13 13:33:42 +0100 (Thu, 13 Mar 2008)
New Revision: 828

Modified:
   /
   trunk/Changes
   trunk/Changes.i18n
   trunk/lib/Parley/I18N/i_default.po
   trunk/root/base/user/profile
Log:
 r4737 at wiggin:  chisel | 2008-03-11 18:45:50 +0000
 / updated Changes
 + another i_defualt i18n phrase
 + show if a user is suspended (in the public section of the profile)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4732
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4737
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes
===================================================================
--- trunk/Changes	2008-03-11 11:19:37 UTC (rev 827)
+++ trunk/Changes	2008-03-13 12:33:42 UTC (rev 828)
@@ -1,6 +1,8 @@
 This file documents the revision history for Parley.
 
 0.59 (UNDER DEVELOPMENT)
+    - user roles can now be assigned and removed
+    - users can have their "suspended" flag set and removed
 
 0.58    Fri Feb  8 07:47:31 GMT 2008
     - re-work the UI design to be cleaner

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-03-11 11:19:37 UTC (rev 827)
+++ trunk/Changes.i18n	2008-03-13 12:33:42 UTC (rev 828)
@@ -24,6 +24,7 @@
             - "Please enter suspension information"
             - "Reason for suspension"
             - "You don't have the required privileges to do that"
+            - "Suspended"
 
     it.po:
         - added:

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-03-11 11:19:37 UTC (rev 827)
+++ trunk/lib/Parley/I18N/i_default.po	2008-03-13 12:33:42 UTC (rev 828)
@@ -654,6 +654,9 @@
 msgid "Suspend Account"
 msgstr "Suspend Account"
 
+msgid "Suspended"
+msgstr "Suspended"
+
 msgid "TERMS ADD NEW"
 msgstr "Add New Site Terms &amp; Conditions"
 

Modified: trunk/root/base/user/profile
===================================================================
--- trunk/root/base/user/profile	2008-03-11 11:19:37 UTC (rev 827)
+++ trunk/root/base/user/profile	2008-03-13 12:33:42 UTC (rev 828)
@@ -16,8 +16,19 @@
                 </div>
             </div>
 
+            [% IF profiled_user.suspended %]
             <div class="yui-gf top_padded">
                 <div class="yui-u first align_right">
+                &nbsp;
+                </div>
+                <div class="yui-u">
+                    [%l('Suspended')%]
+                </div>
+            </div>
+            [% END %]
+
+            <div class="yui-gf top_padded">
+                <div class="yui-u first align_right">
                     [%l('Posts Made')%]:
                 </div>
                 <div class="yui-u">



From chiselwright at mail.berlios.de  Thu Mar 13 13:33:50 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 13 Mar 2008 13:33:50 +0100
Subject: [Parley-svn] r829 - / trunk/lib/Parley/Controller
	trunk/root/base/user
Message-ID: <200803131233.m2DCXoj2020751@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-13 13:33:50 +0100 (Thu, 13 Mar 2008)
New Revision: 829

Added:
   trunk/root/base/user/suspended
Modified:
   /
   trunk/lib/Parley/Controller/Root.pm
   trunk/lib/Parley/Controller/User.pm
Log:
 r4738 at wiggin:  chisel | 2008-03-11 19:20:16 +0000
 + suspended users can only visit user/suspended and user/logout; any other urls are redirected to user/suspended



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4737
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4738
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/Root.pm
===================================================================
--- trunk/lib/Parley/Controller/Root.pm	2008-03-13 12:33:42 UTC (rev 828)
+++ trunk/lib/Parley/Controller/Root.pm	2008-03-13 12:33:50 UTC (rev 829)
@@ -168,7 +168,6 @@
                 'authentication.username'   => $c->user->username(),
             },
             {
-                #join => 'authentication',
                 prefetch => [
                     'authentication',
                     { 'preference' => 'time_format' },
@@ -186,7 +185,23 @@
         }
     }
 
+    ############################################################
+    # if we have a suspended user ...
+    ############################################################
+    if (
+        $c->_authed_user
+            and
+        $c->_authed_user->suspended
+            and
+        $c->request->path() !~ m{user/suspended}
+            and
+        $c->request->path() !~ m{user/logout}
+    ) {
+        $c->forward('/user/suspended');
+        return 0;
+    }
 
+
     ######################################
     # user's with 'site_moderator' role
     # get flagged as such

Modified: trunk/lib/Parley/Controller/User.pm
===================================================================
--- trunk/lib/Parley/Controller/User.pm	2008-03-13 12:33:42 UTC (rev 828)
+++ trunk/lib/Parley/Controller/User.pm	2008-03-13 12:33:50 UTC (rev 829)
@@ -181,6 +181,12 @@
     return;
 }
 
+sub suspended :Local {
+    my ($self, $c) = @_;
+    $c->stash->{template} = 'user/suspended';
+    return;
+}
+
 1;
 
 __END__

Added: trunk/root/base/user/suspended
===================================================================
--- trunk/root/base/user/suspended	2008-03-13 12:33:42 UTC (rev 828)
+++ trunk/root/base/user/suspended	2008-03-13 12:33:50 UTC (rev 829)
@@ -0,0 +1 @@
+<h1 class="top_padded">Your account has been suspended.</h1>



From chiselwright at mail.berlios.de  Thu Mar 13 13:34:01 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 13 Mar 2008 13:34:01 +0100
Subject: [Parley-svn] r830 - / trunk trunk/lib/Parley/I18N
	trunk/lib/Parley/Schema trunk/root/base/user
	trunk/root/static/script
Message-ID: <200803131234.m2DCY1qj020829@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-13 13:34:01 +0100 (Thu, 13 Mar 2008)
New Revision: 830

Modified:
   /
   trunk/Changes.i18n
   trunk/lib/Parley/I18N/i_default.po
   trunk/lib/Parley/Schema/Person.pm
   trunk/root/base/user/profile
   trunk/root/base/user/suspended
   trunk/root/static/script/user_suspend.js
Log:
 r4739 at wiggin:  chisel | 2008-03-12 19:29:28 +0000
 + another i_default i18n phrase
 + Person schema method to (easily) get record for last suspension
 + show reason for suspension in user/profile (for relevant authed users)
 + show user reason for their suspension in user/suspension
 / escape() reason for suspension



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4738
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4739
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-03-13 12:33:50 UTC (rev 829)
+++ trunk/Changes.i18n	2008-03-13 12:34:01 UTC (rev 830)
@@ -25,6 +25,7 @@
             - "Reason for suspension"
             - "You don't have the required privileges to do that"
             - "Suspended"
+            - "No reason given"
 
     it.po:
         - added:

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-03-13 12:33:50 UTC (rev 829)
+++ trunk/lib/Parley/I18N/i_default.po	2008-03-13 12:34:01 UTC (rev 830)
@@ -360,6 +360,9 @@
 msgid "No posts"
 msgstr "No posts"
 
+msgid "No reason given"
+msgstr "No reason given"
+
 msgid "NO MATCHING USERS"
 msgstr "There are no users matching that information"
 

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-03-13 12:33:50 UTC (rev 829)
+++ trunk/lib/Parley/Schema/Person.pm	2008-03-13 12:34:01 UTC (rev 830)
@@ -222,6 +222,30 @@
     }
 }
 
+sub last_suspension {
+    my $record = shift;
+    my ($schema, $result);
+
+    $schema = $record->result_source()->schema();
+
+    $result = $schema->resultset('LogAdminAction')->search(
+        {
+            'action.name' => 'suspend_user',
+        },
+        {
+            join => [qw( action )],
+            rows => 1,
+            order_by    => 'created DESC',
+        }
+    );
+
+    if ($result->count()) {
+        return $result->first;
+    }
+
+    return;
+}
+
 # thin wrapper around check_user_roles() for convenience
 sub is_site_moderator {
     my $record = shift;

Modified: trunk/root/base/user/profile
===================================================================
--- trunk/root/base/user/profile	2008-03-13 12:33:50 UTC (rev 829)
+++ trunk/root/base/user/profile	2008-03-13 12:34:01 UTC (rev 830)
@@ -57,22 +57,32 @@
     [% IF authed_user.is_site_moderator || authed_user.can_suspend_account %]
     <h2>[%l('Administration')%]</h2>
 
-    <div class="yui-gf top_padded">
-        [% IF authed_user.can_suspend_account %]
-        <div class="yui-u first align_right">
-        [%l('Suspend Account')%]
+    [% IF authed_user.can_suspend_account %]
+        <div class="yui-gf top_padded">
+            <div class="yui-u first align_right">
+            [%l('Suspend Account')%]
+            </div>
+            <div class="yui-u">
+            <input
+                type="checkbox"
+                name="suspend_account"
+                id="suspend_account"
+                value="[%profiled_user.id%]"
+                [% IF profiled_user.suspended %]checked="true"[% END %]
+            >
+            </div>
         </div>
-        <div class="yui-u">
-        <input
-            type="checkbox"
-            name="suspend_account"
-            id="suspend_account"
-            value="[%profiled_user.id%]"
-            [% IF profiled_user.suspended %]checked="true"[% END %]
-        >
-        </div>
+        [% IF profiled_user.suspended %]
+            <div class="yui-gf top_padded">
+                <div class="yui-u first align_right">
+                    [%l('Reason for suspension')%]:
+                </div>
+                <div class="yui-u">
+                    [% profiled_user.last_suspension.message ||l('No reason given') %]
+                </div>
+            </div>
         [% END %]
-    </div>
+    [% END %]
 
     [% END %]
 [% ELSE %]

Modified: trunk/root/base/user/suspended
===================================================================
--- trunk/root/base/user/suspended	2008-03-13 12:33:50 UTC (rev 829)
+++ trunk/root/base/user/suspended	2008-03-13 12:34:01 UTC (rev 830)
@@ -1 +1,21 @@
 <h1 class="top_padded">Your account has been suspended.</h1>
+
+[% IF (profiled_user = authed_user) %]
+    <div class="yui-gf">
+        <div class="yui-u first align_right">
+            [%l('Nickname')%]:
+        </div>
+        <div class="yui-u">
+            [% profiled_user.forum_name %]
+        </div>
+    </div>
+
+    <div class="yui-gf top_padded">
+        <div class="yui-u first align_right">
+            [%l('Reason for suspension')%]:
+        </div>
+        <div class="yui-u">
+            [% profiled_user.last_suspension.message ||l('No reason given') %]
+        </div>
+    </div>
+[% END %]

Modified: trunk/root/static/script/user_suspend.js
===================================================================
--- trunk/root/static/script/user_suspend.js	2008-03-13 12:33:50 UTC (rev 829)
+++ trunk/root/static/script/user_suspend.js	2008-03-13 12:34:01 UTC (rev 830)
@@ -51,7 +51,7 @@
                 },
                   'suspend='    + checked
                 + '&person='    + person_id
-                + '&reason='    + reason
+                + '&reason='    + escape(reason)
             );
         } catch(e) { alert(e); }
     };



From chiselwright at mail.berlios.de  Thu Mar 13 13:34:10 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 13 Mar 2008 13:34:10 +0100
Subject: [Parley-svn] r831 - / trunk/root/base/user
Message-ID: <200803131234.m2DCYAa2020903@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-13 13:34:10 +0100 (Thu, 13 Mar 2008)
New Revision: 831

Modified:
   /
   trunk/root/base/user/profile
   trunk/root/base/user/suspended
Log:
 r4740 at wiggin:  chisel | 2008-03-12 19:36:35 +0000
 / html-escape suspension reason in template



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4739
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4740
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/user/profile
===================================================================
--- trunk/root/base/user/profile	2008-03-13 12:34:01 UTC (rev 830)
+++ trunk/root/base/user/profile	2008-03-13 12:34:10 UTC (rev 831)
@@ -78,7 +78,7 @@
                     [%l('Reason for suspension')%]:
                 </div>
                 <div class="yui-u">
-                    [% profiled_user.last_suspension.message ||l('No reason given') %]
+                    [% ForumCode.escape(profiled_user.last_suspension.message) ||l('No reason given') %]
                 </div>
             </div>
         [% END %]

Modified: trunk/root/base/user/suspended
===================================================================
--- trunk/root/base/user/suspended	2008-03-13 12:34:01 UTC (rev 830)
+++ trunk/root/base/user/suspended	2008-03-13 12:34:10 UTC (rev 831)
@@ -15,7 +15,7 @@
             [%l('Reason for suspension')%]:
         </div>
         <div class="yui-u">
-            [% profiled_user.last_suspension.message ||l('No reason given') %]
+            [% ForumCode.escape(profiled_user.last_suspension.message) ||l('No reason given') %]
         </div>
     </div>
 [% END %]



From chiselwright at mail.berlios.de  Thu Mar 13 13:34:16 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 13 Mar 2008 13:34:16 +0100
Subject: [Parley-svn] r832 - / trunk
Message-ID: <200803131234.m2DCYG6n020977@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-13 13:34:15 +0100 (Thu, 13 Mar 2008)
New Revision: 832

Modified:
   /
   trunk/ROADMAP
   trunk/TODO
Log:
 r4741 at wiggin:  chisel | 2008-03-12 19:46:16 +0000
 roadmap and todo updates



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4740
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4741
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/ROADMAP
===================================================================
--- trunk/ROADMAP	2008-03-13 12:34:10 UTC (rev 831)
+++ trunk/ROADMAP	2008-03-13 12:34:15 UTC (rev 832)
@@ -18,7 +18,7 @@
     - admin/moderator support (deal with bad people)
         - [D] edit posts (and flag accordingly)
         - abuse handling
-          - suspend account(s)
+          - [D] suspend account(s)
           - prevent login from IP
           - prevent signup from IP
           - prevent posting/editing from IP

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-03-13 12:34:10 UTC (rev 831)
+++ trunk/TODO	2008-03-13 12:34:15 UTC (rev 832)
@@ -1,5 +1,6 @@
 TODO LIST
 
+  - forumcode "quickhelp" in posting screen(s)
   - get latest i18n from DJ
   - "Cancel" from post/edit
   - "Cancel" from thread/reply



From chiselwright at mail.berlios.de  Thu Mar 13 13:34:22 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 13 Mar 2008 13:34:22 +0100
Subject: [Parley-svn] r833 - / trunk/root/base/shared
	trunk/root/static/images/icons
Message-ID: <200803131234.m2DCYMOv021047@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-13 13:34:21 +0100 (Thu, 13 Mar 2008)
New Revision: 833

Added:
   trunk/root/static/images/icons/attach.png
Modified:
   /
   trunk/root/base/shared/postinfo_table_row
Log:
 r4742 at wiggin:  chisel | 2008-03-12 19:49:06 +0000
 / change the "sticky icon"



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4741
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4742
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/shared/postinfo_table_row
===================================================================
--- trunk/root/base/shared/postinfo_table_row	2008-03-13 12:34:15 UTC (rev 832)
+++ trunk/root/base/shared/postinfo_table_row	2008-03-13 12:34:21 UTC (rev 833)
@@ -4,7 +4,7 @@
     <td width="36" style="padding-top:5px;">
         <!-- interesting things about the thread; sticky, locked, etc -->
         [%- IF thread.sticky %]
-        <img src="static/images/icons/anchor.png" alt="Sticky" title="Sticky Topic" width="16" height="16" />
+        <img src="static/images/icons/attach.png" alt="Sticky" title="Sticky Topic" width="16" height="16" />
         [%- END %]
         [%- IF thread.locked %]
         <img src="static/images/icons/lock.png" alt="Locked" title="Locked Topic" width="16" height="16" />

Added: trunk/root/static/images/icons/attach.png
===================================================================
(Binary files differ)


Property changes on: trunk/root/static/images/icons/attach.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From chiselwright at mail.berlios.de  Thu Mar 13 13:34:28 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 13 Mar 2008 13:34:28 +0100
Subject: [Parley-svn] r834 - / trunk
Message-ID: <200803131234.m2DCYSov021122@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-13 13:34:27 +0100 (Thu, 13 Mar 2008)
New Revision: 834

Modified:
   /
   trunk/ROADMAP
Log:
 r4743 at wiggin:  chisel | 2008-03-12 19:52:01 +0000
 / update ROADMAP



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4742
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4743
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/ROADMAP
===================================================================
--- trunk/ROADMAP	2008-03-13 12:34:21 UTC (rev 833)
+++ trunk/ROADMAP	2008-03-13 12:34:27 UTC (rev 834)
@@ -27,14 +27,18 @@
 0.60:
 
     - upgrade to YUI 2.5.x
-    - advanced search
+    - update to use "new catalyst authentication"
 
 0.61:
 
-    - admin: add/edit/order forums
+    - advanced search
 
 0.62:
 
+    - admin: add/edit/order forums
+
+0.63:
+
     - user prefs:
         - language preference
         - password management



From chiselwright at mail.berlios.de  Fri Mar 14 00:33:51 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 14 Mar 2008 00:33:51 +0100
Subject: [Parley-svn] r835 - / trunk trunk/db trunk/lib/Parley
	trunk/lib/Parley/Controller trunk/lib/Parley/I18N
	trunk/lib/Parley/ResultSet trunk/lib/Parley/Schema
	trunk/root/base/user trunk/t/schema
Message-ID: <200803132333.m2DNXph3019406@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-14 00:33:49 +0100 (Fri, 14 Mar 2008)
New Revision: 835

Added:
   trunk/lib/Parley/ResultSet/IpBan.pm
   trunk/lib/Parley/Schema/IpBan.pm
   trunk/lib/Parley/Schema/IpBanType.pm
   trunk/root/base/user/login_ip_banned
   trunk/t/schema/ip_ban.t
   trunk/t/schema/ip_ban_type.t
Modified:
   /
   trunk/Changes.i18n
   trunk/Makefile.PL
   trunk/db/patch_0.58_to_0.59.psql
   trunk/lib/Parley/Controller/User.pm
   trunk/lib/Parley/I18N/i_default.po
   trunk/lib/Parley/Schema.pm
Log:
 r4751 at wiggin:  chisel | 2008-03-13 19:27:49 +0000
 / more i_default i18n
 + added tables for IP based bans
 + add code to user/login to deal with login-banned-ips
 + add template so send banned ips to
 + new classes and tests for ip_ban and ip_ban_type tables
 + ip_ban ResultSet to provide is_login_banned()
 + added new dep to Makefile.PL: Net::IP::Match::Regexp



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4743
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4751
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/Changes.i18n	2008-03-13 23:33:49 UTC (rev 835)
@@ -26,6 +26,8 @@
             - "You don't have the required privileges to do that"
             - "Suspended"
             - "No reason given"
+            - "Logins are not permitted from %1"
+            - "Login Not Allowed"
 
     it.po:
         - added:

Modified: trunk/Makefile.PL
===================================================================
--- trunk/Makefile.PL	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/Makefile.PL	2008-03-13 23:33:49 UTC (rev 835)
@@ -36,6 +36,7 @@
 requires 'JSON';
 requires 'List::MoreUtils';
 requires 'MIME::Lite';
+requires 'Net::IP::Match::Regexp';
 requires 'Perl6::Export::Attrs';
 requires 'Proc::Daemon';
 requires 'Proc::PID::File';

Modified: trunk/db/patch_0.58_to_0.59.psql
===================================================================
--- trunk/db/patch_0.58_to_0.59.psql	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/db/patch_0.58_to_0.59.psql	2008-03-13 23:33:49 UTC (rev 835)
@@ -7,6 +7,7 @@
 --  lock posts (so they can't be changed after being edited by admin)
 --  allow user accounts to be suspended
 --  logging of admin actions on users (e.g. why suspended)
+--  table support for various per-ip bans
 
 BEGIN;
 
@@ -105,7 +106,28 @@
 CREATE INDEX idx_adminaction_personid ON log_admin_action(person_id);
 CREATE INDEX idx_adminaction_adminid  ON log_admin_action(admin_id);
 
+CREATE TABLE ip_ban_type (
+    id          serial      primary key,
+    name        text        not null,
+    description text,
 
+    UNIQUE(name)
+);
+INSERT INTO ip_ban_type (name,description) VALUES ('access','Restrict all access by IP');
+INSERT INTO ip_ban_type (name,description) VALUES ('login','Restrict login by IP');
+INSERT INTO ip_ban_type (name,description) VALUES ('posting','Restrict posting by IP');
+INSERT INTO ip_ban_type (name,description) VALUES ('signup','Restrict sign-up by IP');
+
+CREATE TABLE ip_ban (
+    id          serial      primary key,
+    ban_type_id integer     not null
+                            references ip_ban_type(id),
+    ip_range    text,
+
+    UNIQUE(ban_type_id)
+);
+
+
 -- patch ends here --
 
 COMMIT;

Modified: trunk/lib/Parley/Controller/User.pm
===================================================================
--- trunk/lib/Parley/Controller/User.pm	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/lib/Parley/Controller/User.pm	2008-03-13 23:33:49 UTC (rev 835)
@@ -1,5 +1,5 @@
 package Parley::Controller::User;
-
+# vim: ts=8 sts=4 et sw=4 sr sta
 use strict;
 use warnings;
 
@@ -19,6 +19,16 @@
     # make sure we use the correct template - we sometimes detach() here
     $c->stash->{template} = 'user/login';
 
+
+    # deal with logins banned by IP
+    my $ip = $c->request->address;
+    my $login_banned =
+        $c->model('ParleyDB::IpBan')->is_login_banned($ip);
+    if ($login_banned) {
+        $c->stash->{template} = 'user/login_ip_banned';
+        return;
+    }
+
     # if we have a username, try to log the user in
     if ( $c->request->param('username') ) {
         # try to log the user in

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/lib/Parley/I18N/i_default.po	2008-03-13 23:33:49 UTC (rev 835)
@@ -312,6 +312,12 @@
 msgid "Login"
 msgstr "Login"
 
+msgid "Login Not Allowed"
+msgstr "Login Not Allowed"
+
+msgid "Logins are not permitted from %1"
+msgstr "Logins are not permitted from %1"
+
 msgid "Logout"
 msgstr "Logout"
 

Added: trunk/lib/Parley/ResultSet/IpBan.pm
===================================================================
--- trunk/lib/Parley/ResultSet/IpBan.pm	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/lib/Parley/ResultSet/IpBan.pm	2008-03-13 23:33:49 UTC (rev 835)
@@ -0,0 +1,51 @@
+package Parley::ResultSet::IpBan;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
+use base 'DBIx::Class::ResultSet';
+
+use Net::IP::Match::Regexp qw( create_iprange_regexp match_ip );
+
+sub is_login_banned {
+    my $resultsource = shift;
+    my $ip_address   = shift;
+    my ($rs);
+
+    # get the record for login ip bans
+    $rs = $resultsource->search(
+        {
+            'ban_type.name' => q{login},
+        },
+        {
+            'join' => [qw/ban_type/],
+        },
+    );
+
+    # no record? no bans
+    return 0 # not banned
+        if (0 == $rs->count);
+
+    # we're only expecting one row, but this way we won't be bitten on the ass
+    # if we change our mind in the future
+    while (my $record = $rs->next) {
+        # build the regexp to check against
+        my $regexp = create_iprange_regexp(
+            split(m{\s+}, $record->ip_range) # we pass an array of
+                                             # "stuff" to the function
+        );
+
+        # see if it's banned
+        if (match_ip($ip_address, $regexp)) {
+            # ip in one of the banned ranges
+            return 1;
+        }
+    }
+
+    # if we don't know any better give the benefit of the doubt
+    return 0; # not banned
+}
+
+1;

Added: trunk/lib/Parley/Schema/IpBan.pm
===================================================================
--- trunk/lib/Parley/Schema/IpBan.pm	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/lib/Parley/Schema/IpBan.pm	2008-03-13 23:33:49 UTC (rev 835)
@@ -0,0 +1,37 @@
+package Parley::Schema::IpBan;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
+use base qw/DBIx::Class/;
+
+# Load required DBIC stuff
+__PACKAGE__->load_components(qw/PK::Auto Core/);
+# Set the table name
+__PACKAGE__->table('ip_ban');
+# Set columns in table
+__PACKAGE__->add_columns(qw/
+    id
+    ban_type_id
+    ip_range
+/);
+# Set the primary key for the table
+__PACKAGE__->set_primary_key(qw/id/);
+__PACKAGE__->resultset_class('Parley::ResultSet::IpBan');
+
+
+__PACKAGE__->belongs_to(
+    ban_type => 'Parley::Schema::IpBanType',
+    'ban_type_id'
+);
+
+__PACKAGE__->add_unique_constraint(
+    'unique_ip_ban_type',
+    ['ban_type_id']
+);
+
+
+
+1;

Added: trunk/lib/Parley/Schema/IpBanType.pm
===================================================================
--- trunk/lib/Parley/Schema/IpBanType.pm	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/lib/Parley/Schema/IpBanType.pm	2008-03-13 23:33:49 UTC (rev 835)
@@ -0,0 +1,30 @@
+package Parley::Schema::IpBanType;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
+use base qw/DBIx::Class/;
+
+# Load required DBIC stuff
+__PACKAGE__->load_components(qw/PK::Auto Core/);
+# Set the table name
+__PACKAGE__->table('ip_ban_type');
+# Set columns in table
+__PACKAGE__->add_columns(qw/id name description/);
+# Set the primary key for the table
+__PACKAGE__->set_primary_key(qw/id/);
+
+#
+# Set relationships:
+#
+
+__PACKAGE__->add_unique_constraint(
+    'unique_ban_name',
+    ['name']
+);
+
+
+
+1;

Modified: trunk/lib/Parley/Schema.pm
===================================================================
--- trunk/lib/Parley/Schema.pm	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/lib/Parley/Schema.pm	2008-03-13 23:33:49 UTC (rev 835)
@@ -14,6 +14,8 @@
         'EmailQueue',
         'ForumModerator',
         'Forum',
+        'IpBan',
+        'IpBanType',
         'LogAdminAction',
         'PasswordReset',
         'Person',

Added: trunk/root/base/user/login_ip_banned
===================================================================
--- trunk/root/base/user/login_ip_banned	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/root/base/user/login_ip_banned	2008-03-13 23:33:49 UTC (rev 835)
@@ -0,0 +1,3 @@
+<h1>[%l('Login Not Allowed')%]</h1>
+
+[%l('Logins are not permitted from [_1]', c.request.address)%]

Added: trunk/t/schema/ip_ban.t
===================================================================
--- trunk/t/schema/ip_ban.t	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/t/schema/ip_ban.t	2008-03-13 23:33:49 UTC (rev 835)
@@ -0,0 +1,46 @@
+#!/usr/bin/perl
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+# load the module that provides all of the common test functionality
+use FindBin qw($Bin);
+use lib $Bin;
+use SchemaTest;
+
+my $schematest = SchemaTest->new(
+    {
+        dsn       => 'dbi:Pg:dbname=parley',
+        namespace => 'Parley::Schema',
+        moniker   => 'IpBan',
+    }
+);
+$schematest->methods(
+    {
+        columns => [
+            qw[
+                id
+                ban_type_id
+                ip_range
+            ]
+        ],
+
+        relations => [
+            qw[
+                ban_type
+            ]
+        ],
+
+        custom => [
+            qw[
+            ]
+        ],
+
+        resultsets => [
+            qw[
+            ]
+        ],
+    }
+);
+
+$schematest->run_tests();


Property changes on: trunk/t/schema/ip_ban.t
___________________________________________________________________
Name: svn:executable
   + *

Added: trunk/t/schema/ip_ban_type.t
===================================================================
--- trunk/t/schema/ip_ban_type.t	2008-03-13 12:34:27 UTC (rev 834)
+++ trunk/t/schema/ip_ban_type.t	2008-03-13 23:33:49 UTC (rev 835)
@@ -0,0 +1,45 @@
+#!/usr/bin/perl
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+# load the module that provides all of the common test functionality
+use FindBin qw($Bin);
+use lib $Bin;
+use SchemaTest;
+
+my $schematest = SchemaTest->new(
+    {
+        dsn       => 'dbi:Pg:dbname=parley',
+        namespace => 'Parley::Schema',
+        moniker   => 'IpBanType',
+    }
+);
+$schematest->methods(
+    {
+        columns => [
+            qw[
+                id
+                name
+                description
+            ]
+        ],
+
+        relations => [
+            qw[
+            ]
+        ],
+
+        custom => [
+            qw[
+            ]
+        ],
+
+        resultsets => [
+            qw[
+            ]
+        ],
+    }
+);
+
+$schematest->run_tests();


Property changes on: trunk/t/schema/ip_ban_type.t
___________________________________________________________________
Name: svn:executable
   + *



From chiselwright at mail.berlios.de  Fri Mar 14 00:34:09 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 14 Mar 2008 00:34:09 +0100
Subject: [Parley-svn] r836 - / trunk
Message-ID: <200803132334.m2DNY9Es020096@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-14 00:34:02 +0100 (Fri, 14 Mar 2008)
New Revision: 836

Modified:
   /
   trunk/ROADMAP
Log:
 r4752 at wiggin:  chisel | 2008-03-13 19:30:02 +0000
 / update ROADMAP



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4751
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4752
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/ROADMAP
===================================================================
--- trunk/ROADMAP	2008-03-13 23:33:49 UTC (rev 835)
+++ trunk/ROADMAP	2008-03-13 23:34:02 UTC (rev 836)
@@ -19,6 +19,10 @@
         - [D] edit posts (and flag accordingly)
         - abuse handling
           - [D] suspend account(s)
+          - [D] prevent login from IP
+          - prevent signup from IP
+          - prevent posting/editing from IP
+        - UI for IP bans
           - prevent login from IP
           - prevent signup from IP
           - prevent posting/editing from IP



From chiselwright at mail.berlios.de  Fri Mar 14 00:34:25 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 14 Mar 2008 00:34:25 +0100
Subject: [Parley-svn] r837 - / trunk/lib/Parley/ResultSet trunk/t/schema
Message-ID: <200803132334.m2DNYPiE020700@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-14 00:34:24 +0100 (Fri, 14 Mar 2008)
New Revision: 837

Modified:
   /
   trunk/lib/Parley/ResultSet/IpBan.pm
   trunk/t/schema/ip_ban.t
Log:
 r4753 at wiggin:  chisel | 2008-03-13 19:35:28 +0000
 / generalised is_login_banned() to is_X_banned()
 + added is_login_banned() as call to is_X_banned()



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4752
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4753
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/ResultSet/IpBan.pm
===================================================================
--- trunk/lib/Parley/ResultSet/IpBan.pm	2008-03-13 23:34:02 UTC (rev 836)
+++ trunk/lib/Parley/ResultSet/IpBan.pm	2008-03-13 23:34:24 UTC (rev 837)
@@ -9,15 +9,16 @@
 
 use Net::IP::Match::Regexp qw( create_iprange_regexp match_ip );
 
-sub is_login_banned {
+sub is_X_banned {
     my $resultsource = shift;
+    my $ban_type     = shift;
     my $ip_address   = shift;
     my ($rs);
 
-    # get the record for login ip bans
+    # get the record for $ban_type ip bans
     $rs = $resultsource->search(
         {
-            'ban_type.name' => q{login},
+            'ban_type.name' => $ban_type
         },
         {
             'join' => [qw/ban_type/],
@@ -48,4 +49,11 @@
     return 0; # not banned
 }
 
+sub is_login_banned {
+    my $resultsource = shift;
+    my $ip_address   = shift;
+
+    return $resultsource->is_X_banned('login', $ip_address);
+}
+
 1;

Modified: trunk/t/schema/ip_ban.t
===================================================================
--- trunk/t/schema/ip_ban.t	2008-03-13 23:34:02 UTC (rev 836)
+++ trunk/t/schema/ip_ban.t	2008-03-13 23:34:24 UTC (rev 837)
@@ -38,6 +38,8 @@
 
         resultsets => [
             qw[
+                is_X_banned
+                is_login_banned
             ]
         ],
     }



From chiselwright at mail.berlios.de  Fri Mar 14 00:34:40 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 14 Mar 2008 00:34:40 +0100
Subject: [Parley-svn] r838 - / trunk trunk/lib/Parley/Controller/User
	trunk/lib/Parley/I18N trunk/lib/Parley/ResultSet
	trunk/root/base/user trunk/t/schema
Message-ID: <200803132334.m2DNYeCi021224@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-14 00:34:39 +0100 (Fri, 14 Mar 2008)
New Revision: 838

Added:
   trunk/root/base/user/signup_ip_banned
Modified:
   /
   trunk/Changes.i18n
   trunk/lib/Parley/Controller/User/SignUp.pm
   trunk/lib/Parley/I18N/i_default.po
   trunk/lib/Parley/ResultSet/IpBan.pm
   trunk/t/schema/ip_ban.t
Log:
 r4754 at wiggin:  chisel | 2008-03-13 23:33:40 +0000
 + added IP Signup Ban



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4753
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4754
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-03-13 23:34:24 UTC (rev 837)
+++ trunk/Changes.i18n	2008-03-13 23:34:39 UTC (rev 838)
@@ -28,6 +28,8 @@
             - "No reason given"
             - "Logins are not permitted from %1"
             - "Login Not Allowed"
+            - "Registrations are not permitted from %1"
+            - "Registration Not Allowed"
 
     it.po:
         - added:

Modified: trunk/lib/Parley/Controller/User/SignUp.pm
===================================================================
--- trunk/lib/Parley/Controller/User/SignUp.pm	2008-03-13 23:34:24 UTC (rev 837)
+++ trunk/lib/Parley/Controller/User/SignUp.pm	2008-03-13 23:34:39 UTC (rev 838)
@@ -69,6 +69,21 @@
 # Controller Actions
 # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
+sub begin :Private {
+    my ($self, $c) = @_;
+
+    # deal with logins banned by IP
+    my $ip = $c->request->address;
+    my $login_banned =
+        $c->model('ParleyDB::IpBan')->is_signup_banned($ip);
+    if ($login_banned) {
+        $c->stash->{template} = 'user/signup_ip_banned';
+        return;
+    }
+
+    return 1;
+}
+
 sub authenticate : Path('/user/authenticate') {
     my ($self, $c, $auth_id) = @_;
 

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-03-13 23:34:24 UTC (rev 837)
+++ trunk/lib/Parley/I18N/i_default.po	2008-03-13 23:34:39 UTC (rev 838)
@@ -543,6 +543,12 @@
 msgid "Registration Complete"
 msgstr "Registration Complete"
 
+msgid "Registrations are not permitted from %1"
+msgstr "Registrations are not permitted from %1"
+
+msgid "Registration Not Allowed"
+msgstr "Registration Not Allowed"
+
 msgid "Remove Watch"
 msgstr "Remove Watch"
 

Modified: trunk/lib/Parley/ResultSet/IpBan.pm
===================================================================
--- trunk/lib/Parley/ResultSet/IpBan.pm	2008-03-13 23:34:24 UTC (rev 837)
+++ trunk/lib/Parley/ResultSet/IpBan.pm	2008-03-13 23:34:39 UTC (rev 838)
@@ -56,4 +56,11 @@
     return $resultsource->is_X_banned('login', $ip_address);
 }
 
+sub is_signup_banned {
+    my $resultsource = shift;
+    my $ip_address   = shift;
+
+    return $resultsource->is_X_banned('signup', $ip_address);
+}
+
 1;

Added: trunk/root/base/user/signup_ip_banned
===================================================================
--- trunk/root/base/user/signup_ip_banned	2008-03-13 23:34:24 UTC (rev 837)
+++ trunk/root/base/user/signup_ip_banned	2008-03-13 23:34:39 UTC (rev 838)
@@ -0,0 +1,3 @@
+<h1>[%l('Registration Not Allowed')%]</h1>
+
+[%l('Registrations are not permitted from [_1]', c.request.address)%]

Modified: trunk/t/schema/ip_ban.t
===================================================================
--- trunk/t/schema/ip_ban.t	2008-03-13 23:34:24 UTC (rev 837)
+++ trunk/t/schema/ip_ban.t	2008-03-13 23:34:39 UTC (rev 838)
@@ -40,6 +40,7 @@
             qw[
                 is_X_banned
                 is_login_banned
+                is_signup_banned
             ]
         ],
     }



From chiselwright at mail.berlios.de  Fri Mar 14 09:23:35 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 14 Mar 2008 09:23:35 +0100
Subject: [Parley-svn] r839 - / trunk trunk/lib/Parley/Controller
	trunk/lib/Parley/Controller/User trunk/lib/Parley/I18N
	trunk/lib/Parley/ResultSet trunk/t/schema
Message-ID: <200803140823.m2E8NZtY023247@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-14 09:23:34 +0100 (Fri, 14 Mar 2008)
New Revision: 839

Modified:
   /
   trunk/Changes.i18n
   trunk/ROADMAP
   trunk/lib/Parley/Controller/Post.pm
   trunk/lib/Parley/Controller/Thread.pm
   trunk/lib/Parley/Controller/User/SignUp.pm
   trunk/lib/Parley/I18N/i_default.po
   trunk/lib/Parley/ResultSet/IpBan.pm
   trunk/t/schema/ip_ban.t
Log:
 r4759 at wiggin:  chisel | 2008-03-14 07:33:27 +0000
 + added Posting/Editing Ban By IP



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4754
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4759
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-03-13 23:34:39 UTC (rev 838)
+++ trunk/Changes.i18n	2008-03-14 08:23:34 UTC (rev 839)
@@ -30,6 +30,8 @@
             - "Login Not Allowed"
             - "Registrations are not permitted from %1"
             - "Registration Not Allowed"
+            - "Posting is not permitted from %1"
+            - "Posting Not Allowed"
 
     it.po:
         - added:

Modified: trunk/ROADMAP
===================================================================
--- trunk/ROADMAP	2008-03-13 23:34:39 UTC (rev 838)
+++ trunk/ROADMAP	2008-03-14 08:23:34 UTC (rev 839)
@@ -20,12 +20,14 @@
         - abuse handling
           - [D] suspend account(s)
           - [D] prevent login from IP
-          - prevent signup from IP
-          - prevent posting/editing from IP
+          - [D] prevent signup from IP
+          - [D] prevent posting/editing from IP
+          - prevent total access from IP
         - UI for IP bans
           - prevent login from IP
           - prevent signup from IP
           - prevent posting/editing from IP
+          - prevent total access from IP
         - IP reporting
 
 0.60:

Modified: trunk/lib/Parley/Controller/Post.pm
===================================================================
--- trunk/lib/Parley/Controller/Post.pm	2008-03-13 23:34:39 UTC (rev 838)
+++ trunk/lib/Parley/Controller/Post.pm	2008-03-14 08:23:34 UTC (rev 839)
@@ -44,6 +44,15 @@
     # what people will make-up or bookmark)
     $c->login_if_required($c->localize(q{EDIT LOGIN REQUIRED}));
 
+    # deal with posting banned by IP
+    my $ip = $c->request->address;
+    my $posting_banned =
+        $c->model('ParleyDB::IpBan')->is_posting_banned($ip);
+    if ($posting_banned) {
+        $c->stash->{template} = 'user/posting_ip_banned';
+        return;
+    }
+
     # you can only edit you own posts
     # (unless you're a moderator)
     if (

Modified: trunk/lib/Parley/Controller/Thread.pm
===================================================================
--- trunk/lib/Parley/Controller/Thread.pm	2008-03-13 23:34:39 UTC (rev 838)
+++ trunk/lib/Parley/Controller/Thread.pm	2008-03-14 08:23:34 UTC (rev 839)
@@ -47,6 +47,15 @@
     # make sure we're authenticated
     # XXX
 
+    # deal with posting banned by IP
+    my $ip = $c->request->address;
+    my $posting_banned =
+        $c->model('ParleyDB::IpBan')->is_posting_banned($ip);
+    if ($posting_banned) {
+        $c->stash->{template} = 'user/posting_ip_banned';
+        return;
+    }
+
     # if we have a form POST ...
     if (defined $c->request->method() and $c->request->method() eq 'POST') {
         $self->_add_new_thread($c);
@@ -101,6 +110,15 @@
     # make sure we're authenticated
     # XXX
 
+    # deal with posting banned by IP
+    my $ip = $c->request->address;
+    my $posting_banned =
+        $c->model('ParleyDB::IpBan')->is_posting_banned($ip);
+    if ($posting_banned) {
+        $c->stash->{template} = 'user/posting_ip_banned';
+        return;
+    }
+
     # can't reply to a locked thread
     if ($c->_current_thread()->locked()) {
         #die q{can't reply to a locked thread!};

Modified: trunk/lib/Parley/Controller/User/SignUp.pm
===================================================================
--- trunk/lib/Parley/Controller/User/SignUp.pm	2008-03-13 23:34:39 UTC (rev 838)
+++ trunk/lib/Parley/Controller/User/SignUp.pm	2008-03-14 08:23:34 UTC (rev 839)
@@ -74,9 +74,9 @@
 
     # deal with logins banned by IP
     my $ip = $c->request->address;
-    my $login_banned =
+    my $signup_banned =
         $c->model('ParleyDB::IpBan')->is_signup_banned($ip);
-    if ($login_banned) {
+    if ($signup_banned) {
         $c->stash->{template} = 'user/signup_ip_banned';
         return;
     }

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-03-13 23:34:39 UTC (rev 838)
+++ trunk/lib/Parley/I18N/i_default.po	2008-03-14 08:23:34 UTC (rev 839)
@@ -489,6 +489,12 @@
 msgid "posted by"
 msgstr "posted by"
 
+msgid "Posting is not permitted from %1"
+msgstr "Posting is not permitted from %1"
+
+msgid "Posting Not Allowed"
+msgstr "Posting Not Allowed"
+
 msgid "Post Edited By: %1"
 msgstr "Post Edited By: %1"
 

Modified: trunk/lib/Parley/ResultSet/IpBan.pm
===================================================================
--- trunk/lib/Parley/ResultSet/IpBan.pm	2008-03-13 23:34:39 UTC (rev 838)
+++ trunk/lib/Parley/ResultSet/IpBan.pm	2008-03-14 08:23:34 UTC (rev 839)
@@ -49,6 +49,13 @@
     return 0; # not banned
 }
 
+sub is_access_banned {
+    my $resultsource = shift;
+    my $ip_address   = shift;
+
+    return $resultsource->is_X_banned('access', $ip_address);
+}
+
 sub is_login_banned {
     my $resultsource = shift;
     my $ip_address   = shift;
@@ -56,6 +63,13 @@
     return $resultsource->is_X_banned('login', $ip_address);
 }
 
+sub is_posting_banned {
+    my $resultsource = shift;
+    my $ip_address   = shift;
+
+    return $resultsource->is_X_banned('posting', $ip_address);
+}
+
 sub is_signup_banned {
     my $resultsource = shift;
     my $ip_address   = shift;

Modified: trunk/t/schema/ip_ban.t
===================================================================
--- trunk/t/schema/ip_ban.t	2008-03-13 23:34:39 UTC (rev 838)
+++ trunk/t/schema/ip_ban.t	2008-03-14 08:23:34 UTC (rev 839)
@@ -39,7 +39,9 @@
         resultsets => [
             qw[
                 is_X_banned
+                is_access_banned
                 is_login_banned
+                is_posting_banned
                 is_signup_banned
             ]
         ],



From chiselwright at mail.berlios.de  Fri Mar 14 09:23:58 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 14 Mar 2008 09:23:58 +0100
Subject: [Parley-svn] r840 - / trunk trunk/lib/Parley/Controller
	trunk/lib/Parley/I18N
Message-ID: <200803140823.m2E8Nwpf023329@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-14 09:23:58 +0100 (Fri, 14 Mar 2008)
New Revision: 840

Modified:
   /
   trunk/Changes
   trunk/Changes.i18n
   trunk/ROADMAP
   trunk/lib/Parley/Controller/Root.pm
   trunk/lib/Parley/I18N/i_default.po
Log:
 r4760 at wiggin:  chisel | 2008-03-14 07:43:53 +0000
 + Prevent All Access By IP



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4759
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4760
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes
===================================================================
--- trunk/Changes	2008-03-14 08:23:34 UTC (rev 839)
+++ trunk/Changes	2008-03-14 08:23:58 UTC (rev 840)
@@ -3,6 +3,7 @@
 0.59 (UNDER DEVELOPMENT)
     - user roles can now be assigned and removed
     - users can have their "suspended" flag set and removed
+    - application can now prevent login/signup/posting/access by IP
 
 0.58    Fri Feb  8 07:47:31 GMT 2008
     - re-work the UI design to be cleaner

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-03-14 08:23:34 UTC (rev 839)
+++ trunk/Changes.i18n	2008-03-14 08:23:58 UTC (rev 840)
@@ -32,6 +32,8 @@
             - "Registration Not Allowed"
             - "Posting is not permitted from %1"
             - "Posting Not Allowed"
+            - "Access Denied"
+            - "Access to this application is not permitted from %1"
 
     it.po:
         - added:

Modified: trunk/ROADMAP
===================================================================
--- trunk/ROADMAP	2008-03-14 08:23:34 UTC (rev 839)
+++ trunk/ROADMAP	2008-03-14 08:23:58 UTC (rev 840)
@@ -22,7 +22,7 @@
           - [D] prevent login from IP
           - [D] prevent signup from IP
           - [D] prevent posting/editing from IP
-          - prevent total access from IP
+          - [D] prevent total access from IP
         - UI for IP bans
           - prevent login from IP
           - prevent signup from IP

Modified: trunk/lib/Parley/Controller/Root.pm
===================================================================
--- trunk/lib/Parley/Controller/Root.pm	2008-03-14 08:23:34 UTC (rev 839)
+++ trunk/lib/Parley/Controller/Root.pm	2008-03-14 08:23:58 UTC (rev 840)
@@ -18,6 +18,22 @@
 #
 __PACKAGE__->config->{namespace} = '';
 
+sub begin :Private {
+    my ($self, $c) = @_;
+
+    # deal with access banned by IP
+    my $ip = $c->request->address;
+    my $access_banned =
+        $c->model('ParleyDB::IpBan')->is_access_banned($ip);
+    if ($access_banned) {
+        $c->stash->{template} = 'user/access_ip_banned';
+        return;
+    }
+
+    return 1;
+}
+
+
 # pre-populate values in the stash if we're given "appropriate" information:
 # - _authed_user
 # - _current_post

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-03-14 08:23:34 UTC (rev 839)
+++ trunk/lib/Parley/I18N/i_default.po	2008-03-14 08:23:58 UTC (rev 840)
@@ -25,6 +25,12 @@
 msgid "ACCEPT TERMS"
 msgstr "You need to accept the Terms and Conditions below to continue using the site"
 
+msgid "Access Denied"
+msgstr "Access Denied"
+
+msgid "Access to this application is not permitted from %1"
+msgstr "Access to this application is not permitted from %1"
+
 msgid "Activate Your %s Registration"
 msgstr "Activate Your %s Registration"
 



From chiselwright at mail.berlios.de  Mon Mar 17 00:00:16 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Mon, 17 Mar 2008 00:00:16 +0100
Subject: [Parley-svn] r841 - / trunk
Message-ID: <200803162300.m2GN0GK5018475@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-17 00:00:10 +0100 (Mon, 17 Mar 2008)
New Revision: 841

Modified:
   /
   trunk/MANIFEST
Log:
 r4763 at wiggin:  chisel | 2008-03-16 20:53:06 +0000
 Updated MANIFEST file



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4760
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4763
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/MANIFEST
===================================================================
--- trunk/MANIFEST	2008-03-14 08:23:58 UTC (rev 840)
+++ trunk/MANIFEST	2008-03-16 23:00:10 UTC (rev 841)
@@ -61,6 +61,8 @@
 lib/Parley/I18N/it.po
 lib/Parley/Model/ParleyDB.pm
 lib/Parley/ResultSet/Forum.pm
+lib/Parley/ResultSet/IpBan.pm
+lib/Parley/ResultSet/IpBanType.pm
 lib/Parley/ResultSet/Person.pm
 lib/Parley/ResultSet/Post.pm
 lib/Parley/ResultSet/Role.pm
@@ -68,10 +70,14 @@
 lib/Parley/ResultSet/Thread.pm
 lib/Parley/ResultSet/ThreadView.pm
 lib/Parley/Schema.pm
+lib/Parley/Schema/AdminAction.pm
 lib/Parley/Schema/Authentication.pm
 lib/Parley/Schema/EmailQueue.pm
 lib/Parley/Schema/Forum.pm
 lib/Parley/Schema/ForumModerator.pm
+lib/Parley/Schema/IpBan.pm
+lib/Parley/Schema/IpBanType.pm
+lib/Parley/Schema/LogAdminAction.pm
 lib/Parley/Schema/PasswordReset.pm
 lib/Parley/Schema/Person.pm
 lib/Parley/Schema/Post.pm
@@ -96,6 +102,7 @@
 parley.yml
 README
 README.admin
+README.gravatar
 ROADMAP
 root/base/about/modules
 root/base/error/simple
@@ -119,6 +126,7 @@
 root/base/my/tab_you
 root/base/post/edit
 root/base/search/forum
+root/base/shared/ajax_dialog
 root/base/shared/autocomplete_style
 root/base/shared/focus_username_js
 root/base/shared/language_dialog
@@ -135,6 +143,7 @@
 root/base/shared/useful_tt_stuff
 root/base/shared/user_avatar
 root/base/shared/user_status
+root/base/site/ip_bans
 root/base/site/services
 root/base/site/user
 root/base/site/users
@@ -146,15 +155,20 @@
 root/base/thread/reply
 root/base/thread/view
 root/base/thread/watches
+root/base/user/access_ip_banned
 root/base/user/auth_emailed
 root/base/user/auth_success
 root/base/user/login
+root/base/user/login_ip_banned
 root/base/user/lostpassword/lost_password
 root/base/user/lostpassword/lost_password_details_sent
 root/base/user/lostpassword/reset
 root/base/user/lostpassword/reset_success
+root/base/user/posting_ip_banned
 root/base/user/profile
 root/base/user/signup/signup
+root/base/user/signup_ip_banned
+root/base/user/suspended
 root/email_templates/i_default/authentication_email.eml
 root/email_templates/i_default/password_reset.eml
 root/email_templates/i_default/thread_update_notify.eml
@@ -174,7 +188,9 @@
 root/static/css/layout23.css
 root/static/css/layout27.css
 root/static/css/layout33.css
+root/static/css/parley-min.css
 root/static/css/parley.css
+root/static/Editable-min.js
 root/static/Editable.js
 root/static/images/btn_120x50_built.png
 root/static/images/btn_120x50_built_shadow.png
@@ -188,6 +204,7 @@
 root/static/images/filetypes/image.png
 root/static/images/filetypes/pdf.png
 root/static/images/icons/anchor.png
+root/static/images/icons/attach.png
 root/static/images/icons/flags/ad.png
 root/static/images/icons/flags/ae.png
 root/static/images/icons/flags/af.png
@@ -437,14 +454,18 @@
 root/static/images/icons/flags/zm.png
 root/static/images/icons/flags/zw.png
 root/static/images/icons/lock.png
+root/static/images/loader-bar.gif
 root/static/images/loader.gif
 root/static/images/locked.png
 root/static/images/parley_logo.jpg
 root/static/images/rel_interstitial_loading.gif
 root/static/images/sticky.png
 root/static/images/unread_posts.gif
+root/static/MessagePreview-min.js
 root/static/MessagePreview.js
+root/static/script/ajax_error_dlg.js
 root/static/script/prototype.js
+root/static/script/user_suspend.js
 root/static/yui/animation/animation-debug.js
 root/static/yui/animation/animation-min.js
 root/static/yui/animation/animation.js
@@ -763,10 +784,14 @@
 t/mechanize/02.forum.t
 t/model_ParleyDB.t
 t/model_Post.t
+t/schema/adminaction.t
 t/schema/authentication.t
 t/schema/email_queue.t
 t/schema/forum.t
 t/schema/forum_moderator.t
+t/schema/ip_ban.t
+t/schema/ip_ban_type.t
+t/schema/logadminaction.t
 t/schema/password_reset.t
 t/schema/person.t
 t/schema/post.t



From chiselwright at mail.berlios.de  Mon Mar 17 00:00:28 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Mon, 17 Mar 2008 00:00:28 +0100
Subject: [Parley-svn] r842 - / trunk trunk/lib/Parley
	trunk/lib/Parley/Controller trunk/lib/Parley/I18N
	trunk/lib/Parley/ResultSet trunk/lib/Parley/Schema
	trunk/root/base/menu trunk/root/base/site trunk/root/base/user
Message-ID: <200803162300.m2GN0Sml018621@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-17 00:00:26 +0100 (Mon, 17 Mar 2008)
New Revision: 842

Added:
   trunk/README.gravatar
   trunk/lib/Parley/ResultSet/IpBanType.pm
   trunk/root/base/site/ip_bans
   trunk/root/base/user/access_ip_banned
   trunk/root/base/user/posting_ip_banned
Modified:
   /
   trunk/Changes.i18n
   trunk/ROADMAP
   trunk/lib/Parley/Contributors.pm
   trunk/lib/Parley/Controller/Site.pm
   trunk/lib/Parley/I18N/i_default.po
   trunk/lib/Parley/Schema/IpBanType.pm
   trunk/root/base/menu/menubar
Log:
 r4764 at wiggin:  chisel | 2008-03-16 22:59:58 +0000
 + more i_default i18n phrases
 + added to ROADMAP
 + added famfamfam flags to contributors file
 + functionality to update/edit ip bans in application UI
 + checked in missing ip-ban template files



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4763
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4764
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/Changes.i18n	2008-03-16 23:00:26 UTC (rev 842)
@@ -34,6 +34,7 @@
             - "Posting Not Allowed"
             - "Access Denied"
             - "Access to this application is not permitted from %1"
+            - "IP Bans"
 
     it.po:
         - added:

Added: trunk/README.gravatar
===================================================================
--- trunk/README.gravatar	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/README.gravatar	2008-03-16 23:00:26 UTC (rev 842)
@@ -0,0 +1,29 @@
+From: http://site.gravatar.com/site/implement
+
+PERL
+
+Gravatar implementations with PERL are pretty straightforward, however you do
+need to include several external libraries. These are probably already
+installed on your machine, but if they're not, you'll have to download and
+install them.
+
+Let's start by including those library functions that we'll utilize:
+
+use URI::Escape qw(uri_escape);
+use Digest::MD5 qw(md5_hex);
+
+Next, assume the following variables are available to you:
+
+my $email = "someone at somewhere.com";
+my $default = "http://www.somewhere.com/homsar.jpg";
+my $size = 40;
+
+You can construct your gravatar url with the following PERL code:
+
+my $grav_url = "http://www.gravatar.com/avatar.php?
+gravatar_id=".md5_hex($email).
+"&default=".uri_escape($default).
+"&size=".$size;
+
+This only constructs the URL, so don't forget to place it in an img tag before
+printing it.

Modified: trunk/ROADMAP
===================================================================
--- trunk/ROADMAP	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/ROADMAP	2008-03-16 23:00:26 UTC (rev 842)
@@ -50,3 +50,4 @@
         - password management
         - resend auth mail(s)
         - realtime time-format example update
+        - gravatar support

Modified: trunk/lib/Parley/Contributors.pm
===================================================================
--- trunk/lib/Parley/Contributors.pm	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/lib/Parley/Contributors.pm	2008-03-16 23:00:26 UTC (rev 842)
@@ -23,6 +23,8 @@
 
 L<FamFamFam Silk Icons|http://www.famfamfam.com/lab/icons/silk/>
 
+L<FamFamFam Flag Icons|http://www.famfamfam.com/lab/icons/flags/>
+
 =head1 I18N
 
 =head2 Italian

Modified: trunk/lib/Parley/Controller/Site.pm
===================================================================
--- trunk/lib/Parley/Controller/Site.pm	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/lib/Parley/Controller/Site.pm	2008-03-16 23:00:26 UTC (rev 842)
@@ -35,6 +35,15 @@
     $c->response->body('Matched Parley::Controller::Site in Site.');
 }
 
+sub ip_bans :Local {
+    my ($self, $c) = @_;
+
+    # a list of ban types
+    $c->stash->{ip_ban_types} =
+        $c->model('ParleyDB::IpBanType')
+            ->ban_type_list;
+}
+
 sub services : Local {
     my ($self, $c) = @_;
 
@@ -218,6 +227,91 @@
     return;
 }
 
+sub saveBanHandler :Local {
+    my ($self, $c) = @_;
+    my ($fieldname, $return_data, $json);
+
+    $return_data->{updated}     = 0;
+    $return_data->{old_value}   = $c->request->param('ovalue');
+
+    $fieldname = $c->request->param('fieldname');
+
+    # update an existing ban?
+    if ($fieldname =~ m{\Aipban_(\d+)\z}xms) {
+        eval {
+            my $id = $1;
+
+            $c->model('ParleyDB')->schema->txn_do(
+                sub {
+                    $c->model('ParleyDB::IpBan')->find($id)
+                        ->update(
+                            {
+                                ip_range    => $c->request->param('value'),
+                            },
+                    )
+                }
+            );
+            $return_data->{updated} = 1;
+        };
+        # deal with any transaction errors
+        if ($@) {                                   # Transaction failed
+            die "something terrible has happened!"  #
+                if ($@ =~ /Rollback failed/);       # Rollback failed
+
+            $return_data->{error}{message} =
+                qq{Database transaction failed: $@};
+            $c->log->error( $@ );
+            $json = to_json($return_data);
+            $c->response->body( $json );
+            return;
+        }
+    }
+
+    # add a new ban?
+    elsif ($fieldname =~ m{\Aipbannewtype_(\d+)\z}xms) {
+        eval {
+            my $id = $1;
+
+            $c->model('ParleyDB')->schema->txn_do(
+                sub {
+                    $c->model('ParleyDB::IpBan')->update_or_create(
+                        {
+                            ban_type_id => $id,
+                            ip_range    => $c->request->param('value'),
+                        },
+                    )
+                }
+            );
+            $return_data->{updated} = 1;
+        };
+        # deal with any transaction errors
+        if ($@) {                                   # Transaction failed
+            die "something terrible has happened!"  #
+                if ($@ =~ /Rollback failed/);       # Rollback failed
+
+            $return_data->{error}{message} =
+                qq{Database transaction failed: $@};
+            $c->log->error( $@ );
+            $json = to_json($return_data);
+            $c->response->body( $json );
+            $c->log->info( $json );
+            return;
+        }
+    }
+
+    # unknown
+    else {
+        $return_data->{error}{message} =
+            $c->localize(q{Unrecognised field-name format});
+    }
+
+    # return some JSON
+    $json = to_json($return_data);
+    $c->response->body( $json );
+    $c->log->info( $json );
+    return;
+}
+
 =head1 NAME
 
 Parley::Controller::Site - Catalyst Controller

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/lib/Parley/I18N/i_default.po	2008-03-16 23:00:26 UTC (rev 842)
@@ -255,6 +255,9 @@
 msgid "Invalid requested value"
 msgstr "Invalid requested value"
 
+msgid "IP Bans"
+msgstr "IP Bans"
+
 msgid "IP Logged"
 msgstr "IP Logged"
 

Added: trunk/lib/Parley/ResultSet/IpBanType.pm
===================================================================
--- trunk/lib/Parley/ResultSet/IpBanType.pm	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/lib/Parley/ResultSet/IpBanType.pm	2008-03-16 23:00:26 UTC (rev 842)
@@ -0,0 +1,25 @@
+package Parley::ResultSet::IpBanType;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
+use base 'DBIx::Class::ResultSet';
+
+sub ban_type_list {
+    my $resultsource = shift;
+    my ($rs);
+
+    $rs = $resultsource->search(
+        {},
+        {
+            'order_by'  => ['name ASC'],
+        }
+    );
+
+    return $rs;
+}
+
+
+1;

Modified: trunk/lib/Parley/Schema/IpBanType.pm
===================================================================
--- trunk/lib/Parley/Schema/IpBanType.pm	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/lib/Parley/Schema/IpBanType.pm	2008-03-16 23:00:26 UTC (rev 842)
@@ -15,6 +15,8 @@
 __PACKAGE__->add_columns(qw/id name description/);
 # Set the primary key for the table
 __PACKAGE__->set_primary_key(qw/id/);
+# Set the resultset class
+__PACKAGE__->resultset_class('Parley::ResultSet::IpBanType');
 
 #
 # Set relationships:
@@ -25,6 +27,12 @@
     ['name']
 );
 
+# lib/Parley/Schema/Forum.pm:__PACKAGE__->has_many(
+# "threads", "Thread", { "foreign.forum" => "self.id" });
+__PACKAGE__->has_many(
+    'ip_bans' => 'IpBan',
+    { 'foreign.ban_type_id' => 'self.id' }
+);
 
 
 1;

Modified: trunk/root/base/menu/menubar
===================================================================
--- trunk/root/base/menu/menubar	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/root/base/menu/menubar	2008-03-16 23:00:26 UTC (rev 842)
@@ -122,6 +122,7 @@
                                         <ul class="first-of-type">
                                             <li class="yuimenuitem"><a class="yuimenuitemlabel" href="site/services">[%l('Services')%]</a></li>
                                             <li class="yuimenuitem"><a class="yuimenuitemlabel" href="site/users">[%l('Users')%]</a></li>
+                                            <li class="yuimenuitem"><a class="yuimenuitemlabel" href="site/ip_bans">[%l('IP Bans')%]</a></li>
                                         </ul>            
                                     </div>
                                 </div>                    

Added: trunk/root/base/site/ip_bans
===================================================================
--- trunk/root/base/site/ip_bans	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/root/base/site/ip_bans	2008-03-16 23:00:26 UTC (rev 842)
@@ -0,0 +1,74 @@
+<h1>[%l('IP Bans')%]</h1>
+[% WHILE (ban_type = ip_ban_types.next) %]
+<h2 class="top_padded">[% ban_type.description %]</h2>
+    [% bans = ban_type.ip_bans_rs %]
+    [% IF bans.count %]
+        [% WHILE (ip_ban = bans.next) %]
+        <span id="ipban_[%ip_ban.id%]" class="editable">[%ip_ban.ip_range%]</span>
+        [% END %]
+    [% ELSE %]
+        <span id="ipbannewtype_[%ban_type.id%]" class="editable">None</span>
+    [% END %]
+[% END %]
+
+
+[% PROCESS shared/ajax_dialog %]
+
+
+<script type="text/javascript" src="[%c.request.base%]/static/Editable-min.js"></script>
+<script type="text/javascript">
+    var E  = new YAHOO.widget.EditableElement;
+    E.config.input_type = 'textarea';
+
+    E.callback = function(){
+        var handleSuccess = function(o) {
+            YAHOO.parley.small_loading.wait.hide();
+            var data = eval('(' + o.responseText + ')');
+            // if we didn't update reset the field value
+            if (data.updated != 1) {
+                o.argument.node.innerHTML = data.old_value;
+            }
+            if (data.error) {
+                try {
+                    YAHOO.parley.ajax_dialog.dlg.show_message( data.error );
+                } catch(e) { alert('handleSuccess: ' + e); }
+            }
+        };
+        var handleFailure =  function(o) {
+            YAHOO.parley.small_loading.wait.hide();
+            try {
+                YAHOO.parley.ajax_dialog.dlg.show_message( o );
+            } catch(e) { alert('handleFailure: ' + e); }
+        };
+
+        // let the user know something is happening
+        YAHOO.parley.small_loading.wait.show();
+
+        // where to post to
+        var sUrl = "[%c.uri_for('/site/saveBanHandler')%]";
+
+        // postdata is a query string ... how irksome!!
+        var postData =
+               'value='     + this.contents_new
+            + '&ovalue='    + this.contents
+            + '&fieldname=' + this.clicked.id
+        ;
+
+        //var msg_node = YAHOO.util.Dom.get('result');
+
+        var request = YAHOO.util.Connect.asyncRequest(
+            'POST',
+            sUrl,
+            {
+                success:  handleSuccess,
+                failure:  handleFailure,
+                argument: {
+                    node:     this.clicked
+                }
+            },
+            postData
+        );
+    };
+
+    E.init();
+</script>

Added: trunk/root/base/user/access_ip_banned
===================================================================
--- trunk/root/base/user/access_ip_banned	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/root/base/user/access_ip_banned	2008-03-16 23:00:26 UTC (rev 842)
@@ -0,0 +1,3 @@
+<h1>[%l('Access Denied')%]</h1>
+
+[%l('Access to this application is not permitted from [_1]', c.request.address)%]

Added: trunk/root/base/user/posting_ip_banned
===================================================================
--- trunk/root/base/user/posting_ip_banned	2008-03-16 23:00:10 UTC (rev 841)
+++ trunk/root/base/user/posting_ip_banned	2008-03-16 23:00:26 UTC (rev 842)
@@ -0,0 +1,3 @@
+<h1>[%l('Posting Not Allowed')%]</h1>
+
+[%l('Posting is not permitted from [_1]', c.request.address)%]



From chiselwright at mail.berlios.de  Tue Mar 18 21:11:00 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 18 Mar 2008 21:11:00 +0100
Subject: [Parley-svn] r843 - / trunk/lib/Parley/Controller
Message-ID: <200803182011.m2IKB0t0023456@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-18 21:10:59 +0100 (Tue, 18 Mar 2008)
New Revision: 843

Modified:
   /
   trunk/lib/Parley/Controller/Root.pm
Log:
 r4767 at wiggin:  chisel | 2008-03-17 20:24:33 +0000
 - removed archaic debugging messages



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4764
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4767
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/Root.pm
===================================================================
--- trunk/lib/Parley/Controller/Root.pm	2008-03-16 23:00:26 UTC (rev 842)
+++ trunk/lib/Parley/Controller/Root.pm	2008-03-18 20:10:59 UTC (rev 843)
@@ -49,8 +49,6 @@
     # do we have a request for a chosen language?
     ##################################################
     if (defined $c->request->param('lang')) {
-        $c->log->debug('SET LANG: ' . $c->request->param('lang'));
-        $c->log->debug($c->request->referer());
         $c->response->cookies->{ $cookie_name } = {
             value       => $c->request->param('lang'),
             expires     => '+14d',
@@ -196,7 +194,6 @@
         my $status = terms_check($c, $c->_authed_user);
         if (not $status) {
             $c->res->body('need to accept');
-            $c->log->debug('User needs to accept T&Cs');
             return 0;
         }
     }
@@ -227,7 +224,6 @@
             and
         $c->check_user_roles('site_moderator')
     ) {
-        $c->log->debug( q{site_moderator role for user} );
         $c->stash->{site_moderator} = 1;
     }
 
@@ -238,7 +234,6 @@
     if (defined $c->_authed_user() and defined $c->_current_forum()) {
         # site_moderators can moderate anything
         if ($c->check_user_roles('site_moderator')) {
-            $c->log->debug( q{site_moderator role moderates anything he wants} );
             $c->stash->{moderator} = 1;
         }
         else {
@@ -256,7 +251,6 @@
             );
             # if we found something, they must moderate the current forum
             if ($results) {
-                #$c->log->debug( q{user moderates this forum} );
                 $c->stash->{moderator} = 1;
             }
         }



From chiselwright at mail.berlios.de  Tue Mar 18 21:11:09 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 18 Mar 2008 21:11:09 +0100
Subject: [Parley-svn] r844 - / trunk/root/email_templates
	trunk/root/email_templates/nl
Message-ID: <200803182011.m2IKB92l023536@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-18 21:11:08 +0100 (Tue, 18 Mar 2008)
New Revision: 844

Added:
   trunk/root/email_templates/nl/
   trunk/root/email_templates/nl/authentication_email.eml
   trunk/root/email_templates/nl/password_reset.eml
   trunk/root/email_templates/nl/thread_update_notify.eml
   trunk/root/email_templates/nl/thread_update_notify.html
   trunk/root/email_templates/nl/username_reminder.eml
Modified:
   /
Log:
 r4768 at wiggin:  chisel | 2008-03-18 19:06:07 +0000
 + added Dutch email template translations



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4767
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4768
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/root/email_templates/nl/authentication_email.eml
===================================================================
--- trunk/root/email_templates/nl/authentication_email.eml	2008-03-18 20:10:59 UTC (rev 843)
+++ trunk/root/email_templates/nl/authentication_email.eml	2008-03-18 20:11:08 UTC (rev 844)
@@ -0,0 +1,12 @@
+[% person.first_name %],
+
+Dank voor het registreren met [% c.config.name %]
+Om uw registratie te voltooien gelieve te klikken op de hieronder verbinding.
+
+  [% c.request.base %]user/authenticate/[% regauth.id %]
+
+en volg de instructies op scherm.
+
+Achting,
+
+Het [% c.config.name %] team.

Added: trunk/root/email_templates/nl/password_reset.eml
===================================================================
--- trunk/root/email_templates/nl/password_reset.eml	2008-03-18 20:10:59 UTC (rev 843)
+++ trunk/root/email_templates/nl/password_reset.eml	2008-03-18 20:11:08 UTC (rev 844)
@@ -0,0 +1,12 @@
+[% person.first_name %],
+
+Om uw rekeningswachtwoord terug te stellen gelieve te klikken op de
+hieronder verbinding.
+
+  [% c.request.base %]user/password/reset/[% pwd_reset.id %]
+
+en volg de instructies op scherm.
+
+Achting,
+
+Het [% c.config.name %] team.

Added: trunk/root/email_templates/nl/thread_update_notify.eml
===================================================================
--- trunk/root/email_templates/nl/thread_update_notify.eml	2008-03-18 20:10:59 UTC (rev 843)
+++ trunk/root/email_templates/nl/thread_update_notify.eml	2008-03-18 20:11:08 UTC (rev 844)
@@ -0,0 +1,20 @@
+[% person.first_name %],
+
+De draad "[% post.thread.subject %]"
+een nieuw antwoord langs heeft ontvangen [% post.creator.forum_name %].
+
+Klik hier blijven lezend de draad:
+
+ [% c.req.base %]thread/next_post?thread=[% post.thread.id %]
+
+Klik hier om de recentste post in de draad te bekijken:
+
+ [% c.req.base %]post/view?post=[% post.id %]
+
+Gelieve van nota te nemen: U zult geen verdere berichten voor deze draad
+ontvangen tot u hierboven de post of om het even welke posten bekijkt
+die na het worden gecreeerd.
+
+Achting,
+
+Het [% c.config.name %] team.

Added: trunk/root/email_templates/nl/thread_update_notify.html
===================================================================
--- trunk/root/email_templates/nl/thread_update_notify.html	2008-03-18 20:10:59 UTC (rev 843)
+++ trunk/root/email_templates/nl/thread_update_notify.html	2008-03-18 20:11:08 UTC (rev 844)
@@ -0,0 +1,29 @@
+<html>
+    <head>
+        <title>Het Bericht van de Update van de draad</title>
+    </head>
+
+    <body>
+        <p>[% person.first_name %],</p>
+
+        <p>De draad "[% post.thread.subject %]"
+        een nieuw antwoord langs heeft ontvangen [% post.creator.forum_name %].</p>
+
+        <p>Kies ??n van de volgende acties:
+        <ul>
+            <li>
+            <a href="[% c.req.base %]thread/next_post?thread=[% post.thread.id %]">Blijf lezend "[% post.thread.subject %]" van uw laatste positie</a>
+            </li>
+            <li>
+            <a href="[% c.req.base %]post/view?post=[% post.id %]">Mening "[% post.thread.subject %]" van de nieuwe post</a>
+            </li>
+        </ul>
+        </p>
+
+        <p>Gelieve van nota te nemen: U <b>zal niet</b> ontvang om het even welke verdere berichten voor deze draad tot u hierboven de post of om het even welke posten bekijkt die na het worden gecreeerd.</p>
+
+        <p>Achting,</p>
+
+        <p>Het [% c.config.name %] team.</p>
+    </body>
+</html>

Added: trunk/root/email_templates/nl/username_reminder.eml
===================================================================
--- trunk/root/email_templates/nl/username_reminder.eml	2008-03-18 20:10:59 UTC (rev 843)
+++ trunk/root/email_templates/nl/username_reminder.eml	2008-03-18 20:11:08 UTC (rev 844)
@@ -0,0 +1,13 @@
+[% person.first_name %],
+
+Uw gebruikersbenaming voor [% c.config.name %] is:
+
+  [% person.authentication.username %]
+
+U kunt bezoeken [% c.config.name %] bij:
+
+  [% c.request.base %]
+
+Achting,
+
+Het [% c.config.name %] team.



From chiselwright at mail.berlios.de  Tue Mar 18 21:11:18 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 18 Mar 2008 21:11:18 +0100
Subject: [Parley-svn] r845 - / trunk
Message-ID: <200803182011.m2IKBIlp023606@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-18 21:11:18 +0100 (Tue, 18 Mar 2008)
New Revision: 845

Modified:
   /
   trunk/MANIFEST
Log:
 r4769 at wiggin:  chisel | 2008-03-18 19:07:22 +0000
 $ rm MANIFEST; make manifest



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4768
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4769
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/MANIFEST
===================================================================
--- trunk/MANIFEST	2008-03-18 20:11:08 UTC (rev 844)
+++ trunk/MANIFEST	2008-03-18 20:11:18 UTC (rev 845)
@@ -59,6 +59,7 @@
 lib/Parley/Controller/User/SignUp.pm
 lib/Parley/I18N/i_default.po
 lib/Parley/I18N/it.po
+lib/Parley/I18N/nl.po
 lib/Parley/Model/ParleyDB.pm
 lib/Parley/ResultSet/Forum.pm
 lib/Parley/ResultSet/IpBan.pm
@@ -179,6 +180,11 @@
 root/email_templates/it/thread_update_notify.eml
 root/email_templates/it/thread_update_notify.html
 root/email_templates/it/username_reminder.eml
+root/email_templates/nl/authentication_email.eml
+root/email_templates/nl/password_reset.eml
+root/email_templates/nl/thread_update_notify.eml
+root/email_templates/nl/thread_update_notify.html
+root/email_templates/nl/username_reminder.eml
 root/favicon.ico
 root/static/css/common.css
 root/static/css/default.css
@@ -465,6 +471,7 @@
 root/static/MessagePreview.js
 root/static/script/ajax_error_dlg.js
 root/static/script/prototype.js
+root/static/script/user_forum_moderate.js
 root/static/script/user_suspend.js
 root/static/yui/animation/animation-debug.js
 root/static/yui/animation/animation-min.js



From chiselwright at mail.berlios.de  Tue Mar 18 21:11:34 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 18 Mar 2008 21:11:34 +0100
Subject: [Parley-svn] r846 - / trunk/lib/Parley
Message-ID: <200803182011.m2IKBY2j023695@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-18 21:11:33 +0100 (Tue, 18 Mar 2008)
New Revision: 846

Modified:
   /
   trunk/lib/Parley/Contributors.pm
Log:
 r4770 at wiggin:  chisel | 2008-03-18 19:08:15 +0000
 + updated contributors to the project



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4769
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4770
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Contributors.pm
===================================================================
--- trunk/lib/Parley/Contributors.pm	2008-03-18 20:11:18 UTC (rev 845)
+++ trunk/lib/Parley/Contributors.pm	2008-03-18 20:11:33 UTC (rev 846)
@@ -27,6 +27,10 @@
 
 =head1 I18N
 
+=head2 Dutch
+
+Translation by Rob Partridge
+
 =head2 Italian
 
 Translation by Darius Jokilehto



From chiselwright at mail.berlios.de  Tue Mar 18 21:11:44 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 18 Mar 2008 21:11:44 +0100
Subject: [Parley-svn] r847 - / trunk/lib/Parley/I18N
Message-ID: <200803182011.m2IKBiZd023765@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-18 21:11:43 +0100 (Tue, 18 Mar 2008)
New Revision: 847

Added:
   trunk/lib/Parley/I18N/nl.po
Modified:
   /
Log:
 r4771 at wiggin:  chisel | 2008-03-18 19:09:28 +0000
 + new Dutch .po i18n phrase file



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4770
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4771
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/lib/Parley/I18N/nl.po
===================================================================
--- trunk/lib/Parley/I18N/nl.po	2008-03-18 20:11:33 UTC (rev 846)
+++ trunk/lib/Parley/I18N/nl.po	2008-03-18 20:11:43 UTC (rev 847)
@@ -0,0 +1,880 @@
+msgid "%1 wrote:"
+msgstr "%1 schreef:"
+
+msgid "%quant(%1,post)"
+msgstr "%quant(%1,post,posten)"
+
+msgid "%quant(%1,Forum)"
+msgstr "%quant(%1,Forum,Forums)"
+
+msgid "%quant(%1,Reply)"
+msgstr "%quant(%1,Antwoord,Antwoorden)"
+
+msgid "%quant(%1,reply)"
+msgstr "%quant(%1,antwoord,antwoorden)"
+
+msgid "%quant(%1,View)"
+msgstr "%quant(%1,Mening,Meningen)"
+
+msgid "%quant(%1,view)"
+msgstr "%quant(%1,mening,meningen)"
+
+msgid "404 Not Found"
+msgstr "404 vinden niet"
+
+msgid "ACCEPT TERMS"
+msgstr "U moet de Voorwaarden het ermee instemmen hieronder blijven gebruikend de plaats"
+
+msgid "Access Denied"
+msgstr "Ontkende toegang"
+
+msgid "Access to this application is not permitted from %1"
+msgstr "De toegang tot deze toepassing wordt niet toegelaten van %1"
+
+msgid "Activate Your %s Registration"
+msgstr "Activeer Uw  %s Registratie"
+
+msgid "Active"
+msgstr "Actief"
+
+msgid "ADD THREAD WATCH"
+msgstr "Voeg een Horloge van de Draad toe"
+
+msgid "Add Reply"
+msgstr "Voeg Antwoord toe"
+
+msgid "Add T-and-Cs"
+msgstr "Voeg T&amp;Cs toe"
+
+msgid "Add Watch"
+msgstr "Voeg Horloge toe"
+
+msgid "ADMIN LOCK POST"
+msgstr "Sluit deze post"
+
+msgid "ADMIN SPECIFY LOCK THREAD"
+msgstr "U moet de te sluiten draad specificeren"
+
+msgid "ADMIN SPECIFY STICK THREAD"
+msgstr "U moet de te plakken draad specificeren"
+
+msgid "Administration"
+msgstr "Beleid"
+
+msgid "ago"
+msgstr "geleden"
+
+msgid "All Forums"
+msgstr "Alle Forums"
+
+msgid "All Rights Reserved"
+msgstr "Alle Voorgebe houde Rechten"
+
+msgid "An email has been sent to"
+msgstr "Een e-mail is verzonden naar"
+
+msgid "An error has occurred"
+msgstr "Een fout is voorgekomen"
+
+msgid "AUTHENTICATION FAILED"
+msgstr "Onbekwaam om de geleverde login geloofsbrieven voor authentiek te verklaren"
+
+msgid "Avatar"
+msgstr "Avatar"
+
+msgid "Cancel"
+msgstr "Annuleer"
+
+msgid "CHANGE AVATAR"
+msgstr "Verander uw avatar beeld door een dossier te selecteren en de Upload hieronder knoop te klikken"
+
+msgid "Click on the login link to continue"
+msgstr "Klik op de login verbinding om verder te gaan"
+
+msgid "Close"
+msgstr "Sluit"
+
+msgid "Comment"
+msgstr "Commentaar"
+
+msgid "Confirm Password"
+msgstr "Bevestig Wachtwoord"
+
+msgid "Contents"
+msgstr "Inhoud"
+
+msgid "Continue"
+msgstr "Ga verder"
+
+msgid "Continue reading"
+msgstr "Blijf lezend"
+
+msgid "Create New Thread"
+msgstr "Cre?er Nieuwe Draad"
+
+msgid "created by"
+msgstr "langs gecreeerd"
+
+msgid "created by (%1)"
+msgstr "langs gecreeerd %1"
+
+msgid "Current Avatar"
+msgstr "Huidige Avatar"
+
+msgid "Current Forum"
+msgstr "Huidig Forum"
+
+msgid "Current User"
+msgstr "Huidige Gebruiker"
+
+msgid "DATABASE CRITERIA MISSING"
+msgstr "Ontbrekende criteria in gegevensbestandraadpleging"
+
+msgid "DATABASE TOO MANY RECORDS"
+msgstr "De gegevensbestandraadpleging keerde teveel verslagen terug"
+
+msgid "Default"
+msgstr "Gebrek"
+
+msgid "DFV FIELDS MISSING"
+msgstr "??n of meerdere vereiste gebieden missen."
+
+msgid "DFV FIELDS INVALID"
+msgstr "??n of meerdere gebieden zijn ongeldig."
+
+msgid "DFV FILL REQUIRED"
+msgstr "U moet alle vereiste gebieden invullen."
+
+msgid "EDIT LOCKED POST"
+msgstr "U kunt gesloten posten uitgeven niet."
+
+msgid "EDIT LOGIN REQUIRED"
+msgstr "U moet worden ingelogd alvorens u uw posten kunt uitgeven."
+
+msgid "EDIT OWN POSTS ONLY"
+msgstr "U kunt posten slechts uitgeven u hebt gemaakt."
+
+msgid "Edit"
+msgstr "Geef uit"
+
+msgid "Edited"
+msgstr "Uitgegeven"
+
+msgid "Email Address"
+msgstr "E-mail Adres"
+
+msgid "Email Engine"
+msgstr "E-mail Motor"
+
+msgid "EMAIL FAILED STORE"
+msgstr "Droevig, kunnen wij momenteel niet uw informatie opslaan. Gelieve te proberen opnieuw later."
+
+msgid "EMAIL IN USE (%1)"
+msgstr "E-mail richt u heeft gekozen is reeds in gebruik.<br />Gelieve te proberen verschillende, of te gebruik <a href=\"%1\">Vergeten Wachtwoord</a> pagina."
+
+msgid "EMAIL SEND PROBLEM"
+msgstr "Er was een probleem verzendend een e-mail van het systeem"
+
+msgid "EMAIL MISSING SUBJECT"
+msgstr "Het onderworpen Missen van de Lijn"
+
+msgid "ENTER REPLY"
+msgstr "Gelieve te gaan uw antwoord in de hieronder vorm in"
+
+msgid "FILE NOT IMAGE"
+msgstr "Het geuploade dossier schijnt geen beelddossier te zijn"
+
+msgid "FILE NEWDIR FAILED"
+msgstr "Slaagde er niet in om bestemmingsfolder tot stand te brengen. Onbekwaam op te slaan uploaden."
+
+msgid "FILE STORE FAILED"
+msgstr "Slaagde op te slaan er niet in uploaden."
+
+msgid "FILE TOO LARGE"
+msgstr "Te grote de grootte van het dossier. Het dossier moet neen groter zijn dan 20K."
+
+msgid "First"
+msgstr "Eerst"
+
+msgid "First Name"
+msgstr "Voornaam"
+
+msgid "Forgotten Password"
+msgstr "Vergeten Wachtwoord"
+
+msgid "Forum"
+msgstr "Forum"
+
+msgid "Forums"
+msgstr "Forums"
+
+msgid "Forum List"
+msgstr "De Lijst van het forum"
+
+msgid "Forum Moderators"
+msgstr "De Moderatoren van het forum"
+
+msgid "Forum Name"
+msgstr "De Naam van het forum"
+
+msgid "Forum Summary"
+msgstr "De Samenvatting van het forum"
+
+msgid "FORUMNAME IN USE"
+msgstr "Het forum noemt u heeft gekozen is reeds in gebruik. Gelieve te proberen verschillende."
+
+msgid "FORUMNAME USED"
+msgstr "reeds is gebruikt door een andere gebruiker."
+
+msgid "General"
+msgstr "Algemeen"
+
+msgid "Guest User"
+msgstr "De Gebruiker van de gast"
+
+msgid "Go"
+msgstr "Ga"
+
+msgid "Help"
+msgstr "Hulp"
+
+# Search for [....] _in_ [......]
+msgid "in"
+msgstr "in"
+
+msgid "Incomplete authentication URL"
+msgstr "Onvolledige authentificatie URL"
+
+msgid "Incomplete URL"
+msgstr "Onvolledig URL"
+
+# e.g. Invalid user-id
+msgid "Invalid %1"
+msgstr "Ongeldig %1"
+
+msgid "Invalid requested value"
+msgstr "Ongeldige gevraagde waarde"
+
+msgid "IP Bans"
+msgstr "IP Verboden"
+
+msgid "IP Logged"
+msgstr "IP Geregistreerd"
+
+msgid "Last"
+msgstr "Duur"
+
+msgid "Last Modified"
+msgstr "Duur Gewijzigd"
+
+msgid "Last Name"
+msgstr "Laatste Naam"
+
+msgid "Last Post"
+msgstr "Laatste Post"
+
+msgid "last post by"
+msgstr "laatste post langs"
+
+msgid "last post by (%1)"
+msgstr "laatste post langs %1"
+
+msgid "Last Viewed"
+msgstr "Duur Bekeken"
+
+msgid "LOCK AFTER POSTING"
+msgstr "De draad van het slot na het posten"
+
+msgid "Lock Thread"
+msgstr "De Draad van het slot"
+
+msgid "Locked"
+msgstr "Gesloten"
+
+msgid "Locked Post"
+msgstr "Gesloten Post"
+
+msgid "LOGIN ADD REPLY"
+msgstr "U moet worden ingelogd alvorens u een antwoord kunt toevoegen."
+
+msgid "LOGIN NEW TOPIC"
+msgstr "U moet worden ingelogd om een nieuw onderwerp toe te voegen."
+
+msgid "LOGIN REQUIRED"
+msgstr "U moet worden ingelogd alvorens u tot dit gebied kunt toegang hebben."
+
+msgid "LOGIN THREAD CONTINUE"
+msgstr "U moet worden ingelogd alvorens u de functie van de draadvoortzetting kunt gebruiken."
+
+msgid "LOGIN USE NEW"
+msgstr "Tevreden log-in die uw gebruikersbenaming gebruikt en uw <u>nieuw</u> wachtwoord."
+
+msgid "LOGIN VIEW WATCHES"
+msgstr "U moet worden ingelogd alvorens u uw gelete op draden kunt bekijken."
+
+msgid "LOGIN WATCH TOPIC"
+msgstr "U moet worden ingelogd alvorens u op een onderwerp kunt letten."
+
+msgid "Logged in as"
+msgstr "Ingelogd zoals"
+
+msgid "Login"
+msgstr "Login"
+
+msgid "Login Not Allowed"
+msgstr "Toegestaan niet login"
+
+msgid "Logins are not permitted from %1"
+msgstr "Logins wordt niet toegelaten van %1"
+
+msgid "Logout"
+msgstr "Logout"
+
+msgid "Manage"
+msgstr "Leid"
+
+msgid "Me"
+msgstr "Me"
+
+msgid "Main Page"
+msgstr "Hoofd Pagina"
+
+msgid "Message"
+msgstr "Bericht"
+
+msgid "Moderate"
+msgstr "Matig me"
+
+msgid "My Preferences"
+msgstr "Mijn Voorkeur"
+
+msgid "My Profile"
+msgstr "Mijn Profiel"
+
+msgid "My Watched Threads"
+msgstr "Mijn Gelete op Draden"
+
+msgid "Name"
+msgstr "Naam"
+
+msgid "Never Posted"
+msgstr "Nooit Gepost"
+
+msgid "New Password"
+msgstr "Nieuw Wachtwoord"
+
+msgid "Next"
+msgstr "Daarna"
+
+msgid "Nickname"
+msgstr "Bijnaam"
+
+msgid "No"
+msgstr "Nr"
+
+msgid "No posts"
+msgstr "Geen posten"
+
+msgid "No reason given"
+msgstr "Geen gegeven reden"
+
+msgid "NO MATCHING USERS"
+msgstr "Er zijn geen gebruikers die die informatie aanpassen"
+
+msgid "NO RECENT THREADS"
+msgstr "Geen recente draden aan vertoning"
+
+msgid "NO SEARCH RESULTS"
+msgstr "Geen resultaten gevonden passende gespecificeerde voorwaarden"
+
+msgid "NO SITE TERMS"
+msgstr "Deze plaats heeft geen Voorwaarden Aan mening"
+
+msgid "No Such Form"
+msgstr "Geen Dergelijke Vorm"
+
+msgid "No User Avatar"
+msgstr "Geen Avatar van de Gebruiker"
+
+msgid "No User Specified"
+msgstr "Geen Gespecificeerde Gebruiker"
+
+msgid "non-integer forum id passed"
+msgstr "Overgegaane het forumidentiteitskaart van het niet-geheel"
+
+msgid "non-integer post id passed"
+msgstr "Post overgegaane identiteitskaart van het niet-geheel"
+
+msgid "non-integer thread id passed"
+msgstr "Overgegaane de draadidentiteitskaart van het niet-geheel"
+
+msgid "non-integer user id passed"
+msgstr "Overgegaane de gebruikersidentiteitskaart van het niet-geheel"
+
+msgid "None"
+msgstr "Niets"
+
+msgid "No Moderators"
+msgstr "Niets"
+
+msgid "Notifications"
+msgstr "Berichten"
+
+msgid "Not Authenticated"
+msgstr "Voor authentiek verklaard niet"
+
+msgid "of"
+msgstr "van"
+
+msgid "or"
+msgstr "of"
+
+msgid "Page"
+msgstr "Pagina"
+
+msgid "Page %1 of %2"
+msgstr "Pagina %1 van %2"
+
+msgid "PASSWORD DETAILS SENT"
+msgstr "U zou een e-mail in de volgende notulen met verdere instructies moeten ontvangen om uw wachtwoord terug te stellen."
+
+msgid "PASSWORD EMAIL SEND FAILED"
+msgstr "De toepassing slaagde er niet in om het wachtwoordterugstellen e-mail te verzenden."
+
+msgid "PASSWORD ENTER DETAILS"
+msgstr "Gelieve te gaan uw gebruikersbenaming en wachtwoord in"
+
+msgid "PASSWORD GAIN"
+msgstr "Om tot uw rekening toegang te krijgen kan uw wachtwoord worden teruggesteld, en een authentificatie e-mail genomen kwalijk."
+
+msgid "PASSWORD IMPOSSIBLE"
+msgstr "Dit maakt het onmogelijk om u aan uw huidig wachtwoord te herinneren."
+
+msgid "PASSWORD PROCEED"
+msgstr "Als u alstublieft wenst te werk te gaan ga de gebruikersbenaming of e-mailadres in u omhoog met ondertekende."
+
+msgid "PASSWORD RESET"
+msgstr "Om uw wachtwoord terug te stellen ga uw gebruikersbenaming en uw gewenst wachtwoord hieronder op de gebieden in, dan klik <em>stel mijn wachtwoord terug</em> knoop om te werk te gaan."
+
+msgid "PASSWORD RESET ID BOGUS"
+msgstr "Valse identiteitskaart van het wachtwoordterugstellen"
+
+msgid "PASSWORD RESET SUCCESS"
+msgstr "Uw wachtwoord is geplaatst aan de waarde u inging."
+
+msgid "PASSWORD RESET URL INCOMPLETE"
+msgstr "Het onvolledige wachtwoordterugstellen URL."
+
+msgid "PASSWORD STORES"
+msgstr "slaat een gecodeerd exemplaar van uw wachtwoord of e-mailadres op u omhoog met ondertekende."
+
+msgid "Password"
+msgstr "Wachtwoord"
+
+msgid "Password Reminder"
+msgstr "De Herinnering van het wachtwoord"
+
+msgid "Password Reminder"
+msgstr "De Herinnering van het wachtwoord"
+
+msgid "person"
+msgstr "persoon"
+
+msgid "Please choose a language"
+msgstr "Gelieve te kiezen een taal"
+
+msgid "Please enter suspension information"
+msgstr "Gelieve te gaan opschortingsinformatie in"
+
+msgid "Please enter your information"
+msgstr "Gelieve te gaan uw informatie in"
+
+msgid "Please enter your username and password"
+msgstr "Gelieve te gaan uw gebruikersbenaming en wachtwoord in"
+
+msgid "people"
+msgstr "mensen"
+
+msgid "posted by"
+msgstr "langs gepost"
+
+msgid "Posting is not permitted from %1"
+msgstr "Het posten wordt niet toegelaten van %1"
+
+msgid "Posting Not Allowed"
+msgstr "Toegestaan niet posten"
+
+msgid "Post Edited By: %1"
+msgstr "Post Uitgegeven door: %1"
+
+msgid "Posted from %1"
+msgstr "Gepost van %1"
+
+msgid "Posts"
+msgstr "Posten"
+
+msgid "posts"
+msgstr "posten"
+
+msgid "Posts Made"
+msgstr "Gemaakte posten"
+
+msgid "PREFS ADD WATCHES"
+msgstr "Voeg automatisch horloges voor nieuwe posten toe"
+
+msgid "PREFS DESIRED LOCATION"
+msgstr "Selecteer uw gewenste plaats. Dit zal aan vertoningstijden worden gebruikt gebruikend uw lokale timezone."
+
+msgid "PREFS EMAIL NOTIFICATION"
+msgstr "Ontvang e-mailbericht voor gelete op draden"
+
+msgid "Preview"
+msgstr "Voorproef"
+
+msgid "Previous"
+msgstr "Vorig"
+
+msgid "PROFILE NOT FOUND"
+msgstr "Kan van een profiel voor de gevraagde gebruiker de plaats bepalen niet."
+
+msgid "Post New Terms"
+msgstr "Post Nieuwe Termijnen"
+
+msgid "Post New Topic"
+msgstr "Post Nieuw Onderwerp"
+
+msgid "Quote"
+msgstr "Citaat"
+
+msgid "Reason for suspension"
+msgstr "Reden voor opschorting"
+
+msgid "Recently Updated Threads"
+msgstr "Onlangs Bijgewerkte Draden"
+
+msgid "Register"
+msgstr "Register"
+
+msgid "Registration Complete"
+msgstr "Volledige registratie"
+
+msgid "Registrations are not permitted from %1"
+msgstr "De registratie wordt niet toegelaten van %1"
+
+msgid "Registration Not Allowed"
+msgstr "Toegestane niet registratie"
+
+msgid "Remove Watch"
+msgstr "Verwijder Horloge"
+
+msgid "REPLY LOCKED THREAD"
+msgstr "U kunt op een gesloten draad antwoorden niet."
+
+msgid "Reply"
+msgstr "Antwoord"
+
+msgid "Replying To"
+msgstr "Het antwoorden op"
+
+msgid "Reset My Password"
+msgstr "Stel Mijn Wachtwoord terug"
+
+msgid "Return to"
+msgstr "Terugkeer aan"
+
+msgid "Return to the forum"
+msgstr "Terugkeer naar het forum"
+
+msgid "Reset Your %s Password"
+msgstr "Stel Uw terug %s Wachtwoord"
+
+msgid "said"
+msgstr "gezegd"
+
+msgid "Search"
+msgstr "Search"
+
+msgid "Search For"
+msgstr "Zoek naar"
+
+msgid "Search Results"
+msgstr "De Resultaten van het onderzoek"
+
+msgid "Searching for"
+msgstr "Het zoeken naar
+
+msgid "Select Zone"
+msgstr "Selecteer Streek"
+
+msgid "Service"
+msgstr "De dienst"
+
+msgid "Services"
+msgstr "De diensten"
+
+msgid "Show timezone"
+msgstr "Toon timezone"
+
+msgid "Sign Up"
+msgstr "Teken omhoog"
+
+msgid "SIGNUP COMPLETE FORM"
+msgstr "Voltooi hieronder de vorm om een nieuwe gebruikersrekening tot stand te brengen."
+
+msgid "SIGNUP EMAIL"
+msgstr "Uw E-mailadres"
+
+msgid "SIGNUP EMAIL CONFIRM"
+msgstr "Bevestig E-mailadres"
+
+msgid "SIGNUP EMAIL USAGE"
+msgstr "Uw e-mailadres zal niet doorgegeven worden aan enige derden. Het zal worden gebruikt om een activeringsverbinding voor de nieuwe rekening te verzenden. Als u om het alarm verzoekt van de draadupdate zal dit adres ook gebruikt worden voor het bericht e-mail."
+
+msgid "SIGNUP ERRORS"
+msgstr "De volgende fouten werden gevonden in uw voorlegging"
+
+msgid "SIGNUP FORUMNAME"
+msgstr "De Naam van het forum"
+
+msgid "SIGNUP FORUMNAME DESCRIPTION"
+msgstr "Uw <em>De Naam van het forum</em> zal met alle het posten worden getoond u op de forums maakt. De namen zijn uniek allen van het forum, zodat wanneer twee het "John Smith"s register, slechts zoals zal verschijnen \"John Smith\" wanneer het posten. (Droevige andere John Smith!)"
+
+msgid "SIGNUP PASSWORD"
+msgstr "Gewenst Wachtwoord"
+
+msgid "SIGNUP PASSWORD CONFIRM"
+msgstr "Bevestig wachtwoord"
+
+msgid "SIGNUP USERNAME"
+msgstr "Gewenste Gebruikersbenaming"
+
+msgid "SITE MODERATOR REQUIRED"
+msgstr "U moet een plaatsmoderator zijn om tot deze sectie van de plaats toegang te hebben."
+
+msgid "Site"
+msgstr "Plaats"
+
+msgid "Snippet"
+msgstr "Snippet"
+
+msgid "Start"
+msgstr "Begin"
+
+msgid "Start A New Topic"
+msgstr "Begin een Nieuw Onderwerp"
+
+msgid "Stick Thread"
+msgstr "De Draad van de stok"
+
+msgid "Sticky"
+msgstr "Kleverig"
+
+msgid "Sticky Topic"
+msgstr "Kleverig Onderwerp"
+
+msgid "Stop"
+msgstr "Einde"
+
+msgid "Subject"
+msgstr "Onderwerp"
+
+msgid "Summary of Changes"
+msgstr "Samenvatting van Veranderingen"
+
+msgid "Suspend Account"
+msgstr "Schort Rekening op"
+
+msgid "Suspended"
+msgstr "Opgeschort"
+
+msgid "TERMS ADD NEW"
+msgstr "Voeg het de Nieuwe Voorwaarden Van de Plaats toe"
+
+msgid "TERMS AGREE"
+msgstr "Ik ga hierboven met de termijnen akkoord"
+
+msgid "TERMS REJECT"
+msgstr "Ik ga niet hierboven met de termijnen akkoord"
+
+msgid "Terms and Conditions"
+msgstr "Voorwaarden"
+
+msgid "Thanks for signing up"
+msgstr "Dank voor omhoog het ondertekenen"
+
+msgid "The following error message was returned by the application"
+msgstr "De volgende foutenmelding was teruggekeerd door de toepassing"
+
+msgid "There is no current forum to view"
+msgstr "Er is geen huidig forum aan mening"
+
+msgid "There is no current thread to view"
+msgstr "Er is geen huidige draad aan mening"
+
+msgid "THREAD NO INFORMATION"
+msgstr "Geen informatie bestaat voor de draad of post u probeert om te antwoorden op."
+
+msgid "THREAD NO POSTS"
+msgstr "U probeert om op een draad zonder posten daarin te antwoorden."
+
+msgid "THREAD WATCH FAILED"
+msgstr "Slaagde er niet in om een horloge voor de gevraagde draad toe te voegen."
+
+msgid "Thread"
+msgstr "Draad"
+
+msgid "threads"
+msgstr "draden"
+
+msgid "Thread Locked"
+msgstr "Gesloten draad"
+
+msgid "Time"
+msgstr "Tijd"
+
+msgid "Time formatting example"
+msgstr "Het formatteren van de tijd voorbeeld"
+
+msgid "Topic"
+msgstr "Onderwerp"
+
+msgid "Unknown field name"
+msgstr "Onbekende gebiedsnaam"
+
+msgid "Unlock Thread"
+msgstr "Open Draad"
+
+msgid "Unread posts"
+msgstr "Ongelezen posten"
+
+msgid "Unstick Thread"
+msgstr "De Draad van Unstick"
+
+msgid "Update"
+msgstr "Update"
+
+msgid "Update Reply"
+msgstr "Het Antwoord van de update"
+
+msgid "Upload"
+msgstr "Upload"
+
+msgid "Use UTC"
+msgstr "Gebruik UTC"
+
+msgid "USER ACTIVATE"
+msgstr "Om uw rekening te activeren klik op de verbinding in e-mail"
+
+msgid "USER ALMOST THERE"
+msgstr "Bijna daar..."
+
+msgid "USER AUTHENTICATED"
+msgstr "Uw registratie is voor authentiek verklaard"
+
+msgid "User Profile"
+msgstr "Het Profiel van de gebruiker"
+
+msgid "USERNAME IN USE"
+msgstr "De gebruikersbenaming u hebt gekozen is reeds in gebruik. Gelieve te proberen verschillende."
+
+msgid "USERNAME INCORRECT"
+msgstr "Onjuiste Geleverde Gebruikersbenaming."
+
+msgid "Username"
+msgstr "Gebruikersbenaming"
+
+msgid "Users"
+msgstr "Gebruikers"
+
+msgid "User Roles"
+msgstr "De Rollen van de gebruiker"
+
+msgid "View"
+msgstr "Mening"
+
+msgid "view"
+msgstr "mening"
+
+msgid "View all"
+msgstr "Bekijk allen"
+
+msgid "views"
+msgstr "meningen"
+
+msgid "View Threads"
+msgstr "De Draden van de mening"
+
+msgid "Watch this thread"
+msgstr "Let op deze draad"
+
+msgid "watching this thread"
+msgstr "het letten van op deze draad"
+
+msgid "We're not in Kansas any more"
+msgstr "Wij zijn niet in Kansas enige meer"
+
+msgid "Users"
+msgstr "Gebruikers"
+
+msgid "wrote"
+msgstr "schreef"
+
+msgid "Yes"
+msgstr "Ja"
+
+msgid "You are not watching any threads"
+msgstr "U let op geen draden"
+
+msgid "You are watching this thread"
+msgstr "U let op deze draad"
+
+msgid "You don't have the required privileges to do that"
+msgstr "U hebt niet de vereiste voorrechten om dat te doen"
+
+msgid "Your Details"
+msgstr "Uw Details"
+
+msgid "Your Preferences"
+msgstr "Uw Voorkeur"
+
+msgid "Your %s Username"
+msgstr "Uw %s Gebruikersbenaming"
+
+
+# UNITS OF TIME
+
+msgid "second"
+msgstr "seconde"
+
+msgid "seconds"
+msgstr "seconden"
+
+msgid "minute"
+msgstr "notulen"
+
+msgid "minutes"
+msgstr "notulen"
+
+msgid "hour"
+msgstr "uur"
+
+msgid "hours"
+msgstr "uren"
+
+msgid "day"
+msgstr "dag"
+
+msgid "days"
+msgstr "dagen"
+
+msgid "month"
+msgstr "maand"
+
+msgid "months"
+msgstr "maanden"
+
+msgid "year"
+msgstr "jaar"
+
+msgid "years"
+msgstr "jaren"
\ No newline at end of file



From chiselwright at mail.berlios.de  Wed Mar 19 22:52:33 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 19 Mar 2008 22:52:33 +0100
Subject: [Parley-svn] r848 - / trunk trunk/lib/Parley/I18N
Message-ID: <200803192152.m2JLqXSA018715@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-19 22:52:32 +0100 (Wed, 19 Mar 2008)
New Revision: 848

Modified:
   /
   trunk/Changes
   trunk/Changes.i18n
   trunk/lib/Parley/I18N/nl.po
Log:
 r4777 at wiggin:  chisel | 2008-03-19 08:50:18 +0000
 / 



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4771
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4777
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes
===================================================================
--- trunk/Changes	2008-03-18 20:11:43 UTC (rev 847)
+++ trunk/Changes	2008-03-19 21:52:32 UTC (rev 848)
@@ -1,6 +1,7 @@
 This file documents the revision history for Parley.
 
 0.59 (UNDER DEVELOPMENT)
+    - added Dutch translation (Thanks Rob!)
     - user roles can now be assigned and removed
     - users can have their "suspended" flag set and removed
     - application can now prevent login/signup/posting/access by IP

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-03-18 20:11:43 UTC (rev 847)
+++ trunk/Changes.i18n	2008-03-19 21:52:32 UTC (rev 848)
@@ -42,6 +42,9 @@
             - "Locked Post"
             - "Post Edited By"
 
+    nl.po:
+        - full translation from i_default.po
+
 0.58
     (en renamed to i_default)
 

Modified: trunk/lib/Parley/I18N/nl.po
===================================================================
--- trunk/lib/Parley/I18N/nl.po	2008-03-18 20:11:43 UTC (rev 847)
+++ trunk/lib/Parley/I18N/nl.po	2008-03-19 21:52:32 UTC (rev 848)
@@ -110,7 +110,7 @@
 msgstr "Blijf lezend"
 
 msgid "Create New Thread"
-msgstr "Cre?er Nieuwe Draad"
+msgstr "Cre??er Nieuwe Draad"
 
 msgid "created by"
 msgstr "langs gecreeerd"
@@ -137,10 +137,10 @@
 msgstr "Gebrek"
 
 msgid "DFV FIELDS MISSING"
-msgstr "??n of meerdere vereiste gebieden missen."
+msgstr "??n of meerdere vereiste gebieden missen."
 
 msgid "DFV FIELDS INVALID"
-msgstr "??n of meerdere gebieden zijn ongeldig."
+msgstr "??n of meerdere gebieden zijn ongeldig."
 
 msgid "DFV FILL REQUIRED"
 msgstr "U moet alle vereiste gebieden invullen."
@@ -877,4 +877,4 @@
 msgstr "jaar"
 
 msgid "years"
-msgstr "jaren"
\ No newline at end of file
+msgstr "jaren"



From chiselwright at mail.berlios.de  Wed Mar 19 22:52:44 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 19 Mar 2008 22:52:44 +0100
Subject: [Parley-svn] r849 - / trunk/lib/Parley/Schema trunk/root/base
	trunk/root/base/shared trunk/root/base/user trunk/root/static/css
Message-ID: <200803192152.m2JLqiL3018843@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-19 22:52:43 +0100 (Wed, 19 Mar 2008)
New Revision: 849

Modified:
   /
   trunk/lib/Parley/Schema/Person.pm
   trunk/root/base/header
   trunk/root/base/shared/language_dialog
   trunk/root/base/shared/postinfo_table_row
   trunk/root/base/user/profile
   trunk/root/static/css/parley-min.css
   trunk/root/static/css/parley.css
Log:
 r4778 at wiggin:  chisel | 2008-03-19 09:04:01 +0000
 + Person method: can_moderate_forum()
 / made more room in "user info" area (removed 'Current User:')
 + added Dutch to the language selection dialog
 / improved layout/behaviour in language dialog
 / tweaked UI for table rows showing post info to better cope with long text (caused by .nl translation)
 / tweak CSS for same reason
 + add suspension/forum_moderator template code



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4777
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4778
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-03-19 21:52:32 UTC (rev 848)
+++ trunk/lib/Parley/Schema/Person.pm	2008-03-19 21:52:43 UTC (rev 849)
@@ -263,4 +263,27 @@
     );
 }
 
+sub can_moderate_forum {
+    my $record = shift;
+    my $forum_id = shift;
+    my $schema = $record->result_source()->schema();
+
+    my $results = $schema->resultset('ForumModerator')->find(
+        {
+            person_id       => $record->id(),
+            forum_id        => $forum_id,
+            can_moderate    => 1,
+        },
+        {
+            key     => 'forum_moderator_person_key',
+        }
+    );
+
+    if ($results) {
+        return 1;
+    }
+
+    return 0;
+}
+
 1;

Modified: trunk/root/base/header
===================================================================
--- trunk/root/base/header	2008-03-19 21:52:32 UTC (rev 848)
+++ trunk/root/base/header	2008-03-19 21:52:43 UTC (rev 849)
@@ -54,14 +54,14 @@
         <script type="text/javascript" src="[%c.uri_for('/static/script/ajax_error_dlg.js')%]"></script>
 
         <!-- defined styles for parley -->
-        <link type="text/css" rel="stylesheet" title="Simple" href="[%c.uri_for('/static/css/parley-min.css')%]" />
+        <link type="text/css" rel="stylesheet" title="Simple"
+            href="[%c.uri_for('/static/css/parley-min.css')%]" />
     </head>
 
     <body class="yui-skin-sam">
         <div id="doc3">
             <div id="hd">
                 <div id="user_information">
-                    [%l('Current User')%]:
                     [% IF authed_user %]
                     <em>[% authed_user.forum_name %]</em>
                     [% ELSE %]

Modified: trunk/root/base/shared/language_dialog
===================================================================
--- trunk/root/base/shared/language_dialog	2008-03-19 21:52:32 UTC (rev 848)
+++ trunk/root/base/shared/language_dialog	2008-03-19 21:52:43 UTC (rev 849)
@@ -68,6 +68,10 @@
         code    => 'it',
         name    => 'Italiano',
     },
+    {
+        code    => 'nl',
+        name    => 'Nederlands',
+    },
    ]
 %]
 
@@ -77,11 +81,15 @@
     </div>
     <div class="bd">
         [% FOR lang IN lang_data %]
+        <div style="float:left;width:110px;">
         <a href="[% c.uri_for('/') %]?lang=[%lang.code%]" style="margin-left:15px;">
             <img src="/static/images/icons/flags/[%lang.code%].png" width="16" height="11" alt="[%lang.name%]" />
             [%lang.name%]
         </a>
+        </div>
         [% END %]
+
+        <div style="margin-top:10px;clear:both;"></div>
     </div>
 </div>
 <!-- (end) LANGUAGE DIALOG -->

Modified: trunk/root/base/shared/postinfo_table_row
===================================================================
--- trunk/root/base/shared/postinfo_table_row	2008-03-19 21:52:32 UTC (rev 848)
+++ trunk/root/base/shared/postinfo_table_row	2008-03-19 21:52:43 UTC (rev 849)
@@ -45,7 +45,7 @@
     </td>
     [% END %]
 
-    <td width="80">
+    <td class="info_column">
         <div class="topic_creator">
             [% l('last post by ([_1])', thread.last_post.creator.forum_name) %]
         </div>
@@ -55,7 +55,7 @@
         </div>
     </td>
 
-    <td width="80">
+    <td class="info_column">
         <div class="topic_creator">
             [% l('created by ([_1])', thread.creator.forum_name) %]
         </div>
@@ -64,7 +64,7 @@
         </div>
     </td>
 
-    <td width="50">
+    <td class="info_column_counts">
         <div class="forum_postcount">
             [%# number of replies is one less than the number of posts %]
             [% SET tpc = (thread.post_count - 1) %]

Modified: trunk/root/base/user/profile
===================================================================
--- trunk/root/base/user/profile	2008-03-19 21:52:32 UTC (rev 848)
+++ trunk/root/base/user/profile	2008-03-19 21:52:43 UTC (rev 849)
@@ -55,35 +55,56 @@
     </div>
 
     [% IF authed_user.is_site_moderator || authed_user.can_suspend_account %]
-    <h2>[%l('Administration')%]</h2>
+        <h2>[%l('Administration')%]</h2>
 
-    [% IF authed_user.can_suspend_account %]
-        <div class="yui-gf top_padded">
-            <div class="yui-u first align_right">
-            [%l('Suspend Account')%]
-            </div>
-            <div class="yui-u">
-            <input
-                type="checkbox"
-                name="suspend_account"
-                id="suspend_account"
-                value="[%profiled_user.id%]"
-                [% IF profiled_user.suspended %]checked="true"[% END %]
-            >
-            </div>
-        </div>
-        [% IF profiled_user.suspended %]
+        [% IF authed_user.can_suspend_account %]
             <div class="yui-gf top_padded">
                 <div class="yui-u first align_right">
-                    [%l('Reason for suspension')%]:
+                [%l('Suspend Account')%]
                 </div>
                 <div class="yui-u">
-                    [% ForumCode.escape(profiled_user.last_suspension.message) ||l('No reason given') %]
+                <input
+                    type="checkbox"
+                    name="suspend_account"
+                    id="suspend_account"
+                    value="[%profiled_user.id%]"
+                    [% IF profiled_user.suspended %]checked="true"[% END %]
+                >
                 </div>
             </div>
+            [% IF profiled_user.suspended %]
+                <div class="yui-gf top_padded">
+                    <div class="yui-u first align_right">
+                        [%l('Reason for suspension')%]:
+                    </div>
+                    <div class="yui-u">
+                        [% ForumCode.escape(profiled_user.last_suspension.message) ||l('No reason given') %]
+                    </div>
+                </div>
+            [% END %]
         [% END %]
     [% END %]
 
+    [% IF authed_user.is_site_moderator %]
+        <h2>[%l('Forum Moderation')%]</h2>
+
+        [% SET dummy=available_forums.reset %]
+        [% WHILE (forum = available_forums.next) %]
+            <div class="yui-gf top_padded">
+                <div class="yui-u first align_right">
+                [%forum.name%]
+                </div>
+                <div class="yui-u">
+                <input
+                    type="checkbox"
+                    name="moderate_forum"
+                    id="moderate_forum"
+                    value="[%forum.id%]"
+                    [%IF profiled_user.can_moderate_forum(forum.id)%]checked="true"[% END %]
+                >
+                </div>
+            </div>
+        [% END %]
     [% END %]
 [% ELSE %]
     <p>[%l('PROFILE NOT FOUND')%]</p>
@@ -92,7 +113,9 @@
 
 
 <script type="text/javascript" src="[%c.uri_for('/static/script/user_suspend.js')%]"></script>
-<div id="suspend_reason_dialog">
+<script type="text/javascript" src="[%c.uri_for('/static/script/user_forum_moderate.js')%]"></script>
+
+<div id="suspend_reason_dialog" style="visibility:hidden;">
     <div class="hd">Please enter suspension information</div>
     <div class="bd">
         <form method="POST" action="assets/post.php">

Modified: trunk/root/static/css/parley-min.css
===================================================================
--- trunk/root/static/css/parley-min.css	2008-03-19 21:52:32 UTC (rev 848)
+++ trunk/root/static/css/parley-min.css	2008-03-19 21:52:43 UTC (rev 849)
@@ -1 +1 @@
-#hd{height:80px;line-height:80px;margin:0;padding-left:10px;background:#EEE url('/static/images/parley_logo.jpg') no-repeat left;color:#79B30B;}#hd h1{font-size:200%;text-align:left;}div#ft{background:#666;color:#FFF;font-size:77%;margin-top:20px;}div#ft p{border:none;margin-top:30px;padding:5px 10px 5px 10px;text-align:right;display:block;}div#ft a{color:#ccc;}div#user_information{line-height:1em;font-size:85%;color:#000;background-color:transparent;position:absolute;top:0;right:10px;height:70px;width:200px;padding-top:3px;text-align:center;}div#user_information .user_info_actions{margin-top:3px;}.caretfix{overflow:auto;}#bd h1{font-weight:bold;background:#666;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h2{font-weight:bold;background:#999;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h3{font-weight:bold;background:#eee;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;color:#79B30B;}a.nav:hover{background:#000;color:#fff!
 ;}a,a:link,a:visited,a:active{background:transparent;color:blue;text-decoration:none;}th{font-size:100%;text-align:left;font-weight:bold;}#login_dialog form{margin:0;padding:0;min-width:400px;max-width:600px;}#login_dialog form fieldset{/ * clear:both;note that this clear causes inputs to break to left in ie5.x mac,commented out */ padding:10px;margin:0;border:none;}#login_dialog form label{display:block;float:left;width:150px;padding:0;margin:5px 0 0;text-align:right;font-weight:bold;margin-bottom:0;}#login_dialog form input,form textarea{width:auto;margin:5px 0 0 10px;}#login_dialog form p{font-size:85%;}.row{border-top:1px dotted #666;border-bottom:1px dotted #666;}.row_odd{background:#eee;}.row_even{background:#ddd;}.admin_edited_post{color:#000;background:#ccc;padding:2px;padding-left:10px;padding-right:10px;border:1px dashed #000;margin-left:15px;font-size:93%;text-align:right;}.align_right{text-align:right;}.forum_description{font-size:93%;}.forum_lastpost{font-size:!
 85%;text-align:right;}.forum_lastpost_subject a{color:#333;col!
 or:#79B3
0B;}.forum_link{font-size:100%;font-weight:bold;}.forum_list{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_list td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.forum_mini_pager{font-size:85%;}.forum_mini_pager a{color:#666;}.forum_name{font-size:100%;text-align:left;font-weight:bold;margin-top:5px;}.forum_name a{color:#333;color:#79B30B;}.forum_postcount{font-size:85%;text-align:right;margin-top:5px;}.forum_view{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_view td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.help li{margin-top:25px;margin-right:25px;list-style-type:none;border-left:2px solid #666;padding-top:5px;padding-bottom:5px;padding-left:10px;background-color:#ddd;}.help li ul li,.help li ol li{margin-top:5px;margin-left:10px;list-style-type:disc;border-left:none;pa!
 dding-left:none;padding-top:none;padding-bottom:none;background-color:transparent;}.innerpost{margin-left:10px;padding:5px;overflow:auto;font-size:93%;}.moderator_list{font-size:77%;margin-bottom:5px;margin-top:5px;text-align:right;}.pager_advanced{font-size:77%;margin-bottom:5px;margin-top:5px;}.post{padding-top:5px;vertical-align:top;border-left:1px solid #ddd;}.post_created{text-align:right;font-size:85%;}.post_creator{font-weight:bold;font-style:italic;font-size:85%;}.post_edited_alert{font-weight:bold;font-style:italic;}.post_info{font-size:77%;line-height:1.1em;margin-top:10px;margin-bottom:2px;text-align:right;}.post_subject{font-weight:bold;}.quote{background-color:#F9FBFF;border:1px solid #333;font-size:85%;margin:0 0 2px 4px;padding:6px;width:85%;overflow:hidden;}.recently_updated{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.recently_updated td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px!
 ;padding-right:10px;}.reply_post_message{border:1px dashed #66!
 6;}.sear
ch_match_context{font-size:85%;}.search_results{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.search_results td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;}.site_terms{width:80%;margin-left:auto;margin-right:auto;margin-bottom:10px;padding:5px;border:1px solid #666;}.thread_add{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_add td{padding-top:4px;padding-bottom:4px;}.thread_add .input_text{width:450px;margin-left:10px;}.thread_add_topic{text-align:right;padding-right:5px;}.thread_add_message{text-align:right;vertical-align:top;padding-right:5px;}.thread_header{font-weight:bold;background:#666;padding:4px;text-align:left;}.thread_header a{color:#ccc;}.thread_info{margin:0;width:100%;border:none;padding:0;margin-bottom:10px;}.thread_info td{border:none;padding:0;}.thread_lastpost{font-size:85%;text-align:right!
 ;}.thread_post_row{border-top:1px solid #ddd;border-bottom:1px solid #ddd;}.thread_post_row td{margin-top:10px;margin-bottom:10px;}.thread_posts{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_recent_forum{float:right;font-size:85%;}.thread_recent_forum a{color:#333;}.thread_reply{font-size:93%;}.thread_reply tr{vertical-align:top;}.thread_reply td{padding-top:10px;padding-left:10px;}.thread_reply textarea{background-color:transparent;border:2px inset black;}.thread_subject a{font-size:93%;color:#333;color:#79B30B;}.thread_watch{margin-top:5px;font-size:77%;text-align:left;}.top_padded{margin-top:10px;}.topic_creator{display:block;font-size:85%;text-align:right;}.user_login form{width:350px;margin-left:auto;margin-right:auto;margin-top:20px;}.user_login p{margin-top:5px;margin-bottom:5px;}.user_permission_list{margin-left:auto;margin-right:auto;margin-top:15px;font-size:93%;width:100%;}.user_permission_list td{vertical-align:top;border:1!
 px dashed #ddd;border:none;line-height:150%;padding-left:10px;!
 padding-
right:10px;padding-top:5px;padding-bottom:5px;}.user_permission_list img{vertical-align:middle;}.user_post_info{background:#ccc;background:transparent;font-size:77%;margin-left:auto;margin-right:auto;text-align:center;vertical-align:top;width:110px;}a[href $='.jpg']{padding-left:20px;background:transparent url(/static/images/filetypes/image.png) no-repeat center left;}a[href $='.pdf']{padding-left:20px;background:transparent url(/static/images/filetypes/pdf.png) no-repeat center left;}#loader_wait.yui-overlay{position:fixed;float:right;top:10px;right:10px;border:none;text-align:right;}#preview_overlay{border:1px dashed #ccc;text-align:left;padding:0;}#thread_message{font-family:monospace;text-align:left;padding:0;background-color:#eee;font-size:93%;width:450px;}#ysearch{text-align:center;}#ysearchinput{position:static;width:20em;}#ysearchcontainer{text-align:left;width:20em;}.forumcode_code{font-family:monospace;border:1px solid #333;font-size:85%;margin:15px 20px 15px 20px;!
 padding:6px;width:85%;overflow:auto;color:#ff0;background-color:#333;border:1px solid #666;white-space:pre;}.forumcode_pre{background-color:transparent;font-family:monospace;border:1px dashed #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;white-space:pre;}.forumcode_quote{background-color:#eee;font-family:monospace;font-style:italic;border:1px dotted #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;}.forumcode_quoting{font-weight:bold;margin-bottom:3px;}.yuimenuitem .disabled{color:#A6A6A6;cursor:default;}.yui-skin-sam .yui-navset .yui-nav,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav{border:solid #333;border-width:0 0 5px;Xposition:relative;zoom:1;}.yui-skin-sam .yui-navset .yui-content{background:transparent;}.yui-skin-sam .yui-navset .yui-nav a,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav a{background-image:none;background-color:#999;border:solid #a3a3a3;border-width:0 1px;color:#fff;text-deco!
 ration:none;}.yui-skin-sam .yui-navset .yui-nav .selected a,.y!
 ui-skin-
sam .yui-navset .yui-nav .selected a:focus,.yui-skin-sam .yui-navset .yui-nav .selected a:hover{background:#333;color:#fff;}.yui-skin-sam .yui-navset .yui-nav a:hover,.yui-skin-sam .yui-navset .yui-nav a:focus{background:#666;color:#fff;outline:0;}
\ No newline at end of file
+#hd{height:80px;line-height:80px;margin:0;padding-left:10px;background:#EEE url('/static/images/parley_logo.jpg') no-repeat left;color:#79B30B;}#hd h1{font-size:200%;text-align:left;}div#ft{background:#666;color:#FFF;font-size:77%;margin-top:20px;}div#ft p{border:none;margin-top:30px;padding:5px 10px 5px 10px;text-align:right;display:block;}div#ft a{color:#ccc;}div#user_information{line-height:1em;font-size:85%;color:#000;background-color:transparent;position:absolute;top:0;right:10px;height:70px;width:200px;padding-top:3px;text-align:center;}div#user_information .user_info_actions{margin-top:3px;}.caretfix{overflow:auto;}#bd h1{font-weight:bold;background:#666;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h2{font-weight:bold;background:#999;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h3{font-weight:bold;background:#eee;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;color:#79B30B;}a.nav:hover{background:#000;color:#fff!
 ;}a,a:link,a:visited,a:active{background:transparent;color:blue;text-decoration:none;}th{font-size:100%;text-align:left;font-weight:bold;}#login_dialog form{margin:0;padding:0;min-width:400px;max-width:600px;}#login_dialog form fieldset{/ * clear:both;note that this clear causes inputs to break to left in ie5.x mac,commented out */ padding:10px;margin:0;border:none;}#login_dialog form label{display:block;float:left;width:150px;padding:0;margin:5px 0 0;text-align:right;font-weight:bold;margin-bottom:0;}#login_dialog form input,form textarea{width:auto;margin:5px 0 0 10px;}#login_dialog form p{font-size:85%;}.row{border-top:1px dotted #666;border-bottom:1px dotted #666;}.row_odd{background:#eee;}.row_even{background:#ddd;}.admin_edited_post{color:#000;background:#ccc;padding:2px;padding-left:10px;padding-right:10px;border:1px dashed #000;margin-left:15px;font-size:93%;text-align:right;}.align_right{text-align:right;}.forum_description{font-size:93%;}.forum_lastpost{font-size:!
 85%;text-align:right;}.forum_lastpost_subject a{color:#333;col!
 or:#79B3
0B;}.forum_link{font-size:100%;font-weight:bold;}.forum_list{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_list td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.forum_mini_pager{font-size:85%;}.forum_mini_pager a{color:#666;}.forum_name{font-size:100%;text-align:left;font-weight:bold;margin-top:5px;}.forum_name a{color:#333;color:#79B30B;}.forum_postcount{font-size:85%;text-align:right;margin-top:5px;}.forum_view{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_view td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.help li{margin-top:25px;margin-right:25px;list-style-type:none;border-left:2px solid #666;padding-top:5px;padding-bottom:5px;padding-left:10px;background-color:#ddd;}.help li ul li,.help li ol li{margin-top:5px;margin-left:10px;list-style-type:disc;border-left:none;pa!
 dding-left:none;padding-top:none;padding-bottom:none;background-color:transparent;}.innerpost{margin-left:10px;padding:5px;overflow:auto;font-size:93%;}.moderator_list{font-size:77%;margin-bottom:5px;margin-top:5px;text-align:right;}.pager_advanced{font-size:77%;margin-bottom:5px;margin-top:5px;}.post{padding-top:5px;vertical-align:top;border-left:1px solid #ddd;}.post_created{text-align:right;font-size:85%;}.post_creator{font-weight:bold;font-style:italic;font-size:85%;}.post_edited_alert{font-weight:bold;font-style:italic;}.post_info{font-size:77%;line-height:1.1em;margin-top:10px;margin-bottom:2px;text-align:right;}.post_subject{font-weight:bold;}.quote{background-color:#F9FBFF;border:1px solid #333;font-size:85%;margin:0 0 2px 4px;padding:6px;width:85%;overflow:hidden;}.recently_updated{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.recently_updated td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px!
 ;padding-right:10px;}.reply_post_message{border:1px dashed #66!
 6;}.sear
ch_match_context{font-size:85%;}.search_results{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.search_results td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;}.site_terms{width:80%;margin-left:auto;margin-right:auto;margin-bottom:10px;padding:5px;border:1px solid #666;}.thread_add{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_add td{padding-top:4px;padding-bottom:4px;}.thread_add .input_text{width:450px;margin-left:10px;}.thread_add_topic{text-align:right;padding-right:5px;}.thread_add_message{text-align:right;vertical-align:top;padding-right:5px;}.thread_header{font-weight:bold;background:#666;padding:4px;text-align:left;}.thread_header a{color:#ccc;}.thread_info{margin:0;width:100%;border:none;padding:0;margin-bottom:10px;}.thread_info td{border:none;padding:0;}.thread_lastpost{font-size:85%;text-align:right!
 ;}.thread_post_row{border-top:1px solid #ddd;border-bottom:1px solid #ddd;}.thread_post_row td{margin-top:10px;margin-bottom:10px;}.thread_posts{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_recent_forum{float:right;font-size:85%;}.thread_recent_forum a{color:#333;}.thread_reply{font-size:93%;}.thread_reply tr{vertical-align:top;}.thread_reply td{padding-top:10px;padding-left:10px;}.thread_reply textarea{background-color:transparent;border:2px inset black;}.thread_subject a{font-size:93%;color:#333;color:#79B30B;}.thread_watch{margin-top:5px;font-size:77%;text-align:left;}.top_padded{margin-top:10px;}.info_column{min-width:80px;max-width:125px;}.topic_creator{display:block;font-size:85%;text-align:right;}.user_login form{width:350px;margin-left:auto;margin-right:auto;margin-top:20px;}.user_login p{margin-top:5px;margin-bottom:5px;}.user_permission_list{margin-left:auto;margin-right:auto;margin-top:15px;font-size:93%;width:100%;}.user_p!
 ermission_list td{vertical-align:top;border:1px dashed #ddd;bo!
 rder:non
e;line-height:150%;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;}.user_permission_list img{vertical-align:middle;}.user_post_info{background:#ccc;background:transparent;font-size:77%;margin-left:auto;margin-right:auto;text-align:center;vertical-align:top;width:110px;}a[href $='.jpg']{padding-left:20px;background:transparent url(/static/images/filetypes/image.png) no-repeat center left;}a[href $='.pdf']{padding-left:20px;background:transparent url(/static/images/filetypes/pdf.png) no-repeat center left;}#loader_wait.yui-overlay{position:fixed;float:right;top:10px;right:10px;border:none;text-align:right;}#preview_overlay{border:1px dashed #ccc;text-align:left;padding:0;}#thread_message{font-family:monospace;text-align:left;padding:0;background-color:#eee;font-size:93%;width:450px;}#ysearch{text-align:center;}#ysearchinput{position:static;width:20em;}#ysearchcontainer{text-align:left;width:20em;}.forumcode_code{font-family:monospace;border:1px solid #!
 333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;color:#ff0;background-color:#333;border:1px solid #666;white-space:pre;}.forumcode_pre{background-color:transparent;font-family:monospace;border:1px dashed #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;white-space:pre;}.forumcode_quote{background-color:#eee;font-family:monospace;font-style:italic;border:1px dotted #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;}.forumcode_quoting{font-weight:bold;margin-bottom:3px;}.yuimenuitem .disabled{color:#A6A6A6;cursor:default;}.yui-skin-sam .yui-navset .yui-nav,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav{border:solid #333;border-width:0 0 5px;Xposition:relative;zoom:1;}.yui-skin-sam .yui-navset .yui-content{background:transparent;}.yui-skin-sam .yui-navset .yui-nav a,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav a{background-image:none;background-color:#999;border:solid #a!
 3a3a3;border-width:0 1px;color:#fff;text-decoration:none;}.yui!
 -skin-sa
m .yui-navset .yui-nav .selected a,.yui-skin-sam .yui-navset .yui-nav .selected a:focus,.yui-skin-sam .yui-navset .yui-nav .selected a:hover{background:#333;color:#fff;}.yui-skin-sam .yui-navset .yui-nav a:hover,.yui-skin-sam .yui-navset .yui-nav a:focus{background:#666;color:#fff;outline:0;}
\ No newline at end of file

Modified: trunk/root/static/css/parley.css
===================================================================
--- trunk/root/static/css/parley.css	2008-03-19 21:52:32 UTC (rev 848)
+++ trunk/root/static/css/parley.css	2008-03-19 21:52:43 UTC (rev 849)
@@ -241,6 +241,12 @@
     background-color:   transparent;
 }
 
+.info_column {
+}
+
+.info_column_counts {
+}
+
 .innerpost {
     margin-left:        10px;
     padding:            5px;



From chiselwright at mail.berlios.de  Thu Mar 20 21:19:19 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 20 Mar 2008 21:19:19 +0100
Subject: [Parley-svn] r850 - / trunk trunk/db trunk/lib
	trunk/lib/Parley/Controller trunk/lib/Parley/Schema
	trunk/root/base/menu trunk/root/base/site
	trunk/root/base/user trunk/root/static/css
	trunk/root/static/images/icons trunk/root/static/script
Message-ID: <200803202019.m2KKJJsq013878@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-20 21:19:17 +0100 (Thu, 20 Mar 2008)
New Revision: 850

Added:
   trunk/root/static/images/icons/page_edit.png
   trunk/root/static/script/user_forum_moderate.js
Modified:
   /
   trunk/Makefile.PL
   trunk/db/patch_0.58_to_0.59.psql
   trunk/lib/Parley.pm
   trunk/lib/Parley/Controller/Root.pm
   trunk/lib/Parley/Controller/Site.pm
   trunk/lib/Parley/Schema/ForumModerator.pm
   trunk/lib/Parley/Schema/Person.pm
   trunk/root/base/menu/menubar
   trunk/root/base/site/ip_bans
   trunk/root/base/user/profile
   trunk/root/static/css/parley-min.css
   trunk/root/static/css/parley.css
Log:
 r4781 at wiggin:  chisel | 2008-03-20 20:13:05 +0000
 + added ACL plugin to Makefile.PL
 + add PK to forum_moderator table (keeps DBIC update_or_create() happy
 / removed hand-made access control (for /site)
 + restrict access to /site urls with ACL plugin
 + add functionality to add/remove forum mods
 + add ACL/role functions to Person class
 / alter ip_bans template so you can only edit items you have permisison for



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4778
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4781
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Makefile.PL
===================================================================
--- trunk/Makefile.PL	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/Makefile.PL	2008-03-20 20:19:17 UTC (rev 850)
@@ -11,6 +11,7 @@
 requires 'Catalyst::Plugin::Authentication';
 requires 'Catalyst::Plugin::Authentication::Credential::Password';
 requires 'Catalyst::Plugin::Authentication::Store::DBIC';
+requires 'Catalyst::Plugin::Authorization::ACL';
 requires 'Catalyst::Plugin::ConfigLoader';
 requires 'Catalyst::Plugin::Dumper';
 requires 'Catalyst::Plugin::Email';

Modified: trunk/db/patch_0.58_to_0.59.psql
===================================================================
--- trunk/db/patch_0.58_to_0.59.psql	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/db/patch_0.58_to_0.59.psql	2008-03-20 20:19:17 UTC (rev 850)
@@ -8,6 +8,7 @@
 --  allow user accounts to be suspended
 --  logging of admin actions on users (e.g. why suspended)
 --  table support for various per-ip bans
+--  add PK to forum_moderator table
 
 BEGIN;
 
@@ -127,6 +128,8 @@
     UNIQUE(ban_type_id)
 );
 
+ALTER TABLE forum_moderator
+    ADD COLUMN id SERIAL primary key;
 
 -- patch ends here --
 

Modified: trunk/lib/Parley/Controller/Root.pm
===================================================================
--- trunk/lib/Parley/Controller/Root.pm	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/lib/Parley/Controller/Root.pm	2008-03-20 20:19:17 UTC (rev 850)
@@ -276,6 +276,10 @@
     $c->response->body( $c->localize('404 Not Found') );
 }
 
+sub access_denied :Local {
+    my ($self, $c) = @_;
+    parley_die($c,"Unauthorized!");
+}
 
 # deal with the end of the phase
 sub render : ActionClass('RenderView') {

Modified: trunk/lib/Parley/Controller/Site.pm
===================================================================
--- trunk/lib/Parley/Controller/Site.pm	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/lib/Parley/Controller/Site.pm	2008-03-20 20:19:17 UTC (rev 850)
@@ -12,29 +12,8 @@
 
 use Parley::App::Error qw( :methods );
 
-sub auto : Private {
-    my ($self, $c) = @_;
+# there are ACL rules in Parley.pm #
 
-    if (not $c->stash->{site_moderator}) {
-        parley_warn($c, $c->localize(q{SITE MODERATOR REQUIRED}));
-
-        $c->response->redirect(
-            $c->uri_for(
-                $c->config->{default_uri}
-            )
-        );
-        return 0;
-    }
-
-    return 1;
-}
-
-sub index : Private {
-    my ( $self, $c ) = @_;
-
-    $c->response->body('Matched Parley::Controller::Site in Site.');
-}
-
 sub ip_bans :Local {
     my ($self, $c) = @_;
 
@@ -227,6 +206,55 @@
     return;
 }
 
+sub fmodSaveHandler :Local {
+    my ($self, $c) = @_;
+    my ($fieldname, $return_data, $json);
+    my ($value, $person_id, $forum_id);
+
+    $return_data->{updated}     = 0;
+
+    eval {
+        $value      = $c->request->param('value');
+        $person_id  = $c->request->param('person');
+        $forum_id   = $c->request->param('forum');
+
+        $c->model('ParleyDB')->schema->txn_do(
+            sub {
+                $c->model('ParleyDB::ForumModerator')->update_or_create(
+                    {
+                        person_id       => $person_id,
+                        forum_id        => $forum_id,
+                        can_moderate    => $value,
+                    },
+                    {
+                        key => 'forum_moderator_person_key',
+                    }
+                );
+                $return_data->{updated} = 1;
+            }
+        )
+    };
+    # deal with any transaction errors
+    if ($@) {                                   # Transaction failed
+        die "something terrible has happened!"  #
+            if ($@ =~ /Rollback failed/);       # Rollback failed
+
+        $return_data->{error}{message} =
+            qq{Database transaction failed: $@};
+        $c->log->error( $@ );
+        $json = to_json($return_data);
+        $c->response->body( $json );
+        return;
+    }
+
+    # return some JSON
+    $json = to_json($return_data);
+    $c->response->body( $json );
+    $c->log->info( $json );
+    return;
+}
+
+
 sub saveBanHandler :Local {
     my ($self, $c) = @_;
     my ($fieldname, $return_data, $json);

Modified: trunk/lib/Parley/Schema/ForumModerator.pm
===================================================================
--- trunk/lib/Parley/Schema/ForumModerator.pm	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/lib/Parley/Schema/ForumModerator.pm	2008-03-20 20:19:17 UTC (rev 850)
@@ -9,6 +9,8 @@
 __PACKAGE__->load_components('PK::Auto', 'Core');
 __PACKAGE__->table('forum_moderator');
 __PACKAGE__->add_columns(
+    id => {},
+
     person_id => {
         data_type       => "integer",
         default_value   => undef,
@@ -31,6 +33,8 @@
     },
 );
 
+__PACKAGE__->set_primary_key(qw/id/);
+
 __PACKAGE__->add_unique_constraint(
     'forum_moderator_person_key',
     ['person_id', 'forum_id']

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/lib/Parley/Schema/Person.pm	2008-03-20 20:19:17 UTC (rev 850)
@@ -170,6 +170,34 @@
     return ($rs->count == scalar(@roles) || 0);
 }
 
+sub check_any_user_role {
+    my $record = shift;
+    my @roles  = @_;
+
+    return
+        if (not @roles);
+
+    my ($schema, $rs);
+
+    $schema = $record->result_source()->schema();
+
+    $rs = $schema->resultset('Role')->search(
+        {
+            'map_user_role.person_id'   => $record->id(),
+            'me.name' => {
+                -in => \@roles,
+            },
+        },
+        {
+            prefetch => [
+                { 'map_user_role' => 'person' },
+            ],
+        },
+    );
+
+    return ($rs->count > 0);
+}
+
 # suspend a user (and log a message at the same time)
 sub set_suspended {
     my ($record, $args) = @_;
@@ -258,28 +286,44 @@
 sub can_suspend_account {
     my $record = shift;
 
-    return $record->check_user_roles(
-        'site_moderator'
+    return $record->check_any_user_role(
+        'site_moderator', 'suspend_account'
     );
 }
+# thin wrapper around check_any_user_role() for convenience
+sub can_ip_ban {
+    my $record = shift;
 
+    return $record->check_any_user_role(
+        'site_moderator', 'ip_ban_posting', 'ip_ban_signup', 'ip_ban_login'
+    );
+}
+
+sub can_view_site_menu {
+    my $record = shift;
+
+    return $record->check_any_user_role(
+        'site_moderator', 'ip_ban_posting', 'ip_ban_signup', 'ip_ban_login'
+    );
+}
+
 sub can_moderate_forum {
     my $record = shift;
     my $forum_id = shift;
     my $schema = $record->result_source()->schema();
 
-    my $results = $schema->resultset('ForumModerator')->find(
+    my $results = $schema->resultset('ForumModerator')->search(
         {
             person_id       => $record->id(),
             forum_id        => $forum_id,
             can_moderate    => 1,
         },
         {
-            key     => 'forum_moderator_person_key',
+            #key     => 'forum_moderator_person_key',
         }
     );
 
-    if ($results) {
+    if ($results->count) {
         return 1;
     }
 

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/lib/Parley.pm	2008-03-20 20:19:17 UTC (rev 850)
@@ -27,6 +27,7 @@
     Authentication::Credential::Password
 
     Authorization::Roles
+    Authorization::ACL
 
     I18N
 /;
@@ -39,6 +40,66 @@
 # only show certain log levels in output
 __PACKAGE__->log (Catalyst::Log->new( @{__PACKAGE__->config->{log_levels}} ));
 
+
+# ---- START: ACL RULES ----
+
+#
+# /site
+#
+##__PACKAGE__->deny_access_unless(
+##    '/site/ip_bans',
+##    [$_]
+##)
+##for qw/ip_ban_posting site_moderator/;
+
+__PACKAGE__->deny_access_unless(
+    '/site/fmodSaveHandler',
+    [qw/site_moderator/]
+);
+__PACKAGE__->deny_access_unless(
+    '/site/ip_bans',
+    sub {
+        my $c = shift;
+        $c->check_any_user_role(
+            qw/site_moderator ip_ban_posting ip_ban_signup ip_ban_login/
+        )
+    }
+);
+__PACKAGE__->deny_access_unless(
+    '/site/roleSaveHandler',
+    [qw/site_moderator/]
+);
+__PACKAGE__->deny_access_unless(
+    '/site/saveBanHandler',
+    sub {
+        my $c = shift;
+        $c->check_any_user_role(
+            qw/site_moderator ip_ban_posting ip_ban_signup ip_ban_login/
+        )
+    }
+);
+__PACKAGE__->deny_access_unless(
+    '/site/services',
+    [qw/site_moderator/]
+);
+__PACKAGE__->deny_access_unless(
+    '/site/user',
+    [qw/site_moderator/]
+);
+__PACKAGE__->deny_access_unless(
+    '/site/users',
+    [qw/site_moderator/]
+);
+__PACKAGE__->deny_access_unless(
+    '/site/users_autocomplete',
+    [qw/site_moderator/]
+);
+
+
+# ---- END:   ACL RULES ----
+
+
+
 # I'm sure there's a (better) way to do this by overriding set()/get() in Class::Accessor
 {
     sub set_get {

Modified: trunk/root/base/menu/menubar
===================================================================
--- trunk/root/base/menu/menubar	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/base/menu/menubar	2008-03-20 20:19:17 UTC (rev 850)
@@ -110,19 +110,27 @@
                 </div>                                        
             </li>
             [% END %]
-            [% IF site_moderator %]
+            [% IF authed_user.can_view_site_menu %]
             <li class="yuimenubaritem"><a class="yuimenubaritemlabel" href="#">[%l('Site')%]</a>
                 <div id="menu_site_moderate" class="yuimenu">
                     <div class="bd">                                        
                         <ul>
+                            [% IF authed_user.is_site_moderator %]
                             <li class="yuimenuitem"><a class="yuimenuitemlabel" href="terms/add">[%l('Add T-and-Cs')%]</a></li>
+                            [% END %]
                             <li class="yuimenuitem"><a class="yuimenuitemlabel" href="#">[%l('Manage')%]</a>
                                 <div id="site" class="yuimenu">
                                     <div class="bd">
                                         <ul class="first-of-type">
+                                            [% IF authed_user.is_site_moderator %]
                                             <li class="yuimenuitem"><a class="yuimenuitemlabel" href="site/services">[%l('Services')%]</a></li>
+                                            [% END %]
+                                            [% IF authed_user.is_site_moderator %]
                                             <li class="yuimenuitem"><a class="yuimenuitemlabel" href="site/users">[%l('Users')%]</a></li>
+                                            [% END %]
+                                            [% IF authed_user.can_ip_ban %]
                                             <li class="yuimenuitem"><a class="yuimenuitemlabel" href="site/ip_bans">[%l('IP Bans')%]</a></li>
+                                            [% END %]
                                         </ul>            
                                     </div>
                                 </div>                    

Modified: trunk/root/base/site/ip_bans
===================================================================
--- trunk/root/base/site/ip_bans	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/base/site/ip_bans	2008-03-20 20:19:17 UTC (rev 850)
@@ -1,13 +1,24 @@
 <h1>[%l('IP Bans')%]</h1>
 [% WHILE (ban_type = ip_ban_types.next) %]
-<h2 class="top_padded">[% ban_type.description %]</h2>
-    [% bans = ban_type.ip_bans_rs %]
+    [% role_name = 'ip_ban_' _ ban_type.name %]
+    [% has_role  = authed_user.check_any_user_role('site_moderator', role_name) %]
+    [% IF has_role %][% eclass="editable" %][% ELSE %][% eclass="noneditable" %][% END %]
+    [% bans      = ban_type.ip_bans_rs %]
+
+<h2 class="top_padded">
+    [% ban_type.description %]
+</h2>
+    [% IF has_role %]
+    <img src="/static/images/icons/page_edit.png" width="16" height="16" />
+    [% ELSE %]
+    <img src="/static/images/icons/lock.png" width="16" height="16" />
+    [% END %]
     [% IF bans.count %]
         [% WHILE (ip_ban = bans.next) %]
-        <span id="ipban_[%ip_ban.id%]" class="editable">[%ip_ban.ip_range%]</span>
+        <span id="ipban_[%ip_ban.id%]" class="[%eclass%]">[%ip_ban.ip_range%]</span>
         [% END %]
     [% ELSE %]
-        <span id="ipbannewtype_[%ban_type.id%]" class="editable">None</span>
+        <span id="ipbannewtype_[%ban_type.id%]" class="[%eclass%]">None</span>
     [% END %]
 [% END %]
 

Modified: trunk/root/base/user/profile
===================================================================
--- trunk/root/base/user/profile	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/base/user/profile	2008-03-20 20:19:17 UTC (rev 850)
@@ -90,18 +90,19 @@
 
         [% SET dummy=available_forums.reset %]
         [% WHILE (forum = available_forums.next) %]
-            <div class="yui-gf top_padded">
+            <div class="yui-gf top_padded forum_moderator_list">
                 <div class="yui-u first align_right">
                 [%forum.name%]
                 </div>
                 <div class="yui-u">
                 <input
                     type="checkbox"
+                    class="fmod_checkbox"
                     name="moderate_forum"
-                    id="moderate_forum"
-                    value="[%forum.id%]"
+                    id="moderateforum_[%forum.id%]"
                     [%IF profiled_user.can_moderate_forum(forum.id)%]checked="true"[% END %]
                 >
+                    <span id="status_[%forum.id%]"></span>
                 </div>
             </div>
         [% END %]
@@ -113,6 +114,11 @@
 
 
 <script type="text/javascript" src="[%c.uri_for('/static/script/user_suspend.js')%]"></script>
+<script type="text/javascript">
+    var person = {
+        id: [%profiled_user.id%]
+    };
+</script>
 <script type="text/javascript" src="[%c.uri_for('/static/script/user_forum_moderate.js')%]"></script>
 
 <div id="suspend_reason_dialog" style="visibility:hidden;">

Modified: trunk/root/static/css/parley-min.css
===================================================================
--- trunk/root/static/css/parley-min.css	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/static/css/parley-min.css	2008-03-20 20:19:17 UTC (rev 850)
@@ -1 +1 @@
-#hd{height:80px;line-height:80px;margin:0;padding-left:10px;background:#EEE url('/static/images/parley_logo.jpg') no-repeat left;color:#79B30B;}#hd h1{font-size:200%;text-align:left;}div#ft{background:#666;color:#FFF;font-size:77%;margin-top:20px;}div#ft p{border:none;margin-top:30px;padding:5px 10px 5px 10px;text-align:right;display:block;}div#ft a{color:#ccc;}div#user_information{line-height:1em;font-size:85%;color:#000;background-color:transparent;position:absolute;top:0;right:10px;height:70px;width:200px;padding-top:3px;text-align:center;}div#user_information .user_info_actions{margin-top:3px;}.caretfix{overflow:auto;}#bd h1{font-weight:bold;background:#666;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h2{font-weight:bold;background:#999;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h3{font-weight:bold;background:#eee;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;color:#79B30B;}a.nav:hover{background:#000;color:#fff!
 ;}a,a:link,a:visited,a:active{background:transparent;color:blue;text-decoration:none;}th{font-size:100%;text-align:left;font-weight:bold;}#login_dialog form{margin:0;padding:0;min-width:400px;max-width:600px;}#login_dialog form fieldset{/ * clear:both;note that this clear causes inputs to break to left in ie5.x mac,commented out */ padding:10px;margin:0;border:none;}#login_dialog form label{display:block;float:left;width:150px;padding:0;margin:5px 0 0;text-align:right;font-weight:bold;margin-bottom:0;}#login_dialog form input,form textarea{width:auto;margin:5px 0 0 10px;}#login_dialog form p{font-size:85%;}.row{border-top:1px dotted #666;border-bottom:1px dotted #666;}.row_odd{background:#eee;}.row_even{background:#ddd;}.admin_edited_post{color:#000;background:#ccc;padding:2px;padding-left:10px;padding-right:10px;border:1px dashed #000;margin-left:15px;font-size:93%;text-align:right;}.align_right{text-align:right;}.forum_description{font-size:93%;}.forum_lastpost{font-size:!
 85%;text-align:right;}.forum_lastpost_subject a{color:#333;col!
 or:#79B3
0B;}.forum_link{font-size:100%;font-weight:bold;}.forum_list{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_list td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.forum_mini_pager{font-size:85%;}.forum_mini_pager a{color:#666;}.forum_name{font-size:100%;text-align:left;font-weight:bold;margin-top:5px;}.forum_name a{color:#333;color:#79B30B;}.forum_postcount{font-size:85%;text-align:right;margin-top:5px;}.forum_view{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_view td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.help li{margin-top:25px;margin-right:25px;list-style-type:none;border-left:2px solid #666;padding-top:5px;padding-bottom:5px;padding-left:10px;background-color:#ddd;}.help li ul li,.help li ol li{margin-top:5px;margin-left:10px;list-style-type:disc;border-left:none;pa!
 dding-left:none;padding-top:none;padding-bottom:none;background-color:transparent;}.innerpost{margin-left:10px;padding:5px;overflow:auto;font-size:93%;}.moderator_list{font-size:77%;margin-bottom:5px;margin-top:5px;text-align:right;}.pager_advanced{font-size:77%;margin-bottom:5px;margin-top:5px;}.post{padding-top:5px;vertical-align:top;border-left:1px solid #ddd;}.post_created{text-align:right;font-size:85%;}.post_creator{font-weight:bold;font-style:italic;font-size:85%;}.post_edited_alert{font-weight:bold;font-style:italic;}.post_info{font-size:77%;line-height:1.1em;margin-top:10px;margin-bottom:2px;text-align:right;}.post_subject{font-weight:bold;}.quote{background-color:#F9FBFF;border:1px solid #333;font-size:85%;margin:0 0 2px 4px;padding:6px;width:85%;overflow:hidden;}.recently_updated{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.recently_updated td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px!
 ;padding-right:10px;}.reply_post_message{border:1px dashed #66!
 6;}.sear
ch_match_context{font-size:85%;}.search_results{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.search_results td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;}.site_terms{width:80%;margin-left:auto;margin-right:auto;margin-bottom:10px;padding:5px;border:1px solid #666;}.thread_add{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_add td{padding-top:4px;padding-bottom:4px;}.thread_add .input_text{width:450px;margin-left:10px;}.thread_add_topic{text-align:right;padding-right:5px;}.thread_add_message{text-align:right;vertical-align:top;padding-right:5px;}.thread_header{font-weight:bold;background:#666;padding:4px;text-align:left;}.thread_header a{color:#ccc;}.thread_info{margin:0;width:100%;border:none;padding:0;margin-bottom:10px;}.thread_info td{border:none;padding:0;}.thread_lastpost{font-size:85%;text-align:right!
 ;}.thread_post_row{border-top:1px solid #ddd;border-bottom:1px solid #ddd;}.thread_post_row td{margin-top:10px;margin-bottom:10px;}.thread_posts{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_recent_forum{float:right;font-size:85%;}.thread_recent_forum a{color:#333;}.thread_reply{font-size:93%;}.thread_reply tr{vertical-align:top;}.thread_reply td{padding-top:10px;padding-left:10px;}.thread_reply textarea{background-color:transparent;border:2px inset black;}.thread_subject a{font-size:93%;color:#333;color:#79B30B;}.thread_watch{margin-top:5px;font-size:77%;text-align:left;}.top_padded{margin-top:10px;}.info_column{min-width:80px;max-width:125px;}.topic_creator{display:block;font-size:85%;text-align:right;}.user_login form{width:350px;margin-left:auto;margin-right:auto;margin-top:20px;}.user_login p{margin-top:5px;margin-bottom:5px;}.user_permission_list{margin-left:auto;margin-right:auto;margin-top:15px;font-size:93%;width:100%;}.user_p!
 ermission_list td{vertical-align:top;border:1px dashed #ddd;bo!
 rder:non
e;line-height:150%;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;}.user_permission_list img{vertical-align:middle;}.user_post_info{background:#ccc;background:transparent;font-size:77%;margin-left:auto;margin-right:auto;text-align:center;vertical-align:top;width:110px;}a[href $='.jpg']{padding-left:20px;background:transparent url(/static/images/filetypes/image.png) no-repeat center left;}a[href $='.pdf']{padding-left:20px;background:transparent url(/static/images/filetypes/pdf.png) no-repeat center left;}#loader_wait.yui-overlay{position:fixed;float:right;top:10px;right:10px;border:none;text-align:right;}#preview_overlay{border:1px dashed #ccc;text-align:left;padding:0;}#thread_message{font-family:monospace;text-align:left;padding:0;background-color:#eee;font-size:93%;width:450px;}#ysearch{text-align:center;}#ysearchinput{position:static;width:20em;}#ysearchcontainer{text-align:left;width:20em;}.forumcode_code{font-family:monospace;border:1px solid #!
 333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;color:#ff0;background-color:#333;border:1px solid #666;white-space:pre;}.forumcode_pre{background-color:transparent;font-family:monospace;border:1px dashed #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;white-space:pre;}.forumcode_quote{background-color:#eee;font-family:monospace;font-style:italic;border:1px dotted #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;}.forumcode_quoting{font-weight:bold;margin-bottom:3px;}.yuimenuitem .disabled{color:#A6A6A6;cursor:default;}.yui-skin-sam .yui-navset .yui-nav,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav{border:solid #333;border-width:0 0 5px;Xposition:relative;zoom:1;}.yui-skin-sam .yui-navset .yui-content{background:transparent;}.yui-skin-sam .yui-navset .yui-nav a,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav a{background-image:none;background-color:#999;border:solid #a!
 3a3a3;border-width:0 1px;color:#fff;text-decoration:none;}.yui!
 -skin-sa
m .yui-navset .yui-nav .selected a,.yui-skin-sam .yui-navset .yui-nav .selected a:focus,.yui-skin-sam .yui-navset .yui-nav .selected a:hover{background:#333;color:#fff;}.yui-skin-sam .yui-navset .yui-nav a:hover,.yui-skin-sam .yui-navset .yui-nav a:focus{background:#666;color:#fff;outline:0;}
\ No newline at end of file
+#hd{height:80px;line-height:80px;margin:0;padding-left:10px;background:#EEE url('/static/images/parley_logo.jpg') no-repeat left;color:#79B30B;}#hd h1{font-size:200%;text-align:left;}div#ft{background:#666;color:#FFF;font-size:77%;margin-top:20px;}div#ft p{border:none;margin-top:30px;padding:5px 10px 5px 10px;text-align:right;display:block;}div#ft a{color:#ccc;}div#user_information{line-height:1em;font-size:85%;color:#000;background-color:transparent;position:absolute;top:0;right:10px;height:70px;width:200px;padding-top:3px;text-align:center;}div#user_information .user_info_actions{margin-top:3px;}.caretfix{overflow:auto;}#bd h1{font-weight:bold;background:#666;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h2{font-weight:bold;background:#999;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h3{font-weight:bold;background:#eee;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;color:#79B30B;}a.nav:hover{background:#000;color:#fff!
 ;}a,a:link,a:visited,a:active{background:transparent;color:blue;text-decoration:none;}th{font-size:100%;text-align:left;font-weight:bold;}#login_dialog form{margin:0;padding:0;min-width:400px;max-width:600px;}#login_dialog form fieldset{/ * clear:both;note that this clear causes inputs to break to left in ie5.x mac,commented out */ padding:10px;margin:0;border:none;}#login_dialog form label{display:block;float:left;width:150px;padding:0;margin:5px 0 0;text-align:right;font-weight:bold;margin-bottom:0;}#login_dialog form input,form textarea{width:auto;margin:5px 0 0 10px;}#login_dialog form p{font-size:85%;}.row{border-top:1px dotted #666;border-bottom:1px dotted #666;}.row_odd{background:#eee;}.row_even{background:#ddd;}.admin_edited_post{color:#000;background:#ccc;padding:2px;padding-left:10px;padding-right:10px;border:1px dashed #000;margin-left:15px;font-size:93%;text-align:right;}.align_right{text-align:right;}.forum_description{font-size:93%;}.forum_lastpost{font-size:!
 85%;text-align:right;}.forum_lastpost_subject a{color:#333;col!
 or:#79B3
0B;}.forum_link{font-size:100%;font-weight:bold;}.forum_list{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_list td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.forum_mini_pager{font-size:85%;}.forum_mini_pager a{color:#666;}.forum_name{font-size:100%;text-align:left;font-weight:bold;margin-top:5px;}.forum_name a{color:#333;color:#79B30B;}.forum_postcount{font-size:85%;text-align:right;margin-top:5px;}.forum_view{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_view td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.help li{margin-top:25px;margin-right:25px;list-style-type:none;border-left:2px solid #666;padding-top:5px;padding-bottom:5px;padding-left:10px;background-color:#ddd;}.help li ul li,.help li ol li{margin-top:5px;margin-left:10px;list-style-type:disc;border-left:none;pa!
 dding-left:none;padding-top:none;padding-bottom:none;background-color:transparent;}.innerpost{margin-left:10px;padding:5px;overflow:auto;font-size:93%;}.moderator_list{font-size:77%;margin-bottom:5px;margin-top:5px;text-align:right;}.pager_advanced{font-size:77%;margin-bottom:5px;margin-top:5px;}.post{padding-top:5px;vertical-align:top;border-left:1px solid #ddd;}.post_created{text-align:right;font-size:85%;}.post_creator{font-weight:bold;font-style:italic;font-size:85%;}.post_edited_alert{font-weight:bold;font-style:italic;}.post_info{font-size:77%;line-height:1.1em;margin-top:10px;margin-bottom:2px;text-align:right;}.post_subject{font-weight:bold;}.quote{background-color:#F9FBFF;border:1px solid #333;font-size:85%;margin:0 0 2px 4px;padding:6px;width:85%;overflow:hidden;}.recently_updated{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.recently_updated td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px!
 ;padding-right:10px;}.reply_post_message{border:1px dashed #66!
 6;}.sear
ch_match_context{font-size:85%;}.search_results{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.search_results td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;}.site_terms{width:80%;margin-left:auto;margin-right:auto;margin-bottom:10px;padding:5px;border:1px solid #666;}.thread_add{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_add td{padding-top:4px;padding-bottom:4px;}.thread_add .input_text{width:450px;margin-left:10px;}.thread_add_topic{text-align:right;padding-right:5px;}.thread_add_message{text-align:right;vertical-align:top;padding-right:5px;}.thread_header{font-weight:bold;background:#666;padding:4px;text-align:left;}.thread_header a{color:#ccc;}.thread_info{margin:0;width:100%;border:none;padding:0;margin-bottom:10px;}.thread_info td{border:none;padding:0;}.thread_lastpost{font-size:85%;text-align:right!
 ;}.thread_post_row{border-top:1px solid #ddd;border-bottom:1px solid #ddd;}.thread_post_row td{margin-top:10px;margin-bottom:10px;}.thread_posts{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_recent_forum{float:right;font-size:85%;}.thread_recent_forum a{color:#333;}.thread_reply{font-size:93%;}.thread_reply tr{vertical-align:top;}.thread_reply td{padding-top:10px;padding-left:10px;}.thread_reply textarea{background-color:transparent;border:2px inset black;}.thread_subject a{font-size:93%;color:#333;color:#79B30B;}.thread_watch{margin-top:5px;font-size:77%;text-align:left;}.top_padded{margin-top:10px;}.topic_creator{display:block;font-size:85%;text-align:right;}.user_login form{width:350px;margin-left:auto;margin-right:auto;margin-top:20px;}.user_login p{margin-top:5px;margin-bottom:5px;}.user_permission_list{margin-left:auto;margin-right:auto;margin-top:15px;font-size:93%;width:100%;}.user_permission_list td{vertical-align:top;border:1!
 px dashed #ddd;border:none;line-height:150%;padding-left:10px;!
 padding-
right:10px;padding-top:5px;padding-bottom:5px;}.user_permission_list img{vertical-align:middle;}.forum_moderator_list div input{line-height:250%;background-color:red;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;height:150%;}.forum_moderator_list img{vertical-align:middle;}.user_post_info{background:#ccc;background:transparent;font-size:77%;margin-left:auto;margin-right:auto;text-align:center;vertical-align:top;width:110px;}a[href $='.jpg']{padding-left:20px;background:transparent url(/static/images/filetypes/image.png) no-repeat center left;}a[href $='.pdf']{padding-left:20px;background:transparent url(/static/images/filetypes/pdf.png) no-repeat center left;}#loader_wait.yui-overlay{position:fixed;float:right;top:10px;right:10px;border:none;text-align:right;}#preview_overlay{border:1px dashed #ccc;text-align:left;padding:0;}#thread_message{font-family:monospace;text-align:left;padding:0;background-color:#eee;font-size:93%;width:450px;}#ysearch{text!
 -align:center;}#ysearchinput{position:static;width:20em;}#ysearchcontainer{text-align:left;width:20em;}.forumcode_code{font-family:monospace;border:1px solid #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;color:#ff0;background-color:#333;border:1px solid #666;white-space:pre;}.forumcode_pre{background-color:transparent;font-family:monospace;border:1px dashed #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;white-space:pre;}.forumcode_quote{background-color:#eee;font-family:monospace;font-style:italic;border:1px dotted #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;}.forumcode_quoting{font-weight:bold;margin-bottom:3px;}.yuimenuitem .disabled{color:#A6A6A6;cursor:default;}.yui-skin-sam .yui-navset .yui-nav,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav{border:solid #333;border-width:0 0 5px;Xposition:relative;zoom:1;}.yui-skin-sam .yui-navset .yui-content{background:tra!
 nsparent;}.yui-skin-sam .yui-navset .yui-nav a,.yui-skin-sam .!
 yui-navs
et .yui-navset-top .yui-nav a{background-image:none;background-color:#999;border:solid #a3a3a3;border-width:0 1px;color:#fff;text-decoration:none;}.yui-skin-sam .yui-navset .yui-nav .selected a,.yui-skin-sam .yui-navset .yui-nav .selected a:focus,.yui-skin-sam .yui-navset .yui-nav .selected a:hover{background:#333;color:#fff;}.yui-skin-sam .yui-navset .yui-nav a:hover,.yui-skin-sam .yui-navset .yui-nav a:focus{background:#666;color:#fff;outline:0;}
\ No newline at end of file

Modified: trunk/root/static/css/parley.css
===================================================================
--- trunk/root/static/css/parley.css	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/static/css/parley.css	2008-03-20 20:19:17 UTC (rev 850)
@@ -512,6 +512,14 @@
     vertical-align: middle;
 }
 
+.forum_moderator_list div input{
+    height: 150%;
+}
+.forum_moderator_list img {
+    vertical-align: middle;
+}
+
+
 .user_post_info {
     background:         #ccc;
     background:         transparent;

Added: trunk/root/static/images/icons/page_edit.png
===================================================================
(Binary files differ)


Property changes on: trunk/root/static/images/icons/page_edit.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/root/static/script/user_forum_moderate.js
===================================================================
--- trunk/root/static/script/user_forum_moderate.js	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/static/script/user_forum_moderate.js	2008-03-20 20:19:17 UTC (rev 850)
@@ -0,0 +1,77 @@
+(function () {
+    var YU  = YAHOO.util,
+        Dom = YAHOO.util.Dom;
+
+    var items = Dom.getElementsByClassName('fmod_checkbox');
+
+    update_forummod = function() {
+        var elID = this.id,
+            checked = (this.checked ? 1 : 0);
+        var forumID = elID.split('_')[1];
+        var statusDiv = Dom.get('status_' + forumID);
+
+        var handleSuccess = function(o) {
+            var data = eval('(' + o.responseText + ')');
+            o.argument.msg_node.innerHTML = '';
+
+            // show any returned errors
+            if (data.error) {
+                if (data.error.message!=undefined) {
+                    o.argument.msg_node.innerHTML = data.error.message;
+                }
+
+                // reset the checkbox
+                Dom.get(o.argument.cb_node).checked =
+                    (1 - o.argument.value);
+            }
+
+            // if we didn't update on the server, reset the checkbox
+            if (0 == data.updated) {
+                Dom.get(o.argument.cb_node).checked =
+                    (1 - o.argument.value);
+            }
+        };
+        var handleFailure = function(o) {
+            // show the status message
+            o.argument.msg_node.innerHTML = o.responseText;
+
+            // reset the checkbox
+            Dom.get(o.argument.cb_node).checked =
+                (1 - o.argument.value);
+        };
+
+        // where to post to
+        var sUrl = '/site/fmodSaveHandler';
+
+        // postdata is a query string ... how irksome!!
+        var postData =
+               'person='    + person.id
+            +  '&forum='    + forumID
+            +  '&value='    + checked
+        ;
+
+        // some visual feedback that something is happening
+        statusDiv.innerHTML = '<img src="/static/images/loader-bar.gif" />';
+
+        var request = YAHOO.util.Connect.asyncRequest(
+            'POST',
+            sUrl,
+            {
+                success:  handleSuccess,
+                failure:  handleFailure,
+                argument: {
+                    msg_node: statusDiv,
+                    cb_node:  elID,
+                    value:    checked
+                }
+            },
+            postData
+        );
+    };
+
+    YU.Event.addListener(
+        items,
+        'change',
+        update_forummod
+    );
+})();



From chiselwright at mail.berlios.de  Fri Mar 21 12:02:55 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 21 Mar 2008 12:02:55 +0100
Subject: [Parley-svn] r851 - / trunk
Message-ID: <200803211102.m2LB2t88025822@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-21 12:02:55 +0100 (Fri, 21 Mar 2008)
New Revision: 851

Modified:
   /
   trunk/Changes
   trunk/MANIFEST
   trunk/ROADMAP
Log:
 r4783 at wiggin:  chisel | 2008-03-21 11:02:49 +0000
 / updated info-files



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4781
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4783
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes
===================================================================
--- trunk/Changes	2008-03-20 20:19:17 UTC (rev 850)
+++ trunk/Changes	2008-03-21 11:02:55 UTC (rev 851)
@@ -2,6 +2,7 @@
 
 0.59 (UNDER DEVELOPMENT)
     - added Dutch translation (Thanks Rob!)
+    - forum moderators can be assigned and removed through the UI
     - user roles can now be assigned and removed
     - users can have their "suspended" flag set and removed
     - application can now prevent login/signup/posting/access by IP

Modified: trunk/MANIFEST
===================================================================
--- trunk/MANIFEST	2008-03-20 20:19:17 UTC (rev 850)
+++ trunk/MANIFEST	2008-03-21 11:02:55 UTC (rev 851)
@@ -460,6 +460,7 @@
 root/static/images/icons/flags/zm.png
 root/static/images/icons/flags/zw.png
 root/static/images/icons/lock.png
+root/static/images/icons/page_edit.png
 root/static/images/loader-bar.gif
 root/static/images/loader.gif
 root/static/images/locked.png

Modified: trunk/ROADMAP
===================================================================
--- trunk/ROADMAP	2008-03-20 20:19:17 UTC (rev 850)
+++ trunk/ROADMAP	2008-03-21 11:02:55 UTC (rev 851)
@@ -14,7 +14,7 @@
 
 0.59:
 
-    - assign new moderators (on a per-forum basis)
+    - [D] assign new moderators (on a per-forum basis)
     - admin/moderator support (deal with bad people)
         - [D] edit posts (and flag accordingly)
         - abuse handling
@@ -24,10 +24,10 @@
           - [D] prevent posting/editing from IP
           - [D] prevent total access from IP
         - UI for IP bans
-          - prevent login from IP
-          - prevent signup from IP
-          - prevent posting/editing from IP
-          - prevent total access from IP
+          - [D] prevent login from IP
+          - [D] prevent signup from IP
+          - [D] prevent posting/editing from IP
+          - [D] prevent total access from IP
         - IP reporting
 
 0.60:



From chiselwright at mail.berlios.de  Sun Mar 23 23:57:52 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Sun, 23 Mar 2008 23:57:52 +0100
Subject: [Parley-svn] r852 - / trunk/lib/Parley/ResultSet trunk/t
Message-ID: <200803232257.m2NMvqlX015788@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-23 23:57:51 +0100 (Sun, 23 Mar 2008)
New Revision: 852

Modified:
   /
   trunk/lib/Parley/ResultSet/Post.pm
   trunk/t/model_Post.t
Log:
 r4785 at wiggin:  chisel | 2008-03-23 22:57:35 +0000
 / rename: $resultsource --> $resultset
 + made people_posting_from_ip() work as anticipated
 + tests for people_posting_from_ip()



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4783
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4785
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/ResultSet/Post.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Post.pm	2008-03-21 11:02:55 UTC (rev 851)
+++ trunk/lib/Parley/ResultSet/Post.pm	2008-03-23 22:57:51 UTC (rev 852)
@@ -8,10 +8,10 @@
 use base 'DBIx::Class::ResultSet';
 
 sub record_from_id {
-    my ($resultsource, $post_id) = @_;
+    my ($resultset, $post_id) = @_;
     my ($rs);
 
-    $rs = $resultsource->find(
+    $rs = $resultset->find(
         {
             'me.id'  => $post_id,
         },
@@ -29,22 +29,16 @@
 }
 
 sub people_posting_from_ip {
-    my ($resultsource, $ip_addr) = @_;
+    my ($resultset, $ip_addr) = @_;
     my ($rs);
 
-    $rs = $resultsource->search(
+    $rs = $resultset->search(
         {
             ip_addr     => $ip_addr,
         },
         {
-            select => [
-                { distinct => 'creator_id' },
-            ],
-            as => [ 'foobar' ],
-
-            prefetch => [
-                'creator',
-            ],
+            distinct    => 1,
+            columns     => [ qw/creator_id/ ],
         }
     );
 

Modified: trunk/t/model_Post.t
===================================================================
--- trunk/t/model_Post.t	2008-03-21 11:02:55 UTC (rev 851)
+++ trunk/t/model_Post.t	2008-03-23 22:57:51 UTC (rev 852)
@@ -1,6 +1,6 @@
 use strict;
 use warnings;
-use Test::More tests => 4;
+use Test::More tests => 7;
 
 BEGIN { use_ok 'Parley::Schema' }
 
@@ -20,9 +20,62 @@
 $rs = $resultset->people_posting_from_ip('127.0.0.1');
 isa_ok($rs, 'Parley::ResultSet::Post');
 
-my %creator_id;
-while (my $record = $rs->next) {
-    diag $record->creator->forum_name;
+# insert some posts, in a txn, so we can roll them back and not pollute the
+# database
+eval {
+    $schema->txn_do(
+        sub {
+            _ip_posting_test(
+                $schema
+            );
+        }
+    );
+};
+if ($@) {
+    die $@;
 }
 
-diag $rs->count;
+sub _ip_posting_test {
+    my $schema = shift;
+    my $resultset = $schema->resultset('Post');
+
+    my $fake_ip = q{10.231.123.111};
+
+    # create a thread for fake posts
+    my $thread = $schema->resultset('Thread')->create(
+        {
+            forum_id    => 0,
+            subject     => $fake_ip,
+            creator_id  => 0,
+        }
+    );
+
+    # create a fake post for a couple of users
+    for my $person_id (qw/0 0 0 1 1/) {
+        $resultset->create(
+            {
+                thread_id   => $thread->id,
+                subject     => $fake_ip,
+                message     => $fake_ip,
+                creator_id  => $person_id,
+                ip_addr     => $fake_ip,
+            }
+        );
+    }
+
+    # there should be 5 posts from $fake_ip
+    my $count = $resultset->count(
+        {
+            ip_addr     => $fake_ip,
+        }
+    );
+    is($count, 5, qq{correct number of posts from $fake_ip});
+
+    # test the resultset method ..
+    my $rs = $resultset->people_posting_from_ip($fake_ip);
+    isa_ok($rs, 'Parley::ResultSet::Post');
+    is($rs->count, 2, qq{correct number of people posting from $fake_ip});
+
+    # make sure our changes don't land in the database
+    $schema->txn_rollback;
+}



From chiselwright at mail.berlios.de  Mon Mar 24 12:47:13 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Mon, 24 Mar 2008 12:47:13 +0100
Subject: [Parley-svn] r853 - / trunk/t/schema
Message-ID: <200803241147.m2OBlDNo021223@sheep.berlios.de>

Author: chiselwright
Date: 2008-03-24 12:47:12 +0100 (Mon, 24 Mar 2008)
New Revision: 853

Modified:
   /
   trunk/t/schema/SchemaTest.pm
Log:
 r4787 at wiggin:  chisel | 2008-03-24 11:46:59 +0000
 / wrapped schema class tests in a txn_do with a rollback at the end, to prevent any data-pollution from the tests/methods run



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4785
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4787
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/t/schema/SchemaTest.pm
===================================================================
--- trunk/t/schema/SchemaTest.pm	2008-03-23 22:57:51 UTC (rev 852)
+++ trunk/t/schema/SchemaTest.pm	2008-03-24 11:47:12 UTC (rev 853)
@@ -63,35 +63,50 @@
 
         my @std_method_types = qw(columns relations custom);
 
-        foreach my $method_type (@std_method_types) {
-            SKIP: {
-                skip qq{no $method_type methods}, 1
-                    unless @{ $self->{methods}->{$method_type} };
+        eval {
+            $schema->txn_do(
+                sub {
+                    foreach my $method_type (@std_method_types) {
+                        SKIP: {
+                            skip qq{no $method_type methods}, 1
+                                unless @{ $self->{methods}->{$method_type} };
 
-                can_ok(
-                    $record,
-                    @{ $self->{methods}->{$method_type} },
-                );
-                # try calling each method
-                foreach my $method ( @{ $self->{methods}->{$method_type} } ) {
-                    eval { $record->$method };
-                    is($@, q{}, qq{calling $method() didn't barf});
+                            can_ok(
+                                $record,
+                                @{ $self->{methods}->{$method_type} },
+                            );
+                            # try calling each method
+                            foreach my $method ( @{ $self->{methods}->{$method_type} } ) {
+                                eval { $record->$method };
+                                is($@, q{}, qq{calling $method() didn't barf});
+                            }
+                        }
+                    } # foreach
+
+                    # resultset class methods - we need something slightly different here
+                    SKIP: {
+                        skip qq{no resultsets methods}, 1
+                            unless @{ $self->{methods}->{resultsets} };
+
+                        $resultset = $schema->resultset( $self->{moniker} )->search({});
+                        can_ok(
+                            $resultset,
+                            @{ $self->{methods}->{resultsets} },
+                        );
+                    } # SKIP, no resultsets
+
+
+                    # rollback any evil changes that crept through from the
+                    # tested calls
+                    $schema->txn_rollback;
                 }
-            }
+            )
+        };
+        if ($@) {
+            warn $@;
         }
 
-        # resultset class methods - we need something slightly different here
-        SKIP: {
-            skip qq{no resultsets methods}, 1
-                unless @{ $self->{methods}->{resultsets} };
-
-            $resultset = $schema->resultset( $self->{moniker} )->search({});
-            can_ok(
-                $resultset,
-                @{ $self->{methods}->{resultsets} },
-            );
-        }
-    }
+    } # SKIP, no records
 }
 
 1;



