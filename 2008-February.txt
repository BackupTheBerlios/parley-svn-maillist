From chiselwright at mail.berlios.de  Sat Feb  2 12:15:52 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Sat, 2 Feb 2008 12:15:52 +0100
Subject: [Parley-svn] r770 - / trunk/root/static/css
Message-ID: <200802021115.m12BFq89005039@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-02 12:15:52 +0100 (Sat, 02 Feb 2008)
New Revision: 770

Modified:
   /
   trunk/root/static/css/parley.css
Log:
 r4590 at wiggin:  chisel | 2008-02-01 08:23:21 +0000
 / extra CSS tabview styling tweaks



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4588
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4590
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/static/css/parley.css
===================================================================
--- trunk/root/static/css/parley.css	2008-01-31 20:18:28 UTC (rev 769)
+++ trunk/root/static/css/parley.css	2008-02-02 11:15:52 UTC (rev 770)
@@ -568,7 +568,7 @@
 /* .yui-navset defaults to .yui-navset-top */ 
 .yui-skin-sam .yui-navset .yui-nav, 
 .yui-skin-sam .yui-navset .yui-navset-top .yui-nav { /* protect nested tabviews from other orientations */ 
-    border:solid #000; /* color between tab list and content */ 
+    border:solid #333; /* color between tab list and content */ 
     border-width:0 0 5px; 
     Xposition:relative; 
     zoom:1; 
@@ -580,10 +580,11 @@
 
 .yui-skin-sam .yui-navset .yui-nav a, 
 .yui-skin-sam .yui-navset .yui-navset-top .yui-nav a { 
-    background-color:   #333;
+    background-image:   none;
+    background-color:   #999;
     border:             solid #a3a3a3; 
     border-width:       0 1px; 
-    color:              #ccc;
+    color:              #fff;
     text-decoration:    none; 
 }
 
@@ -591,13 +592,13 @@
 .yui-skin-sam .yui-navset .yui-nav .selected a, 
 .yui-skin-sam .yui-navset .yui-nav .selected a:focus, /* no focus effect for selected */ 
 .yui-skin-sam .yui-navset .yui-nav .selected a:hover { /* no hover effect for selected */ 
-    background:#000;
+    background:#333;
     color:#fff;
 }
 
 .yui-skin-sam .yui-navset .yui-nav a:hover, 
 .yui-skin-sam .yui-navset .yui-nav a:focus { 
     background: #666;
-    color: black;
+    color: #fff;
     outline:0; 
 }



From chiselwright at mail.berlios.de  Sat Feb  2 12:16:01 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Sat, 2 Feb 2008 12:16:01 +0100
Subject: [Parley-svn] r771 - / trunk/root/base/my
Message-ID: <200802021116.m12BG1wv005114@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-02 12:16:01 +0100 (Sat, 02 Feb 2008)
New Revision: 771

Modified:
   /
   trunk/root/base/my/tab_notifications
Log:
 r4591 at wiggin:  chisel | 2008-02-01 08:32:22 +0000
 / reworked tab_notifications; replaced table with yui-grid



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4590
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4591
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/my/tab_notifications
===================================================================
--- trunk/root/base/my/tab_notifications	2008-02-02 11:15:52 UTC (rev 770)
+++ trunk/root/base/my/tab_notifications	2008-02-02 11:16:01 UTC (rev 771)
@@ -1,30 +1,39 @@
 <!-- preferences : notification tab -->
-
 <form action="my/preferences/update" method="POST" name="notifications">
     <input type="hidden" name="form_name" value="notifications">
-    <table class="prefs_notification">
-        <tbody>
-            <tr>
-                <td>
-                    <input type="checkbox" name="watch_on_post" value="1" [% IF authed_user.preference.watch_on_post %]checked="checked" [% END %] />
-                    [%l('PREFS ADD WATCHES')%] 
-                </td>
-            </tr>
-            <tr>
-                <td>
-                    <input type="checkbox" name="notify_thread_watch" value="1" [% IF authed_user.preference.notify_thread_watch %]checked="checked" [% END %] />
-                    [%l('PREFS EMAIL NOTIFICATION')%] 
-                </td>
-            </tr>
 
-            <tr><td colspan="2">&nbsp;</td></tr>
+    <div style="background-color:#ccc;margin-top:5px;margin-bottom:5px;">
+        &nbsp;
+    </div>
 
-            <tr>
-                <td colspan="2" style="text-align: center;">
-                <input type="submit" value="[%l('Update')%]" name="update" class="input_button" />
-                </td>
-            </tr>
-        </tbody>
-    </table>
+
+    <div class="yui-gf top_padded">
+        <div class="yui-u first align_right">
+            <input type="checkbox" name="watch_on_post" value="1" [% IF authed_user.preference.watch_on_post %]checked="checked" [% END %] />
+        </div>
+        <div class="yui-u">
+            &nbsp;
+            [%l('PREFS ADD WATCHES')%] 
+        </div>
+    </div>
+
+    <div class="yui-gf top_padded">
+        <div class="yui-u first align_right">
+            <input type="checkbox" name="notify_thread_watch" value="1" [% IF authed_user.preference.notify_thread_watch %]checked="checked" [% END %] />
+        </div>
+        <div class="yui-u">
+            &nbsp;
+            [%l('PREFS EMAIL NOTIFICATION')%] 
+        </div>
+    </div>
+
+    <div class="yui-gf top_padded">
+        <div class="yui-u first align_right">
+            &nbsp;
+        </div>
+        <div class="yui-u">
+            <input type="submit" value="[%l('Update')%]" name="update" class="input_button" />
+        </div>
+    </div>
 </form>
 <!-- (end) preferences : notification tab -->



From chiselwright at mail.berlios.de  Sat Feb  2 12:16:09 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Sat, 2 Feb 2008 12:16:09 +0100
Subject: [Parley-svn] r772 - / trunk/root/base/my
Message-ID: <200802021116.m12BG9Xa005186@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-02 12:16:09 +0100 (Sat, 02 Feb 2008)
New Revision: 772

Modified:
   /
   trunk/root/base/my/tab_avatar
Log:
 r4592 at wiggin:  chisel | 2008-02-01 08:39:33 +0000
 / replaced table with yui-grids in tab_avatar



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4591
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4592
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/my/tab_avatar
===================================================================
--- trunk/root/base/my/tab_avatar	2008-02-02 11:16:01 UTC (rev 771)
+++ trunk/root/base/my/tab_avatar	2008-02-02 11:16:09 UTC (rev 772)
@@ -1,35 +1,25 @@
 <!-- preferences : tab_you -->
-
 <form action="my/preferences/update" method="post" enctype="multipart/form-data">
     <input type="hidden" name="form_name" value="user_avatar">
-    <table class="user_profile">
-        <thead>
-            <tr>
-                <td width="150" align="center">
-                   [%l('Current Avatar')%] 
-                </td>
-                <td>
-                    &nbsp;
-                </td>
-            </tr>
-        </thead>
 
-        <tbody>
-            <tr>
-                <td width="150" align="center">
-                    [% INCLUDE shared/user_avatar person=authed_user %]
-                </td>
-                <td>
-                    [%l('CHANGE AVATAR')%]:
-                    <br />
+    <div style="background-color:#ccc;margin-top:5px;margin-bottom:5px;">
+        &nbsp;
+    </div>
 
-                    <input type="file" id="avatar_file" name="avatar_file" />
 
-                    <input type="submit" value="[%l('Upload')%]" style="float: right;"/>
-                </td>
-            </tr>
-        </tbody>
-    </table>
+    <div class="yui-gf top_padded">
+        <div class="yui-u first align_right">
+            [% INCLUDE shared/user_avatar person=authed_user %]
+        </div>
+        <div class="yui-u">
+            <div>
+                [%l('CHANGE AVATAR')%]:
+            </div>
+            <div class="top_padded">
+                <input type="file" id="avatar_file" name="avatar_file" />
+                <input type="submit" value="[%l('Upload')%]""/>
+            </div>
+        </div>
+    </div>
 </form>
-
 <!-- (end) preferences : tab_you -->



From chiselwright at mail.berlios.de  Sat Feb  2 12:16:17 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Sat, 2 Feb 2008 12:16:17 +0100
Subject: [Parley-svn] r773 - / trunk/root/base/user
Message-ID: <200802021116.m12BGHJQ005270@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-02 12:16:17 +0100 (Sat, 02 Feb 2008)
New Revision: 773

Modified:
   /
   trunk/root/base/user/profile
Log:
 r4593 at wiggin:  chisel | 2008-02-01 08:48:00 +0000
 / reworked user profile page; replaced table with yui-grids



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4592
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4593
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/user/profile
===================================================================
--- trunk/root/base/user/profile	2008-02-02 11:16:09 UTC (rev 772)
+++ trunk/root/base/user/profile	2008-02-02 11:16:17 UTC (rev 773)
@@ -1,58 +1,48 @@
 <!-- user/profile -->
 <h1>[%l('User Profile')%]</h1>
 [% IF profiled_user %]
+    <div class="yui-gf top_padded">
+        <div class="yui-u first align_right">
+            [% INCLUDE shared/user_avatar person=authed_user %]
+        </div>
+        <div class="yui-u">
 
-<table class="user_profile">
-    <tbody>
-        <tr>
-            <!-- user avatar -->
-            [% avatar_file = c.path_to('root') _ "/static/user_file/${profiled_user.id}/avatar.jpg" %]
-            [% TRY %]
-                [% USE avatar = Image(avatar_file) %]
-                [% tmp = avatar.attr %]
-                <td rowspan="4">
-                    <img class="picborder" src="/static/user_file/[% profiled_user.id %]/avatar.jpg" border="0" [% avatar.attr %] alt="Avatar" />
-                    <br />
-                </td>
-            [% CATCH %]
-                <!-- No User Avatar -->
-            [% END %]
-            <!-- end : user avatar -->
-            <td class="user_profile_key">
-                [%l('Nickname')%]:
-            </td>
-            <td class="user_profile_value">
-                [% profiled_user.forum_name %]
-            </td>
-        </tr>
+            <div class="yui-gf">
+                <div class="yui-u first align_right">
+                    [%l('Nickname')%]:
+                </div>
+                <div class="yui-u">
+                    [% profiled_user.forum_name %]
+                </div>
+            </div>
 
-        <tr>
-            <td class="user_profile_key">
-                [%l('Posts Made')%]:
-            </td>
-            <td class="user_profile_value">
-                [% profiled_user.post_count %]
-            </td>
-        </tr>
+            <div class="yui-gf top_padded">
+                <div class="yui-u first align_right">
+                    [%l('Posts Made')%]:
+                </div>
+                <div class="yui-u">
+                    [% profiled_user.post_count %]
+                </div>
+            </div>
 
-        <tr>
-            <td class="user_profile_key">
-                [%l('Last Post')%]:
-            </td>
-            <td class="user_profile_value">
-                [% IF profiled_user.last_post %]
-                <a href="thread/view?thread=[% profiled_user.last_post.thread.id %]">[% ForumCode.escape(profiled_user.last_post.thread.subject) |truncate(55) %]</a>
-                <br />
-                [% nicedate(profiled_user.last_post.created) %]
-                [% ELSE %]
-                [%l('Never Posted')%] 
-                [% END %]
-            </td>
-        </tr>
-    </tbody>
-</table>
+            <div class="yui-gf top_padded">
+                <div class="yui-u first align_right">
+                    [%l('Last Post')%]:
+                </div>
+                <div class="yui-u">
+                    [% IF profiled_user.last_post %]
+                    <a href="thread/view?thread=[% profiled_user.last_post.thread.id %]">[% ForumCode.escape(profiled_user.last_post.thread.subject) |truncate(55) %]</a>
+                    <br />
+                    [% nicedate(profiled_user.last_post.created) %]
+                    [% ELSE %]
+                    [%l('Never Posted')%] 
+                    [% END %]
+                </div>
+            </div>
 
+        </div>
+    </div>
 [% ELSE %]
-<p>[%l('PROFILE NOT FOUND')%]</p>
+    <p>[%l('PROFILE NOT FOUND')%]</p>
 [% END %]
 <!-- end : user/profile -->



From chiselwright at mail.berlios.de  Sat Feb  2 12:16:25 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Sat, 2 Feb 2008 12:16:25 +0100
Subject: [Parley-svn] r774 - / trunk trunk/lib
Message-ID: <200802021116.m12BGPK7005341@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-02 12:16:25 +0100 (Sat, 02 Feb 2008)
New Revision: 774

Modified:
   /
   trunk/Makefile.PL
   trunk/lib/Parley.pm
Log:
 r4594 at wiggin:  chisel | 2008-02-01 08:56:19 +0000
 / bumped application version to _99
 / bumped minimum Catalyst version required (Makefile.PL)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4593
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4594
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Makefile.PL
===================================================================
--- trunk/Makefile.PL	2008-02-02 11:16:17 UTC (rev 773)
+++ trunk/Makefile.PL	2008-02-02 11:16:25 UTC (rev 774)
@@ -3,7 +3,7 @@
 name 'Parley';
 all_from 'lib/Parley.pm';
 
-requires 'Catalyst' => '5.7001';
+requires 'Catalyst' => '5.008001';
 requires 'Catalyst::Action::RenderView';
 requires 'Catalyst::Model::DBIC::Schema';
 requires 'Catalyst::Plugin::Authentication';

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-02-02 11:16:17 UTC (rev 773)
+++ trunk/lib/Parley.pm	2008-02-02 11:16:25 UTC (rev 774)
@@ -3,7 +3,7 @@
 use strict;
 use warnings;
 
-our $VERSION = '0.58_19';
+our $VERSION = '0.58_99';
 
 use Catalyst::Runtime '5.70';
 use Catalyst qw/



From chiselwright at mail.berlios.de  Sat Feb  2 12:16:34 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Sat, 2 Feb 2008 12:16:34 +0100
Subject: [Parley-svn] r775 - / trunk
Message-ID: <200802021116.m12BGY4k005413@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-02 12:16:33 +0100 (Sat, 02 Feb 2008)
New Revision: 775

Modified:
   /
   trunk/ROADMAP
Log:
 r4595 at wiggin:  chisel | 2008-02-01 11:01:50 +0000
 / fixed version numbers in ROADMAP



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4594
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4595
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/ROADMAP
===================================================================
--- trunk/ROADMAP	2008-02-02 11:16:25 UTC (rev 774)
+++ trunk/ROADMAP	2008-02-02 11:16:33 UTC (rev 775)
@@ -6,28 +6,28 @@
 reasoning from interested parties.
 
 
-0.59 (Feb 2008):
+0.58 (Feb 2008):
 
     - UI improvements and cleanup
     - DBIC ResultSetManager deprecation
     - DBIC prefetch (DB optimisation)
 
-0.60:
+0.59:
 
     - admin/moderator support (deal with bad people)
         - edit posts (and flag accordingly)
         - abuse handling (suspend accounts, ban-by-ip, ...)
         - IP reporting
 
-0.61:
+0.60:
 
     - advanced search
 
-0.62:
+0.61:
 
     - admin: add/edit/order forums
 
-0.63:
+0.62:
 
     - user prefs:
         - language preference



From chiselwright at mail.berlios.de  Sat Feb  2 12:16:44 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Sat, 2 Feb 2008 12:16:44 +0100
Subject: [Parley-svn] r776 - / trunk
Message-ID: <200802021116.m12BGig3005504@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-02 12:16:43 +0100 (Sat, 02 Feb 2008)
New Revision: 776

Modified:
   /
   trunk/TODO
Log:
 r4596 at wiggin:  chisel | 2008-02-01 15:29:35 +0000
 + added some issues raised by PJC



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4595
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4596
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-02 11:16:33 UTC (rev 775)
+++ trunk/TODO	2008-02-02 11:16:43 UTC (rev 776)
@@ -1,5 +1,10 @@
 TODO LIST
 
+  - more visible Login/Register
+  - disabled menu items don't look disabled
+  - more visible Create New Thread
+  - login form doesn't submit onEnter
+  - login form flickers on IE7 page load
   - TESTS, TESTS, TESTS!
   - investigate in-application language preference/choice
   - styling: user prefs



From chiselwright at mail.berlios.de  Sat Feb  2 12:16:54 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Sat, 2 Feb 2008 12:16:54 +0100
Subject: [Parley-svn] r777 - / trunk trunk/root/base trunk/root/static/css
Message-ID: <200802021116.m12BGsKX005575@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-02 12:16:54 +0100 (Sat, 02 Feb 2008)
New Revision: 777

Modified:
   /
   trunk/TODO
   trunk/root/base/header
   trunk/root/static/css/parley.css
Log:
 r4597 at wiggin:  chisel | 2008-02-01 23:00:11 +0000
 / TODO updated
 - removed (commented) logo markup
 / more visible Login/Register
 / make disabled menuitems look 'different'



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4596
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4597
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-02 11:16:43 UTC (rev 776)
+++ trunk/TODO	2008-02-02 11:16:54 UTC (rev 777)
@@ -1,7 +1,6 @@
 TODO LIST
 
-  - more visible Login/Register
-  - disabled menu items don't look disabled
+  - add i18n for 'or'
   - more visible Create New Thread
   - login form doesn't submit onEnter
   - login form flickers on IE7 page load
@@ -21,6 +20,8 @@
   - 'smileys'?
   - realtime time-format example update (my/prefs - tab_time)
   - timezone menu usability
+D - disabled menu items don't look disabled
+D - more visible Login/Register
 D - [bug] fix email notification for thread notification emails
 D - application logo
 D - styling: thread/reply

Modified: trunk/root/base/header
===================================================================
--- trunk/root/base/header	2008-02-02 11:16:43 UTC (rev 776)
+++ trunk/root/base/header	2008-02-02 11:16:54 UTC (rev 777)
@@ -59,11 +59,6 @@
     <body class="yui-skin-sam">
         <div id="doc3">
             <div id="hd">
-                <!--
-                <img src="[%c.uri_for('/static/images/parley_logo.jpg')%]" />
-                <h1>Parley</h1>
-                -->
-
                 <div id="user_information">
                     [%l('Current User')%]:
                     [% IF authed_user %]
@@ -80,6 +75,15 @@
                         <img src="/static/images/icons/flags/gb.png" width="16" height="11" alt="GB" />
                         [% END %]
                     </a>
+                    [% UNLESS authed_user %]
+                    <div class="user_info_actions">
+                        [
+                            <a href="javascript:YAHOO.parley.login.login_dialog.show();">[%l('Login')%]</a>
+                        [%l('or')%]
+                            <a href="[%c.uri_for('/user/signup')%]">[%l('Register')%]</a>
+                        ]
+                    </div>
+                    [% END %]
                 </div>
             </div><!-- id="hd" -->
 

Modified: trunk/root/static/css/parley.css
===================================================================
--- trunk/root/static/css/parley.css	2008-02-02 11:16:43 UTC (rev 776)
+++ trunk/root/static/css/parley.css	2008-02-02 11:16:54 UTC (rev 777)
@@ -29,8 +29,13 @@
     height:             70px;
     width:              200px;
     padding-top:        3px;
+    text-align:         center;
 }
 
+div#user_information .user_info_actions {
+    margin-top:         3px;
+}
+
 /* CSS bug fixes */
 
 .caretfix {
@@ -563,6 +568,12 @@
 
 /* YUI CSS overrides */
 
+/* make disabled menuitems look 'different' */
+.yuimenuitem .disabled {
+    color:              #A6A6A6;
+    cursor:             default;
+}
+
 /* tabview (user prefs) */
 
 /* .yui-navset defaults to .yui-navset-top */ 



From chiselwright at mail.berlios.de  Sat Feb  2 12:17:02 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Sat, 2 Feb 2008 12:17:02 +0100
Subject: [Parley-svn] r778 - / trunk trunk/lib trunk/lib/Parley/Controller
	trunk/root/base
Message-ID: <200802021117.m12BH2Zj005667@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-02 12:17:02 +0100 (Sat, 02 Feb 2008)
New Revision: 778

Modified:
   /
   trunk/TODO
   trunk/lib/Parley.pm
   trunk/lib/Parley/Controller/User.pm
   trunk/root/base/header
Log:
 r4598 at wiggin:  chisel | 2008-02-02 10:56:42 +0000
 / fixed issue where user/logout wasn't working
 + added [Logout] link to user information area
 / updated TODO list



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4597
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4598
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-02 11:16:54 UTC (rev 777)
+++ trunk/TODO	2008-02-02 11:17:02 UTC (rev 778)
@@ -6,8 +6,6 @@
   - login form flickers on IE7 page load
   - TESTS, TESTS, TESTS!
   - investigate in-application language preference/choice
-  - styling: user prefs
-  - styling: user profile
   - write some sensible T&Cs
   - update avatar update response to force a No-Cache?
   - advanced search page
@@ -20,6 +18,9 @@
   - 'smileys'?
   - realtime time-format example update (my/prefs - tab_time)
   - timezone menu usability
+D - [bug] can't logout
+D - styling: user prefs
+D - styling: user profile
 D - disabled menu items don't look disabled
 D - more visible Login/Register
 D - [bug] fix email notification for thread notification emails

Modified: trunk/lib/Parley/Controller/User.pm
===================================================================
--- trunk/lib/Parley/Controller/User.pm	2008-02-02 11:16:54 UTC (rev 777)
+++ trunk/lib/Parley/Controller/User.pm	2008-02-02 11:17:02 UTC (rev 778)
@@ -71,11 +71,11 @@
 sub logout : Path('/user/logout') {
     my ($self, $c) = @_;
 
-    # if no-one logged in, send them to the main page as a punishment
-    if (not exists $c->session->{authed_user}) {
-        $c->response->redirect( $c->uri_for($c->config()->{default_uri}) );
-        return;
-    }
+#    # if no-one logged in, send them to the main page as a punishment
+#    if (not exists $c->session->{authed_user}) {
+#        $c->response->redirect( $c->uri_for($c->config()->{default_uri}) );
+#        return;
+#    }
 
     # session logout, and remove information we've stashed
     $c->logout;

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-02-02 11:16:54 UTC (rev 777)
+++ trunk/lib/Parley.pm	2008-02-02 11:17:02 UTC (rev 778)
@@ -3,7 +3,7 @@
 use strict;
 use warnings;
 
-our $VERSION = '0.58_99';
+our $VERSION = '0.58_99_002';
 
 use Catalyst::Runtime '5.70';
 use Catalyst qw/

Modified: trunk/root/base/header
===================================================================
--- trunk/root/base/header	2008-02-02 11:16:54 UTC (rev 777)
+++ trunk/root/base/header	2008-02-02 11:17:02 UTC (rev 778)
@@ -75,9 +75,15 @@
                         <img src="/static/images/icons/flags/gb.png" width="16" height="11" alt="GB" />
                         [% END %]
                     </a>
-                    [% UNLESS authed_user %]
+                    [% IF authed_user %]
                     <div class="user_info_actions">
                         [
+                            <a href="[%c.uri_for('/user/logout')%]">[%l('Logout')%]</a>
+                        ]
+                    </div>
+                    [% ELSE %]
+                    <div class="user_info_actions">
+                        [
                             <a href="javascript:YAHOO.parley.login.login_dialog.show();">[%l('Login')%]</a>
                         [%l('or')%]
                             <a href="[%c.uri_for('/user/signup')%]">[%l('Register')%]</a>



From chiselwright at mail.berlios.de  Tue Feb  5 09:26:47 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 5 Feb 2008 09:26:47 +0100
Subject: [Parley-svn] r779 - / trunk trunk/lib trunk/root/base
	trunk/root/base/forum trunk/root/base/thread
Message-ID: <200802050826.m158Qlkf001839@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-05 09:26:46 +0100 (Tue, 05 Feb 2008)
New Revision: 779

Modified:
   /
   trunk/TODO
   trunk/lib/Parley.pm
   trunk/root/base/forum/view
   trunk/root/base/header
   trunk/root/base/thread/add
Log:
 r4608 at wiggin:  chisel | 2008-02-04 19:23:19 +0000
 / updated TODO
 / minor version bump
 / fix (now) invalid YUI url (button vs button-beta)
 + make "Create New Thread" more visible
 + add a Cancel button to thread/add



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4598
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4608
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-02 11:17:02 UTC (rev 778)
+++ trunk/TODO	2008-02-05 08:26:46 UTC (rev 779)
@@ -1,7 +1,7 @@
 TODO LIST
 
   - add i18n for 'or'
-  - more visible Create New Thread
+  - Quick Reply
   - login form doesn't submit onEnter
   - login form flickers on IE7 page load
   - TESTS, TESTS, TESTS!
@@ -18,6 +18,7 @@
   - 'smileys'?
   - realtime time-format example update (my/prefs - tab_time)
   - timezone menu usability
+D - more visible Create New Thread
 D - [bug] can't logout
 D - styling: user prefs
 D - styling: user profile

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-02-02 11:17:02 UTC (rev 778)
+++ trunk/lib/Parley.pm	2008-02-05 08:26:46 UTC (rev 779)
@@ -3,7 +3,7 @@
 use strict;
 use warnings;
 
-our $VERSION = '0.58_99_002';
+our $VERSION = '0.58_99_003';
 
 use Catalyst::Runtime '5.70';
 use Catalyst qw/

Modified: trunk/root/base/forum/view
===================================================================
--- trunk/root/base/forum/view	2008-02-02 11:17:02 UTC (rev 778)
+++ trunk/root/base/forum/view	2008-02-05 08:26:46 UTC (rev 779)
@@ -1,7 +1,16 @@
 <h1>[% current_forum.name %] : List Of Active Threads</h1>
 
 [%- IF thread_list.count > 0 %]
+
+<div style="float:right; font-size: 85%;">
+    <span class="yui-button yui-link-button">
+        <span class="first-child">
+            <a href="[%c.uri_for('/thread/add',{'forum'=>current_forum.id})%]">[%l('Create New Thread')%]</a>
+        </span>
+    </span>
+</div>
 [% PROCESS shared/pager_advanced %]
+
 <table class="forum_view">
     <tbody>
         [%- WHILE (thread = thread_list.next) %]
@@ -15,9 +24,7 @@
     </tbody>
 </table>
 
-
 [% PROCESS shared/pager_advanced %]
 [% ELSE %]
   No active threads in this forum
 [% END %]
-

Modified: trunk/root/base/header
===================================================================
--- trunk/root/base/header	2008-02-02 11:17:02 UTC (rev 778)
+++ trunk/root/base/header	2008-02-05 08:26:46 UTC (rev 779)
@@ -46,7 +46,7 @@
         <script type="text/javascript" src="[%c.request.base%]/static/yui/container/container_core-min.js"></script>
         <script type="text/javascript" src="[%c.request.base%]/static/yui/container/container-min.js"></script>
         <script type="text/javascript" src="[%c.request.base%]/static/yui/utilities/utilities.js"></script>
-        <script type="text/javascript" src="[%c.request.base%]/static/yui/button/button-beta-min.js"></script>
+        <script type="text/javascript" src="[%c.request.base%]/static/yui/button/button-min.js"></script>
         <script type="text/javascript" src="[%c.request.base%]/static/yui/menu/menu-min.js"></script>
         <script type="text/javascript" src="[%c.request.base%]/static/yui/tabview/tabview-min.js"></script>
         <script type="text/javascript" src="[%c.request.base%]/static/yui/logger/logger-min.js"></script>

Modified: trunk/root/base/thread/add
===================================================================
--- trunk/root/base/thread/add	2008-02-02 11:17:02 UTC (rev 778)
+++ trunk/root/base/thread/add	2008-02-05 08:26:46 UTC (rev 779)
@@ -31,9 +31,16 @@
         </tr>
 
         <tr>
-            <td colspan="2" style="text-align: center;">
-            <input type="button" value="[%l('Preview')%]" name="post_reply" class="" id="message_preview" />
-            <input type="submit" value="[%l('Post New Topic')%]" name="post_reply" class="" />
+            <td>&nbsp;</td>
+            <td colspan="1" style="text-align: left;">
+                <span class="yui-button yui-link-button" style="margin-right:50px;margin-left:50px;">
+                    <span class="first-child">
+                        <a href="[%c.uri_for('/forum/view',{'forum'=>current_forum.id})%]">[%l('Cancel')%]</a>
+                    </span>
+                </span>
+
+                <input type="button" value="[%l('Preview')%]" name="preview_reply" class="" id="message_preview" />
+                <input type="submit" value="[%l('Post New Topic')%]" name="post_reply" class="" />
             </td>
         </tr>
 



From chiselwright at mail.berlios.de  Tue Feb  5 09:26:57 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 5 Feb 2008 09:26:57 +0100
Subject: [Parley-svn] r780 - / trunk trunk/lib/Parley/I18N
Message-ID: <200802050826.m158QvLB001911@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-05 09:26:56 +0100 (Tue, 05 Feb 2008)
New Revision: 780

Modified:
   /
   trunk/Changes.i18n
   trunk/TODO
   trunk/lib/Parley/I18N/i_default.po
   trunk/lib/Parley/I18N/it.po
Log:
 r4609 at wiggin:  chisel | 2008-02-05 07:21:07 +0000
 / added i18n for 'or' (i_default and it)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4608
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4609
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-02-05 08:26:46 UTC (rev 779)
+++ trunk/Changes.i18n	2008-02-05 08:26:56 UTC (rev 780)
@@ -12,6 +12,7 @@
     it.po:
         - full translation from i_default.po
         - added:
+            - 'or'
             - 'Cancel'
             - 'in'
             - 'Please choose a language' (babelfish)
@@ -19,6 +20,7 @@
 
     i_default.po:
         - added:
+            - 'or'
             - "%1 wrote:"
             - "%quant(%1,reply)"
             - "%quant(%1,view)"

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-05 08:26:46 UTC (rev 779)
+++ trunk/TODO	2008-02-05 08:26:56 UTC (rev 780)
@@ -1,6 +1,5 @@
 TODO LIST
 
-  - add i18n for 'or'
   - Quick Reply
   - login form doesn't submit onEnter
   - login form flickers on IE7 page load
@@ -18,6 +17,7 @@
   - 'smileys'?
   - realtime time-format example update (my/prefs - tab_time)
   - timezone menu usability
+D - add i18n for 'or'
 D - more visible Create New Thread
 D - [bug] can't logout
 D - styling: user prefs

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-02-05 08:26:46 UTC (rev 779)
+++ trunk/lib/Parley/I18N/i_default.po	2008-02-05 08:26:56 UTC (rev 780)
@@ -392,6 +392,9 @@
 msgid "of"
 msgstr "of"
 
+msgid "or"
+msgstr "or"
+
 msgid "Page"
 msgstr "Page"
 

Modified: trunk/lib/Parley/I18N/it.po
===================================================================
--- trunk/lib/Parley/I18N/it.po	2008-02-05 08:26:46 UTC (rev 779)
+++ trunk/lib/Parley/I18N/it.po	2008-02-05 08:26:56 UTC (rev 780)
@@ -392,6 +392,9 @@
 msgid "of"
 msgstr "di"
 
+msgid "or"
+msgstr "o"
+
 msgid "Page"
 msgstr "Pagina"
 



From chiselwright at mail.berlios.de  Tue Feb  5 09:27:31 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 5 Feb 2008 09:27:31 +0100
Subject: [Parley-svn] r781 - / trunk/lib
Message-ID: <200802050827.m158RVFo002045@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-05 09:27:31 +0100 (Tue, 05 Feb 2008)
New Revision: 781

Modified:
   /
   trunk/lib/Parley.pm
Log:
 r4613 at wiggin:  chisel | 2008-02-05 08:27:25 +0000
 / minor version bump



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4609
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4613
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-02-05 08:26:56 UTC (rev 780)
+++ trunk/lib/Parley.pm	2008-02-05 08:27:31 UTC (rev 781)
@@ -3,7 +3,7 @@
 use strict;
 use warnings;
 
-our $VERSION = '0.58_99_003';
+our $VERSION = '0.58';
 
 use Catalyst::Runtime '5.70';
 use Catalyst qw/



From chiselwright at mail.berlios.de  Wed Feb  6 17:07:05 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 6 Feb 2008 17:07:05 +0100
Subject: [Parley-svn] r782 - / trunk/lib trunk/root/base/shared
Message-ID: <200802061607.m16G75AF013656@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-06 17:07:05 +0100 (Wed, 06 Feb 2008)
New Revision: 782

Modified:
   /
   trunk/lib/Parley.pm
   trunk/root/base/shared/login_dialog
Log:
 r4617 at wiggin:  chisel | 2008-02-05 18:10:23 +0000
 / tweaks to try to stop the login dialod flicking up on page loads in IE
 / the ever happening version bump



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4613
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4617
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-02-05 08:27:31 UTC (rev 781)
+++ trunk/lib/Parley.pm	2008-02-06 16:07:05 UTC (rev 782)
@@ -3,7 +3,7 @@
 use strict;
 use warnings;
 
-our $VERSION = '0.58';
+our $VERSION = '0.58_99_005';
 
 use Catalyst::Runtime '5.70';
 use Catalyst qw/

Modified: trunk/root/base/shared/login_dialog
===================================================================
--- trunk/root/base/shared/login_dialog	2008-02-05 08:27:31 UTC (rev 781)
+++ trunk/root/base/shared/login_dialog	2008-02-06 16:07:05 UTC (rev 782)
@@ -26,6 +26,7 @@
             visible:                false, 
             modal:                  false,
             constraintoviewport:    true,
+            width:                  '450px',
             buttons : [
                 { text:'[%l('Login')%]',  handler:handleSubmit, isDefault:true },
                 { text:'[%l('Cancel')%]', handler:handleCancel }
@@ -59,7 +60,7 @@
 YAHOO.util.Event.onDOMReady(login_dialog_init);
 </script>
 
-<div id="login_dialog">
+<div id="login_dialog" style="visibility:hidden;">
     <div class="hd">
         [%l('Please enter your information')%]
     </div>



From chiselwright at mail.berlios.de  Wed Feb  6 17:07:11 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 6 Feb 2008 17:07:11 +0100
Subject: [Parley-svn] r783 - / trunk/root/base/user
Message-ID: <200802061607.m16G7BRg013730@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-06 17:07:11 +0100 (Wed, 06 Feb 2008)
New Revision: 783

Modified:
   /
   trunk/root/base/user/profile
Log:
 r4618 at wiggin:  chisel | 2008-02-06 16:06:55 +0000
 / fix a thinko that stopped avatar from showing correctly



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4617
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4618
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/user/profile
===================================================================
--- trunk/root/base/user/profile	2008-02-06 16:07:05 UTC (rev 782)
+++ trunk/root/base/user/profile	2008-02-06 16:07:11 UTC (rev 783)
@@ -3,7 +3,7 @@
 [% IF profiled_user %]
     <div class="yui-gf top_padded">
         <div class="yui-u first align_right">
-            [% INCLUDE shared/user_avatar person=authed_user %]
+            [% INCLUDE shared/user_avatar person=profiled_user %]
         </div>
         <div class="yui-u">
 



From chiselwright at mail.berlios.de  Wed Feb  6 20:16:37 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 6 Feb 2008 20:16:37 +0100
Subject: [Parley-svn] r784 - / trunk
Message-ID: <200802061916.m16JGbpI018358@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-06 20:16:36 +0100 (Wed, 06 Feb 2008)
New Revision: 784

Modified:
   /
   trunk/TODO
Log:
 r4621 at wiggin:  chisel | 2008-02-06 18:18:52 +0000
 / TODO update



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4618
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4621
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-06 16:07:11 UTC (rev 783)
+++ trunk/TODO	2008-02-06 19:16:36 UTC (rev 784)
@@ -2,7 +2,6 @@
 
   - Quick Reply
   - login form doesn't submit onEnter
-  - login form flickers on IE7 page load
   - TESTS, TESTS, TESTS!
   - investigate in-application language preference/choice
   - write some sensible T&Cs
@@ -17,6 +16,8 @@
   - 'smileys'?
   - realtime time-format example update (my/prefs - tab_time)
   - timezone menu usability
+D - login form flickers on IE7 page load
+D - [bug] user/profile doesn't show avatar
 D - add i18n for 'or'
 D - more visible Create New Thread
 D - [bug] can't logout



From chiselwright at mail.berlios.de  Thu Feb  7 10:18:24 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 7 Feb 2008 10:18:24 +0100
Subject: [Parley-svn] r785 - / trunk
Message-ID: <200802070918.m179IOQk023538@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-07 10:18:23 +0100 (Thu, 07 Feb 2008)
New Revision: 785

Modified:
   /
   trunk/TODO
Log:
 r4623 at wiggin:  chisel | 2008-02-07 07:49:56 +0000
 YATU (Yet Another TODO Update)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4621
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4623
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-06 19:16:36 UTC (rev 784)
+++ trunk/TODO	2008-02-07 09:18:23 UTC (rev 785)
@@ -16,6 +16,7 @@
   - 'smileys'?
   - realtime time-format example update (my/prefs - tab_time)
   - timezone menu usability
+  - skinning (user pref overrides CSS used?)
 D - login form flickers on IE7 page load
 D - [bug] user/profile doesn't show avatar
 D - add i18n for 'or'



From chiselwright at mail.berlios.de  Tue Feb 12 11:48:33 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 12 Feb 2008 11:48:33 +0100
Subject: [Parley-svn] r786 - / trunk trunk/lib
Message-ID: <200802121048.m1CAmXbh023341@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-12 11:48:32 +0100 (Tue, 12 Feb 2008)
New Revision: 786

Modified:
   /
   trunk/Changes
   trunk/TODO
   trunk/lib/Parley.pm
Log:
 r4633 at wiggin:  chisel | 2008-02-10 15:50:08 +0000
 / some final tweaks before going live with v0.58



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4623
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4633
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes
===================================================================
--- trunk/Changes	2008-02-07 09:18:23 UTC (rev 785)
+++ trunk/Changes	2008-02-12 10:48:32 UTC (rev 786)
@@ -1,24 +1,24 @@
 This file documents the revision history for Parley.
 
-0.58 (UNDER DEVELOPMENT)
+0.58    Fri Feb  8 07:47:31 GMT 2008
+    - re-work the UI design to be cleaner
     - added an application logo
+    - more efficient database querying (a la DBIC's prefetch)
+    - added first part of .it i18n (Thanks Darius!)
     - add browser and user driven language selection
-    - added first part of .it i18n (Thanks Darius!)
-    - re-work the UI design to be cleaner
+    - upgraded to YUI 2.4.1
+    - modify ::Schema so that we can export mysql and sqlite schemas
+    - rename DB columns to be more sensible
     - make the display of the time zone independant of the time_format string
-    - fix issues with email notifications
-    - [bug] fix user's last post information (profile page)
-    - [bug] fix issue with forum-limited searches
     - limit thread subject length on user profile page
-    - rename DB columns to be more sensible
-    - upgraded to YUI 2.4.1
     - factored out MessagePreview javascript into single included file
-    - [bug] fix error when trying to post new thread with no subject line
-    - modify ::Schema so that we can export mysql and sqlite schemas
-    - more efficient database querying (a la DBIC's prefetch)
     - fix uri_for() error on user/login 
     - fix DBIC field error during lostpassword process
     - fix DBIC field errors during signup
+    - fix issues with email notifications
+    - [bug] fix user's last post information (profile page)
+    - [bug] fix issue with forum-limited searches
+    - [bug] fix error when trying to post new thread with no subject line
 
 0.57    Wed Oct 31 19:15:06 GMT 2007
     - added T&Cs to application

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-07 09:18:23 UTC (rev 785)
+++ trunk/TODO	2008-02-12 10:48:32 UTC (rev 786)
@@ -17,6 +17,8 @@
   - realtime time-format example update (my/prefs - tab_time)
   - timezone menu usability
   - skinning (user pref overrides CSS used?)
+  - posting page ForumCode help/tips
+  - database versioning
 D - login form flickers on IE7 page load
 D - [bug] user/profile doesn't show avatar
 D - add i18n for 'or'

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-02-07 09:18:23 UTC (rev 785)
+++ trunk/lib/Parley.pm	2008-02-12 10:48:32 UTC (rev 786)
@@ -3,7 +3,7 @@
 use strict;
 use warnings;
 
-our $VERSION = '0.58_99_005';
+our $VERSION = '0.58';
 
 use Catalyst::Runtime '5.70';
 use Catalyst qw/



From chiselwright at mail.berlios.de  Tue Feb 12 11:48:45 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 12 Feb 2008 11:48:45 +0100
Subject: [Parley-svn] r787 - / tags
Message-ID: <200802121048.m1CAmjLe023420@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-12 11:48:44 +0100 (Tue, 12 Feb 2008)
New Revision: 787

Added:
   tags/parley-0.58/
Modified:
   /
Log:
 r4634 at wiggin:  chisel | 2008-02-10 15:51:48 +0000
 Tagging Parley v0.58



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4633
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4634
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Copied: tags/parley-0.58 (from rev 786, trunk)



From chiselwright at mail.berlios.de  Tue Feb 12 11:53:55 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 12 Feb 2008 11:53:55 +0100
Subject: [Parley-svn] r788 - / trunk/db_script
Message-ID: <200802121053.m1CArtc3024192@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-12 11:53:54 +0100 (Tue, 12 Feb 2008)
New Revision: 788

Added:
   trunk/db_script/Parley-Schema-0.58_13-MySQL.sql
   trunk/db_script/Parley-Schema-0.58_13-PostgreSQL.sql
   trunk/db_script/Parley-Schema-0.58_13-SQLite.sql
Modified:
   /
Log:
 r4635 at wiggin:  chisel | 2008-02-10 15:57:16 +0000
 / added missing files



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4634
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4635
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/db_script/Parley-Schema-0.58_13-MySQL.sql
===================================================================
--- trunk/db_script/Parley-Schema-0.58_13-MySQL.sql	2008-02-12 10:48:44 UTC (rev 787)
+++ trunk/db_script/Parley-Schema-0.58_13-MySQL.sql	2008-02-12 10:53:54 UTC (rev 788)
@@ -0,0 +1,275 @@
+-- 
+-- Created by SQL::Translator::Producer::MySQL
+-- Created on Mon Jan 14 19:14:00 2008
+-- 
+SET foreign_key_checks=0;
+
+DROP TABLE IF EXISTS terms;
+--
+-- Table: terms
+--
+CREATE TABLE terms (
+  id integer NOT NULL,
+  created timestamp with time zone NOT NULL,
+  content text NOT NULL,
+  change_summary text NOT NULL,
+  INDEX (id),
+  PRIMARY KEY (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS thread;
+--
+-- Table: thread
+--
+CREATE TABLE thread (
+  id integer(4) NOT NULL,
+  locked enum('0','1') NOT NULL DEFAULT 'false',
+  creator_id integer(4) NOT NULL,
+  subject text NOT NULL,
+  active enum('0','1') NOT NULL DEFAULT 'true',
+  forum_id integer(4) NOT NULL,
+  created timestamp with time zone(8) DEFAULT 'now()',
+  last_post_id integer(4),
+  sticky enum('0','1') NOT NULL DEFAULT 'false',
+  post_count integer(4) NOT NULL DEFAULT '0',
+  view_count integer(4) NOT NULL DEFAULT '0',
+  INDEX (id),
+  INDEX (last_post_id),
+  INDEX (forum_id),
+  INDEX (creator_id),
+  PRIMARY KEY (id),
+  CONSTRAINT thread_fk_last_post_id FOREIGN KEY (last_post_id) REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE,
+  CONSTRAINT thread_fk_forum_id FOREIGN KEY (forum_id) REFERENCES forum_moderator (forum),
+  CONSTRAINT thread_fk_creator_id FOREIGN KEY (creator_id) REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE,
+  CONSTRAINT thread_fk_forum_id_1 FOREIGN KEY (forum_id) REFERENCES forum (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS forum;
+--
+-- Table: forum
+--
+CREATE TABLE forum (
+  id integer(4) NOT NULL,
+  last_post_id integer(4),
+  post_count integer(4) NOT NULL DEFAULT '0',
+  active enum('0','1') NOT NULL DEFAULT 'true',
+  name text NOT NULL,
+  description text,
+  INDEX (id),
+  INDEX (name),
+  INDEX (last_post_id),
+  PRIMARY KEY (id),
+  UNIQUE forum_name_key (name),
+  CONSTRAINT forum_fk_last_post_id FOREIGN KEY (last_post_id) REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS preference;
+--
+-- Table: preference
+--
+CREATE TABLE preference (
+  id integer(4) NOT NULL,
+  timezone text NOT NULL DEFAULT 'UTC',
+  time_format_id integer(4) NOT NULL,
+  show_tz enum('0','1') NOT NULL DEFAULT 'true',
+  notify_thread_watch enum('0','1') NOT NULL DEFAULT 'false',
+  watch_on_post enum('0','1') NOT NULL DEFAULT 'false',
+  INDEX (id),
+  INDEX (preference_id),
+  INDEX (time_format_id),
+  PRIMARY KEY (id),
+  CONSTRAINT preference_fk_preference_id FOREIGN KEY (preference_id) REFERENCES person (id),
+  CONSTRAINT preference_fk_time_format_id FOREIGN KEY (time_format_id) REFERENCES preference_time_string (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS authentication;
+--
+-- Table: authentication
+--
+CREATE TABLE authentication (
+  id integer(4) NOT NULL,
+  password text NOT NULL,
+  authenticated enum('0','1') NOT NULL DEFAULT 'false',
+  username text NOT NULL,
+  INDEX (id),
+  INDEX (username),
+  PRIMARY KEY (id),
+  UNIQUE authentication_username_key (username)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS email_queue;
+--
+-- Table: email_queue
+--
+CREATE TABLE email_queue (
+  id integer(4) NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  cc_id integer(4),
+  bcc_id integer(4),
+  sender text,
+  subject text NOT NULL,
+  html_content text,
+  attempted_delivery enum('0','1') NOT NULL DEFAULT 'false',
+  text_content text NOT NULL,
+  queued timestamp with time zone(8) NOT NULL DEFAULT 'now()',
+  INDEX (id),
+  INDEX (bcc_id),
+  INDEX (cc_id),
+  INDEX (recipient_id),
+  PRIMARY KEY (id),
+  CONSTRAINT email_queue_fk_bcc_id FOREIGN KEY (bcc_id) REFERENCES person (id),
+  CONSTRAINT email_queue_fk_cc_id FOREIGN KEY (cc_id) REFERENCES person (id),
+  CONSTRAINT email_queue_fk_recipient_id FOREIGN KEY (recipient_id) REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS terms_agreed;
+--
+-- Table: terms_agreed
+--
+CREATE TABLE terms_agreed (
+  id integer NOT NULL,
+  person_id integer NOT NULL,
+  terms_id integer NOT NULL,
+  accepted_on timestamp with time zone NOT NULL,
+  INDEX (id),
+  INDEX (person_id),
+  INDEX (terms_id),
+  PRIMARY KEY (id),
+  CONSTRAINT terms_agreed_fk_person_id FOREIGN KEY (person_id) REFERENCES person (id),
+  CONSTRAINT terms_agreed_fk_terms_id FOREIGN KEY (terms_id) REFERENCES terms (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS password_reset;
+--
+-- Table: password_reset
+--
+CREATE TABLE password_reset (
+  id integer NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  expires timestamp without time zone(8),
+  INDEX (id),
+  INDEX (recipient_id),
+  PRIMARY KEY (id),
+  CONSTRAINT password_reset_fk_recipient_id FOREIGN KEY (recipient_id) REFERENCES person (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS post;
+--
+-- Table: post
+--
+CREATE TABLE post (
+  id integer(4) NOT NULL,
+  creator_id integer(4) NOT NULL,
+  subject text,
+  quoted_post_id integer(4),
+  message text NOT NULL,
+  quoted_text text,
+  created timestamp with time zone(8) DEFAULT 'now()',
+  thread_id integer(4) NOT NULL,
+  reply_to_id integer(4),
+  edited timestamp with time zone(8),
+  ip_addr inet(8),
+  INDEX (id),
+  INDEX (creator_id),
+  INDEX (quoted_post_id),
+  INDEX (thread_id),
+  INDEX (reply_to_id),
+  PRIMARY KEY (id),
+  CONSTRAINT post_fk_creator_id FOREIGN KEY (creator_id) REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE,
+  CONSTRAINT post_fk_quoted_post_id FOREIGN KEY (quoted_post_id) REFERENCES post (id),
+  CONSTRAINT post_fk_thread_id FOREIGN KEY (thread_id) REFERENCES thread (id) ON DELETE CASCADE ON UPDATE CASCADE,
+  CONSTRAINT post_fk_reply_to_id FOREIGN KEY (reply_to_id) REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS forum_moderator;
+--
+-- Table: forum_moderator
+--
+CREATE TABLE forum_moderator (
+  person_id integer(4) NOT NULL,
+  forum_id integer(4) NOT NULL,
+  can_moderate enum('0','1') NOT NULL DEFAULT 'false',
+  INDEX (person_id),
+  INDEX (forum_id),
+  UNIQUE forum_moderator_person_key (person_id, forum_id),
+  CONSTRAINT forum_moderator_fk_person_id FOREIGN KEY (person_id) REFERENCES person (id),
+  CONSTRAINT forum_moderator_fk_forum_id FOREIGN KEY (forum_id) REFERENCES forum (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS thread_view;
+--
+-- Table: thread_view
+--
+CREATE TABLE thread_view (
+  id integer(4) NOT NULL,
+  watched enum('0','1') NOT NULL DEFAULT 'false',
+  last_notified timestamp with time zone(8),
+  thread_id integer(4) NOT NULL,
+  timestamp timestamp with time zone(8) NOT NULL DEFAULT 'now()',
+  person_id integer(4) NOT NULL,
+  INDEX (id),
+  INDEX (person_id),
+  INDEX (thread_id),
+  PRIMARY KEY (id),
+  UNIQUE thread_view_person_key (person_id, thread_id),
+  CONSTRAINT thread_view_fk_thread_id FOREIGN KEY (thread_id) REFERENCES thread (id) ON DELETE CASCADE ON UPDATE CASCADE,
+  CONSTRAINT thread_view_fk_person_id FOREIGN KEY (person_id) REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS person;
+--
+-- Table: person
+--
+CREATE TABLE person (
+  id integer(4) NOT NULL,
+  authentication_id integer(4),
+  last_name text NOT NULL,
+  email text NOT NULL,
+  forum_name text NOT NULL,
+  preference_id integer(4),
+  last_post_id integer(4),
+  post_count integer(4) NOT NULL DEFAULT '0',
+  first_name text NOT NULL,
+  INDEX (id),
+  INDEX (forum_name),
+  INDEX (email),
+  INDEX (last_post_id),
+  INDEX (preference_id),
+  INDEX (authentication_id),
+  PRIMARY KEY (id),
+  UNIQUE person_forum_name_key (forum_name),
+  UNIQUE person_email_key (email),
+  CONSTRAINT person_fk_last_post_id FOREIGN KEY (last_post_id) REFERENCES post (id),
+  CONSTRAINT person_fk_preference_id FOREIGN KEY (preference_id) REFERENCES preference (id),
+  CONSTRAINT person_fk_authentication_id FOREIGN KEY (authentication_id) REFERENCES authentication (id) ON DELETE CASCADE ON UPDATE CASCADE
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS registration_authentication;
+--
+-- Table: registration_authentication
+--
+CREATE TABLE registration_authentication (
+  id text NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  expires date(4),
+  INDEX (id),
+  INDEX (recipient_id),
+  PRIMARY KEY (id),
+  CONSTRAINT registration_authentication_fk_recipient_id FOREIGN KEY (recipient_id) REFERENCES person (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS preference_time_string;
+--
+-- Table: preference_time_string
+--
+CREATE TABLE preference_time_string (
+  id integer(4) NOT NULL,
+  time_string text NOT NULL,
+  sample text NOT NULL,
+  comment text,
+  INDEX (id),
+  PRIMARY KEY (id)
+) Type=InnoDB;
+
+SET foreign_key_checks=1;
+

Added: trunk/db_script/Parley-Schema-0.58_13-PostgreSQL.sql
===================================================================
--- trunk/db_script/Parley-Schema-0.58_13-PostgreSQL.sql	2008-02-12 10:48:44 UTC (rev 787)
+++ trunk/db_script/Parley-Schema-0.58_13-PostgreSQL.sql	2008-02-12 10:53:54 UTC (rev 788)
@@ -0,0 +1,305 @@
+--
+-- Table: terms
+--
+DROP TABLE terms CASCADE;
+CREATE TABLE terms (
+  id integer NOT NULL,
+  created timestamp with time zone NOT NULL,
+  content text NOT NULL,
+  change_summary text NOT NULL,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: thread
+--
+DROP TABLE thread CASCADE;
+CREATE TABLE thread (
+  id smallint NOT NULL,
+  locked boolean(1) DEFAULT 'false' NOT NULL,
+  creator_id smallint NOT NULL,
+  subject text NOT NULL,
+  active boolean(1) DEFAULT 'true' NOT NULL,
+  forum_id smallint NOT NULL,
+  created timestamp with time zone(6) DEFAULT now(),
+  last_post_id smallint,
+  sticky boolean(1) DEFAULT 'false' NOT NULL,
+  post_count smallint DEFAULT '0' NOT NULL,
+  view_count smallint DEFAULT '0' NOT NULL,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: forum
+--
+DROP TABLE forum CASCADE;
+CREATE TABLE forum (
+  id smallint NOT NULL,
+  last_post_id smallint,
+  post_count smallint DEFAULT '0' NOT NULL,
+  active boolean(1) DEFAULT 'true' NOT NULL,
+  name text NOT NULL,
+  description text,
+  PRIMARY KEY (id),
+  Constraint "forum_name_key" UNIQUE (name)
+);
+
+
+
+--
+-- Table: preference
+--
+DROP TABLE preference CASCADE;
+CREATE TABLE preference (
+  id smallint NOT NULL,
+  timezone text DEFAULT 'UTC' NOT NULL,
+  time_format_id smallint NOT NULL,
+  show_tz boolean(1) DEFAULT 'true' NOT NULL,
+  notify_thread_watch boolean(1) DEFAULT 'false' NOT NULL,
+  watch_on_post boolean(1) DEFAULT 'false' NOT NULL,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: authentication
+--
+DROP TABLE authentication CASCADE;
+CREATE TABLE authentication (
+  id smallint NOT NULL,
+  password text NOT NULL,
+  authenticated boolean(1) DEFAULT 'false' NOT NULL,
+  username text NOT NULL,
+  PRIMARY KEY (id),
+  Constraint "authentication_username_key" UNIQUE (username)
+);
+
+
+
+--
+-- Table: email_queue
+--
+DROP TABLE email_queue CASCADE;
+CREATE TABLE email_queue (
+  id smallint NOT NULL,
+  recipient_id smallint NOT NULL,
+  cc_id smallint,
+  bcc_id smallint,
+  sender text,
+  subject text NOT NULL,
+  html_content text,
+  attempted_delivery boolean(1) DEFAULT 'false' NOT NULL,
+  text_content text NOT NULL,
+  queued timestamp with time zone(6) DEFAULT now() NOT NULL,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: terms_agreed
+--
+DROP TABLE terms_agreed CASCADE;
+CREATE TABLE terms_agreed (
+  id integer NOT NULL,
+  person_id integer NOT NULL,
+  terms_id integer NOT NULL,
+  accepted_on timestamp with time zone NOT NULL,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: password_reset
+--
+DROP TABLE password_reset CASCADE;
+CREATE TABLE password_reset (
+  id integer NOT NULL,
+  recipient_id smallint NOT NULL,
+  expires timestamp without time zone(6),
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: post
+--
+DROP TABLE post CASCADE;
+CREATE TABLE post (
+  id smallint NOT NULL,
+  creator_id smallint NOT NULL,
+  subject text,
+  quoted_post_id smallint,
+  message text NOT NULL,
+  quoted_text text,
+  created timestamp with time zone(6) DEFAULT now(),
+  thread_id smallint NOT NULL,
+  reply_to_id smallint,
+  edited timestamp with time zone(6),
+  ip_addr inet(8),
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: forum_moderator
+--
+DROP TABLE forum_moderator CASCADE;
+CREATE TABLE forum_moderator (
+  person_id smallint NOT NULL,
+  forum_id smallint NOT NULL,
+  can_moderate boolean(1) DEFAULT 'false' NOT NULL,
+  Constraint "forum_moderator_person_key" UNIQUE (person_id, forum_id)
+);
+
+
+
+--
+-- Table: thread_view
+--
+DROP TABLE thread_view CASCADE;
+CREATE TABLE thread_view (
+  id smallint NOT NULL,
+  watched boolean(1) DEFAULT 'false' NOT NULL,
+  last_notified timestamp with time zone(6),
+  thread_id smallint NOT NULL,
+  timestamp timestamp with time zone(6) DEFAULT now() NOT NULL,
+  person_id smallint NOT NULL,
+  PRIMARY KEY (id),
+  Constraint "thread_view_person_key" UNIQUE (person_id, thread_id)
+);
+
+
+
+--
+-- Table: person
+--
+DROP TABLE person CASCADE;
+CREATE TABLE person (
+  id smallint NOT NULL,
+  authentication_id smallint,
+  last_name text NOT NULL,
+  email text NOT NULL,
+  forum_name text NOT NULL,
+  preference_id smallint,
+  last_post_id smallint,
+  post_count smallint DEFAULT '0' NOT NULL,
+  first_name text NOT NULL,
+  PRIMARY KEY (id),
+  Constraint "person_forum_name_key" UNIQUE (forum_name),
+  Constraint "person_email_key" UNIQUE (email)
+);
+
+
+
+--
+-- Table: registration_authentication
+--
+DROP TABLE registration_authentication CASCADE;
+CREATE TABLE registration_authentication (
+  id text NOT NULL,
+  recipient_id smallint NOT NULL,
+  expires date(4),
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: preference_time_string
+--
+DROP TABLE preference_time_string CASCADE;
+CREATE TABLE preference_time_string (
+  id smallint NOT NULL,
+  time_string text NOT NULL,
+  sample text NOT NULL,
+  comment text,
+  PRIMARY KEY (id)
+);
+
+--
+-- Foreign Key Definitions
+--
+
+ALTER TABLE thread ADD FOREIGN KEY (last_post_id)
+  REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE thread ADD FOREIGN KEY (forum_id)
+  REFERENCES forum_moderator (forum);
+
+ALTER TABLE thread ADD FOREIGN KEY (creator_id)
+  REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE thread ADD FOREIGN KEY (forum_id)
+  REFERENCES forum (id);
+
+ALTER TABLE forum ADD FOREIGN KEY (last_post_id)
+  REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE preference ADD FOREIGN KEY (preference_id)
+  REFERENCES person (id);
+
+ALTER TABLE preference ADD FOREIGN KEY (time_format_id)
+  REFERENCES preference_time_string (id);
+
+ALTER TABLE email_queue ADD FOREIGN KEY (bcc_id)
+  REFERENCES person (id);
+
+ALTER TABLE email_queue ADD FOREIGN KEY (cc_id)
+  REFERENCES person (id);
+
+ALTER TABLE email_queue ADD FOREIGN KEY (recipient_id)
+  REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE terms_agreed ADD FOREIGN KEY (person_id)
+  REFERENCES person (id);
+
+ALTER TABLE terms_agreed ADD FOREIGN KEY (terms_id)
+  REFERENCES terms (id);
+
+ALTER TABLE password_reset ADD FOREIGN KEY (recipient_id)
+  REFERENCES person (id);
+
+ALTER TABLE post ADD FOREIGN KEY (creator_id)
+  REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE post ADD FOREIGN KEY (quoted_post_id)
+  REFERENCES post (id);
+
+ALTER TABLE post ADD FOREIGN KEY (thread_id)
+  REFERENCES thread (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE post ADD FOREIGN KEY (reply_to_id)
+  REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE forum_moderator ADD FOREIGN KEY (person_id)
+  REFERENCES person (id);
+
+ALTER TABLE forum_moderator ADD FOREIGN KEY (forum_id)
+  REFERENCES forum (id);
+
+ALTER TABLE thread_view ADD FOREIGN KEY (thread_id)
+  REFERENCES thread (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE thread_view ADD FOREIGN KEY (person_id)
+  REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE person ADD FOREIGN KEY (last_post_id)
+  REFERENCES post (id);
+
+ALTER TABLE person ADD FOREIGN KEY (preference_id)
+  REFERENCES preference (id);
+
+ALTER TABLE person ADD FOREIGN KEY (authentication_id)
+  REFERENCES authentication (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE registration_authentication ADD FOREIGN KEY (recipient_id)
+  REFERENCES person (id);

Added: trunk/db_script/Parley-Schema-0.58_13-SQLite.sql
===================================================================
--- trunk/db_script/Parley-Schema-0.58_13-SQLite.sql	2008-02-12 10:48:44 UTC (rev 787)
+++ trunk/db_script/Parley-Schema-0.58_13-SQLite.sql	2008-02-12 10:53:54 UTC (rev 788)
@@ -0,0 +1,211 @@
+-- 
+-- Created by SQL::Translator::Producer::SQLite
+-- Created on Mon Jan 14 19:14:00 2008
+-- 
+BEGIN TRANSACTION;
+
+
+--
+-- Table: terms
+--
+DROP TABLE terms;
+CREATE TABLE terms (
+  id INTEGER PRIMARY KEY NOT NULL,
+  created timestamp with time zone NOT NULL,
+  content text NOT NULL,
+  change_summary text NOT NULL
+);
+
+
+--
+-- Table: thread
+--
+DROP TABLE thread;
+CREATE TABLE thread (
+  id INTEGER PRIMARY KEY NOT NULL,
+  locked boolean(1) NOT NULL DEFAULT 'false',
+  creator_id integer(4) NOT NULL,
+  subject text NOT NULL,
+  active boolean(1) NOT NULL DEFAULT 'true',
+  forum_id integer(4) NOT NULL,
+  created timestamp with time zone(8) DEFAULT CURRENT_TIMESTAMP,
+  last_post_id integer(4),
+  sticky boolean(1) NOT NULL DEFAULT 'false',
+  post_count integer(4) NOT NULL DEFAULT '0',
+  view_count integer(4) NOT NULL DEFAULT '0'
+);
+
+
+--
+-- Table: forum
+--
+DROP TABLE forum;
+CREATE TABLE forum (
+  id INTEGER PRIMARY KEY NOT NULL,
+  last_post_id integer(4),
+  post_count integer(4) NOT NULL DEFAULT '0',
+  active boolean(1) NOT NULL DEFAULT 'true',
+  name text NOT NULL,
+  description text
+);
+
+CREATE UNIQUE INDEX forum_name_key_forum on forum (name);
+
+--
+-- Table: preference
+--
+DROP TABLE preference;
+CREATE TABLE preference (
+  id INTEGER PRIMARY KEY NOT NULL,
+  timezone text NOT NULL DEFAULT 'UTC',
+  time_format_id integer(4) NOT NULL,
+  show_tz boolean(1) NOT NULL DEFAULT 'true',
+  notify_thread_watch boolean(1) NOT NULL DEFAULT 'false',
+  watch_on_post boolean(1) NOT NULL DEFAULT 'false'
+);
+
+
+--
+-- Table: authentication
+--
+DROP TABLE authentication;
+CREATE TABLE authentication (
+  id INTEGER PRIMARY KEY NOT NULL,
+  password text NOT NULL,
+  authenticated boolean(1) NOT NULL DEFAULT 'false',
+  username text NOT NULL
+);
+
+CREATE UNIQUE INDEX authentication_username_key_au on authentication (username);
+
+--
+-- Table: email_queue
+--
+DROP TABLE email_queue;
+CREATE TABLE email_queue (
+  id INTEGER PRIMARY KEY NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  cc_id integer(4),
+  bcc_id integer(4),
+  sender text,
+  subject text NOT NULL,
+  html_content text,
+  attempted_delivery boolean(1) NOT NULL DEFAULT 'false',
+  text_content text NOT NULL,
+  queued timestamp with time zone(8) NOT NULL DEFAULT CURRENT_TIMESTAMP
+);
+
+
+--
+-- Table: terms_agreed
+--
+DROP TABLE terms_agreed;
+CREATE TABLE terms_agreed (
+  id INTEGER PRIMARY KEY NOT NULL,
+  person_id integer NOT NULL,
+  terms_id integer NOT NULL,
+  accepted_on timestamp with time zone NOT NULL
+);
+
+
+--
+-- Table: password_reset
+--
+DROP TABLE password_reset;
+CREATE TABLE password_reset (
+  id INTEGER PRIMARY KEY NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  expires timestamp without time zone(8)
+);
+
+
+--
+-- Table: post
+--
+DROP TABLE post;
+CREATE TABLE post (
+  id INTEGER PRIMARY KEY NOT NULL,
+  creator_id integer(4) NOT NULL,
+  subject text,
+  quoted_post_id integer(4),
+  message text NOT NULL,
+  quoted_text text,
+  created timestamp with time zone(8) DEFAULT CURRENT_TIMESTAMP,
+  thread_id integer(4) NOT NULL,
+  reply_to_id integer(4),
+  edited timestamp with time zone(8),
+  ip_addr inet(8)
+);
+
+
+--
+-- Table: forum_moderator
+--
+DROP TABLE forum_moderator;
+CREATE TABLE forum_moderator (
+  person_id integer(4) NOT NULL,
+  forum_id integer(4) NOT NULL,
+  can_moderate boolean(1) NOT NULL DEFAULT 'false'
+);
+
+CREATE UNIQUE INDEX forum_moderator_person_key_for on forum_moderator (person_id, forum_id);
+
+--
+-- Table: thread_view
+--
+DROP TABLE thread_view;
+CREATE TABLE thread_view (
+  id INTEGER PRIMARY KEY NOT NULL,
+  watched boolean(1) NOT NULL DEFAULT 'false',
+  last_notified timestamp with time zone(8),
+  thread_id integer(4) NOT NULL,
+  timestamp timestamp with time zone(8) NOT NULL DEFAULT CURRENT_TIMESTAMP,
+  person_id integer(4) NOT NULL
+);
+
+CREATE UNIQUE INDEX thread_view_person_key_thread_ on thread_view (person_id, thread_id);
+
+--
+-- Table: person
+--
+DROP TABLE person;
+CREATE TABLE person (
+  id INTEGER PRIMARY KEY NOT NULL,
+  authentication_id integer(4),
+  last_name text NOT NULL,
+  email text NOT NULL,
+  forum_name text NOT NULL,
+  preference_id integer(4),
+  last_post_id integer(4),
+  post_count integer(4) NOT NULL DEFAULT '0',
+  first_name text NOT NULL
+);
+
+CREATE UNIQUE INDEX person_forum_name_key_person on person (forum_name);
+CREATE UNIQUE INDEX person_email_key_person on person (email);
+
+--
+-- Table: registration_authentication
+--
+DROP TABLE registration_authentication;
+CREATE TABLE registration_authentication (
+  id text NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  expires date(4),
+  PRIMARY KEY (id)
+);
+
+
+--
+-- Table: preference_time_string
+--
+DROP TABLE preference_time_string;
+CREATE TABLE preference_time_string (
+  id INTEGER PRIMARY KEY NOT NULL,
+  time_string text NOT NULL,
+  sample text NOT NULL,
+  comment text
+);
+
+
+COMMIT;



From chiselwright at mail.berlios.de  Tue Feb 12 11:54:06 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 12 Feb 2008 11:54:06 +0100
Subject: [Parley-svn] r789 - / tags
Message-ID: <200802121054.m1CAs6HM024276@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-12 11:54:03 +0100 (Tue, 12 Feb 2008)
New Revision: 789

Removed:
   tags/parley-0.58/
Modified:
   /
Log:
 r4636 at wiggin:  chisel | 2008-02-10 15:57:57 +0000
 - missed a couple of files



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4635
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4636
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222



From chiselwright at mail.berlios.de  Tue Feb 12 11:54:14 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 12 Feb 2008 11:54:14 +0100
Subject: [Parley-svn] r790 - / tags
Message-ID: <200802121054.m1CAsEeV024347@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-12 11:54:14 +0100 (Tue, 12 Feb 2008)
New Revision: 790

Added:
   tags/parley-0.58/
Modified:
   /
Log:
 r4637 at wiggin:  chisel | 2008-02-10 15:58:46 +0000
 Tagging Parley 0.58 (again)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4636
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4637
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Copied: tags/parley-0.58 (from rev 788, trunk)



From chiselwright at mail.berlios.de  Tue Feb 12 11:59:47 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 12 Feb 2008 11:59:47 +0100
Subject: [Parley-svn] r791 - / trunk trunk/db_script trunk/lib
Message-ID: <200802121059.m1CAxlSQ024783@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-12 11:59:47 +0100 (Tue, 12 Feb 2008)
New Revision: 791

Added:
   trunk/db_script/Parley-Schema-0.59_01-MySQL.sql
   trunk/db_script/Parley-Schema-0.59_01-PostgreSQL.sql
   trunk/db_script/Parley-Schema-0.59_01-SQLite.sql
Modified:
   /
   trunk/Changes
   trunk/Changes.i18n
   trunk/lib/Parley.pm
Log:
 r4638 at wiggin:  chisel | 2008-02-11 08:44:21 +0000
 / initial prep for 0.59 development



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4637
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4638
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes
===================================================================
--- trunk/Changes	2008-02-12 10:54:14 UTC (rev 790)
+++ trunk/Changes	2008-02-12 10:59:47 UTC (rev 791)
@@ -1,5 +1,7 @@
 This file documents the revision history for Parley.
 
+0.59 (UNDER DEVELOPMENT)
+
 0.58    Fri Feb  8 07:47:31 GMT 2008
     - re-work the UI design to be cleaner
     - added an application logo

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-02-12 10:54:14 UTC (rev 790)
+++ trunk/Changes.i18n	2008-02-12 10:59:47 UTC (rev 791)
@@ -6,6 +6,8 @@
 will be used as the 'en' i18n file.
 It's unlikely that we'll need an 'en' file in the project.
 
+0.59 (UNDER DEVELOPMENT)
+
 0.58
     (en renamed to i_default)
 

Added: trunk/db_script/Parley-Schema-0.59_01-MySQL.sql
===================================================================
--- trunk/db_script/Parley-Schema-0.59_01-MySQL.sql	2008-02-12 10:54:14 UTC (rev 790)
+++ trunk/db_script/Parley-Schema-0.59_01-MySQL.sql	2008-02-12 10:59:47 UTC (rev 791)
@@ -0,0 +1,275 @@
+-- 
+-- Created by SQL::Translator::Producer::MySQL
+-- Created on Mon Feb 11 08:43:35 2008
+-- 
+SET foreign_key_checks=0;
+
+DROP TABLE IF EXISTS authentication;
+--
+-- Table: authentication
+--
+CREATE TABLE authentication (
+  id integer(4) NOT NULL,
+  password text NOT NULL,
+  authenticated enum('0','1') NOT NULL DEFAULT 'false',
+  username text NOT NULL,
+  INDEX (id),
+  INDEX (username),
+  PRIMARY KEY (id),
+  UNIQUE authentication_username_key (username)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS email_queue;
+--
+-- Table: email_queue
+--
+CREATE TABLE email_queue (
+  id integer(4) NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  cc_id integer(4),
+  bcc_id integer(4),
+  sender text,
+  subject text NOT NULL,
+  html_content text,
+  attempted_delivery enum('0','1') NOT NULL DEFAULT 'false',
+  text_content text NOT NULL,
+  queued timestamp with time zone(8) NOT NULL DEFAULT 'now()',
+  INDEX (id),
+  INDEX (bcc_id),
+  INDEX (cc_id),
+  INDEX (recipient_id),
+  PRIMARY KEY (id),
+  CONSTRAINT email_queue_fk_bcc_id FOREIGN KEY (bcc_id) REFERENCES person (id),
+  CONSTRAINT email_queue_fk_cc_id FOREIGN KEY (cc_id) REFERENCES person (id),
+  CONSTRAINT email_queue_fk_recipient_id FOREIGN KEY (recipient_id) REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS forum;
+--
+-- Table: forum
+--
+CREATE TABLE forum (
+  id integer(4) NOT NULL,
+  last_post_id integer(4),
+  post_count integer(4) NOT NULL DEFAULT '0',
+  active enum('0','1') NOT NULL DEFAULT 'true',
+  name text NOT NULL,
+  description text,
+  INDEX (id),
+  INDEX (name),
+  INDEX (last_post_id),
+  PRIMARY KEY (id),
+  UNIQUE forum_name_key (name),
+  CONSTRAINT forum_fk_last_post_id FOREIGN KEY (last_post_id) REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS forum_moderator;
+--
+-- Table: forum_moderator
+--
+CREATE TABLE forum_moderator (
+  person_id integer(4) NOT NULL,
+  forum_id integer(4) NOT NULL,
+  can_moderate enum('0','1') NOT NULL DEFAULT 'false',
+  INDEX (person_id),
+  INDEX (forum_id),
+  UNIQUE forum_moderator_person_key (person_id, forum_id),
+  CONSTRAINT forum_moderator_fk_forum_id FOREIGN KEY (forum_id) REFERENCES forum (id),
+  CONSTRAINT forum_moderator_fk_person_id FOREIGN KEY (person_id) REFERENCES person (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS password_reset;
+--
+-- Table: password_reset
+--
+CREATE TABLE password_reset (
+  id integer NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  expires timestamp without time zone(8),
+  INDEX (id),
+  INDEX (recipient_id),
+  PRIMARY KEY (id),
+  CONSTRAINT password_reset_fk_recipient_id FOREIGN KEY (recipient_id) REFERENCES person (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS person;
+--
+-- Table: person
+--
+CREATE TABLE person (
+  id integer(4) NOT NULL,
+  authentication_id integer(4),
+  last_name text NOT NULL,
+  email text NOT NULL,
+  forum_name text NOT NULL,
+  preference_id integer(4),
+  last_post_id integer(4),
+  post_count integer(4) NOT NULL DEFAULT '0',
+  first_name text NOT NULL,
+  INDEX (id),
+  INDEX (forum_name),
+  INDEX (email),
+  INDEX (authentication_id),
+  INDEX (last_post_id),
+  INDEX (preference_id),
+  PRIMARY KEY (id),
+  UNIQUE person_forum_name_key (forum_name),
+  UNIQUE person_email_key (email),
+  CONSTRAINT person_fk_authentication_id FOREIGN KEY (authentication_id) REFERENCES authentication (id) ON DELETE CASCADE ON UPDATE CASCADE,
+  CONSTRAINT person_fk_last_post_id FOREIGN KEY (last_post_id) REFERENCES post (id),
+  CONSTRAINT person_fk_preference_id FOREIGN KEY (preference_id) REFERENCES preference (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS post;
+--
+-- Table: post
+--
+CREATE TABLE post (
+  id integer(4) NOT NULL,
+  creator_id integer(4) NOT NULL,
+  subject text,
+  quoted_post_id integer(4),
+  message text NOT NULL,
+  quoted_text text,
+  created timestamp with time zone(8) DEFAULT 'now()',
+  thread_id integer(4) NOT NULL,
+  reply_to_id integer(4),
+  edited timestamp with time zone(8),
+  ip_addr inet(8),
+  INDEX (id),
+  INDEX (creator_id),
+  INDEX (quoted_post_id),
+  INDEX (reply_to_id),
+  INDEX (thread_id),
+  PRIMARY KEY (id),
+  CONSTRAINT post_fk_creator_id FOREIGN KEY (creator_id) REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE,
+  CONSTRAINT post_fk_quoted_post_id FOREIGN KEY (quoted_post_id) REFERENCES post (id),
+  CONSTRAINT post_fk_reply_to_id FOREIGN KEY (reply_to_id) REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE,
+  CONSTRAINT post_fk_thread_id FOREIGN KEY (thread_id) REFERENCES thread (id) ON DELETE CASCADE ON UPDATE CASCADE
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS preference;
+--
+-- Table: preference
+--
+CREATE TABLE preference (
+  id integer(4) NOT NULL,
+  timezone text NOT NULL DEFAULT 'UTC',
+  time_format_id integer(4) NOT NULL,
+  show_tz enum('0','1') NOT NULL DEFAULT 'true',
+  notify_thread_watch enum('0','1') NOT NULL DEFAULT 'false',
+  watch_on_post enum('0','1') NOT NULL DEFAULT 'false',
+  INDEX (id),
+  INDEX (preference_id),
+  INDEX (time_format_id),
+  PRIMARY KEY (id),
+  CONSTRAINT preference_fk_preference_id FOREIGN KEY (preference_id) REFERENCES person (id),
+  CONSTRAINT preference_fk_time_format_id FOREIGN KEY (time_format_id) REFERENCES preference_time_string (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS preference_time_string;
+--
+-- Table: preference_time_string
+--
+CREATE TABLE preference_time_string (
+  id integer(4) NOT NULL,
+  time_string text NOT NULL,
+  sample text NOT NULL,
+  comment text,
+  INDEX (id),
+  PRIMARY KEY (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS registration_authentication;
+--
+-- Table: registration_authentication
+--
+CREATE TABLE registration_authentication (
+  id text NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  expires date(4),
+  INDEX (id),
+  INDEX (recipient_id),
+  PRIMARY KEY (id),
+  CONSTRAINT registration_authentication_fk_recipient_id FOREIGN KEY (recipient_id) REFERENCES person (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS terms;
+--
+-- Table: terms
+--
+CREATE TABLE terms (
+  id integer NOT NULL,
+  created timestamp with time zone NOT NULL,
+  content text NOT NULL,
+  change_summary text NOT NULL,
+  INDEX (id),
+  PRIMARY KEY (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS terms_agreed;
+--
+-- Table: terms_agreed
+--
+CREATE TABLE terms_agreed (
+  id integer NOT NULL,
+  person_id integer NOT NULL,
+  terms_id integer NOT NULL,
+  accepted_on timestamp with time zone NOT NULL,
+  INDEX (id),
+  INDEX (person_id),
+  INDEX (terms_id),
+  PRIMARY KEY (id),
+  CONSTRAINT terms_agreed_fk_person_id FOREIGN KEY (person_id) REFERENCES person (id),
+  CONSTRAINT terms_agreed_fk_terms_id FOREIGN KEY (terms_id) REFERENCES terms (id)
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS thread;
+--
+-- Table: thread
+--
+CREATE TABLE thread (
+  id integer(4) NOT NULL,
+  locked enum('0','1') NOT NULL DEFAULT 'false',
+  creator_id integer(4) NOT NULL,
+  subject text NOT NULL,
+  active enum('0','1') NOT NULL DEFAULT 'true',
+  forum_id integer(4) NOT NULL,
+  created timestamp with time zone(8) DEFAULT 'now()',
+  last_post_id integer(4),
+  sticky enum('0','1') NOT NULL DEFAULT 'false',
+  post_count integer(4) NOT NULL DEFAULT '0',
+  view_count integer(4) NOT NULL DEFAULT '0',
+  INDEX (id),
+  INDEX (creator_id),
+  INDEX (forum_id),
+  INDEX (last_post_id),
+  PRIMARY KEY (id),
+  CONSTRAINT thread_fk_creator_id FOREIGN KEY (creator_id) REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE,
+  CONSTRAINT thread_fk_forum_id FOREIGN KEY (forum_id) REFERENCES forum (id),
+  CONSTRAINT thread_fk_forum_id_1 FOREIGN KEY (forum_id) REFERENCES forum_moderator (forum),
+  CONSTRAINT thread_fk_last_post_id FOREIGN KEY (last_post_id) REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE
+) Type=InnoDB;
+
+DROP TABLE IF EXISTS thread_view;
+--
+-- Table: thread_view
+--
+CREATE TABLE thread_view (
+  id integer(4) NOT NULL,
+  watched enum('0','1') NOT NULL DEFAULT 'false',
+  last_notified timestamp with time zone(8),
+  thread_id integer(4) NOT NULL,
+  timestamp timestamp with time zone(8) NOT NULL DEFAULT 'now()',
+  person_id integer(4) NOT NULL,
+  INDEX (id),
+  INDEX (person_id),
+  INDEX (thread_id),
+  PRIMARY KEY (id),
+  UNIQUE thread_view_person_key (person_id, thread_id),
+  CONSTRAINT thread_view_fk_person_id FOREIGN KEY (person_id) REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE,
+  CONSTRAINT thread_view_fk_thread_id FOREIGN KEY (thread_id) REFERENCES thread (id) ON DELETE CASCADE ON UPDATE CASCADE
+) Type=InnoDB;
+
+SET foreign_key_checks=1;
+

Added: trunk/db_script/Parley-Schema-0.59_01-PostgreSQL.sql
===================================================================
--- trunk/db_script/Parley-Schema-0.59_01-PostgreSQL.sql	2008-02-12 10:54:14 UTC (rev 790)
+++ trunk/db_script/Parley-Schema-0.59_01-PostgreSQL.sql	2008-02-12 10:59:47 UTC (rev 791)
@@ -0,0 +1,305 @@
+--
+-- Table: authentication
+--
+DROP TABLE authentication CASCADE;
+CREATE TABLE authentication (
+  id smallint NOT NULL,
+  password text NOT NULL,
+  authenticated boolean(1) DEFAULT 'false' NOT NULL,
+  username text NOT NULL,
+  PRIMARY KEY (id),
+  Constraint "authentication_username_key" UNIQUE (username)
+);
+
+
+
+--
+-- Table: email_queue
+--
+DROP TABLE email_queue CASCADE;
+CREATE TABLE email_queue (
+  id smallint NOT NULL,
+  recipient_id smallint NOT NULL,
+  cc_id smallint,
+  bcc_id smallint,
+  sender text,
+  subject text NOT NULL,
+  html_content text,
+  attempted_delivery boolean(1) DEFAULT 'false' NOT NULL,
+  text_content text NOT NULL,
+  queued timestamp with time zone(6) DEFAULT now() NOT NULL,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: forum
+--
+DROP TABLE forum CASCADE;
+CREATE TABLE forum (
+  id smallint NOT NULL,
+  last_post_id smallint,
+  post_count smallint DEFAULT '0' NOT NULL,
+  active boolean(1) DEFAULT 'true' NOT NULL,
+  name text NOT NULL,
+  description text,
+  PRIMARY KEY (id),
+  Constraint "forum_name_key" UNIQUE (name)
+);
+
+
+
+--
+-- Table: forum_moderator
+--
+DROP TABLE forum_moderator CASCADE;
+CREATE TABLE forum_moderator (
+  person_id smallint NOT NULL,
+  forum_id smallint NOT NULL,
+  can_moderate boolean(1) DEFAULT 'false' NOT NULL,
+  Constraint "forum_moderator_person_key" UNIQUE (person_id, forum_id)
+);
+
+
+
+--
+-- Table: password_reset
+--
+DROP TABLE password_reset CASCADE;
+CREATE TABLE password_reset (
+  id integer NOT NULL,
+  recipient_id smallint NOT NULL,
+  expires timestamp without time zone(6),
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: person
+--
+DROP TABLE person CASCADE;
+CREATE TABLE person (
+  id smallint NOT NULL,
+  authentication_id smallint,
+  last_name text NOT NULL,
+  email text NOT NULL,
+  forum_name text NOT NULL,
+  preference_id smallint,
+  last_post_id smallint,
+  post_count smallint DEFAULT '0' NOT NULL,
+  first_name text NOT NULL,
+  PRIMARY KEY (id),
+  Constraint "person_forum_name_key" UNIQUE (forum_name),
+  Constraint "person_email_key" UNIQUE (email)
+);
+
+
+
+--
+-- Table: post
+--
+DROP TABLE post CASCADE;
+CREATE TABLE post (
+  id smallint NOT NULL,
+  creator_id smallint NOT NULL,
+  subject text,
+  quoted_post_id smallint,
+  message text NOT NULL,
+  quoted_text text,
+  created timestamp with time zone(6) DEFAULT now(),
+  thread_id smallint NOT NULL,
+  reply_to_id smallint,
+  edited timestamp with time zone(6),
+  ip_addr inet(8),
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: preference
+--
+DROP TABLE preference CASCADE;
+CREATE TABLE preference (
+  id smallint NOT NULL,
+  timezone text DEFAULT 'UTC' NOT NULL,
+  time_format_id smallint NOT NULL,
+  show_tz boolean(1) DEFAULT 'true' NOT NULL,
+  notify_thread_watch boolean(1) DEFAULT 'false' NOT NULL,
+  watch_on_post boolean(1) DEFAULT 'false' NOT NULL,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: preference_time_string
+--
+DROP TABLE preference_time_string CASCADE;
+CREATE TABLE preference_time_string (
+  id smallint NOT NULL,
+  time_string text NOT NULL,
+  sample text NOT NULL,
+  comment text,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: registration_authentication
+--
+DROP TABLE registration_authentication CASCADE;
+CREATE TABLE registration_authentication (
+  id text NOT NULL,
+  recipient_id smallint NOT NULL,
+  expires date(4),
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: terms
+--
+DROP TABLE terms CASCADE;
+CREATE TABLE terms (
+  id integer NOT NULL,
+  created timestamp with time zone NOT NULL,
+  content text NOT NULL,
+  change_summary text NOT NULL,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: terms_agreed
+--
+DROP TABLE terms_agreed CASCADE;
+CREATE TABLE terms_agreed (
+  id integer NOT NULL,
+  person_id integer NOT NULL,
+  terms_id integer NOT NULL,
+  accepted_on timestamp with time zone NOT NULL,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: thread
+--
+DROP TABLE thread CASCADE;
+CREATE TABLE thread (
+  id smallint NOT NULL,
+  locked boolean(1) DEFAULT 'false' NOT NULL,
+  creator_id smallint NOT NULL,
+  subject text NOT NULL,
+  active boolean(1) DEFAULT 'true' NOT NULL,
+  forum_id smallint NOT NULL,
+  created timestamp with time zone(6) DEFAULT now(),
+  last_post_id smallint,
+  sticky boolean(1) DEFAULT 'false' NOT NULL,
+  post_count smallint DEFAULT '0' NOT NULL,
+  view_count smallint DEFAULT '0' NOT NULL,
+  PRIMARY KEY (id)
+);
+
+
+
+--
+-- Table: thread_view
+--
+DROP TABLE thread_view CASCADE;
+CREATE TABLE thread_view (
+  id smallint NOT NULL,
+  watched boolean(1) DEFAULT 'false' NOT NULL,
+  last_notified timestamp with time zone(6),
+  thread_id smallint NOT NULL,
+  timestamp timestamp with time zone(6) DEFAULT now() NOT NULL,
+  person_id smallint NOT NULL,
+  PRIMARY KEY (id),
+  Constraint "thread_view_person_key" UNIQUE (person_id, thread_id)
+);
+
+--
+-- Foreign Key Definitions
+--
+
+ALTER TABLE email_queue ADD FOREIGN KEY (bcc_id)
+  REFERENCES person (id);
+
+ALTER TABLE email_queue ADD FOREIGN KEY (cc_id)
+  REFERENCES person (id);
+
+ALTER TABLE email_queue ADD FOREIGN KEY (recipient_id)
+  REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE forum ADD FOREIGN KEY (last_post_id)
+  REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE forum_moderator ADD FOREIGN KEY (forum_id)
+  REFERENCES forum (id);
+
+ALTER TABLE forum_moderator ADD FOREIGN KEY (person_id)
+  REFERENCES person (id);
+
+ALTER TABLE password_reset ADD FOREIGN KEY (recipient_id)
+  REFERENCES person (id);
+
+ALTER TABLE person ADD FOREIGN KEY (authentication_id)
+  REFERENCES authentication (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE person ADD FOREIGN KEY (last_post_id)
+  REFERENCES post (id);
+
+ALTER TABLE person ADD FOREIGN KEY (preference_id)
+  REFERENCES preference (id);
+
+ALTER TABLE post ADD FOREIGN KEY (creator_id)
+  REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE post ADD FOREIGN KEY (quoted_post_id)
+  REFERENCES post (id);
+
+ALTER TABLE post ADD FOREIGN KEY (reply_to_id)
+  REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE post ADD FOREIGN KEY (thread_id)
+  REFERENCES thread (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE preference ADD FOREIGN KEY (preference_id)
+  REFERENCES person (id);
+
+ALTER TABLE preference ADD FOREIGN KEY (time_format_id)
+  REFERENCES preference_time_string (id);
+
+ALTER TABLE registration_authentication ADD FOREIGN KEY (recipient_id)
+  REFERENCES person (id);
+
+ALTER TABLE terms_agreed ADD FOREIGN KEY (person_id)
+  REFERENCES person (id);
+
+ALTER TABLE terms_agreed ADD FOREIGN KEY (terms_id)
+  REFERENCES terms (id);
+
+ALTER TABLE thread ADD FOREIGN KEY (creator_id)
+  REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE thread ADD FOREIGN KEY (forum_id)
+  REFERENCES forum (id);
+
+ALTER TABLE thread ADD FOREIGN KEY (forum_id)
+  REFERENCES forum_moderator (forum);
+
+ALTER TABLE thread ADD FOREIGN KEY (last_post_id)
+  REFERENCES post (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE thread_view ADD FOREIGN KEY (person_id)
+  REFERENCES person (id) ON DELETE CASCADE ON UPDATE CASCADE;
+
+ALTER TABLE thread_view ADD FOREIGN KEY (thread_id)
+  REFERENCES thread (id) ON DELETE CASCADE ON UPDATE CASCADE;

Added: trunk/db_script/Parley-Schema-0.59_01-SQLite.sql
===================================================================
--- trunk/db_script/Parley-Schema-0.59_01-SQLite.sql	2008-02-12 10:54:14 UTC (rev 790)
+++ trunk/db_script/Parley-Schema-0.59_01-SQLite.sql	2008-02-12 10:59:47 UTC (rev 791)
@@ -0,0 +1,211 @@
+-- 
+-- Created by SQL::Translator::Producer::SQLite
+-- Created on Mon Feb 11 08:43:35 2008
+-- 
+BEGIN TRANSACTION;
+
+
+--
+-- Table: authentication
+--
+DROP TABLE authentication;
+CREATE TABLE authentication (
+  id INTEGER PRIMARY KEY NOT NULL,
+  password text NOT NULL,
+  authenticated boolean(1) NOT NULL DEFAULT 'false',
+  username text NOT NULL
+);
+
+CREATE UNIQUE INDEX authentication_username_key_au on authentication (username);
+
+--
+-- Table: email_queue
+--
+DROP TABLE email_queue;
+CREATE TABLE email_queue (
+  id INTEGER PRIMARY KEY NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  cc_id integer(4),
+  bcc_id integer(4),
+  sender text,
+  subject text NOT NULL,
+  html_content text,
+  attempted_delivery boolean(1) NOT NULL DEFAULT 'false',
+  text_content text NOT NULL,
+  queued timestamp with time zone(8) NOT NULL DEFAULT CURRENT_TIMESTAMP
+);
+
+
+--
+-- Table: forum
+--
+DROP TABLE forum;
+CREATE TABLE forum (
+  id INTEGER PRIMARY KEY NOT NULL,
+  last_post_id integer(4),
+  post_count integer(4) NOT NULL DEFAULT '0',
+  active boolean(1) NOT NULL DEFAULT 'true',
+  name text NOT NULL,
+  description text
+);
+
+CREATE UNIQUE INDEX forum_name_key_forum on forum (name);
+
+--
+-- Table: forum_moderator
+--
+DROP TABLE forum_moderator;
+CREATE TABLE forum_moderator (
+  person_id integer(4) NOT NULL,
+  forum_id integer(4) NOT NULL,
+  can_moderate boolean(1) NOT NULL DEFAULT 'false'
+);
+
+CREATE UNIQUE INDEX forum_moderator_person_key_for on forum_moderator (person_id, forum_id);
+
+--
+-- Table: password_reset
+--
+DROP TABLE password_reset;
+CREATE TABLE password_reset (
+  id INTEGER PRIMARY KEY NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  expires timestamp without time zone(8)
+);
+
+
+--
+-- Table: person
+--
+DROP TABLE person;
+CREATE TABLE person (
+  id INTEGER PRIMARY KEY NOT NULL,
+  authentication_id integer(4),
+  last_name text NOT NULL,
+  email text NOT NULL,
+  forum_name text NOT NULL,
+  preference_id integer(4),
+  last_post_id integer(4),
+  post_count integer(4) NOT NULL DEFAULT '0',
+  first_name text NOT NULL
+);
+
+CREATE UNIQUE INDEX person_forum_name_key_person on person (forum_name);
+CREATE UNIQUE INDEX person_email_key_person on person (email);
+
+--
+-- Table: post
+--
+DROP TABLE post;
+CREATE TABLE post (
+  id INTEGER PRIMARY KEY NOT NULL,
+  creator_id integer(4) NOT NULL,
+  subject text,
+  quoted_post_id integer(4),
+  message text NOT NULL,
+  quoted_text text,
+  created timestamp with time zone(8) DEFAULT CURRENT_TIMESTAMP,
+  thread_id integer(4) NOT NULL,
+  reply_to_id integer(4),
+  edited timestamp with time zone(8),
+  ip_addr inet(8)
+);
+
+
+--
+-- Table: preference
+--
+DROP TABLE preference;
+CREATE TABLE preference (
+  id INTEGER PRIMARY KEY NOT NULL,
+  timezone text NOT NULL DEFAULT 'UTC',
+  time_format_id integer(4) NOT NULL,
+  show_tz boolean(1) NOT NULL DEFAULT 'true',
+  notify_thread_watch boolean(1) NOT NULL DEFAULT 'false',
+  watch_on_post boolean(1) NOT NULL DEFAULT 'false'
+);
+
+
+--
+-- Table: preference_time_string
+--
+DROP TABLE preference_time_string;
+CREATE TABLE preference_time_string (
+  id INTEGER PRIMARY KEY NOT NULL,
+  time_string text NOT NULL,
+  sample text NOT NULL,
+  comment text
+);
+
+
+--
+-- Table: registration_authentication
+--
+DROP TABLE registration_authentication;
+CREATE TABLE registration_authentication (
+  id text NOT NULL,
+  recipient_id integer(4) NOT NULL,
+  expires date(4),
+  PRIMARY KEY (id)
+);
+
+
+--
+-- Table: terms
+--
+DROP TABLE terms;
+CREATE TABLE terms (
+  id INTEGER PRIMARY KEY NOT NULL,
+  created timestamp with time zone NOT NULL,
+  content text NOT NULL,
+  change_summary text NOT NULL
+);
+
+
+--
+-- Table: terms_agreed
+--
+DROP TABLE terms_agreed;
+CREATE TABLE terms_agreed (
+  id INTEGER PRIMARY KEY NOT NULL,
+  person_id integer NOT NULL,
+  terms_id integer NOT NULL,
+  accepted_on timestamp with time zone NOT NULL
+);
+
+
+--
+-- Table: thread
+--
+DROP TABLE thread;
+CREATE TABLE thread (
+  id INTEGER PRIMARY KEY NOT NULL,
+  locked boolean(1) NOT NULL DEFAULT 'false',
+  creator_id integer(4) NOT NULL,
+  subject text NOT NULL,
+  active boolean(1) NOT NULL DEFAULT 'true',
+  forum_id integer(4) NOT NULL,
+  created timestamp with time zone(8) DEFAULT CURRENT_TIMESTAMP,
+  last_post_id integer(4),
+  sticky boolean(1) NOT NULL DEFAULT 'false',
+  post_count integer(4) NOT NULL DEFAULT '0',
+  view_count integer(4) NOT NULL DEFAULT '0'
+);
+
+
+--
+-- Table: thread_view
+--
+DROP TABLE thread_view;
+CREATE TABLE thread_view (
+  id INTEGER PRIMARY KEY NOT NULL,
+  watched boolean(1) NOT NULL DEFAULT 'false',
+  last_notified timestamp with time zone(8),
+  thread_id integer(4) NOT NULL,
+  timestamp timestamp with time zone(8) NOT NULL DEFAULT CURRENT_TIMESTAMP,
+  person_id integer(4) NOT NULL
+);
+
+CREATE UNIQUE INDEX thread_view_person_key_thread_ on thread_view (person_id, thread_id);
+
+COMMIT;

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-02-12 10:54:14 UTC (rev 790)
+++ trunk/lib/Parley.pm	2008-02-12 10:59:47 UTC (rev 791)
@@ -3,7 +3,7 @@
 use strict;
 use warnings;
 
-our $VERSION = '0.58';
+our $VERSION = '0.59_01';
 
 use Catalyst::Runtime '5.70';
 use Catalyst qw/



From chiselwright at mail.berlios.de  Tue Feb 12 11:59:54 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 12 Feb 2008 11:59:54 +0100
Subject: [Parley-svn] r792 - / trunk
Message-ID: <200802121059.m1CAxsG1024879@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-12 11:59:54 +0100 (Tue, 12 Feb 2008)
New Revision: 792

Modified:
   /
   trunk/TODO
Log:
 r4639 at wiggin:  chisel | 2008-02-11 08:46:15 +0000
 + added item to TODO that's been in the tip of my tongue for some time



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4638
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4639
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-12 10:59:47 UTC (rev 791)
+++ trunk/TODO	2008-02-12 10:59:54 UTC (rev 792)
@@ -19,6 +19,7 @@
   - skinning (user pref overrides CSS used?)
   - posting page ForumCode help/tips
   - database versioning
+  - ForumCode: thumbnail image, lightbox view?
 D - login form flickers on IE7 page load
 D - [bug] user/profile doesn't show avatar
 D - add i18n for 'or'



From chiselwright at mail.berlios.de  Tue Feb 12 12:00:52 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 12 Feb 2008 12:00:52 +0100
Subject: [Parley-svn] r793 - / trunk/lib/Parley/I18N
Message-ID: <200802121100.m1CB0qkL025238@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-12 12:00:51 +0100 (Tue, 12 Feb 2008)
New Revision: 793

Modified:
   /
   trunk/lib/Parley/I18N/it.po
Log:
 r4647 at wiggin:  chisel | 2008-02-12 11:00:41 +0000
 / some .it i18n tweaks



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4639
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4647
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/I18N/it.po
===================================================================
--- trunk/lib/Parley/I18N/it.po	2008-02-12 10:59:54 UTC (rev 792)
+++ trunk/lib/Parley/I18N/it.po	2008-02-12 11:00:51 UTC (rev 793)
@@ -44,10 +44,10 @@
 msgstr "Aggiungi Watch"
 
 msgid "ADMIN SPECIFY LOCK THREAD"
-msgstr "Bisogna specificare il thread da chiudere"
+msgstr "Bisogna specificare il discussione da chiudere"
 
 msgid "ADMIN SPECIFY STICK THREAD"
-msgstr "Bisogna specificare il thread di rilievo"
+msgstr "Bisogna specificare il discussione di rilievo"
 
 msgid "ago"
 msgstr "fa"
@@ -261,7 +261,7 @@
 msgstr "Ultima Lettura"
 
 msgid "LOCK AFTER POSTING"
-msgstr "Chiudi thread dopo aver inviato il messaggio"
+msgstr "Chiudi discussione dopo aver inviato il messaggio"
 
 msgid "Lock Thread"
 msgstr "Chiudi Thread"
@@ -282,13 +282,13 @@
 msgstr "Bisogna aver effettuato il login prima di poter accedere qui."
 
 msgid "LOGIN THREAD CONTINUE"
-msgstr "Bisogna aver effettuato il login prima di poter usare la funzione continuazione thread."
+msgstr "Bisogna aver effettuato il login prima di poter usare la funzione continuazione discussione."
 
 msgid "LOGIN USE NEW"
 msgstr "Effettuare login usando nome utente e la <u>nuova</u> password."
 
 msgid "LOGIN VIEW WATCHES"
-msgstr "Bisogna aver effettuato il login prima di potere vedere i thread seguiti."
+msgstr "Bisogna aver effettuato il login prima di potere vedere i discussione seguiti."
 
 msgid "LOGIN WATCH TOPIC"
 msgstr "Bisogna aver effettuato il login prima di poter seguire una discussione."
@@ -348,7 +348,7 @@
 msgstr "Non ci sono utenti che corrispondo alle informazioni fornite"
 
 msgid "NO RECENT THREADS"
-msgstr "Non ci sono thread recenti da visualizzare"
+msgstr "Non ci sono discussione recenti da visualizzare"
 
 msgid "NO SEARCH RESULTS"
 msgstr "La ricerca non ha fornito risultati"
@@ -372,7 +372,7 @@
 msgstr "L'id del messaggio non ? un numero intero"
 
 msgid "non-integer thread id passed"
-msgstr "L'id del thread non ? un numero intero"
+msgstr "L'id del discussione non ? un numero intero"
 
 msgid "non-integer user id passed"
 msgstr "L'id dell'utente non ? un numero intero"
@@ -478,7 +478,7 @@
 msgstr "Scegliere il paese di provenienza. Questa informazione sar? usata per visualizzare l'ora di scrittura dei messaggi calcolando i fusi orari."
 
 msgid "PREFS EMAIL NOTIFICATION"
-msgstr "Ricevere email di notifica per thread sotto osservazione"
+msgstr "Ricevere email di notifica per discussione sotto osservazione"
 
 msgid "Preview"
 msgstr "Preview"
@@ -512,7 +512,7 @@
 msgstr "Rimuovi Watch"
 
 msgid "REPLY LOCKED THREAD"
-msgstr "Non ? possibilie rispondere a thread chiusi."
+msgstr "Non ? possibilie rispondere a discussione chiusi."
 
 msgid "Reply"
 msgstr "Rispondi"
@@ -608,7 +608,7 @@
 msgstr "Crea una nuova discussione"
 
 msgid "Stick Thread"
-msgstr "Segnare come thread di rilievo"
+msgstr "Segnare come discussione di rilievo"
 
 msgid "Sticky"
 msgstr "Rilievo"
@@ -647,16 +647,16 @@
 msgstr "Non ? stato selezionato un forum da visualizzare"
 
 msgid "There is no current thread to view"
-msgstr "Non ? stato selezionato un thread da visualizzare"
+msgstr "Non ? stato selezionato un discussione da visualizzare"
 
 msgid "THREAD NO INFORMATION"
-msgstr "Non ci sono informazioni per il thread o il messaggio al quale si ? provato a rispondere."
+msgstr "Non ci sono informazioni per il discussione o il messaggio al quale si ? provato a rispondere."
 
 msgid "THREAD NO POSTS"
-msgstr "Non si pu? rispondere a thread che non contiene messaggi."
+msgstr "Non si pu? rispondere a discussione che non contiene messaggi."
 
 msgid "THREAD WATCH FAILED"
-msgstr "Non ? stato possibile aggiungere un watch ai thread richiesti."
+msgstr "Non ? stato possibile aggiungere un watch ai discussione richiesti."
 
 msgid "Thread"
 msgstr "Thread"
@@ -737,10 +737,10 @@
 msgstr "Visualizza Thread"
 
 msgid "Watch this thread"
-msgstr "Segui questo thread"
+msgstr "Segui questo discussione"
 
 msgid "watching this thread"
-msgstr "questo thread ? sotto osservazione"
+msgstr "questo discussione ? sotto osservazione"
 
 msgid "wrote"
 msgstr "ha scritto"
@@ -749,10 +749,10 @@
 msgstr "S?"
 
 msgid "You are not watching any threads"
-msgstr "Non stai seguendo alcun thread"
+msgstr "Non stai seguendo alcun discussione"
 
 msgid "You are watching this thread"
-msgstr "Stai seguendo questo thread"
+msgstr "Stai seguendo questo discussione"
 
 msgid "Your Details"
 msgstr "Le tue Informazioni"



From chiselwright at mail.berlios.de  Wed Feb 13 00:15:36 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 13 Feb 2008 00:15:36 +0100
Subject: [Parley-svn] r794 - / trunk trunk/lib/Parley/I18N
Message-ID: <200802122315.m1CNFaUL022071@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-13 00:15:36 +0100 (Wed, 13 Feb 2008)
New Revision: 794

Modified:
   /
   trunk/Changes.i18n
   trunk/lib/Parley/I18N/it.po
Log:
 r4649 at wiggin:  chisel | 2008-02-12 22:26:28 +0000
 + added translations from DJ



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4647
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4649
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-02-12 11:00:51 UTC (rev 793)
+++ trunk/Changes.i18n	2008-02-12 23:15:36 UTC (rev 794)
@@ -8,6 +8,18 @@
 
 0.59 (UNDER DEVELOPMENT)
 
+    i_default.po:
+        - added:
+            - "ADMIN LOCK POST"
+            - "Locked Post"
+            - "Post Edited By"
+
+    it.po:
+        - added:
+            - "ADMIN LOCK POST"
+            - "Locked Post"
+            - "Post Edited By"
+
 0.58
     (en renamed to i_default)
 

Modified: trunk/lib/Parley/I18N/it.po
===================================================================
--- trunk/lib/Parley/I18N/it.po	2008-02-12 11:00:51 UTC (rev 793)
+++ trunk/lib/Parley/I18N/it.po	2008-02-12 23:15:36 UTC (rev 794)
@@ -43,6 +43,9 @@
 msgid "Add Watch"
 msgstr "Aggiungi Watch"
 
+msgid "ADMIN LOCK POST"
+msgstr "Chiudi questo messaggio"
+
 msgid "ADMIN SPECIFY LOCK THREAD"
 msgstr "Bisogna specificare il discussione da chiudere"
 
@@ -269,6 +272,9 @@
 msgid "Locked"
 msgstr "Chiuso"
 
+msgid "Locked Post"
+msgstr "Messaggio Chiuso"
+
 msgid "Locked Topic"
 msgstr "Discussione Chiusa"
 
@@ -443,9 +449,8 @@
 msgid "person"
 msgstr "persona"
 
-# added by Chisel via babelfish
 msgid "Please choose a language"
-msgstr "Scelga una lingua"
+msgstr "Scegli una lingua"
 
 msgid "Please enter your information"
 msgstr "Per favore fornire le proprie informazioni"
@@ -459,6 +464,9 @@
 msgid "posted by"
 msgstr "inviato da"
 
+msgid "Post Edited By: %1"
+msgstr "Messaggio Modificato Da: %1"
+
 msgid "Posted from %1"
 msgstr "Inviato da %1"
 



From chiselwright at mail.berlios.de  Wed Feb 13 00:15:45 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 13 Feb 2008 00:15:45 +0100
Subject: [Parley-svn] r795 - / trunk
Message-ID: <200802122315.m1CNFjco022141@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-13 00:15:45 +0100 (Wed, 13 Feb 2008)
New Revision: 795

Modified:
   /
   trunk/TODO
Log:
 r4650 at wiggin:  chisel | 2008-02-12 22:27:15 +0000
 + more stuff to do *sigh*



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4649
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4650
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-12 23:15:36 UTC (rev 794)
+++ trunk/TODO	2008-02-12 23:15:45 UTC (rev 795)
@@ -1,5 +1,7 @@
 TODO LIST
 
+  - "Cancel" from post/edit
+  - "Cancel" from thread/reply
   - Quick Reply
   - login form doesn't submit onEnter
   - TESTS, TESTS, TESTS!
@@ -20,6 +22,9 @@
   - posting page ForumCode help/tips
   - database versioning
   - ForumCode: thumbnail image, lightbox view?
+  - investigate: package Your::Schema; sub connect { do the check; next::method }
+  - investigate: DBIx::Class::Schema::Versioned
+  - investigate: t/model_Post.t / distinct count
 D - login form flickers on IE7 page load
 D - [bug] user/profile doesn't show avatar
 D - add i18n for 'or'



From chiselwright at mail.berlios.de  Wed Feb 13 00:15:52 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 13 Feb 2008 00:15:52 +0100
Subject: [Parley-svn] r796 - / trunk/lib/Parley/I18N
Message-ID: <200802122315.m1CNFqQQ022212@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-13 00:15:52 +0100 (Wed, 13 Feb 2008)
New Revision: 796

Modified:
   /
   trunk/lib/Parley/I18N/i_default.po
Log:
 r4651 at wiggin:  chisel | 2008-02-12 22:28:45 +0000
 + new (default/en) i18n phrases



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4650
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4651
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-02-12 23:15:45 UTC (rev 795)
+++ trunk/lib/Parley/I18N/i_default.po	2008-02-12 23:15:52 UTC (rev 796)
@@ -43,6 +43,9 @@
 msgid "Add Watch"
 msgstr "Add Watch"
 
+msgid "ADMIN LOCK POST"
+msgstr "Lock this post"
+
 msgid "ADMIN SPECIFY LOCK THREAD"
 msgstr "You must specify the thread to lock"
 
@@ -269,8 +272,8 @@
 msgid "Locked"
 msgstr "Locked"
 
-msgid "Locked Topic"
-msgstr "Locked Topic"
+msgid "Locked Post"
+msgstr "Locked Post"
 
 msgid "LOGIN ADD REPLY"
 msgstr "You must be logged in before you can add a reply."
@@ -461,6 +464,9 @@
 msgid "posted by"
 msgstr "posted by"
 
+msgid "Post Edited By: %1"
+msgstr "Post Edited By: ~%1~"
+
 msgid "Posted from %1"
 msgstr "Posted from %1"
 



From chiselwright at mail.berlios.de  Wed Feb 13 00:16:02 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 13 Feb 2008 00:16:02 +0100
Subject: [Parley-svn] r797 - / trunk/lib/Parley/I18N
Message-ID: <200802122316.m1CNG26e022282@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-13 00:16:02 +0100 (Wed, 13 Feb 2008)
New Revision: 797

Modified:
   /
   trunk/lib/Parley/I18N/i_default.po
Log:
 r4652 at wiggin:  chisel | 2008-02-12 22:31:28 +0000
 / removed "reminder" '~' chars in translation file



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4651
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4652
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-02-12 23:15:52 UTC (rev 796)
+++ trunk/lib/Parley/I18N/i_default.po	2008-02-12 23:16:02 UTC (rev 797)
@@ -465,7 +465,7 @@
 msgstr "posted by"
 
 msgid "Post Edited By: %1"
-msgstr "Post Edited By: ~%1~"
+msgstr "Post Edited By: %1"
 
 msgid "Posted from %1"
 msgstr "Posted from %1"



From chiselwright at mail.berlios.de  Wed Feb 13 00:16:12 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 13 Feb 2008 00:16:12 +0100
Subject: [Parley-svn] r798 - / trunk/db trunk/lib/Parley/Controller
	trunk/lib/Parley/Schema trunk/root/base/post
	trunk/root/base/thread trunk/root/static/css
Message-ID: <200802122316.m1CNGCnM022353@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-13 00:16:10 +0100 (Wed, 13 Feb 2008)
New Revision: 798

Added:
   trunk/db/patch_0.58_to_0.59.psql
Modified:
   /
   trunk/lib/Parley/Controller/Post.pm
   trunk/lib/Parley/Schema/Post.pm
   trunk/root/base/post/edit
   trunk/root/base/thread/view
   trunk/root/static/css/parley.css
Log:
 r4653 at wiggin:  chisel | 2008-02-12 22:40:27 +0000
 + extend post table to include admin editor and individual post lock
 + corresponding ::Schema changes for above addition
 + allow moderators to edit posts; optionally locking individual post from further editing
 / modify post/edit for moderator edit view (whose post, and lock checkbox)
 / only show Reply/Quote buttons if we have a logged in user
 + show Edit button for moderators to edit other posts
 + class for admin edited post



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4652
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4653
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/db/patch_0.58_to_0.59.psql
===================================================================
--- trunk/db/patch_0.58_to_0.59.psql	2008-02-12 23:16:02 UTC (rev 797)
+++ trunk/db/patch_0.58_to_0.59.psql	2008-02-12 23:16:10 UTC (rev 798)
@@ -0,0 +1,20 @@
+-- Patch:
+--   From: 0.58
+--   To:   0.59
+--
+-- Description:
+--  add flagging of posts edited by admin
+--  lock posts (so they can't be changed after being edited by admin)
+
+BEGIN;
+
+-- patch starts here --
+
+ALTER TABLE post
+    ADD COLUMN admin_editor_id integer references person(id),
+    ADD COLUMN locked boolean default False
+;
+
+-- patch ends here --
+
+COMMIT;

Modified: trunk/lib/Parley/Controller/Post.pm
===================================================================
--- trunk/lib/Parley/Controller/Post.pm	2008-02-12 23:16:02 UTC (rev 797)
+++ trunk/lib/Parley/Controller/Post.pm	2008-02-12 23:16:10 UTC (rev 798)
@@ -15,6 +15,7 @@
     # DFV validation profile for adding a new topic
     edit_post => {
         required    => [qw( post_message )],
+        optional    => [qw( lock_post )],
         filters     => [qw( trim )],
         msgs => {
             format  => q{%s},
@@ -42,14 +43,24 @@
     $c->login_if_required($c->localize(q{EDIT LOGIN REQUIRED}));
 
     # you can only edit you own posts
-    # (unless you're a moderator, but we don't do that yet)
-    if ($c->_authed_user()->id() != $c->_current_post()->creator()->id()) {
+    # (unless you're a moderator)
+    if (
+        (not $c->stash->{moderator})
+            and
+        ($c->_authed_user()->id() != $c->_current_post()->creator()->id())
+    ) {
         $c->stash->{error}{message} = $c->localize(q{EDIT OWN POSTS ONLY});
         return;
     }
 
-    # you can't edit a locked post
-    elsif ($c->_current_post->thread->locked) {
+    # you can't edit post in a locked thread
+    # you also can't edit individually locked posts (unless you are a
+    # moderator)
+    elsif (
+        $c->_current_post->thread->locked
+            or
+        ($c->_current_post->locked and not $c->stash->{moderator})
+    ) {
         $c->stash->{error}{message} = $c->localize(q{EDIT LOCKED POST});
         return;
     }
@@ -74,6 +85,7 @@
             }
         }
         # otherwise; everything seems fine - edit the post
+        # XXX why the HELL isn't this in a txn_do?!
         else {
             # update the post with the new information
             $c->_current_post->message( $c->form->valid->{post_message} );
@@ -81,6 +93,23 @@
             # set the edited time
             $c->_current_post->edited( DateTime->now() );
 
+            # did an 'evil' admin edit the post?
+            if (
+                ($c->_current_post->creator_id != $c->_authed_user->id)
+                    and
+                $c->stash->{moderator}
+            ) {
+                # stamp the post with the admin editor's mark
+                $c->_current_post->admin_editor_id(
+                    $c->_authed_user->id
+                );
+                # if they asked for the thread to be locked
+                # make it so...
+                if ($c->form->valid->{lock_post}) {
+                    $c->_current_post->locked( 1 );
+                }
+            }
+
             # store the updates in the db
             $c->_current_post->update();
 

Modified: trunk/lib/Parley/Schema/Post.pm
===================================================================
--- trunk/lib/Parley/Schema/Post.pm	2008-02-12 23:16:02 UTC (rev 797)
+++ trunk/lib/Parley/Schema/Post.pm	2008-02-12 23:16:10 UTC (rev 798)
@@ -85,6 +85,9 @@
     is_nullable => 1,
     size => 8,
   },
+
+  admin_editor_id   => {},
+  locked            => {},
 );
 
 __PACKAGE__->set_primary_key("id");
@@ -128,6 +131,10 @@
     "people" => "Person",
     { "foreign.last_post" => "self.id" },
 );
+__PACKAGE__->belongs_to(
+    "admin_editor" => "Person",
+    { 'foreign.id' => "self.admin_editor_id" },
+);
 
 
 

Modified: trunk/root/base/post/edit
===================================================================
--- trunk/root/base/post/edit	2008-02-12 23:16:02 UTC (rev 797)
+++ trunk/root/base/post/edit	2008-02-12 23:16:10 UTC (rev 798)
@@ -18,6 +18,10 @@
 </p>
 [% END %]
 
+[% IF authed_user.id != current_post.creator_id %]
+Editing [% current_post.creator.forum_name %]'s post
+[% END %]
+
 <form action="post/edit?post=[% current_post.id %]" method="POST" name="new_thread">
     <table>
         <tbody>
@@ -28,8 +32,20 @@
                 </td>
             </tr>
 
+            [% IF authed_user.id != current_post.creator_id %]
             <tr>
                 <td>&nbsp;</td>
+                <td>
+                    <input type="checkbox" name="lock_post" id="lock_post" value="1" />
+                    <label for="lock_post">
+                        [%l('ADMIN LOCK POST')%]
+                    </label>
+                </td>
+            </tr>
+            [% END %]
+
+            <tr>
+                <td>&nbsp;</td>
                 <td style="text-align: center;">
                     <input type="button" value="[%l('Preview')%]" name="post_reply" class="" id="message_preview" />
                     <input type="submit" value="[%l('Update Reply')%]" name="post_update"    class="input_button" />

Modified: trunk/root/base/thread/view
===================================================================
--- trunk/root/base/thread/view	2008-02-12 23:16:02 UTC (rev 797)
+++ trunk/root/base/thread/view	2008-02-12 23:16:10 UTC (rev 798)
@@ -36,7 +36,7 @@
                                 [% IF current_thread.locked %]
                                     [%l('Thread Locked')%] 
                                     <img src="static/images/icons/lock.png" alt="[%l('Locked')%]" title="[%l('Locked Topic')%]" width="16" height="16" />
-                                [% ELSE %]
+                                [% ELSIF authed_user %]
                                     <span class="yui-button yui-link-button">
                                         <span class="first-child">
                                             <a href="thread/reply?thread=[% current_thread.id %]">[%l('Reply')%]</a>
@@ -76,6 +76,14 @@
             </td>
 
             <td class="post">
+                    [% IF post.admin_editor %]
+                    <div class="admin_edited_post">
+                        [%l('Post Edited By: [_1]', post.admin_editor.forum_name)%]:
+                        [% IF post.locked %]
+                        <img src="static/images/icons/lock.png" alt="[%l('Locked')%]" title="[%l('Locked Post')%]" width="16" height="16" />
+                        [% END %]
+                    </div>
+                    [% END %]
                 <!-- the body of the post -->
                 <div class="innerpost">
                     [% IF post.quoted_post %]
@@ -104,10 +112,10 @@
                            [%l('IP Logged')%] 
                         [% END %]
                     [% END %]
-                    [% UNLESS current_thread.locked %]
+                    [% IF (!current_thread.locked && authed_user) %]
                         <br />
                         <br />
-                        [% IF authed_user.id == post.creator.id %]
+                        [% IF ((authed_user.id == post.creator.id) && !post.locked) || moderator %]
                         <span class="yui-button yui-link-button">
                             <span class="first-child">
                                 <a href="post/edit?post=[% post.id %]">[%l('Edit')%]</a>
@@ -157,7 +165,7 @@
                                 [% IF current_thread.locked %]
                                     [%l('Thread Locked')%] 
                                     <img src="static/images/icons/lock.png" alt="[%l('Locked')%]" title="[%l('Locked Topic')%]" width="16" height="16" />
-                                [% ELSE %]
+                                [% ELSIF authed_user %]
                                     <span class="yui-button yui-link-button">
                                         <span class="first-child">
                                             <a href="thread/reply?thread=[% current_thread.id %]">[%l('Reply')%]</a>

Modified: trunk/root/static/css/parley.css
===================================================================
--- trunk/root/static/css/parley.css	2008-02-12 23:16:02 UTC (rev 797)
+++ trunk/root/static/css/parley.css	2008-02-12 23:16:10 UTC (rev 798)
@@ -136,6 +136,19 @@
 }
 
 /* style classes */
+
+.admin_edited_post {
+    color:              #000;
+    background:         #ccc;
+    padding:            2px;
+    padding-left:       10px;
+    padding-right:      10px;
+    border:             1px dashed #000;
+    margin-left:        15px;
+    font-size:          93%;
+    text-align:         right;
+}
+
 .align_right {
     text-align:         right;
 }



From chiselwright at mail.berlios.de  Wed Feb 13 00:16:22 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 13 Feb 2008 00:16:22 +0100
Subject: [Parley-svn] r799 - / trunk/t/schema
Message-ID: <200802122316.m1CNGMLV022423@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-13 00:16:22 +0100 (Wed, 13 Feb 2008)
New Revision: 799

Modified:
   /
   trunk/t/schema/post.t
Log:
 r4654 at wiggin:  chisel | 2008-02-12 22:41:30 +0000
 + added tests for new columns (and relation) in post table



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4653
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4654
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/t/schema/post.t
===================================================================
--- trunk/t/schema/post.t	2008-02-12 23:16:10 UTC (rev 798)
+++ trunk/t/schema/post.t	2008-02-12 23:16:22 UTC (rev 799)
@@ -30,6 +30,8 @@
                 reply_to_id
                 edited
                 ip_addr
+                admin_editor_id
+                locked
             ]
         ],
 
@@ -44,6 +46,7 @@
                 quoted_post
                 post_quoted_posts
                 people
+                admin_editor
             ]
         ],
 



From chiselwright at mail.berlios.de  Wed Feb 13 10:36:25 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 13 Feb 2008 10:36:25 +0100
Subject: [Parley-svn] r800 - / trunk
Message-ID: <200802130936.m1D9aPmS016284@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-13 10:36:25 +0100 (Wed, 13 Feb 2008)
New Revision: 800

Added:
   trunk/README.admin
Modified:
   /
   trunk/ROADMAP
Log:
 r4661 at wiggin:  chisel | 2008-02-13 08:08:16 +0000
 / expanded elements of the roadmap
 + new file outlining access restriction merits, issues, etc



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4654
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4661
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/README.admin
===================================================================
--- trunk/README.admin	2008-02-12 23:16:22 UTC (rev 799)
+++ trunk/README.admin	2008-02-13 09:36:25 UTC (rev 800)
@@ -0,0 +1,50 @@
+0. INTRODUCTION
+
+  Administering public forums is notoriously nightmarish.
+
+1. BAN TYPES
+
+  The ideas for slowing down Evil People are as follows:
+
+1.1 Account Suspension
+
+    When the account tries to log-in all they see is an "Account Suspended"
+    page.
+
+    The site can be viewed while logged out (i.e. guest user)
+
+1.2 Ban-by-IP
+
+    This can take varying levels of restriction:
+
+1.2.1 Restrict Posting by IP
+
+    Prevent user(s) from matching IPs creating new threads, replying to
+    existing threads or editing existing posts.
+
+1.2.2 Restrict Login by IP
+
+    Prevent user(s) from matching IPs using the login functionality
+
+1.2.3 Restrict Sign-Up by IP
+
+    Prevent new accounts being created from matching IPs
+
+1.2.4 Restrict All Access by IP
+
+    Matching IPs are shown the "Evil People Got You Banned" page.
+    This is pretty harsh, and should be saved as a ast resort .. if
+    implemented/used at all.
+
+2. KNOWN ISSUES
+
+  There are the usual issues of people running through proxies, catching
+  people we didn't intend to, or being used by banned users to circumvent IP
+  based bans.
+
+3. POSSIBLE IMPLEMENTATIONS
+
+3.1 Net::IP::Match::Regexp
+
+    This looks like a useful module for providing (CIDR - a.b.c.d/x) IP ranges
+    and matching IPs that live in those ranges.

Modified: trunk/ROADMAP
===================================================================
--- trunk/ROADMAP	2008-02-12 23:16:22 UTC (rev 799)
+++ trunk/ROADMAP	2008-02-13 09:36:25 UTC (rev 800)
@@ -14,9 +14,14 @@
 
 0.59:
 
+    - assign new moderators (on a per-forum basis)
     - admin/moderator support (deal with bad people)
-        - edit posts (and flag accordingly)
-        - abuse handling (suspend accounts, ban-by-ip, ...)
+        - [D] edit posts (and flag accordingly)
+        - abuse handling
+          - suspend account(s)
+          - prevent login from IP
+          - prevent signup from IP
+          - prevent posting/editing from IP
         - IP reporting
 
 0.60:



From chiselwright at mail.berlios.de  Wed Feb 13 10:36:33 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 13 Feb 2008 10:36:33 +0100
Subject: [Parley-svn] r801 - / trunk
Message-ID: <200802130936.m1D9aXGx016375@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-13 10:36:33 +0100 (Wed, 13 Feb 2008)
New Revision: 801

Modified:
   /
   trunk/README.admin
Log:
 r4662 at wiggin:  chisel | 2008-02-13 08:31:07 +0000
 + expanding thoughts on dealing with Naughty People



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4661
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4662
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/README.admin
===================================================================
--- trunk/README.admin	2008-02-13 09:36:25 UTC (rev 800)
+++ trunk/README.admin	2008-02-13 09:36:33 UTC (rev 801)
@@ -42,9 +42,68 @@
   people we didn't intend to, or being used by banned users to circumvent IP
   based bans.
 
-3. POSSIBLE IMPLEMENTATIONS
+3. CONCERNS
 
-3.1 Net::IP::Match::Regexp
+3.1 Performance
 
+    Will IP checking for every request have a noticable, negative, effect on
+    application performance?
+    We could store information in-session for IPs we discover to be affected,
+    but we then have the following issues:
+        - we're still doing a lookup every hit for the majority of hits (the
+          Good people)
+        - if we escalate or modify a user's IP restriction it won't take
+          effect, since we already have them session-flagged for something
+          lesser.
+
+4. POSSIBLE IMPLEMENTATIONS
+
+4.1 Net::IP::Match::Regexp
+
     This looks like a useful module for providing (CIDR - a.b.c.d/x) IP ranges
     and matching IPs that live in those ranges.
+
+4.2 IP matching
+
+    In (3.1) concerns were raised regarding a per hit performance lookup.
+
+    This may be reduced by reducing the number of lookups and queries; instead
+    of a growing set of records in a table - one for each new match - we could
+    make use of the create_iprange_regexp() feature in Net::IP::Match::Regexp
+    and have one row for each ban-type.
+
+    This should reduce database overheads, and hopefully simplify the IP
+    matching.
+
+    The interface may become difficult to use (in the initial) implementation
+    if we offer a textarea to manage the ranges. This could be overcome in the
+    future by having the interface split/format IP blocks on viewing, and
+    compress to one string on saving.
+    A small hit at admin time, instead of a per-hit overhead.
+
+    We'd lose the ability to timestamp individual modifications, or provide a
+    per-block rejection message.
+
+4.3 Admin Action Tracking
+
+    It would be useful for the application to keep a log of changes, with a
+    comment written by the moderator, so that time and reasons for bans could
+    be viewed by other admins.
+
+    e.g.
+
+      2008-02-13 08:25  Added r.s.t.u/x - they just kept on being abusive
+
+    There might be an opportunity to establish the "diff" between the before
+    and after IP list(s) and store those with the message. (list based maths?)
+
+4.4 Admin permissions and roles
+
+    We don't necessarily wish to allow all moderators the ability to perform
+    anoy or all of the restriction actions.
+
+    This will most likely introduce some kind of role based system;
+    Catalyst::Plugin::Authorization::Roles?
+
+    Methods can be added to ::Schema::Person to do various role checks;
+    e.g.  can_suspend_account()



From chiselwright at mail.berlios.de  Thu Feb 14 22:12:28 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 14 Feb 2008 22:12:28 +0100
Subject: [Parley-svn] r802 - / trunk trunk/db trunk/lib trunk/lib/Parley
	trunk/lib/Parley/Schema trunk/t/schema
Message-ID: <200802142112.m1ELCSrn016537@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-14 22:12:26 +0100 (Thu, 14 Feb 2008)
New Revision: 802

Added:
   trunk/lib/Parley/Schema/Role.pm
   trunk/lib/Parley/Schema/UserRole.pm
   trunk/t/schema/role.t
   trunk/t/schema/user_role.t
Modified:
   /
   trunk/db/patch_0.58_to_0.59.psql
   trunk/lib/Parley.pm
   trunk/lib/Parley/Schema.pm
   trunk/lib/Parley/Schema/Person.pm
   trunk/parley.yml
   trunk/t/schema/person.t
Log:
 r4665 at wiggin:  chisel | 2008-02-14 21:10:52 +0000
 + allow user accounts to be flagged as suspended
 + add role and user_roles tablr to schema
 / ::Schema changes for basic roles support
 + tests for role changes



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4662
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4665
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/db/patch_0.58_to_0.59.psql
===================================================================
--- trunk/db/patch_0.58_to_0.59.psql	2008-02-13 09:36:33 UTC (rev 801)
+++ trunk/db/patch_0.58_to_0.59.psql	2008-02-14 21:12:26 UTC (rev 802)
@@ -5,6 +5,7 @@
 -- Description:
 --  add flagging of posts edited by admin
 --  lock posts (so they can't be changed after being edited by admin)
+--  allow user accounts to be suspended
 
 BEGIN;
 
@@ -12,9 +13,53 @@
 
 ALTER TABLE post
     ADD COLUMN admin_editor_id integer references person(id),
-    ADD COLUMN locked boolean default False
+    ADD COLUMN locked boolean not null default False
 ;
 
+ALTER TABLE person
+    ADD COLUMN suspended boolean not null default False
+;
+
+CREATE TABLE role (
+    id          serial      primary key,
+    name        varchar(30) not null unique,
+    description text
+);
+-- a couple of roles
+INSERT INTO role (name, description) VALUES (
+    'site_moderator',
+    'Site Moderator (aka Da Boss)'
+);
+INSERT INTO role (name, description) VALUES (
+    'ip_ban_posting',
+    'Restrict Posting by IP'
+);
+INSERT INTO role (name, description) VALUES (
+    'ip_ban_signup',
+    'Restrict Sign-Up by IP'
+);
+INSERT INTO role (name, description) VALUES (
+    'ip_ban_login',
+    'Restrict Login by IP'
+);
+
+CREATE TABLE user_roles (
+    id          serial      primary key,
+    person_id   integer     not null
+                            references person(id),
+    role_id     integer     not null
+                            references role(id),
+    UNIQUE (person_id, role_id)
+);
+
+-- make topdog a site_moderator
+INSERT INTO user_roles
+    (person_id, role_id)
+VALUES (
+    0,
+    (SELECT id FROM role WHERE name='site_moderator')
+);
+
 -- patch ends here --
 
 COMMIT;

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-02-13 09:36:33 UTC (rev 801)
+++ trunk/lib/Parley/Schema/Person.pm	2008-02-14 21:12:26 UTC (rev 802)
@@ -107,4 +107,7 @@
   { "foreign.recipient" => "self.id" },
 );
 
+__PACKAGE__->has_many(map_user_role => 'Parley::Schema::UserRole', 'person_id');
+
+
 1;

Added: trunk/lib/Parley/Schema/Role.pm
===================================================================
--- trunk/lib/Parley/Schema/Role.pm	2008-02-13 09:36:33 UTC (rev 801)
+++ trunk/lib/Parley/Schema/Role.pm	2008-02-14 21:12:26 UTC (rev 802)
@@ -0,0 +1,27 @@
+package Parley::Schema::Role;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use base 'DBIx::Class';
+use DateTime::Format::Pg;
+
+use Parley::App::DateTime qw( :interval );
+
+__PACKAGE__->load_components("PK::Auto", "Core");
+__PACKAGE__->table("role");
+__PACKAGE__->add_columns(
+  id    => { },
+  name  => { },
+);
+
+__PACKAGE__->set_primary_key("id");
+#__PACKAGE__->resultset_class('Parley::ResultSet::Role');
+
+__PACKAGE__->has_many(
+    map_user_role => 'Parley::Schema::UserRole',
+    'role_id'
+);
+
+
+1;

Added: trunk/lib/Parley/Schema/UserRole.pm
===================================================================
--- trunk/lib/Parley/Schema/UserRole.pm	2008-02-13 09:36:33 UTC (rev 801)
+++ trunk/lib/Parley/Schema/UserRole.pm	2008-02-14 21:12:26 UTC (rev 802)
@@ -0,0 +1,43 @@
+package Parley::Schema::UserRole;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use base qw/DBIx::Class/;
+
+# Load required DBIC stuff
+__PACKAGE__->load_components(qw/PK::Auto Core/);
+# Set the table name
+__PACKAGE__->table('user_roles');
+# Set columns in table
+__PACKAGE__->add_columns(qw/id person_id role_id/);
+# Set the primary key for the table
+__PACKAGE__->set_primary_key(qw/id/);
+
+#
+# Set relationships:
+#
+
+# belongs_to():
+#   args:
+#     1) Name of relationship, DBIC will create accessor with this name
+#     2) Name of the model class referenced by this relationship
+#     3) Column name in *this* table
+__PACKAGE__->belongs_to(person => 'Parley::Schema::Person', 'person_id');
+
+# belongs_to():
+#   args:
+#     1) Name of relationship, DBIC will create accessor with this name
+#     2) Name of the model class referenced by this relationship
+#     3) Column name in *this* table
+__PACKAGE__->belongs_to(role => 'Parley::Schema::Role', 'role_id');
+
+
+__PACKAGE__->add_unique_constraint(
+    'userroles_person_role_key',
+    ['person_id', 'role_id']
+);
+
+
+
+1;

Modified: trunk/lib/Parley/Schema.pm
===================================================================
--- trunk/lib/Parley/Schema.pm	2008-02-13 09:36:33 UTC (rev 801)
+++ trunk/lib/Parley/Schema.pm	2008-02-14 21:12:26 UTC (rev 802)
@@ -18,10 +18,12 @@
         'Preference',
         'PreferenceTimeString',
         'RegistrationAuthentication',
+        'Role',
         'TermsAgreed',
         'Terms',
         'Thread',
         'ThreadView',
+        'UserRole',
     ]
 );
 

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-02-13 09:36:33 UTC (rev 801)
+++ trunk/lib/Parley.pm	2008-02-14 21:12:26 UTC (rev 802)
@@ -26,6 +26,8 @@
     Authentication::Store::DBIC
     Authentication::Credential::Password
 
+    Authorization::Roles
+
     I18N
 /;
 

Modified: trunk/parley.yml
===================================================================
--- trunk/parley.yml	2008-02-13 09:36:33 UTC (rev 801)
+++ trunk/parley.yml	2008-02-14 21:12:26 UTC (rev 802)
@@ -46,12 +46,20 @@
 # authentiation settings; perldoc Catalyst::Plugin::Authentication::Store::DBIC
 authentication:
     dbic:
-        user_class:         'Parley::Model::ParleyDB::Authentication'
+        user_class:         'ParleyDB::Authentication'
         user_field:         'username'
         password_field:     'password'
         password_type:      'hashed'
         password_hash_type: 'MD5'
 
+authorization:
+    dbic:
+        role_class:             'ParleyDB::Role'
+        role_field:             'name'
+        role_rel:               'map_user_role'
+        user_role_user_field:   'person_id'
+
+
 # session settings; perldoc Catalyst::Plugin::Session::FastMmap
 session:
     expires:    3600

Modified: trunk/t/schema/person.t
===================================================================
--- trunk/t/schema/person.t	2008-02-13 09:36:33 UTC (rev 801)
+++ trunk/t/schema/person.t	2008-02-14 21:12:26 UTC (rev 802)
@@ -40,6 +40,7 @@
                 last_post
                 authentication
                 registration_authentications
+                map_user_role
             ]
         ],
 

Added: trunk/t/schema/role.t
===================================================================
--- trunk/t/schema/role.t	2008-02-13 09:36:33 UTC (rev 801)
+++ trunk/t/schema/role.t	2008-02-14 21:12:26 UTC (rev 802)
@@ -0,0 +1,45 @@
+#!/usr/bin/perl
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+# load the module that provides all of the common test functionality
+use FindBin qw($Bin);
+use lib $Bin;
+use SchemaTest;
+
+my $schematest = SchemaTest->new(
+    {
+        dsn       => 'dbi:Pg:dbname=parley',
+        namespace => 'Parley::Schema',
+        moniker   => 'Role',
+    }
+);
+$schematest->methods(
+    {
+        columns => [
+            qw[
+                id
+                name
+            ]
+        ],
+
+        relations => [
+            qw[
+                map_user_role
+            ]
+        ],
+
+        custom => [
+            qw[
+            ]
+        ],
+
+        resultsets => [
+            qw[
+            ]
+        ],
+    }
+);
+
+$schematest->run_tests();


Property changes on: trunk/t/schema/role.t
___________________________________________________________________
Name: svn:executable
   + *

Added: trunk/t/schema/user_role.t
===================================================================
--- trunk/t/schema/user_role.t	2008-02-13 09:36:33 UTC (rev 801)
+++ trunk/t/schema/user_role.t	2008-02-14 21:12:26 UTC (rev 802)
@@ -0,0 +1,47 @@
+#!/usr/bin/perl
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+# load the module that provides all of the common test functionality
+use FindBin qw($Bin);
+use lib $Bin;
+use SchemaTest;
+
+my $schematest = SchemaTest->new(
+    {
+        dsn       => 'dbi:Pg:dbname=parley',
+        namespace => 'Parley::Schema',
+        moniker   => 'UserRole',
+    }
+);
+$schematest->methods(
+    {
+        columns => [
+            qw[
+                id
+                person_id
+                role_id
+            ]
+        ],
+
+        relations => [
+            qw[
+                person
+                role
+            ]
+        ],
+
+        custom => [
+            qw[
+            ]
+        ],
+
+        resultsets => [
+            qw[
+            ]
+        ],
+    }
+);
+
+$schematest->run_tests();


Property changes on: trunk/t/schema/user_role.t
___________________________________________________________________
Name: svn:executable
   + *



From chiselwright at mail.berlios.de  Fri Feb 15 17:05:12 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Fri, 15 Feb 2008 17:05:12 +0100
Subject: [Parley-svn] r803 - / trunk trunk/lib/Parley/Controller
	trunk/lib/Parley/ResultSet trunk/lib/Parley/Schema trunk/t/schema
Message-ID: <200802151605.m1FG5CAR026120@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-15 17:05:11 +0100 (Fri, 15 Feb 2008)
New Revision: 803

Modified:
   /
   trunk/README.admin
   trunk/lib/Parley/Controller/Post.pm
   trunk/lib/Parley/Controller/Root.pm
   trunk/lib/Parley/ResultSet/Post.pm
   trunk/lib/Parley/ResultSet/Thread.pm
   trunk/lib/Parley/Schema/Forum.pm
   trunk/t/schema/forum.t
   trunk/t/schema/post.t
   trunk/t/schema/thread.t
Log:
 r4667 at wiggin:  chisel | 2008-02-15 16:04:42 +0000
 + add an extra thought to README.admin
 / switch from objToJson() to to_json() [deprecation warnings for the former]
 / convert some in-controller DBIC lookups to ResultSet methods
 + added to schema tests accordingly
 / user #0 is no longer 'special'. special, aka Site Moderator is now a user_role



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4665
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4667
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/README.admin
===================================================================
--- trunk/README.admin	2008-02-14 21:12:26 UTC (rev 802)
+++ trunk/README.admin	2008-02-15 16:05:11 UTC (rev 803)
@@ -107,3 +107,4 @@
 
     Methods can be added to ::Schema::Person to do various role checks;
     e.g.  can_suspend_account()
+    [although, how can we use the Catalyst plugin be used from the Schema?]

Modified: trunk/lib/Parley/Controller/Post.pm
===================================================================
--- trunk/lib/Parley/Controller/Post.pm	2008-02-14 21:12:26 UTC (rev 802)
+++ trunk/lib/Parley/Controller/Post.pm	2008-02-15 16:05:11 UTC (rev 803)
@@ -158,7 +158,7 @@
     my $tt_forum = Template::Plugin::ForumCode->new();
     my $msg_source = $c->request->param('msg_source');
 
-    my $json = objToJson(
+    my $json = to_json(
         {
             'formatted' =>
                 $tt_forum->forumcode(

Modified: trunk/lib/Parley/Controller/Root.pm
===================================================================
--- trunk/lib/Parley/Controller/Root.pm	2008-02-14 21:12:26 UTC (rev 802)
+++ trunk/lib/Parley/Controller/Root.pm	2008-02-15 16:05:11 UTC (rev 803)
@@ -71,14 +71,8 @@
     }
 
     # get a list of (all/available) forums
-    $c->stash->{available_forums} = $c->model('ParleyDB')->resultset('Forum')->search(
-        {
-            active  => 1,
-        },
-        {
-            order_by    => 'name ASC',
-        }
-    );
+    $c->stash->{available_forums} =
+        $c->model('ParleyDB::Forum')->available_list();
 
     ##################################################
     # do we have a post id in the URL?
@@ -96,18 +90,8 @@
 
         # get the matching post
         $c->_current_post(
-            $c->model('ParleyDB')->resultset('Post')->find(
-                {
-                    'me.id'  => $c->request->param('post')
-                },
-                {
-                    prefetch => [
-                        { thread => 'forum' },
-                        'creator',
-                        'reply_to',
-                        'quoted_post',
-                    ],
-                }
+            $c->model('ParleyDB::Post')->record_from_id(
+                $c->request->param('post')
             )
         );
 
@@ -137,17 +121,8 @@
 
         # get the matching thread
         $c->_current_thread(
-            $c->model('ParleyDB')->resultset('Thread')->find(
-                {
-                    'me.id'  => $c->request->param('thread'),
-                },
-                {
-                    prefetch => [
-                        { 'forum' => 'last_post' },
-                        'creator',
-                        'last_post',
-                    ]
-                }
+            $c->model('ParleyDB::Thread')->record_from_id(
+                $c->request->param('thread')
             )
         );
 
@@ -172,15 +147,8 @@
 
         # get the matching forum
         $c->_current_forum(
-            $c->model('ParleyDB')->resultset('Forum')->find(
-                {
-                    'me.id'  => $c->request->param('forum'),
-                },
-                {
-                    prefetch => [
-                        'last_post',
-                    ],
-                }
+            $c->model('ParleyDB::Forum')->record_from_id(
+                $c->request->param('forum')
             )
         );
     }
@@ -191,13 +159,14 @@
     if ( $c->user and not defined $c->_authed_user ) {
         $c->log->info('Fetching user information for ' . $c->user->id);
 
+        # FIXME : move this to the ResultSet class?
         # get the person info for the username
         my $row = $c->model('ParleyDB')->resultset('Person')->find(
             {
                 'authentication.username'   => $c->user->username(),
             },
             {
-                join => 'authentication',
+                #join => 'authentication',
                 prefetch => [
                     'authentication',
                     { 'preference' => 'time_format' },
@@ -217,10 +186,15 @@
 
 
     ######################################
-    # TopDog is always a site moderator
+    # user's with 'site_moderator' role
+    # get flagged as such
     # ####################################
-    if (defined $c->_authed_user() and 0 == $c->_authed_user()->id()) {
-        $c->log->debug( q{topdog user site-moderates anything he wants} );
+    if (
+        defined $c->_authed_user()
+            and
+        $c->check_user_roles('site_moderator')
+    ) {
+        $c->log->debug( q{site_moderator role for user} );
         $c->stash->{site_moderator} = 1;
     }
 
@@ -229,12 +203,13 @@
     # user moderate it?
     ##################################################
     if (defined $c->_authed_user() and defined $c->_current_forum()) {
-        # 'topdog' user can moderate anything
-        if (0 == $c->_authed_user()->id()) {
-            $c->log->debug( q{topdog user moderates anything he wants} );
+        # site_moderators can moderate anything
+        if ($c->check_user_roles('site_moderator')) {
+            $c->log->debug( q{site_moderator role moderates anything he wants} );
             $c->stash->{moderator} = 1;
         }
         else {
+            # FIXME : move this to the ResultSet class?
             # look up person/forum
             my $results = $c->model('ParleyDB')->resultset('ForumModerator')->find(
                 {

Modified: trunk/lib/Parley/ResultSet/Post.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Post.pm	2008-02-14 21:12:26 UTC (rev 802)
+++ trunk/lib/Parley/ResultSet/Post.pm	2008-02-15 16:05:11 UTC (rev 803)
@@ -5,6 +5,27 @@
 
 use base 'DBIx::Class::ResultSet';
 
+sub record_from_id {
+    my ($resultsource, $post_id) = @_;
+    my ($rs);
+
+    $rs = $resultsource->find(
+        {
+            'me.id'  => $post_id,
+        },
+        {
+            prefetch => [
+                { thread => 'forum' },
+                'creator',
+                'reply_to',
+                'quoted_post',
+            ],
+        }
+    );
+
+    return $rs;
+}
+
 sub people_posting_from_ip {
     my ($resultsource, $ip_addr) = @_;
     my ($rs);

Modified: trunk/lib/Parley/ResultSet/Thread.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Thread.pm	2008-02-14 21:12:26 UTC (rev 802)
+++ trunk/lib/Parley/ResultSet/Thread.pm	2008-02-15 16:05:11 UTC (rev 803)
@@ -127,4 +127,24 @@
     );
 }
 
+sub record_from_id {
+    my ($resultsource, $thread_id) = @_;
+    my ($rs);
+
+    $rs = $resultsource->find(
+        {
+            'me.id'  => $thread_id,
+        },
+        {
+            prefetch => [
+                { 'forum' => 'last_post' },
+                'creator',
+                'last_post',
+            ]
+        }
+    );
+
+    return $rs;
+}
+
 1;

Modified: trunk/lib/Parley/Schema/Forum.pm
===================================================================
--- trunk/lib/Parley/Schema/Forum.pm	2008-02-14 21:12:26 UTC (rev 802)
+++ trunk/lib/Parley/Schema/Forum.pm	2008-02-15 16:05:11 UTC (rev 803)
@@ -50,6 +50,9 @@
 
 __PACKAGE__->set_primary_key("id");
 __PACKAGE__->add_unique_constraint("forum_name_key", ["name"]);
+
+__PACKAGE__->resultset_class('Parley::ResultSet::Forum');
+
 __PACKAGE__->has_many("threads", "Thread", { "foreign.forum" => "self.id" });
 __PACKAGE__->belongs_to(
     "last_post" => "Post",

Modified: trunk/t/schema/forum.t
===================================================================
--- trunk/t/schema/forum.t	2008-02-14 21:12:26 UTC (rev 802)
+++ trunk/t/schema/forum.t	2008-02-15 16:05:11 UTC (rev 803)
@@ -43,6 +43,8 @@
 
         resultsets => [
             qw[
+                available_list
+                record_from_id
             ]
         ],
     }

Modified: trunk/t/schema/post.t
===================================================================
--- trunk/t/schema/post.t	2008-02-14 21:12:26 UTC (rev 802)
+++ trunk/t/schema/post.t	2008-02-15 16:05:11 UTC (rev 803)
@@ -59,6 +59,7 @@
 
         resultsets => [
             qw[
+                record_from_id
                 people_posting_from_ip
                 last_post_in_list
                 next_post

Modified: trunk/t/schema/thread.t
===================================================================
--- trunk/t/schema/thread.t	2008-02-14 21:12:26 UTC (rev 802)
+++ trunk/t/schema/thread.t	2008-02-15 16:05:11 UTC (rev 803)
@@ -49,6 +49,9 @@
 
         resultsets => [
             qw[
+                last_post_viewed_in_thread
+                recent
+                record_from_id
             ]
         ],
     }



From chiselwright at mail.berlios.de  Tue Feb 19 20:18:48 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 19 Feb 2008 20:18:48 +0100
Subject: [Parley-svn] r804 - / trunk trunk/lib/Parley/Controller
	trunk/lib/Parley/I18N trunk/lib/Parley/Schema
	trunk/root/base/menu trunk/t/schema
Message-ID: <200802191918.m1JJImME012282@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-19 20:18:47 +0100 (Tue, 19 Feb 2008)
New Revision: 804

Modified:
   /
   trunk/Changes.i18n
   trunk/TODO
   trunk/lib/Parley/Controller/Site.pm
   trunk/lib/Parley/I18N/i_default.po
   trunk/lib/Parley/Schema/Person.pm
   trunk/root/base/menu/menubar
   trunk/t/schema/person.t
Log:
 r4679 at wiggin:  chisel | 2008-02-19 18:18:19 +0000
 + added a couple if i_default i18n phrases
 + added to TODO
 + added site/users URI
 + added ResultSet::Person
 + added record level Role functions to Schema::Person
 / tweaked Site menu, including adding Manage/Users
 / extended test for Person table/model



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4667
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4679
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-02-15 16:05:11 UTC (rev 803)
+++ trunk/Changes.i18n	2008-02-19 19:18:47 UTC (rev 804)
@@ -13,6 +13,8 @@
             - "ADMIN LOCK POST"
             - "Locked Post"
             - "Post Edited By"
+            - "Manage"
+            - "Users"
 
     it.po:
         - added:

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-15 16:05:11 UTC (rev 803)
+++ trunk/TODO	2008-02-19 19:18:47 UTC (rev 804)
@@ -2,6 +2,7 @@
 
   - "Cancel" from post/edit
   - "Cancel" from thread/reply
+  - fix <ul>/<ol> CSS
   - Quick Reply
   - login form doesn't submit onEnter
   - TESTS, TESTS, TESTS!

Modified: trunk/lib/Parley/Controller/Site.pm
===================================================================
--- trunk/lib/Parley/Controller/Site.pm	2008-02-15 16:05:11 UTC (rev 803)
+++ trunk/lib/Parley/Controller/Site.pm	2008-02-19 19:18:47 UTC (rev 804)
@@ -45,7 +45,18 @@
     $c->stash->{email_engine}{pid} = $pid;
 }
 
+sub users : Local {
+    my ($self, $c) = @_;
 
+    $c->stash->{users_with_roles} =
+        $c->model('ParleyDB::Person')->users_with_roles()
+    ;
+
+    $c->log->debug(
+        ref($c->stash->{users_with_roles})
+    );
+}
+
 =head1 NAME
 
 Parley::Controller::Site - Catalyst Controller

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-02-15 16:05:11 UTC (rev 803)
+++ trunk/lib/Parley/I18N/i_default.po	2008-02-19 19:18:47 UTC (rev 804)
@@ -305,6 +305,9 @@
 msgid "Logout"
 msgstr "Logout"
 
+msgid "Manage"
+msgstr "Manage"
+
 msgid "Me"
 msgstr "Me"
 
@@ -728,6 +731,9 @@
 msgid "Username"
 msgstr "Username"
 
+msgid "Users"
+msgstr "Users"
+
 msgid "View"
 msgstr "View"
 

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-02-15 16:05:11 UTC (rev 803)
+++ trunk/lib/Parley/Schema/Person.pm	2008-02-19 19:18:47 UTC (rev 804)
@@ -65,7 +65,11 @@
     size => undef,
   },
 );
+
 __PACKAGE__->set_primary_key("id");
+
+__PACKAGE__->resultset_class('Parley::ResultSet::Person');
+
 __PACKAGE__->add_unique_constraint(
     "person_forum_name_key",
     ["forum_name"]
@@ -107,7 +111,55 @@
   { "foreign.recipient" => "self.id" },
 );
 
-__PACKAGE__->has_many(map_user_role => 'Parley::Schema::UserRole', 'person_id');
+__PACKAGE__->has_many(
+    map_user_role => 'Parley::Schema::UserRole',
+    'person_id',
+    { join_type => 'right' }
+);
 
+sub roles {
+    my $record = shift;
+    my ($schema, $rs);
 
+    $schema = $record->result_source()->schema();
+
+    $rs = $schema->resultset('Role')->search(
+        {
+            'person.id'  => $record->id(),
+        },
+        {
+            prefetch => [
+                { 'map_user_role' => 'person' },
+            ],
+        }
+    );
+
+    return $rs;
+}
+
+sub check_user_roles {
+    my $record = shift;
+    my @roles  = @_;
+
+    my ($schema, $rs);
+
+    $schema = $record->result_source()->schema();
+
+    $rs = $schema->resultset('Role')->search(
+        {
+            'map_user_role.person_id'   => $record->id(),
+            'me.name' => {
+                -in => \@roles,
+            },
+        },
+        {
+            prefetch => [
+                { 'map_user_role' => 'person' },
+            ],
+        },
+    );
+
+    return ($rs->count == scalar(@roles) || 0);
+}
+
 1;

Modified: trunk/root/base/menu/menubar
===================================================================
--- trunk/root/base/menu/menubar	2008-02-15 16:05:11 UTC (rev 803)
+++ trunk/root/base/menu/menubar	2008-02-19 19:18:47 UTC (rev 804)
@@ -116,11 +116,12 @@
                     <div class="bd">                                        
                         <ul>
                             <li class="yuimenuitem"><a class="yuimenuitemlabel" href="terms/add">[%l('Add T-and-Cs')%]</a></li>
-                            <li class="yuimenuitem"><a class="yuimenuitemlabel" href="#">[%l('Site')%]</a>
+                            <li class="yuimenuitem"><a class="yuimenuitemlabel" href="#">[%l('Manage')%]</a>
                                 <div id="site" class="yuimenu">
                                     <div class="bd">
                                         <ul class="first-of-type">
                                             <li class="yuimenuitem"><a class="yuimenuitemlabel" href="site/services">[%l('Services')%]</a></li>
+                                            <li class="yuimenuitem"><a class="yuimenuitemlabel" href="site/users">[%l('Users')%]</a></li>
                                         </ul>            
                                     </div>
                                 </div>                    

Modified: trunk/t/schema/person.t
===================================================================
--- trunk/t/schema/person.t	2008-02-15 16:05:11 UTC (rev 803)
+++ trunk/t/schema/person.t	2008-02-19 19:18:47 UTC (rev 804)
@@ -51,6 +51,7 @@
 
         resultsets => [
             qw[
+                users_with_roles
             ]
         ],
     }



From chiselwright at mail.berlios.de  Tue Feb 19 20:18:56 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 19 Feb 2008 20:18:56 +0100
Subject: [Parley-svn] r805 - / trunk/t
Message-ID: <200802191918.m1JJIuF7012354@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-19 20:18:56 +0100 (Tue, 19 Feb 2008)
New Revision: 805

Added:
   trunk/t/05.userroles.t
Modified:
   /
Log:
 r4680 at wiggin:  chisel | 2008-02-19 18:18:42 +0000
 + added user-role tests



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4679
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4680
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/t/05.userroles.t
===================================================================
--- trunk/t/05.userroles.t	2008-02-19 19:18:47 UTC (rev 804)
+++ trunk/t/05.userroles.t	2008-02-19 19:18:56 UTC (rev 805)
@@ -0,0 +1,42 @@
+use strict;
+use warnings;
+use Test::More tests => 10;
+
+BEGIN { use_ok 'Parley::Schema' }
+
+my ($schema, $resultset, $rs, $user_0, $user_0_roles, $status_ok);
+
+# get a schema to query
+$schema = Parley::Schema->connect(
+    'dbi:Pg:dbname=parley'
+);
+isa_ok($schema, 'Parley::Schema');
+
+# grab the Person resultset
+$resultset = $schema->resultset('Person');
+isa_ok($resultset, 'Parley::ResultSet::Person');
+
+# we should be able to fetch user #0
+$user_0 = $resultset->find(0);
+isa_ok($user_0, 'Parley::Schema::Person');
+
+# XXX (incorrect assumption - only in $c?)
+# user_0 should have a "roles" method
+can_ok($user_0, qw(roles));
+
+# user_0 should have some roles
+$user_0_roles = $user_0->roles;
+isa_ok($user_0_roles, 'DBIx::Class::ResultSet');
+ok($user_0_roles > 0, 'user 0 has at least one role');
+
+# user_0 should be a site-admin
+$status_ok = $user_0->check_user_roles('site_moderator');
+is($status_ok, 1, 'user 0 is site_moderator');
+
+# user 0 should NOT be a 'muppet'
+$status_ok = $user_0->check_user_roles('muppet');
+is($status_ok, 0, 'user 0 is NOT a muppet');
+
+# user 0 should NOT be a site_moderator AND a 'muppet'
+$status_ok = $user_0->check_user_roles('site_moderator', 'muppet');
+is($status_ok, 0, 'user 0 is site_moderator but NOT a muppet');



From chiselwright at mail.berlios.de  Tue Feb 19 20:19:03 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 19 Feb 2008 20:19:03 +0100
Subject: [Parley-svn] r806 - / trunk/lib/Parley/ResultSet
Message-ID: <200802191919.m1JJJ3WD012424@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-19 20:19:03 +0100 (Tue, 19 Feb 2008)
New Revision: 806

Added:
   trunk/lib/Parley/ResultSet/Forum.pm
   trunk/lib/Parley/ResultSet/Person.pm
Modified:
   /
Log:
 r4681 at wiggin:  chisel | 2008-02-19 19:16:05 +0000
 + added a couple of overlooked resultset classes



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4680
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4681
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/lib/Parley/ResultSet/Forum.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Forum.pm	2008-02-19 19:18:56 UTC (rev 805)
+++ trunk/lib/Parley/ResultSet/Forum.pm	2008-02-19 19:19:03 UTC (rev 806)
@@ -0,0 +1,42 @@
+package Parley::ResultSet::Forum;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use base 'DBIx::Class::ResultSet';
+
+sub available_list {
+    my ($resultsource) = @_;
+    my ($rs);
+
+    $rs = $resultsource->search(
+        {
+            active  => 1,
+        },
+        {
+            order_by    => 'name ASC',
+        }
+    );
+
+    return $rs;
+}
+
+sub record_from_id {
+    my ($resultsource, $forum_id) = @_;
+    my ($rs);
+
+    $rs = $resultsource->find(
+        {
+            'me.id'  => $forum_id,
+        },
+        {
+            prefetch => [
+                'last_post',
+            ],
+        }
+    );
+
+    return $rs;
+}
+
+1;

Added: trunk/lib/Parley/ResultSet/Person.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Person.pm	2008-02-19 19:18:56 UTC (rev 805)
+++ trunk/lib/Parley/ResultSet/Person.pm	2008-02-19 19:19:03 UTC (rev 806)
@@ -0,0 +1,24 @@
+package Parley::ResultSet::Person;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use base 'DBIx::Class::ResultSet';
+
+sub users_with_roles {
+    my $resultsource = shift;
+    my ($rs);
+
+    $rs = $resultsource->search(
+        {
+        },
+        {
+            join        => 'map_user_role',
+            distinct    => 1,
+        },
+    );
+
+    return $rs;
+}
+
+1;



From chiselwright at mail.berlios.de  Tue Feb 19 20:19:11 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 19 Feb 2008 20:19:11 +0100
Subject: [Parley-svn] r807 - / trunk/lib/Parley/Schema trunk/root/base
Message-ID: <200802191919.m1JJJBT4012495@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-19 20:19:11 +0100 (Tue, 19 Feb 2008)
New Revision: 807

Modified:
   /
   trunk/lib/Parley/Schema/Person.pm
   trunk/root/base/header
Log:
 r4682 at wiggin:  chisel | 2008-02-19 19:17:16 +0000
 + 



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4681
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4682
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-02-19 19:19:03 UTC (rev 806)
+++ trunk/lib/Parley/Schema/Person.pm	2008-02-19 19:19:11 UTC (rev 807)
@@ -134,7 +134,7 @@
         }
     );
 
-    return $rs;
+    return (scalar $rs);
 }
 
 sub check_user_roles {

Modified: trunk/root/base/header
===================================================================
--- trunk/root/base/header	2008-02-19 19:19:03 UTC (rev 806)
+++ trunk/root/base/header	2008-02-19 19:19:11 UTC (rev 807)
@@ -31,6 +31,21 @@
 
         <!-- YUI ajax magick -->
 
+        <link rel="stylesheet" type="text/css"
+            href="[%c.request.base%]/static/yui/fonts/fonts-min.css" />
+        <link rel="stylesheet" type="text/css"
+            href="[%c.request.base%]/static/yui/treeview/assets/skins/sam/treeview.css" />
+        <script type="text/javascript" src="[%c.request.base%]/static/yui/yahoo/yahoo.js"></script>
+        <script type="text/javascript" src="[%c.request.base%]/static/yui/event/event.js"></script>
+
+        <script type="text/javascript" src="[%c.request.base%]/static/yui/treeview/treeview.js"></script>
+
+
+<!--begin custom header content for this example-->
+<!--bring in the folder-style CSS for the TreeView Control-->
+<link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/treeview/assets/treeview-menu.css" />
+
+
         <!-- CSS -->
         <link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/fonts/fonts-min.css" />
         <link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/reset-fonts-grids/reset-fonts-grids.css" />



From chiselwright at mail.berlios.de  Tue Feb 19 20:19:18 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 19 Feb 2008 20:19:18 +0100
Subject: [Parley-svn] r808 - / trunk/root/base/site
Message-ID: <200802191919.m1JJJIuF012570@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-19 20:19:18 +0100 (Tue, 19 Feb 2008)
New Revision: 808

Added:
   trunk/root/base/site/users
Modified:
   /
Log:
 r4683 at wiggin:  chisel | 2008-02-19 19:17:49 +0000
 + basic user-role listing (site/users)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4682
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4683
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/root/base/site/users
===================================================================
--- trunk/root/base/site/users	2008-02-19 19:19:11 UTC (rev 807)
+++ trunk/root/base/site/users	2008-02-19 19:19:18 UTC (rev 808)
@@ -0,0 +1,84 @@
+<h1>User Management</h1>
+
+<h2>Administration Rights</h2>
+
+<!-- markup for expand/contract links -->
+<!--
+<div id="expandcontractdiv">
+	<a id="collapse" href="#">Collapse all</a>
+</div>
+-->
+
+<div id="treeDiv1"></div>
+
+<h2>Restrictions, Bans and Suspensions</h2>
+
+
+<hr />
+
+<!-- Some custom style for the expand/contract section-->
+<style type="text/css">
+#expandcontractdiv {border:1px dotted #dedede; background-color:#EBE4F2; margin:0 0 .5em 0; padding:0.4em;}
+#treeDiv1 { background: #fff; padding:1em; margin-top:1em; }
+</style>
+
+
+
+<!--BEGIN SOURCE CODE FOR EXAMPLE =============================== -->
+
+
+<script type="text/javascript">
+//an anonymous function wraps our code to keep our variables
+//in function scope rather than in the global namespace:
+(function() {
+	var tree; //will hold our TreeView instance
+	
+	function treeInit() {
+		
+		YAHOO.log("Example's treeInit function firing.", "info", "example");
+		
+		//Hand off ot a method that randomly generates tree nodes:
+		buildRandomTextNodeTree();
+		
+		//handler for collapsing all nodes
+		YAHOO.util.Event.on("collapse", "click", function(e) {
+			YAHOO.log("Collapsing all TreeView  nodes.", "info", "example");
+			tree.collapseAll();
+			YAHOO.util.Event.preventDefault(e);
+		});
+	}
+	
+	function buildRandomTextNodeTree() {
+		//instantiate the tree:
+		tree = new YAHOO.widget.TreeView("treeDiv1");
+		
+		//create top-level nodes
+        [% dummy_value = users_with_roles.reset %]
+        [% WHILE (person = users_with_roles.next) %]
+			var tmpNode = new YAHOO.widget.MenuNode("[%person.forum_name%]", tree.getRoot(), false);
+            console.log('Person: ', "[%person.forum_name%]");
+            console.log('Roles:  ', "[%person.roles||'noroles?'%]");
+
+            [% pRoles = person.roles %]
+            [% WHILE (role = pRoles.next) %]
+                console.log('Role: ', '[%role.name%]');
+				var roleNode = new YAHOO.widget.MenuNode("[%role.name%]", tmpNode, false);
+            [% END %]
+        [% END %]
+		
+		//once it's all built out, we need to render
+		//our TreeView instance:
+		tree.draw();
+	}
+	
+	//When the DOM is done loading, we can initialize our TreeView
+	//instance:
+	YAHOO.util.Event.onDOMReady(treeInit);
+	
+})();//anonymous function wrapper closed; () notation executes function
+
+</script>
+
+<!--END SOURCE CODE FOR EXAMPLE =============================== -->
+
+



From chiselwright at mail.berlios.de  Tue Feb 19 20:19:26 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Tue, 19 Feb 2008 20:19:26 +0100
Subject: [Parley-svn] r809 - / trunk/lib/Parley/Schema
Message-ID: <200802191919.m1JJJQC8012645@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-19 20:19:25 +0100 (Tue, 19 Feb 2008)
New Revision: 809

Modified:
   /
   trunk/lib/Parley/Schema/Person.pm
Log:
 r4684 at wiggin:  chisel | 2008-02-19 19:18:39 +0000
 / removed "force scalar $rs" return value



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4683
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4684
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-02-19 19:19:18 UTC (rev 808)
+++ trunk/lib/Parley/Schema/Person.pm	2008-02-19 19:19:25 UTC (rev 809)
@@ -134,7 +134,7 @@
         }
     );
 
-    return (scalar $rs);
+    return $rs;
 }
 
 sub check_user_roles {



From chiselwright at mail.berlios.de  Wed Feb 27 10:44:40 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 27 Feb 2008 10:44:40 +0100
Subject: [Parley-svn] r810 - / trunk
Message-ID: <200802270944.m1R9iea1010661@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-27 10:44:39 +0100 (Wed, 27 Feb 2008)
New Revision: 810

Modified:
   /
   trunk/ROADMAP
Log:
 r4701 at wiggin:  chisel | 2008-02-25 18:54:09 +0000
 + add YUI upgrade to roadmap



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4684
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4701
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/ROADMAP
===================================================================
--- trunk/ROADMAP	2008-02-19 19:19:25 UTC (rev 809)
+++ trunk/ROADMAP	2008-02-27 09:44:39 UTC (rev 810)
@@ -26,6 +26,7 @@
 
 0.60:
 
+    - upgrade to YUI 2.5.x
     - advanced search
 
 0.61:



From chiselwright at mail.berlios.de  Wed Feb 27 10:44:55 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 27 Feb 2008 10:44:55 +0100
Subject: [Parley-svn] r811 - / trunk trunk/db trunk/lib/Parley/Controller
	trunk/lib/Parley/Schema trunk/root/base trunk/root/base/site
	trunk/root/static/css trunk/t/schema
Message-ID: <200802270944.m1R9it7b010790@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-27 10:44:54 +0100 (Wed, 27 Feb 2008)
New Revision: 811

Modified:
   /
   trunk/TODO
   trunk/db/patch_0.58_to_0.59.psql
   trunk/lib/Parley/Controller/Site.pm
   trunk/lib/Parley/Schema/Role.pm
   trunk/root/base/header
   trunk/root/base/site/users
   trunk/root/static/css/parley.css
   trunk/t/schema/role.t
Log:
 r4702 at wiggin:  chisel | 2008-02-27 08:41:49 +0000
 / TODO update
 + add idx field to role table, and assign in role INSERTs
 + add site/user URI, to view/manage user access/permissions
 + add site/users_autocomplete, to support site/users autocomplete field
 + fixed Schema::Role to reflect columns in table
 + add ResultSet::Role, with role_list() method
 / UI/CSS changes for evolving user management screens
 + added new tests to schema/role.t



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4701
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4702
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-27 09:44:39 UTC (rev 810)
+++ trunk/TODO	2008-02-27 09:44:54 UTC (rev 811)
@@ -1,5 +1,6 @@
 TODO LIST
 
+  - Parley::Version (a la SVK)
   - "Cancel" from post/edit
   - "Cancel" from thread/reply
   - fix <ul>/<ol> CSS

Modified: trunk/db/patch_0.58_to_0.59.psql
===================================================================
--- trunk/db/patch_0.58_to_0.59.psql	2008-02-27 09:44:39 UTC (rev 810)
+++ trunk/db/patch_0.58_to_0.59.psql	2008-02-27 09:44:54 UTC (rev 811)
@@ -22,23 +22,28 @@
 
 CREATE TABLE role (
     id          serial      primary key,
+    idx         integer     not null default 9999,
     name        varchar(30) not null unique,
     description text
 );
 -- a couple of roles
-INSERT INTO role (name, description) VALUES (
+INSERT INTO role (idx, name, description) VALUES (
+    0,
     'site_moderator',
     'Site Moderator (aka Da Boss)'
 );
-INSERT INTO role (name, description) VALUES (
+INSERT INTO role (idx, name, description) VALUES (
+    100,
     'ip_ban_posting',
     'Restrict Posting by IP'
 );
-INSERT INTO role (name, description) VALUES (
+INSERT INTO role (idx, name, description) VALUES (
+    100,
     'ip_ban_signup',
     'Restrict Sign-Up by IP'
 );
-INSERT INTO role (name, description) VALUES (
+INSERT INTO role (idx, name, description) VALUES (
+    100,
     'ip_ban_login',
     'Restrict Login by IP'
 );

Modified: trunk/lib/Parley/Controller/Site.pm
===================================================================
--- trunk/lib/Parley/Controller/Site.pm	2008-02-27 09:44:39 UTC (rev 810)
+++ trunk/lib/Parley/Controller/Site.pm	2008-02-27 09:44:54 UTC (rev 811)
@@ -4,6 +4,7 @@
 use warnings;
 use base 'Catalyst::Controller';
 
+use JSON;
 use Proc::Daemon;
 use Proc::PID::File;
 
@@ -51,10 +52,57 @@
     $c->stash->{users_with_roles} =
         $c->model('ParleyDB::Person')->users_with_roles()
     ;
+}
 
-    $c->log->debug(
-        ref($c->stash->{users_with_roles})
+sub user : Local {
+    my ($self, $c) = @_;
+    my $pid = $c->request->param('pid');
+
+    if (defined $pid && $pid =~ m{\A\d+\z}xms) {
+        $c->stash->{person} =
+            $c->model('ParleyDB::Person')->find($pid)
+        ;
+
+        $c->stash->{roles} =
+            $c->model('ParleyDB::Role')->role_list();
+    }
+    else {
+        $c->response->redirect(
+            $c->uri_for('/site/users/')
+        );
+        return;
+    }
+}
+
+sub users_autocomplete : Local {
+    my ($self, $c) = @_;
+    my @results;
+
+    my $stuff = $c->model('ParleyDB::Person')->search(
+        {
+            forum_name => { -ilike => $c->request->param('query') . q{%} },
+        },
+        {
+            'order_by' => 'forum_name',
+            columns => [qw/id forum_name first_name last_name/],
+        }
     );
+
+    while (my $person = $stuff->next) {
+        my %data = $person->get_columns;
+        push @results, \%data;
+    }
+
+    $c->response->body(
+        to_json( 
+            {
+                ResultSet => {
+                    person => \@results,
+                }
+            }
+        )
+    );
+    return;
 }
 
 =head1 NAME

Modified: trunk/lib/Parley/Schema/Role.pm
===================================================================
--- trunk/lib/Parley/Schema/Role.pm	2008-02-27 09:44:39 UTC (rev 810)
+++ trunk/lib/Parley/Schema/Role.pm	2008-02-27 09:44:54 UTC (rev 811)
@@ -11,12 +11,14 @@
 __PACKAGE__->load_components("PK::Auto", "Core");
 __PACKAGE__->table("role");
 __PACKAGE__->add_columns(
-  id    => { },
-  name  => { },
+  id            => { },
+  idx           => { },
+  name          => { },
+  description   => { },
 );
 
 __PACKAGE__->set_primary_key("id");
-#__PACKAGE__->resultset_class('Parley::ResultSet::Role');
+__PACKAGE__->resultset_class('Parley::ResultSet::Role');
 
 __PACKAGE__->has_many(
     map_user_role => 'Parley::Schema::UserRole',

Modified: trunk/root/base/header
===================================================================
--- trunk/root/base/header	2008-02-27 09:44:39 UTC (rev 810)
+++ trunk/root/base/header	2008-02-27 09:44:54 UTC (rev 811)
@@ -31,40 +31,24 @@
 
         <!-- YUI ajax magick -->
 
-        <link rel="stylesheet" type="text/css"
-            href="[%c.request.base%]/static/yui/fonts/fonts-min.css" />
-        <link rel="stylesheet" type="text/css"
-            href="[%c.request.base%]/static/yui/treeview/assets/skins/sam/treeview.css" />
-        <script type="text/javascript" src="[%c.request.base%]/static/yui/yahoo/yahoo.js"></script>
-        <script type="text/javascript" src="[%c.request.base%]/static/yui/event/event.js"></script>
-
-        <script type="text/javascript" src="[%c.request.base%]/static/yui/treeview/treeview.js"></script>
-
-
-<!--begin custom header content for this example-->
-<!--bring in the folder-style CSS for the TreeView Control-->
-<link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/treeview/assets/treeview-menu.css" />
-
-
         <!-- CSS -->
-        <link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/fonts/fonts-min.css" />
+        <link rel="stylesheet" type="text/css" href="[%c.uri_for('/static/yui/fonts/fonts-min.css')%]" />
         <link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/reset-fonts-grids/reset-fonts-grids.css" />
 
         <link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/button/assets/skins/sam/button.css" />
         <link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/container/assets/skins/sam/container.css" />
         <link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/menu/assets/skins/sam/menu.css" /> 
         <link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/tabview/assets/skins/sam/tabview.css" />
-        <link rel="stylesheet" type="text/css" href="[%c.request.base%]/static/yui/logger/assets/skins/sam/logger.css" />
+        <link rel="stylesheet" type="text/css" href="[%c.uri_for('/static/yui/autocomplete/assets/skins/sam/autocomplete.css')%]" />
 
         <!-- Dependency source files -->
         <script type="text/javascript" src="[%c.request.base%]/static/yui/yahoo-dom-event/yahoo-dom-event.js"></script>
-        <script type="text/javascript" src="[%c.request.base%]/static/yui/container/container_core-min.js"></script>
         <script type="text/javascript" src="[%c.request.base%]/static/yui/container/container-min.js"></script>
-        <script type="text/javascript" src="[%c.request.base%]/static/yui/utilities/utilities.js"></script>
+        <script type="text/javascript" src="[%c.uri_for('/static/yui/utilities/utilities.js')%]"></script>
         <script type="text/javascript" src="[%c.request.base%]/static/yui/button/button-min.js"></script>
         <script type="text/javascript" src="[%c.request.base%]/static/yui/menu/menu-min.js"></script>
         <script type="text/javascript" src="[%c.request.base%]/static/yui/tabview/tabview-min.js"></script>
-        <script type="text/javascript" src="[%c.request.base%]/static/yui/logger/logger-min.js"></script>
+        <script type="text/javascript" src="[%c.uri_for('/static/yui/autocomplete/autocomplete-min.js')%]"></script>
 
 
         <!-- defined styles for parley -->

Modified: trunk/root/base/site/users
===================================================================
--- trunk/root/base/site/users	2008-02-27 09:44:39 UTC (rev 810)
+++ trunk/root/base/site/users	2008-02-27 09:44:54 UTC (rev 811)
@@ -2,83 +2,72 @@
 
 <h2>Administration Rights</h2>
 
-<!-- markup for expand/contract links -->
-<!--
-<div id="expandcontractdiv">
-	<a id="collapse" href="#">Collapse all</a>
-</div>
--->
 
-<div id="treeDiv1"></div>
+<form action="[%c.uri_for('/site/user/')%]" onsubmit="return YAHOO.example.ACJson.validateForm();">
+    <div id="ysearch">
+		<label>User Search: </label>
+		<input id="ysearchinput" type="text">
+		<input id="ac_personid" type="hidden" value="zx" name="pid">
+		<input id="ysearchsubmit" type="submit" value="Submit Query">
+		<div id="ysearchcontainer"></div>
+    </div>
+</form>
 
 <h2>Restrictions, Bans and Suspensions</h2>
 
+<script type="text/javascript">
+YAHOO.example.ACJson = new function(){
+    // Instantiate an XHR DataSource and define schema as an array:
+    //     ["Multi-depth.object.notation.to.find.a.single.result.item",
+    //     "Query Key",
+    //     "Additional Param Name 1",
+    //     ...
+    //     "Additional Param Name n"]
+    this.oACDS = new YAHOO.widget.DS_XHR("/site/users_autocomplete/", ["ResultSet.person","forum_name"]);
+    this.oACDS.queryMatchContains = true;
+    this.oACDS.forceSelection = true;
+    this.oACDS.typeAhead = true;
+    this.oACDS.animSpeed = 0.1;
+    //this.oACDS.scriptQueryAppend = "output=json&results=100"; // Needed for YWS
 
-<hr />
+    // Instantiate AutoComplete
+    this.oAutoComp = new YAHOO.widget.AutoComplete("ysearchinput","ysearchcontainer", this.oACDS);
+    this.oAutoComp.useShadow = true;
+    this.oAutoComp.formatResult = function(oResultItem, sQuery) {
+        return oResultItem[1].forum_name
+            + " ("
+            + oResultItem[1].first_name
+            + " "
+            + oResultItem[1].last_name
+            + ")";
+    };
+    this.oAutoComp.doBeforeExpandContainer = function(oTextbox, oContainer, sQuery, aResults) {
+        var pos = YAHOO.util.Dom.getXY(oTextbox);
+        pos[1] += YAHOO.util.Dom.get(oTextbox).offsetHeight + 2;
+        YAHOO.util.Dom.setXY(oContainer,pos);
+        return true;
+    };
 
-<!-- Some custom style for the expand/contract section-->
-<style type="text/css">
-#expandcontractdiv {border:1px dotted #dedede; background-color:#EBE4F2; margin:0 0 .5em 0; padding:0.4em;}
-#treeDiv1 { background: #fff; padding:1em; margin-top:1em; }
-</style>
+    this.oAutoComp.itemSelectEvent.subscribe(
+        function(oSelf, elItem, oData) {
+            console.log(elItem[2][1]);
 
+            YAHOO.util.Dom.get('ac_personid').value = elItem[2][1].id;
 
+            try {
+                console.log( YAHOO.util.Dom.get('ac_personid') );
+            }
+            catch(e) { console.log(e); }
 
-<!--BEGIN SOURCE CODE FOR EXAMPLE =============================== -->
+        },
+        this,
+        false
+    );
 
-
-<script type="text/javascript">
-//an anonymous function wraps our code to keep our variables
-//in function scope rather than in the global namespace:
-(function() {
-	var tree; //will hold our TreeView instance
-	
-	function treeInit() {
-		
-		YAHOO.log("Example's treeInit function firing.", "info", "example");
-		
-		//Hand off ot a method that randomly generates tree nodes:
-		buildRandomTextNodeTree();
-		
-		//handler for collapsing all nodes
-		YAHOO.util.Event.on("collapse", "click", function(e) {
-			YAHOO.log("Collapsing all TreeView  nodes.", "info", "example");
-			tree.collapseAll();
-			YAHOO.util.Event.preventDefault(e);
-		});
-	}
-	
-	function buildRandomTextNodeTree() {
-		//instantiate the tree:
-		tree = new YAHOO.widget.TreeView("treeDiv1");
-		
-		//create top-level nodes
-        [% dummy_value = users_with_roles.reset %]
-        [% WHILE (person = users_with_roles.next) %]
-			var tmpNode = new YAHOO.widget.MenuNode("[%person.forum_name%]", tree.getRoot(), false);
-            console.log('Person: ', "[%person.forum_name%]");
-            console.log('Roles:  ', "[%person.roles||'noroles?'%]");
-
-            [% pRoles = person.roles %]
-            [% WHILE (role = pRoles.next) %]
-                console.log('Role: ', '[%role.name%]');
-				var roleNode = new YAHOO.widget.MenuNode("[%role.name%]", tmpNode, false);
-            [% END %]
-        [% END %]
-		
-		//once it's all built out, we need to render
-		//our TreeView instance:
-		tree.draw();
-	}
-	
-	//When the DOM is done loading, we can initialize our TreeView
-	//instance:
-	YAHOO.util.Event.onDOMReady(treeInit);
-	
-})();//anonymous function wrapper closed; () notation executes function
-
+    // Stub for form validation
+    this.validateForm = function() {
+        // Validation code goes here
+        return true;
+    };
+};
 </script>
-
-<!--END SOURCE CODE FOR EXAMPLE =============================== -->
-
-

Modified: trunk/root/static/css/parley.css
===================================================================
--- trunk/root/static/css/parley.css	2008-02-27 09:44:39 UTC (rev 810)
+++ trunk/root/static/css/parley.css	2008-02-27 09:44:54 UTC (rev 811)
@@ -531,6 +531,18 @@
     width:              450px;
 }
 
+#ysearch {
+    text-align:         center;
+}
+#ysearchinput {
+    position:           static;
+    width:              20em;
+} /* to center, set static and explicit width: */
+#ysearchcontainer {
+    text-align:         left;
+    width:              20em;
+} /* to center, set left-align and explicit width: */
+
 /* ForumCode styles */
 .forumcode_code {
     font-family:        monospace;

Modified: trunk/t/schema/role.t
===================================================================
--- trunk/t/schema/role.t	2008-02-27 09:44:39 UTC (rev 810)
+++ trunk/t/schema/role.t	2008-02-27 09:44:54 UTC (rev 811)
@@ -20,7 +20,9 @@
         columns => [
             qw[
                 id
+                idx
                 name
+                description
             ]
         ],
 
@@ -37,6 +39,7 @@
 
         resultsets => [
             qw[
+                role_list
             ]
         ],
     }



From chiselwright at mail.berlios.de  Wed Feb 27 10:45:26 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 27 Feb 2008 10:45:26 +0100
Subject: [Parley-svn] r812 - / trunk/lib/Parley/ResultSet
	trunk/root/base/site
Message-ID: <200802270945.m1R9jQDv010939@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-27 10:45:26 +0100 (Wed, 27 Feb 2008)
New Revision: 812

Added:
   trunk/lib/Parley/ResultSet/Role.pm
   trunk/root/base/site/user
Modified:
   /
Log:
 r4703 at wiggin:  chisel | 2008-02-27 08:42:29 +0000
 + added new files



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4702
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4703
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/lib/Parley/ResultSet/Role.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Role.pm	2008-02-27 09:44:54 UTC (rev 811)
+++ trunk/lib/Parley/ResultSet/Role.pm	2008-02-27 09:45:26 UTC (rev 812)
@@ -0,0 +1,23 @@
+package Parley::ResultSet::Role;
+# vim: ts=8 sts=4 et sw=4 sr sta
+use strict;
+use warnings;
+
+use base 'DBIx::Class::ResultSet';
+
+sub role_list {
+    my $resultsource = shift;
+    my ($rs);
+
+    $rs = $resultsource->search(
+        {
+        },
+        {
+            'order_by' => [ 'idx ASC', 'description ASC' ],
+        },
+    );
+
+    return $rs;
+}
+
+1;

Added: trunk/root/base/site/user
===================================================================
--- trunk/root/base/site/user	2008-02-27 09:44:54 UTC (rev 811)
+++ trunk/root/base/site/user	2008-02-27 09:45:26 UTC (rev 812)
@@ -0,0 +1,23 @@
+<h1>User Stuff</h1>
+
+<h2>[% person.forum_name %] ([%person.first_name%] [%person.last_name%])</h2>
+
+<table class="forum_list">
+    <tbody>
+
+        [% WHILE (role = roles.next) %]
+        [% toggler = (1 - (toggler||0)) %]
+        <tr class="row [% row_styles.$toggler %]">
+            <td>
+                [% role.description %]
+            </td>
+            <td>
+                [% person.check_user_roles(role.name) %]
+            </td>
+        </tr>
+        [% END %]
+
+    </tbody>
+</table>
+
+<hr />



From chiselwright at mail.berlios.de  Wed Feb 27 10:45:42 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 27 Feb 2008 10:45:42 +0100
Subject: [Parley-svn] r813 - / trunk trunk/lib trunk/lib/Parley
	trunk/lib/Parley/App trunk/lib/Parley/App/Communication
	trunk/lib/Parley/Controller trunk/lib/Parley/Controller/User
	trunk/lib/Parley/Model trunk/lib/Parley/ResultSet
	trunk/lib/Parley/Schema trunk/lib/Parley/View trunk/lib/Text/Search
Message-ID: <200802270945.m1R9jgxk011028@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-27 10:45:40 +0100 (Wed, 27 Feb 2008)
New Revision: 813

Added:
   trunk/lib/Parley/Version.pm
Modified:
   /
   trunk/TODO
   trunk/lib/Parley.pm
   trunk/lib/Parley/App/Communication/Email.pm
   trunk/lib/Parley/App/DFV.pm
   trunk/lib/Parley/App/DateTime.pm
   trunk/lib/Parley/App/Error.pm
   trunk/lib/Parley/App/I18N.pm
   trunk/lib/Parley/App/Notification.pm
   trunk/lib/Parley/App/Terms.pm
   trunk/lib/Parley/Contributors.pm
   trunk/lib/Parley/Controller/Admin.pm
   trunk/lib/Parley/Controller/Forum.pm
   trunk/lib/Parley/Controller/Help.pm
   trunk/lib/Parley/Controller/My.pm
   trunk/lib/Parley/Controller/Post.pm
   trunk/lib/Parley/Controller/Root.pm
   trunk/lib/Parley/Controller/Search.pm
   trunk/lib/Parley/Controller/Site.pm
   trunk/lib/Parley/Controller/Terms.pm
   trunk/lib/Parley/Controller/Thread.pm
   trunk/lib/Parley/Controller/User.pm
   trunk/lib/Parley/Controller/User/LostPassword.pm
   trunk/lib/Parley/Controller/User/SignUp.pm
   trunk/lib/Parley/Model/ParleyDB.pm
   trunk/lib/Parley/ResultSet/Forum.pm
   trunk/lib/Parley/ResultSet/Person.pm
   trunk/lib/Parley/ResultSet/Post.pm
   trunk/lib/Parley/ResultSet/Role.pm
   trunk/lib/Parley/ResultSet/Terms.pm
   trunk/lib/Parley/ResultSet/Thread.pm
   trunk/lib/Parley/ResultSet/ThreadView.pm
   trunk/lib/Parley/Schema.pm
   trunk/lib/Parley/Schema/Authentication.pm
   trunk/lib/Parley/Schema/EmailQueue.pm
   trunk/lib/Parley/Schema/Forum.pm
   trunk/lib/Parley/Schema/ForumModerator.pm
   trunk/lib/Parley/Schema/PasswordReset.pm
   trunk/lib/Parley/Schema/Person.pm
   trunk/lib/Parley/Schema/Post.pm
   trunk/lib/Parley/Schema/Preference.pm
   trunk/lib/Parley/Schema/PreferenceTimeString.pm
   trunk/lib/Parley/Schema/RegistrationAuthentication.pm
   trunk/lib/Parley/Schema/Role.pm
   trunk/lib/Parley/Schema/Terms.pm
   trunk/lib/Parley/Schema/TermsAgreed.pm
   trunk/lib/Parley/Schema/Thread.pm
   trunk/lib/Parley/Schema/ThreadView.pm
   trunk/lib/Parley/Schema/UserRole.pm
   trunk/lib/Parley/View/Plain.pm
   trunk/lib/Parley/View/TT.pm
   trunk/lib/Text/Search/SQL.pm
Log:
 r4704 at wiggin:  chisel | 2008-02-27 08:57:57 +0000
 + implmented SVK-esque Parley::Version



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4703
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4704
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/TODO	2008-02-27 09:45:40 UTC (rev 813)
@@ -1,6 +1,5 @@
 TODO LIST
 
-  - Parley::Version (a la SVK)
   - "Cancel" from post/edit
   - "Cancel" from thread/reply
   - fix <ul>/<ol> CSS
@@ -27,6 +26,7 @@
   - investigate: package Your::Schema; sub connect { do the check; next::method }
   - investigate: DBIx::Class::Schema::Versioned
   - investigate: t/model_Post.t / distinct count
+D - Parley::Version (a la SVK)
 D - login form flickers on IE7 page load
 D - [bug] user/profile doesn't show avatar
 D - add i18n for 'or'

Modified: trunk/lib/Parley/App/Communication/Email.pm
===================================================================
--- trunk/lib/Parley/App/Communication/Email.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/App/Communication/Email.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use Perl6::Export::Attrs;
 
 use Parley::App::I18N qw( :locale );

Modified: trunk/lib/Parley/App/DFV.pm
===================================================================
--- trunk/lib/Parley/App/DFV.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/App/DFV.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use Email::Valid;
 use Perl6::Export::Attrs;
 

Modified: trunk/lib/Parley/App/DateTime.pm
===================================================================
--- trunk/lib/Parley/App/DateTime.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/App/DateTime.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use DateTime;
 use Perl6::Export::Attrs;
 

Modified: trunk/lib/Parley/App/Error.pm
===================================================================
--- trunk/lib/Parley/App/Error.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/App/Error.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use Perl6::Export::Attrs;
 
 sub has_errors :Export(:methods) {

Modified: trunk/lib/Parley/App/I18N.pm
===================================================================
--- trunk/lib/Parley/App/I18N.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/App/I18N.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use Perl6::Export::Attrs;
 
 sub first_valid_locale :Export( :locale ) {

Modified: trunk/lib/Parley/App/Notification.pm
===================================================================
--- trunk/lib/Parley/App/Notification.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/App/Notification.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use Perl6::Export::Attrs;
 
 sub notify_watchers :Export( :watch ) {

Modified: trunk/lib/Parley/App/Terms.pm
===================================================================
--- trunk/lib/Parley/App/Terms.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/App/Terms.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use Perl6::Export::Attrs;
 
 sub terms_check :Export( :terms ) {

Modified: trunk/lib/Parley/Contributors.pm
===================================================================
--- trunk/lib/Parley/Contributors.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Contributors.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -1,4 +1,5 @@
 package Parley::Contributors;
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 
 # this is a dummy package to provide POD
 

Modified: trunk/lib/Parley/Controller/Admin.pm
===================================================================
--- trunk/lib/Parley/Controller/Admin.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/Admin.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 # vim: ts=8 sts=4 et sw=4 sr sta
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 sub index : Private {

Modified: trunk/lib/Parley/Controller/Forum.pm
===================================================================
--- trunk/lib/Parley/Controller/Forum.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/Forum.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 use Parley::App::Error qw( :methods );

Modified: trunk/lib/Parley/Controller/Help.pm
===================================================================
--- trunk/lib/Parley/Controller/Help.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/Help.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 # vim: ts=8 sts=4 et sw=4 sr sta
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 use Parley::App::I18N qw( :locale );

Modified: trunk/lib/Parley/Controller/My.pm
===================================================================
--- trunk/lib/Parley/Controller/My.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/My.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -1,6 +1,8 @@
 package Parley::Controller::My;
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 use Graphics::Magick;

Modified: trunk/lib/Parley/Controller/Post.pm
===================================================================
--- trunk/lib/Parley/Controller/Post.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/Post.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 use DateTime;
 use JSON;

Modified: trunk/lib/Parley/Controller/Root.pm
===================================================================
--- trunk/lib/Parley/Controller/Root.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/Root.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 # vim: ts=8 sts=4 et sw=4 sr sta
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 use DateTime;

Modified: trunk/lib/Parley/Controller/Search.pm
===================================================================
--- trunk/lib/Parley/Controller/Search.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/Search.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 use Text::Search::SQL;

Modified: trunk/lib/Parley/Controller/Site.pm
===================================================================
--- trunk/lib/Parley/Controller/Site.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/Site.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 # vim: ts=8 sts=4 et sw=4 sr sta
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 use JSON;

Modified: trunk/lib/Parley/Controller/Terms.pm
===================================================================
--- trunk/lib/Parley/Controller/Terms.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/Terms.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 # vim: ts=8 sts=4 et sw=4 sr sta
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 use Parley::App::Terms qw( :terms );

Modified: trunk/lib/Parley/Controller/Thread.pm
===================================================================
--- trunk/lib/Parley/Controller/Thread.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/Thread.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 use Data::SpreadPagination;
 

Modified: trunk/lib/Parley/Controller/User/LostPassword.pm
===================================================================
--- trunk/lib/Parley/Controller/User/LostPassword.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/User/LostPassword.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 use List::MoreUtils qw{ uniq };

Modified: trunk/lib/Parley/Controller/User/SignUp.pm
===================================================================
--- trunk/lib/Parley/Controller/User/SignUp.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/User/SignUp.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 use List::MoreUtils qw{ uniq };

Modified: trunk/lib/Parley/Controller/User.pm
===================================================================
--- trunk/lib/Parley/Controller/User.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Controller/User.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 
 use strict;
 use warnings;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Controller';
 
 # deal with user login requests on user/login

Modified: trunk/lib/Parley/Model/ParleyDB.pm
===================================================================
--- trunk/lib/Parley/Model/ParleyDB.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Model/ParleyDB.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -1,6 +1,8 @@
 package Parley::Model::ParleyDB;
 
 use strict;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::Model::DBIC::Schema';
 
 __PACKAGE__->config(

Modified: trunk/lib/Parley/ResultSet/Forum.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Forum.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/ResultSet/Forum.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class::ResultSet';
 
 sub available_list {

Modified: trunk/lib/Parley/ResultSet/Person.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Person.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/ResultSet/Person.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class::ResultSet';
 
 sub users_with_roles {

Modified: trunk/lib/Parley/ResultSet/Post.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Post.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/ResultSet/Post.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class::ResultSet';
 
 sub record_from_id {

Modified: trunk/lib/Parley/ResultSet/Role.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Role.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/ResultSet/Role.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class::ResultSet';
 
 sub role_list {

Modified: trunk/lib/Parley/ResultSet/Terms.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Terms.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/ResultSet/Terms.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class::ResultSet';
 
 sub latest_terms {

Modified: trunk/lib/Parley/ResultSet/Thread.pm
===================================================================
--- trunk/lib/Parley/ResultSet/Thread.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/ResultSet/Thread.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class::ResultSet';
 
 # This is slightly complicated; the way we find the last post a user has seen

Modified: trunk/lib/Parley/ResultSet/ThreadView.pm
===================================================================
--- trunk/lib/Parley/ResultSet/ThreadView.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/ResultSet/ThreadView.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class::ResultSet';
 
 sub watching_thread {

Modified: trunk/lib/Parley/Schema/Authentication.pm
===================================================================
--- trunk/lib/Parley/Schema/Authentication.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/Authentication.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -5,6 +5,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 
 __PACKAGE__->load_components("PK::Auto", "Core");

Modified: trunk/lib/Parley/Schema/EmailQueue.pm
===================================================================
--- trunk/lib/Parley/Schema/EmailQueue.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/EmailQueue.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -5,6 +5,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 
 __PACKAGE__->load_components("PK::Auto", "Core");

Modified: trunk/lib/Parley/Schema/Forum.pm
===================================================================
--- trunk/lib/Parley/Schema/Forum.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/Forum.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -5,6 +5,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 
 __PACKAGE__->load_components("PK::Auto", "Core");

Modified: trunk/lib/Parley/Schema/ForumModerator.pm
===================================================================
--- trunk/lib/Parley/Schema/ForumModerator.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/ForumModerator.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -4,6 +4,8 @@
 use warnings;
 use base 'DBIx::Class';
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 __PACKAGE__->load_components('PK::Auto', 'Core');
 __PACKAGE__->table('forum_moderator');
 __PACKAGE__->add_columns(

Modified: trunk/lib/Parley/Schema/PasswordReset.pm
===================================================================
--- trunk/lib/Parley/Schema/PasswordReset.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/PasswordReset.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 
 __PACKAGE__->load_components("PK::Auto", "Core");

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/Person.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -5,6 +5,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 
 __PACKAGE__->load_components("PK::Auto", "Core");

Modified: trunk/lib/Parley/Schema/Post.pm
===================================================================
--- trunk/lib/Parley/Schema/Post.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/Post.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -6,6 +6,8 @@
 use warnings;
 use Data::Dump qw(pp);
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use DateTime;
 use DateTime::Format::Pg;
 use Text::Context::EitherSide;

Modified: trunk/lib/Parley/Schema/Preference.pm
===================================================================
--- trunk/lib/Parley/Schema/Preference.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/Preference.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -5,6 +5,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 
 __PACKAGE__->load_components("PK::Auto", "Core");

Modified: trunk/lib/Parley/Schema/PreferenceTimeString.pm
===================================================================
--- trunk/lib/Parley/Schema/PreferenceTimeString.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/PreferenceTimeString.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use warnings;
 use base 'DBIx::Class';
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 __PACKAGE__->load_components("PK::Auto", "Core");
 __PACKAGE__->table("preference_time_string");
 __PACKAGE__->add_columns(

Modified: trunk/lib/Parley/Schema/RegistrationAuthentication.pm
===================================================================
--- trunk/lib/Parley/Schema/RegistrationAuthentication.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/RegistrationAuthentication.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -5,6 +5,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 
 __PACKAGE__->load_components("PK::Auto", "Core");

Modified: trunk/lib/Parley/Schema/Role.pm
===================================================================
--- trunk/lib/Parley/Schema/Role.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/Role.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 use DateTime::Format::Pg;
 

Modified: trunk/lib/Parley/Schema/Terms.pm
===================================================================
--- trunk/lib/Parley/Schema/Terms.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/Terms.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -6,6 +6,8 @@
 use base 'DBIx::Class';
 use DateTime::Format::Pg;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 __PACKAGE__->load_components('PK::Auto', 'Core');
 __PACKAGE__->table('terms');
 

Modified: trunk/lib/Parley/Schema/TermsAgreed.pm
===================================================================
--- trunk/lib/Parley/Schema/TermsAgreed.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/TermsAgreed.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 
 __PACKAGE__->load_components('PK::Auto', 'Core');

Modified: trunk/lib/Parley/Schema/Thread.pm
===================================================================
--- trunk/lib/Parley/Schema/Thread.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/Thread.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -5,6 +5,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 
 __PACKAGE__->load_components("PK::Auto", "Core");

Modified: trunk/lib/Parley/Schema/ThreadView.pm
===================================================================
--- trunk/lib/Parley/Schema/ThreadView.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/ThreadView.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -5,6 +5,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base 'DBIx::Class';
 use DateTime::Format::Pg;
 

Modified: trunk/lib/Parley/Schema/UserRole.pm
===================================================================
--- trunk/lib/Parley/Schema/UserRole.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema/UserRole.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,6 +3,8 @@
 use strict;
 use warnings;
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 use base qw/DBIx::Class/;
 
 # Load required DBIC stuff

Modified: trunk/lib/Parley/Schema.pm
===================================================================
--- trunk/lib/Parley/Schema.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Schema.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -2,6 +2,7 @@
 # vim: ts=8 sts=4 et sw=4 sr sta
 use strict;
 use warnings;
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 
 use base 'DBIx::Class::Schema';
 

Added: trunk/lib/Parley/Version.pm
===================================================================
--- trunk/lib/Parley/Version.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/Version.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -0,0 +1,28 @@
+package Parley;
+
+use version; our $VERSION = qv(0.59.001);
+
+=head1 NAME
+
+Parley::Version - The Parley project-wide version number
+
+=head1 SYNOPSIS
+
+    package Parley::Whatever;
+
+    # Must be on one line so MakeMaker can parse it.
+use Parley::Version;  our  = ;
+
+=head1 DESCRIPTION
+
+Because of the problems coordinationg revision numbers in a distributed
+version control system and across a directory full of Perl modules, this
+module provides a central location for the project's release number.
+
+=head1 IDEA FROM
+
+This idea was taken from L<SVK>
+
+=cut
+
+1;

Modified: trunk/lib/Parley/View/Plain.pm
===================================================================
--- trunk/lib/Parley/View/Plain.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/View/Plain.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -1,6 +1,8 @@
 package Parley::View::Plain;
 
 use strict;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::View::TT';
 
 =head1 NAME

Modified: trunk/lib/Parley/View/TT.pm
===================================================================
--- trunk/lib/Parley/View/TT.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley/View/TT.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -1,6 +1,8 @@
 package Parley::View::TT;
 
 use strict;
+
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 use base 'Catalyst::View::TT';
 
 =head1 NAME

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Parley.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -3,7 +3,7 @@
 use strict;
 use warnings;
 
-our $VERSION = '0.59_01';
+use Parley::Version;  our $VERSION = $Parley::VERSION;
 
 use Catalyst::Runtime '5.70';
 use Catalyst qw/

Modified: trunk/lib/Text/Search/SQL.pm
===================================================================
--- trunk/lib/Text/Search/SQL.pm	2008-02-27 09:45:26 UTC (rev 812)
+++ trunk/lib/Text/Search/SQL.pm	2008-02-27 09:45:40 UTC (rev 813)
@@ -5,6 +5,8 @@
 use Carp;
 use Data::Dump qw(pp);
 
+use Parley::Version;  our $VERSION = $Parley::VERSION;
+
 sub new {
     my ($proto, $options) = @_;
 



From chiselwright at mail.berlios.de  Wed Feb 27 10:46:00 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 27 Feb 2008 10:46:00 +0100
Subject: [Parley-svn] r814 - / trunk
Message-ID: <200802270946.m1R9k0dp011114@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-27 10:46:00 +0100 (Wed, 27 Feb 2008)
New Revision: 814

Modified:
   /
   trunk/MANIFEST
Log:
 r4705 at wiggin:  chisel | 2008-02-27 09:00:38 +0000
 / update manifest



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4704
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4705
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/MANIFEST
===================================================================
--- trunk/MANIFEST	2008-02-27 09:45:40 UTC (rev 813)
+++ trunk/MANIFEST	2008-02-27 09:46:00 UTC (rev 814)
@@ -12,11 +12,15 @@
 db/patch_0.52_to_0.53.psql
 db/patch_0.53_to_0.57.psql
 db/patch_0.57_to_0.58.psql
+db/patch_0.58_to_0.59.psql
 db_script/Parley-Schema-0.57_08-PostgreSQL.sql
 db_script/Parley-Schema-0.58-PostgreSQL.sql
 db_script/Parley-Schema-0.58_13-MySQL.sql
 db_script/Parley-Schema-0.58_13-PostgreSQL.sql
 db_script/Parley-Schema-0.58_13-SQLite.sql
+db_script/Parley-Schema-0.59_01-MySQL.sql
+db_script/Parley-Schema-0.59_01-PostgreSQL.sql
+db_script/Parley-Schema-0.59_01-SQLite.sql
 doc/parley-qs.html
 inc/Module/AutoInstall.pm
 inc/Module/Install.pm
@@ -56,7 +60,10 @@
 lib/Parley/I18N/i_default.po
 lib/Parley/I18N/it.po
 lib/Parley/Model/ParleyDB.pm
+lib/Parley/ResultSet/Forum.pm
+lib/Parley/ResultSet/Person.pm
 lib/Parley/ResultSet/Post.pm
+lib/Parley/ResultSet/Role.pm
 lib/Parley/ResultSet/Terms.pm
 lib/Parley/ResultSet/Thread.pm
 lib/Parley/ResultSet/ThreadView.pm
@@ -71,10 +78,13 @@
 lib/Parley/Schema/Preference.pm
 lib/Parley/Schema/PreferenceTimeString.pm
 lib/Parley/Schema/RegistrationAuthentication.pm
+lib/Parley/Schema/Role.pm
 lib/Parley/Schema/Terms.pm
 lib/Parley/Schema/TermsAgreed.pm
 lib/Parley/Schema/Thread.pm
 lib/Parley/Schema/ThreadView.pm
+lib/Parley/Schema/UserRole.pm
+lib/Parley/Version.pm
 lib/Parley/View/Plain.pm
 lib/Parley/View/TT.pm
 lib/Template/Plugin/ForumCode.pm
@@ -85,6 +95,7 @@
 META.yml
 parley.yml
 README
+README.admin
 ROADMAP
 root/base/about/modules
 root/base/error/simple
@@ -125,6 +136,8 @@
 root/base/shared/user_avatar
 root/base/shared/user_status
 root/base/site/services
+root/base/site/user
+root/base/site/users
 root/base/terms/accept
 root/base/terms/add
 root/base/terms/index
@@ -733,6 +746,7 @@
 t/02pod.t
 t/03podcoverage.t
 t/04_forumcode.t
+t/05.userroles.t
 t/50.text_search.sql.t
 t/controller_Admin.t
 t/controller_Forum.t
@@ -759,11 +773,13 @@
 t/schema/preference.t
 t/schema/preference_time_string.t
 t/schema/registration_authentication.t
+t/schema/role.t
 t/schema/SchemaTest.pm
 t/schema/terms.t
 t/schema/terms_agreed.t
 t/schema/thread.t
 t/schema/thread_view.t
+t/schema/user_role.t
 t/view_Plain.t
 t/view_TT.t
 TODO



From chiselwright at mail.berlios.de  Wed Feb 27 10:46:16 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 27 Feb 2008 10:46:16 +0100
Subject: [Parley-svn] r815 - / trunk trunk/lib/Parley
Message-ID: <200802270946.m1R9kGEB011199@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-27 10:46:16 +0100 (Wed, 27 Feb 2008)
New Revision: 815

Modified:
   /
   trunk/Makefile.PL
   trunk/lib/Parley/Version.pm
Log:
 r4706 at wiggin:  chisel | 2008-02-27 09:44:29 +0000
 / make version 0.59_001, not 0.59.001
 / add "use lib" to Makefile.PL



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4705
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4706
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Makefile.PL
===================================================================
--- trunk/Makefile.PL	2008-02-27 09:46:00 UTC (rev 814)
+++ trunk/Makefile.PL	2008-02-27 09:46:16 UTC (rev 815)
@@ -1,5 +1,7 @@
 use inc::Module::Install;
 
+use lib qw{lib};
+
 name 'Parley';
 all_from 'lib/Parley.pm';
 

Modified: trunk/lib/Parley/Version.pm
===================================================================
--- trunk/lib/Parley/Version.pm	2008-02-27 09:46:00 UTC (rev 814)
+++ trunk/lib/Parley/Version.pm	2008-02-27 09:46:16 UTC (rev 815)
@@ -1,6 +1,6 @@
 package Parley;
 
-use version; our $VERSION = qv(0.59.001);
+use version; our $VERSION = qv(0.59_001);
 
 =head1 NAME
 



From chiselwright at mail.berlios.de  Wed Feb 27 23:54:44 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 27 Feb 2008 23:54:44 +0100
Subject: [Parley-svn] r816 - / trunk/root/static
Message-ID: <200802272254.m1RMsiD3025222@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-27 23:54:43 +0100 (Wed, 27 Feb 2008)
New Revision: 816

Added:
   trunk/root/static/Editable-min.js
   trunk/root/static/MessagePreview-min.js
Modified:
   /
Log:
 r4713 at wiggin:  chisel | 2008-02-27 22:35:37 +0000
 / used YUI Compressor on JS files



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4706
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4713
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Added: trunk/root/static/Editable-min.js
===================================================================
--- trunk/root/static/Editable-min.js	2008-02-27 09:46:16 UTC (rev 815)
+++ trunk/root/static/Editable-min.js	2008-02-27 22:54:43 UTC (rev 816)
@@ -0,0 +1 @@
+(function(){YAHOO.widget.EditableElement=function(){var Dom=YAHOO.util.Dom,YU=YAHOO.util;this.config={class_name:"editable",trigger:"click",input_type:"text",save_on_enter:true,clear_on_escape:true,linebreak:false,save_button:true,cancel_button:true,textarea_rows:6,textarea_cols:50};this.clicked=undefined;this.contents=undefined;this.input=undefined;this.init=function(){_items=Dom.getElementsByClassName(this.config.class_name);if(_items.length>0){for(i=0;i<_items.length;i++){this.elID=YU.Dom.generateId(_items[i]);YU.Event.addListener(_items[i],this.config.trigger,this.triggered,this,true);if(this.config.save_on_enter||this.config.clear_on_escape){var status=YU.Event.addListener(_items[i],"keyup",this.onKeyUp,this,true)}}}};this._max=function(x,y){if(x>y){return x}return y};this.step_up=function(el){if(el){var tmpEl=el;while(tmpEl.className!=this.config.class_name){tmpEl=tmpEl.parentNode}if(tmpEl){el=tmpEl}}return el};this.triggered=function(ev){if(!this.check()){return }thi!
 s.clicked=YU.Event.getTarget(ev);this.clicked=this.step_up(this.clicked);this.contents=this.clicked.innerHTML;this.create_input_field()};this.onKeyUp=function(p_oEvent){var keyCode=YU.Event.getCharCode(p_oEvent);switch(keyCode){case 13:if(this.config.save_on_enter){this.check(p_oEvent)}break;case 27:if(this.config.save_on_enter){this.reset_input_field()}break;default:break}};this.create_input_field=function(){this.input=YU.Dom.generateId();if(this.config.input_type=="text"){new_input=document.createElement("input");min_size=this._max(this.contents.length,this.config.min_size);with(new_input){setAttribute("type","text");setAttribute("id",this.input);value=this.contents;setAttribute("size",min_size);className="editable_input"}}else{if(this.config.input_type=="textarea"){new_input=document.createElement("textarea");with(new_input){setAttribute("id",this.input);value=this.contents;className="editable_input";setAttribute("rows",this.config.textarea_rows);setAttribute("cols",this!
 .config.textarea_cols)}}}this.clicked.innerHTML="";this.clicke!
 d.append
Child(new_input);if(this.config.linebreak){newline=document.createElement("br");this.clicked.appendChild(newline)}if(this.config.save_button){this.create_save_button()}if(this.config.cancel_button){this.create_cancel_button()}new_input.select()};this.create_save_button=function(){this.save_input=YU.Dom.generateId();new_save_input=document.createElement("input");with(new_save_input){setAttribute("type","button");setAttribute("id",this.save_input);value="Save";className="editable_input"}this.clicked.appendChild(new_save_input);YU.Event.addListener(new_save_input,"click",this.check,this,true)};this.create_cancel_button=function(){this.cancel_input=YU.Dom.generateId();new_cancel_input=document.createElement("input");with(new_cancel_input){setAttribute("type","button");setAttribute("id",this.cancel_input);value="Cancel";className="editable_input"}this.clicked.appendChild(new_cancel_input);YU.Event.addListener(new_cancel_input,"click",this.reset_input_field,this,true)};this.reset_!
 input_field=function(){this.clicked.innerHTML=this.contents;this.clicked=undefined;this.contents=undefined;this.input=undefined};this.clear_input=function(){if(this.input){var input_value=YU.Dom.get(this.input).value;if(input_value.length>0){this.clean_input();this.contents_new=input_value}else{this.contents_new="[removed]"}this.clicked.innerHTML=this.contents_new;if(this.contents_new!=this.contents){var el=this.step_up(this.clicked);this.callback(el)}}this.clicked=undefined;this.contents=undefined;this.input=undefined};this.clean_input=function(){checkText=new String(YU.Dom.get(this.input).value);regEx1=/\"/g;checkText=String(checkText.replace(regEx1,""));YU.Dom.get(this.input).value=checkText};this.check=function(ev){if(!ev){if(this.clicked==undefined){return true}return false}if(this.clicked){clicked=YU.Event.getTarget(ev);this.clear_input();return true}};this.callback=function(){alert("default callback() called")}}})();
\ No newline at end of file

Added: trunk/root/static/MessagePreview-min.js
===================================================================
--- trunk/root/static/MessagePreview-min.js	2008-02-27 09:46:16 UTC (rev 815)
+++ trunk/root/static/MessagePreview-min.js	2008-02-27 22:54:43 UTC (rev 816)
@@ -0,0 +1 @@
+(function(){ParleyMessagePreview=function(){var Dom=YAHOO.util.Dom,YU=YAHOO.util;this.config={trigger:"message_preview",user_input:"thread_message",container:"message_container",trigger_evt:"click",post_url:"post/preview",label_edit:"Edit",label_preview:"Preview"};this.message_source=false;this.message_preview=false;this.handleSuccess=function(o){var data=eval("("+o.responseText+")");var obj=o.argument.obj;if(data.formatted){obj.previewElId=YU.Dom.generateId();obj.user_input.style.visibility="hidden";var pWidth=obj.user_input.clientWidth,pHeight=obj.user_input.clientHeight,pLeft=obj.user_input.offsetLeft,pTop=obj.user_input.offsetTop;obj.preview_overlay=new YAHOO.widget.Overlay("preview_overlay",{context:[obj.config.user_input,"tl","tl"],visible:true,width:obj.user_input.clientWidth+"px",height:obj.user_input.clientHeight+"px"});obj.preview_overlay.setBody(data.formatted);obj.preview_overlay.render(document.body);Dom.get("preview_overlay").style.overflow="auto";obj.trigger.!
 value=obj.config.label_edit;YU.Event.removeListener(obj.trigger,"click");YU.Event.addListener(obj.trigger,obj.config.trigger_evt,obj.edit,obj,true)}};this.handleFailure=function(o){console.log("failure")};this.edit=function(){this.trigger.value=this.config.label_preview;this.user_input.style.visibility="visible";this.preview_overlay.destroy();YU.Event.removeListener(this.trigger,"click");YU.Event.addListener(this.trigger,this.config.trigger_evt,this.preview,this,true)};this.preview=function(){var request=YU.Connect.asyncRequest("POST",this.config.post_url,{success:this.handleSuccess,failure:this.handleFailure,argument:{obj:this}},"msg_source="+escape(this.user_input.value))};this.init=function(){this.container=Dom.get(this.config.container);this.user_input=Dom.get(this.config.user_input);this.trigger=Dom.get(this.config.trigger);YU.Event.addListener(this.trigger,this.config.trigger_evt,this.preview,this,true)}}})();
\ No newline at end of file



From chiselwright at mail.berlios.de  Wed Feb 27 23:54:52 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 27 Feb 2008 23:54:52 +0100
Subject: [Parley-svn] r817 - / trunk/root/base/my trunk/root/base/post
	trunk/root/base/site trunk/root/base/thread trunk/root/static/css
Message-ID: <200802272254.m1RMsqBW025307@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-27 23:54:51 +0100 (Wed, 27 Feb 2008)
New Revision: 817

Modified:
   /
   trunk/root/base/my/tab_you
   trunk/root/base/post/edit
   trunk/root/base/site/user
   trunk/root/base/thread/add
   trunk/root/base/thread/reply
   trunk/root/static/css/parley.css
Log:
 r4714 at wiggin:  chisel | 2008-02-27 22:51:41 +0000
 / use -min.js files
 / imorove UI for site/user



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4713
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4714
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/my/tab_you
===================================================================
--- trunk/root/base/my/tab_you	2008-02-27 22:54:43 UTC (rev 816)
+++ trunk/root/base/my/tab_you	2008-02-27 22:54:51 UTC (rev 817)
@@ -44,7 +44,7 @@
     </div>
 </div>
 
-<script type="text/javascript" src="[%c.request.base%]/static/Editable.js"></script>
+<script type="text/javascript" src="[%c.request.base%]/static/Editable-min.js"></script>
 <script type="text/javascript">
     var E  = new YAHOO.widget.EditableElement;
 

Modified: trunk/root/base/post/edit
===================================================================
--- trunk/root/base/post/edit	2008-02-27 22:54:43 UTC (rev 816)
+++ trunk/root/base/post/edit	2008-02-27 22:54:51 UTC (rev 817)
@@ -56,7 +56,7 @@
 </form>
 
 <!-- message preview majick -->
-<script type="text/javascript" src="[%c.uri_for('/static/MessagePreview.js')%]"></script>
+<script type="text/javascript" src="[%c.uri_for('/static/MessagePreview-min.js')%]"></script>
 <script type="text/javascript">
     var MessagePreview = new ParleyMessagePreview();
 

Modified: trunk/root/base/site/user
===================================================================
--- trunk/root/base/site/user	2008-02-27 22:54:43 UTC (rev 816)
+++ trunk/root/base/site/user	2008-02-27 22:54:51 UTC (rev 817)
@@ -2,22 +2,55 @@
 
 <h2>[% person.forum_name %] ([%person.first_name%] [%person.last_name%])</h2>
 
-<table class="forum_list">
-    <tbody>
+<form>
+    <table class="user_permission_list">
+        <tbody>
 
-        [% WHILE (role = roles.next) %]
-        [% toggler = (1 - (toggler||0)) %]
-        <tr class="row [% row_styles.$toggler %]">
-            <td>
-                [% role.description %]
-            </td>
-            <td>
-                [% person.check_user_roles(role.name) %]
-            </td>
-        </tr>
-        [% END %]
+            [% WHILE (role = roles.next) %]
+            [% toggler = (1 - (toggler||0)) %]
+            <tr class="row [% row_styles.$toggler %]">
+                <td width="25%">
+                    <label for="userrole_[%role.id%]">
+                        [% role.description %]
+                    </label>
+                </td>
+                <td>
+                    [% has_role = person.check_user_roles(role.name) %]
+                    <input type="checkbox" class="role_checkbox" id="userrole_[%role.id%]" [%IF has_role%]checked="checked"[%END%]/>
 
-    </tbody>
-</table>
+                    <span id="status_[%role.id%]"></span>
+                </td>
+            </tr>
+            [% END %]
 
-<hr />
+        </tbody>
+    </table>
+</form>
+
+<script type="text/javascript">
+    var YU  = YAHOO.util,
+        Dom = YAHOO.util.Dom;
+
+    var items = Dom.getElementsByClassName('role_checkbox');
+    console.log(items);
+
+
+    var boink = function() {
+        var elID = this.id,
+            checked = this.checked;
+        var roleID = elID.split('_')[1];
+        var statusDiv = Dom.get('status_' + roleID);
+
+        statusDiv.innerHTML = '<blink>updating...</blink>';
+        statusDiv.innerHTML = '<img src="/static/images/loader-bar.gif" />';
+
+        console.log('roleID:  ', roleID);
+        console.log('checked: ', checked);
+    }
+
+    YU.Event.addListener(
+        items,
+        'change',
+        boink
+    );
+</script>

Modified: trunk/root/base/thread/add
===================================================================
--- trunk/root/base/thread/add	2008-02-27 22:54:43 UTC (rev 816)
+++ trunk/root/base/thread/add	2008-02-27 22:54:51 UTC (rev 817)
@@ -58,7 +58,7 @@
 </style>
 
 <!-- message preview majick -->
-<script type="text/javascript" src="[%c.uri_for('/static/MessagePreview.js')%]"></script>
+<script type="text/javascript" src="[%c.uri_for('/static/MessagePreview-min.js')%]"></script>
 <script type="text/javascript">
     var MessagePreview = new ParleyMessagePreview();
 

Modified: trunk/root/base/thread/reply
===================================================================
--- trunk/root/base/thread/reply	2008-02-27 22:54:43 UTC (rev 816)
+++ trunk/root/base/thread/reply	2008-02-27 22:54:51 UTC (rev 817)
@@ -139,7 +139,7 @@
 </style>
 
 <!-- message preview majick -->
-<script type="text/javascript" src="[%c.uri_for('/static/MessagePreview.js')%]"></script>
+<script type="text/javascript" src="[%c.uri_for('/static/MessagePreview-min.js')%]"></script>
 <script type="text/javascript">
     var MessagePreview = new ParleyMessagePreview();
 

Modified: trunk/root/static/css/parley.css
===================================================================
--- trunk/root/static/css/parley.css	2008-02-27 22:54:43 UTC (rev 816)
+++ trunk/root/static/css/parley.css	2008-02-27 22:54:51 UTC (rev 817)
@@ -485,6 +485,27 @@
     margin-bottom:      5px;
 }
 
+.user_permission_list  {
+    margin-left:        auto;
+    margin-right:       auto;
+    margin-top:         15px;
+    font-size:          93%;
+    width:              100%;
+}
+.user_permission_list td {
+    vertical-align:     top;
+    border:             1px dashed #ddd;
+    border:             none;
+    line-height:        150%;
+    padding-left:       10px;
+    padding-right:      10px;
+    padding-top:        5px;
+    padding-bottom:     5px;
+}
+.user_permission_list img {
+    vertical-align: middle;
+}
+
 .user_post_info {
     background:         #ccc;
     background:         transparent;



From chiselwright at mail.berlios.de  Wed Feb 27 23:55:04 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Wed, 27 Feb 2008 23:55:04 +0100
Subject: [Parley-svn] r818 - / trunk/root/base trunk/root/static/css
Message-ID: <200802272255.m1RMt424025382@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-27 23:55:04 +0100 (Wed, 27 Feb 2008)
New Revision: 818

Added:
   trunk/root/static/css/parley-min.css
Modified:
   /
   trunk/root/base/header
Log:
 r4715 at wiggin:  chisel | 2008-02-27 22:54:36 +0000
 / switch to a compressed version of parley.css



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4714
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4715
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/root/base/header
===================================================================
--- trunk/root/base/header	2008-02-27 22:54:51 UTC (rev 817)
+++ trunk/root/base/header	2008-02-27 22:55:04 UTC (rev 818)
@@ -52,7 +52,7 @@
 
 
         <!-- defined styles for parley -->
-        <link type="text/css" rel="stylesheet" title="Simple" href="[%c.uri_for('/static/css/parley.css')%]" />
+        <link type="text/css" rel="stylesheet" title="Simple" href="[%c.uri_for('/static/css/parley-min.css')%]" />
     </head>
 
     <body class="yui-skin-sam">

Added: trunk/root/static/css/parley-min.css
===================================================================
--- trunk/root/static/css/parley-min.css	2008-02-27 22:54:51 UTC (rev 817)
+++ trunk/root/static/css/parley-min.css	2008-02-27 22:55:04 UTC (rev 818)
@@ -0,0 +1 @@
+#hd{height:80px;line-height:80px;margin:0;padding-left:10px;background:#EEE url('/static/images/parley_logo.jpg') no-repeat left;color:#79B30B;}#hd h1{font-size:200%;text-align:left;}div#ft{background:#666;color:#FFF;font-size:77%;margin-top:20px;}div#ft p{border:none;margin-top:30px;padding:5px 10px 5px 10px;text-align:right;display:block;}div#ft a{color:#ccc;}div#user_information{line-height:1em;font-size:85%;color:#000;background-color:transparent;position:absolute;top:0;right:10px;height:70px;width:200px;padding-top:3px;text-align:center;}div#user_information .user_info_actions{margin-top:3px;}.caretfix{overflow:auto;}#bd h1{font-weight:bold;background:#666;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h2{font-weight:bold;background:#999;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h3{font-weight:bold;background:#eee;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;color:#79B30B;}a.nav:hover{background:#000;color:#fff!
 ;}a,a:link,a:visited,a:active{background:transparent;color:blue;text-decoration:none;}th{font-size:100%;text-align:left;font-weight:bold;}#login_dialog form{margin:0;padding:0;min-width:400px;max-width:600px;}#login_dialog form fieldset{/ * clear:both;note that this clear causes inputs to break to left in ie5.x mac,commented out */ padding:10px;margin:0;border:none;}#login_dialog form label{display:block;float:left;width:150px;padding:0;margin:5px 0 0;text-align:right;font-weight:bold;margin-bottom:0;}#login_dialog form input,form textarea{width:auto;margin:5px 0 0 10px;}#login_dialog form p{font-size:85%;}.row{border-top:1px dotted #666;border-bottom:1px dotted #666;}.row_odd{background:#eee;}.row_even{background:#ddd;}.admin_edited_post{color:#000;background:#ccc;padding:2px;padding-left:10px;padding-right:10px;border:1px dashed #000;margin-left:15px;font-size:93%;text-align:right;}.align_right{text-align:right;}.forum_description{font-size:93%;}.forum_lastpost{font-size:!
 85%;text-align:right;}.forum_lastpost_subject a{color:#333;col!
 or:#79B3
0B;}.forum_link{font-size:100%;font-weight:bold;}.forum_list{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_list td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.forum_mini_pager{font-size:85%;}.forum_mini_pager a{color:#666;}.forum_name{font-size:100%;text-align:left;font-weight:bold;margin-top:5px;}.forum_name a{color:#333;color:#79B30B;}.forum_postcount{font-size:85%;text-align:right;margin-top:5px;}.forum_view{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_view td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.help li{margin-top:25px;margin-right:25px;list-style-type:none;border-left:2px solid #666;padding-top:5px;padding-bottom:5px;padding-left:10px;background-color:#ddd;}.help li ul li,.help li ol li{margin-top:5px;margin-left:10px;list-style-type:disc;border-left:none;pa!
 dding-left:none;padding-top:none;padding-bottom:none;background-color:transparent;}.innerpost{margin-left:10px;padding:5px;overflow:auto;font-size:93%;}.moderator_list{font-size:77%;margin-bottom:5px;margin-top:5px;text-align:right;}.pager_advanced{font-size:77%;margin-bottom:5px;margin-top:5px;}.post{padding-top:5px;vertical-align:top;border-left:1px solid #ddd;}.post_created{text-align:right;font-size:85%;}.post_creator{font-weight:bold;font-style:italic;font-size:85%;}.post_edited_alert{font-weight:bold;font-style:italic;}.post_info{font-size:77%;line-height:1.1em;margin-top:10px;margin-bottom:2px;text-align:right;}.post_subject{font-weight:bold;}.quote{background-color:#F9FBFF;border:1px solid #333;font-size:85%;margin:0 0 2px 4px;padding:6px;width:85%;overflow:hidden;}.recently_updated{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.recently_updated td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px!
 ;padding-right:10px;}.reply_post_message{border:1px dashed #66!
 6;}.sear
ch_match_context{font-size:85%;}.search_results{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.search_results td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;}.site_terms{width:80%;margin-left:auto;margin-right:auto;margin-bottom:10px;padding:5px;border:1px solid #666;}.thread_add{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_add td{padding-top:4px;padding-bottom:4px;}.thread_add .input_text{width:450px;margin-left:10px;}.thread_add_topic{text-align:right;padding-right:5px;}.thread_add_message{text-align:right;vertical-align:top;padding-right:5px;}.thread_header{font-weight:bold;background:#666;padding:4px;text-align:left;}.thread_header a{color:#ccc;}.thread_info{margin:0;width:100%;border:none;padding:0;margin-bottom:10px;}.thread_info td{border:none;padding:0;}.thread_lastpost{font-size:85%;text-align:right!
 ;}.thread_post_row{border-top:1px solid #ddd;border-bottom:1px solid #ddd;}.thread_post_row td{margin-top:10px;margin-bottom:10px;}.thread_posts{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_recent_forum{float:right;font-size:85%;}.thread_recent_forum a{color:#333;}.thread_reply{font-size:93%;}.thread_reply tr{vertical-align:top;}.thread_reply td{padding-top:10px;padding-left:10px;}.thread_reply textarea{background-color:transparent;border:2px inset black;}.thread_subject a{font-size:93%;color:#333;color:#79B30B;}.thread_watch{margin-top:5px;font-size:77%;text-align:left;}.top_padded{margin-top:10px;}.topic_creator{display:block;font-size:85%;text-align:right;}.user_login form{width:350px;margin-left:auto;margin-right:auto;margin-top:20px;}.user_login p{margin-top:5px;margin-bottom:5px;}.user_permission_list{margin-left:auto;margin-right:auto;margin-top:15px;font-size:93%;width:100%;}.user_permission_list td{vertical-align:top;border:1!
 px dashed #ddd;border:none;line-height:150%;padding-left:10px;!
 padding-
right:10px;padding-top:5px;padding-bottom:5px;}.user_permission_list img{vertical-align:middle;}.user_post_info{background:#ccc;background:transparent;font-size:77%;margin-left:auto;margin-right:auto;text-align:center;vertical-align:top;width:110px;}a[href $='.jpg']{padding-left:20px;background:transparent url(/static/images/filetypes/image.png) no-repeat center left;}a[href $='.pdf']{padding-left:20px;background:transparent url(/static/images/filetypes/pdf.png) no-repeat center left;}#loader_wait.yui-overlay{position:fixed;float:right;top:10px;right:10px;border:none;text-align:right;}#preview_overlay{border:1px dashed #ccc;text-align:left;padding:0;}#thread_message{font-family:monospace;text-align:left;padding:0;background-color:#eee;font-size:93%;width:450px;}#ysearch{text-align:center;}#ysearchinput{position:static;width:20em;}#ysearchcontainer{text-align:left;width:20em;}.forumcode_code{font-family:monospace;border:1px solid #333;font-size:85%;margin:15px 20px 15px 20px;!
 padding:6px;width:85%;overflow:auto;color:#ff0;background-color:#333;border:1px solid #666;white-space:pre;}.forumcode_pre{background-color:transparent;font-family:monospace;border:1px dashed #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;white-space:pre;}.forumcode_quote{background-color:#eee;font-family:monospace;font-style:italic;border:1px dotted #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;}.forumcode_quoting{font-weight:bold;margin-bottom:3px;}.yuimenuitem .disabled{color:#A6A6A6;cursor:default;}.yui-skin-sam .yui-navset .yui-nav,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav{border:solid #333;border-width:0 0 5px;Xposition:relative;zoom:1;}.yui-skin-sam .yui-navset .yui-content{background:transparent;}.yui-skin-sam .yui-navset .yui-nav a,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav a{background-image:none;background-color:#999;border:solid #a3a3a3;border-width:0 1px;color:#fff;text-deco!
 ration:none;}.yui-skin-sam .yui-navset .yui-nav .selected a,.y!
 ui-skin-
sam .yui-navset .yui-nav .selected a:focus,.yui-skin-sam .yui-navset .yui-nav .selected a:hover{background:#333;color:#fff;}.yui-skin-sam .yui-navset .yui-nav a:hover,.yui-skin-sam .yui-navset .yui-nav a:focus{background:#666;color:#fff;outline:0;}
\ No newline at end of file



From chiselwright at mail.berlios.de  Thu Feb 28 23:31:44 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 28 Feb 2008 23:31:44 +0100
Subject: [Parley-svn] r819 - / trunk
Message-ID: <200802282231.m1SMViN0030242@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-28 23:31:43 +0100 (Thu, 28 Feb 2008)
New Revision: 819

Modified:
   /
   trunk/TODO
Log:
 r4719 at wiggin:  chisel | 2008-02-28 20:33:06 +0000
 + i18n reminder



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4715
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4719
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-02-27 22:55:04 UTC (rev 818)
+++ trunk/TODO	2008-02-28 22:31:43 UTC (rev 819)
@@ -1,5 +1,6 @@
 TODO LIST
 
+  - get latest i18n from DJ
   - "Cancel" from post/edit
   - "Cancel" from thread/reply
   - fix <ul>/<ol> CSS



From chiselwright at mail.berlios.de  Thu Feb 28 23:31:57 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 28 Feb 2008 23:31:57 +0100
Subject: [Parley-svn] r820 - / trunk/lib/Parley/Controller
	trunk/root/base/site trunk/root/static/images
Message-ID: <200802282231.m1SMVvki030317@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-28 23:31:57 +0100 (Thu, 28 Feb 2008)
New Revision: 820

Added:
   trunk/root/static/images/loader-bar.gif
Modified:
   /
   trunk/lib/Parley/Controller/My.pm
   trunk/lib/Parley/Controller/Site.pm
   trunk/root/base/site/user
Log:
 r4720 at wiggin:  chisel | 2008-02-28 20:38:28 +0000
 / objToJson() --> to_json() 
 + added server support for AJAX user role changes
 / update JS an UI to make AJAX user role updates
 + added feedback icon for AJAX updates



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4719
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4720
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/lib/Parley/Controller/My.pm
===================================================================
--- trunk/lib/Parley/Controller/My.pm	2008-02-28 22:31:43 UTC (rev 819)
+++ trunk/lib/Parley/Controller/My.pm	2008-02-28 22:31:57 UTC (rev 820)
@@ -480,7 +480,7 @@
                     . q{.</p>}
                 ;
                 $return_data->{updated} = 0;
-                $json = objToJson($return_data);
+                $json = to_json($return_data);
                 $c->response->body( $json );
                 $c->log->info( $json );
                 return;

Modified: trunk/lib/Parley/Controller/Site.pm
===================================================================
--- trunk/lib/Parley/Controller/Site.pm	2008-02-28 22:31:43 UTC (rev 819)
+++ trunk/lib/Parley/Controller/Site.pm	2008-02-28 22:31:57 UTC (rev 820)
@@ -107,6 +107,98 @@
     return;
 }
 
+sub roleSaveHandler :Local {
+    my ($self, $c) = @_;
+    my ($return_data, $json);
+    my ($person_id, $role_id, $value);
+
+    $person_id  = $c->request->param('person');
+    $role_id    = $c->request->param('role');
+    $value      = $c->request->param('value');
+
+    # default to responding with "nothing changed"
+    $return_data->{updated} = 0;
+
+    # check incoming values
+    if (not defined $person_id or $person_id !~ m{\A\d+\z}) {
+        $return_data->{error}{message} = 'Invalid user-id';
+    }
+    elsif (not defined $role_id or $role_id !~ m{\A\d+\z}) {
+        $return_data->{error}{message} = 'Invalid role-id';
+    }
+    elsif (not defined $value or $value !~ m{\A[01]}) {
+        $return_data->{error}{message} = 'Invalid requested value';
+    }
+
+    # remove the role?
+    elsif (0 == $value) {
+        # try to remove the join table entry
+        eval {
+            $c->model('ParleyDB')->schema->txn_do(
+                sub {
+                    $c->model('ParleyDB::UserRole')->search(
+                        {
+                            person_id   => $person_id,
+                            role_id     => $role_id,
+                        }
+                    )
+                    ->delete;
+                }
+            );
+            $return_data->{updated} = 1;
+        };
+        # deal with any transaction errors
+        if ($@) {                                   # Transaction failed
+            die "something terrible has happened!"  #
+                if ($@ =~ /Rollback failed/);       # Rollback failed
+
+            $return_data->{error}{message} =
+                qq{Database transaction failed: $@};
+            $c->log->error( $@ );
+            return;
+        }
+    }
+
+    # add the role?
+    elsif (1 == $value) {
+        # try to remove the join table entry
+        eval {
+            $c->model('ParleyDB')->schema->txn_do(
+                sub {
+                    $c->model('ParleyDB::UserRole')->update_or_create(
+                        {
+                            person_id   => $person_id,
+                            role_id     => $role_id,
+                        }
+                    )
+                }
+            );
+            $return_data->{updated} = 1;
+        };
+        # deal with any transaction errors
+        if ($@) {                                   # Transaction failed
+            die "something terrible has happened!"  #
+                if ($@ =~ /Rollback failed/);       # Rollback failed
+
+            $return_data->{error}{message} =
+                qq{Database transaction failed: $@};
+            $c->log->error( $@ );
+            return;
+        }
+    }
+
+    # else ... um, how did we end up here?
+    else {
+        $return_data->{error}{message} = q{We're not in Kansas any more};
+    }
+
+    # return some JSON
+    $json = to_json($return_data);
+    $c->response->body( $json );
+    $c->log->info( $json );
+    return;
+}
+
 =head1 NAME
 
 Parley::Controller::Site - Catalyst Controller

Modified: trunk/root/base/site/user
===================================================================
--- trunk/root/base/site/user	2008-02-28 22:31:43 UTC (rev 819)
+++ trunk/root/base/site/user	2008-02-28 22:31:57 UTC (rev 820)
@@ -17,7 +17,6 @@
                 <td>
                     [% has_role = person.check_user_roles(role.name) %]
                     <input type="checkbox" class="role_checkbox" id="userrole_[%role.id%]" [%IF has_role%]checked="checked"[%END%]/>
-
                     <span id="status_[%role.id%]"></span>
                 </td>
             </tr>
@@ -27,30 +26,81 @@
     </table>
 </form>
 
+<div class="top_padded">
+<a href="[%c.uri_for('/site/users/')%]">Back to User Management</a>
+</div>
+
 <script type="text/javascript">
     var YU  = YAHOO.util,
         Dom = YAHOO.util.Dom;
 
     var items = Dom.getElementsByClassName('role_checkbox');
-    console.log(items);
 
-
-    var boink = function() {
+    update_role = function() {
         var elID = this.id,
-            checked = this.checked;
+            checked = (this.checked ? 1 : 0);
         var roleID = elID.split('_')[1];
         var statusDiv = Dom.get('status_' + roleID);
 
-        statusDiv.innerHTML = '<blink>updating...</blink>';
-        statusDiv.innerHTML = '<img src="/static/images/loader-bar.gif" />';
+        var handleSuccess = function(o) {
+            var data = eval('(' + o.responseText + ')');
+            // show the status message
+            //o.argument.msg_node.innerHTML = data.message;
+            // clear the loader-gif
+            o.argument.msg_node.innerHTML = '';
 
-        console.log('roleID:  ', roleID);
-        console.log('checked: ', checked);
-    }
+            // show any returned errors
+            if (data.error) {
+                if (data.error.message!=undefined) {
+                    o.argument.msg_node.innerHTML = data.error.message;
+                }
 
+                // reset the checkbox
+                Dom.get(o.argument.cb_node).checked =
+                    (1 - o.argument.value);
+            }
+        };
+        var handleFailure = function(o) {
+            // show the status message
+            o.argument.msg_node.innerHTML = o.responseText;
+
+            // reset the checkbox
+            Dom.get(o.argument.cb_node).checked =
+                (1 - o.argument.value);
+        };
+
+        // where to post to
+        var sUrl = '[%c.uri_for('/site/roleSaveHandler')%]';
+
+        // postdata is a query string ... how irksome!!
+        var postData =
+               'person='    + [%person.id%]
+            +  '&role='     + roleID
+            +  '&value='    + checked
+        ;
+
+        // some visual feedback that something is happening
+        statusDiv.innerHTML = '<img src="[%c.uri_for('/static/images/loader-bar.gif')%]" />';
+
+        var request = YAHOO.util.Connect.asyncRequest(
+            'POST',
+            sUrl,
+            {
+                success:  handleSuccess,
+                failure:  handleFailure,
+                argument: {
+                    msg_node: statusDiv,
+                    cb_node:  elID,
+                    value:    checked
+                }
+            },
+            postData
+        );
+    };
+
     YU.Event.addListener(
         items,
         'change',
-        boink
+        update_role
     );
 </script>

Added: trunk/root/static/images/loader-bar.gif
===================================================================
(Binary files differ)


Property changes on: trunk/root/static/images/loader-bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From chiselwright at mail.berlios.de  Thu Feb 28 23:32:08 2008
From: chiselwright at mail.berlios.de (chiselwright at BerliOS)
Date: Thu, 28 Feb 2008 23:32:08 +0100
Subject: [Parley-svn] r821 - / trunk trunk/lib/Parley/Controller
	trunk/lib/Parley/I18N trunk/root/base/site
Message-ID: <200802282232.m1SMW8r9030390@sheep.berlios.de>

Author: chiselwright
Date: 2008-02-28 23:32:08 +0100 (Thu, 28 Feb 2008)
New Revision: 821

Modified:
   /
   trunk/Changes.i18n
   trunk/lib/Parley/Controller/Site.pm
   trunk/lib/Parley/I18N/i_default.po
   trunk/root/base/site/user
Log:
 r4721 at wiggin:  chisel | 2008-02-28 22:31:30 +0000
 / i18n-ise recent additions (.it translations missing)



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4720
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4721
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Changes.i18n
===================================================================
--- trunk/Changes.i18n	2008-02-28 22:31:57 UTC (rev 820)
+++ trunk/Changes.i18n	2008-02-28 22:32:08 UTC (rev 821)
@@ -15,6 +15,10 @@
             - "Post Edited By"
             - "Manage"
             - "Users"
+            - "User Roles"
+            - "We're not in Kansas any more"
+            - "Invalid %1"
+            - "Invalid requested value"
 
     it.po:
         - added:

Modified: trunk/lib/Parley/Controller/Site.pm
===================================================================
--- trunk/lib/Parley/Controller/Site.pm	2008-02-28 22:31:57 UTC (rev 820)
+++ trunk/lib/Parley/Controller/Site.pm	2008-02-28 22:32:08 UTC (rev 821)
@@ -121,13 +121,16 @@
 
     # check incoming values
     if (not defined $person_id or $person_id !~ m{\A\d+\z}) {
-        $return_data->{error}{message} = 'Invalid user-id';
+        $return_data->{error}{message} =
+            $c->localize('Invalid %1', 'user-id');
     }
     elsif (not defined $role_id or $role_id !~ m{\A\d+\z}) {
-        $return_data->{error}{message} = 'Invalid role-id';
+        $return_data->{error}{message} =
+            $c->localize('Invalid %1', 'role-id');
     }
     elsif (not defined $value or $value !~ m{\A[01]}) {
-        $return_data->{error}{message} = 'Invalid requested value';
+        $return_data->{error}{message} =
+            $c->localize('Invalid requested value');
     }
 
     # remove the role?
@@ -189,7 +192,8 @@
 
     # else ... um, how did we end up here?
     else {
-        $return_data->{error}{message} = q{We're not in Kansas any more};
+        $return_data->{error}{message} =
+            $c->localize(q{We're not in Kansas any more});
     }
 
     # return some JSON

Modified: trunk/lib/Parley/I18N/i_default.po
===================================================================
--- trunk/lib/Parley/I18N/i_default.po	2008-02-28 22:31:57 UTC (rev 820)
+++ trunk/lib/Parley/I18N/i_default.po	2008-02-28 22:32:08 UTC (rev 821)
@@ -239,6 +239,13 @@
 msgid "Incomplete URL"
 msgstr "Incomplete URL"
 
+# e.g. Invalid user-id
+msgid "Invalid %1"
+msgstr "Invalid %1"
+
+msgid "Invalid requested value"
+msgstr "Invalid requested value"
+
 msgid "IP Logged"
 msgstr "IP Logged"
 
@@ -734,6 +741,9 @@
 msgid "Users"
 msgstr "Users"
 
+msgid "User Roles"
+msgstr "User Roles"
+
 msgid "View"
 msgstr "View"
 
@@ -755,6 +765,12 @@
 msgid "watching this thread"
 msgstr "watching this thread"
 
+msgid "We're not in Kansas any more"
+msgstr "We're not in Kansas any more"
+
+msgid "Users"
+msgstr "Users"
+
 msgid "wrote"
 msgstr "wrote"
 

Modified: trunk/root/base/site/user
===================================================================
--- trunk/root/base/site/user	2008-02-28 22:31:57 UTC (rev 820)
+++ trunk/root/base/site/user	2008-02-28 22:32:08 UTC (rev 821)
@@ -1,4 +1,4 @@
-<h1>User Stuff</h1>
+<h1>[%l('User Roles')%]</h1>
 
 <h2>[% person.forum_name %] ([%person.first_name%] [%person.last_name%])</h2>
 



