<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Parley-svn] r850 - / trunk trunk/db trunk/lib	trunk/lib/Parley/Controller trunk/lib/Parley/Schema	trunk/root/base/menu trunk/root/base/site	trunk/root/base/user trunk/root/static/css	trunk/root/static/images/icons trunk/root/static/script
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/parley-svn/2008-March/index.html" >
   <LINK REL="made" HREF="mailto:parley-svn%40lists.berlios.de?Subject=Re%3A%20%5BParley-svn%5D%20r850%20-%20/%20trunk%20trunk/db%20trunk/lib%0A%09trunk/lib/Parley/Controller%20trunk/lib/Parley/Schema%0A%09trunk/root/base/menu%20trunk/root/base/site%0A%09trunk/root/base/user%20trunk/root/static/css%0A%09trunk/root/static/images/icons%20trunk/root/static/script&In-Reply-To=%3C200803202019.m2KKJJsq013878%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000737.html">
   <LINK REL="Next"  HREF="000739.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Parley-svn] r850 - / trunk trunk/db trunk/lib	trunk/lib/Parley/Controller trunk/lib/Parley/Schema	trunk/root/base/menu trunk/root/base/site	trunk/root/base/user trunk/root/static/css	trunk/root/static/images/icons trunk/root/static/script</H1>
    <B>chiselwright at BerliOS</B> 
    <A HREF="mailto:parley-svn%40lists.berlios.de?Subject=Re%3A%20%5BParley-svn%5D%20r850%20-%20/%20trunk%20trunk/db%20trunk/lib%0A%09trunk/lib/Parley/Controller%20trunk/lib/Parley/Schema%0A%09trunk/root/base/menu%20trunk/root/base/site%0A%09trunk/root/base/user%20trunk/root/static/css%0A%09trunk/root/static/images/icons%20trunk/root/static/script&In-Reply-To=%3C200803202019.m2KKJJsq013878%40sheep.berlios.de%3E"
       TITLE="[Parley-svn] r850 - / trunk trunk/db trunk/lib	trunk/lib/Parley/Controller trunk/lib/Parley/Schema	trunk/root/base/menu trunk/root/base/site	trunk/root/base/user trunk/root/static/css	trunk/root/static/images/icons trunk/root/static/script">chiselwright at mail.berlios.de
       </A><BR>
    <I>Thu Mar 20 21:19:19 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000737.html">[Parley-svn] r849 - / trunk/lib/Parley/Schema trunk/root/base	trunk/root/base/shared trunk/root/base/user trunk/root/static/css
</A></li>
        <LI>Next message: <A HREF="000739.html">[Parley-svn] r851 - / trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#738">[ date ]</a>
              <a href="thread.html#738">[ thread ]</a>
              <a href="subject.html#738">[ subject ]</a>
              <a href="author.html#738">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: chiselwright
Date: 2008-03-20 21:19:17 +0100 (Thu, 20 Mar 2008)
New Revision: 850

Added:
   trunk/root/static/images/icons/page_edit.png
   trunk/root/static/script/user_forum_moderate.js
Modified:
   /
   trunk/Makefile.PL
   trunk/db/patch_0.58_to_0.59.psql
   trunk/lib/Parley.pm
   trunk/lib/Parley/Controller/Root.pm
   trunk/lib/Parley/Controller/Site.pm
   trunk/lib/Parley/Schema/ForumModerator.pm
   trunk/lib/Parley/Schema/Person.pm
   trunk/root/base/menu/menubar
   trunk/root/base/site/ip_bans
   trunk/root/base/user/profile
   trunk/root/static/css/parley-min.css
   trunk/root/static/css/parley.css
Log:
 <A HREF="https://lists.berlios.de/mailman/listinfo/parley-svn">r4781 at wiggin</A>:  chisel | 2008-03-20 20:13:05 +0000
 + added ACL plugin to Makefile.PL
 + add PK to forum_moderator table (keeps DBIC update_or_create() happy
 / removed hand-made access control (for /site)
 + restrict access to /site urls with ACL plugin
 + add functionality to add/remove forum mods
 + add ACL/role functions to Person class
 / alter ip_bans template so you can only edit items you have permisison for



Property changes on: 
___________________________________________________________________
Name: svk:merge
   - 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4778
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222
   + 6a361f96-f029-0410-94f8-848cdd0f6ccf:/local/parley:4781
6fba2e3f-c318-0410-85fa-910d1bc53201:/local/parley:5151
c0683b51-46fc-0310-adae-a083e7ee0929:/local/berlios/parley:15762
f1659af6-751b-0410-a472-c93ec2bf8afc:/local/parley:1222

Modified: trunk/Makefile.PL
===================================================================
--- trunk/Makefile.PL	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/Makefile.PL	2008-03-20 20:19:17 UTC (rev 850)
@@ -11,6 +11,7 @@
 requires 'Catalyst::Plugin::Authentication';
 requires 'Catalyst::Plugin::Authentication::Credential::Password';
 requires 'Catalyst::Plugin::Authentication::Store::DBIC';
+requires 'Catalyst::Plugin::Authorization::ACL';
 requires 'Catalyst::Plugin::ConfigLoader';
 requires 'Catalyst::Plugin::Dumper';
 requires 'Catalyst::Plugin::Email';

Modified: trunk/db/patch_0.58_to_0.59.psql
===================================================================
--- trunk/db/patch_0.58_to_0.59.psql	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/db/patch_0.58_to_0.59.psql	2008-03-20 20:19:17 UTC (rev 850)
@@ -8,6 +8,7 @@
 --  allow user accounts to be suspended
 --  logging of admin actions on users (e.g. why suspended)
 --  table support for various per-ip bans
+--  add PK to forum_moderator table
 
 BEGIN;
 
@@ -127,6 +128,8 @@
     UNIQUE(ban_type_id)
 );
 
+ALTER TABLE forum_moderator
+    ADD COLUMN id SERIAL primary key;
 
 -- patch ends here --
 

Modified: trunk/lib/Parley/Controller/Root.pm
===================================================================
--- trunk/lib/Parley/Controller/Root.pm	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/lib/Parley/Controller/Root.pm	2008-03-20 20:19:17 UTC (rev 850)
@@ -276,6 +276,10 @@
     $c-&gt;response-&gt;body( $c-&gt;localize('404 Not Found') );
 }
 
+sub access_denied :Local {
+    my ($self, $c) = @_;
+    parley_die($c,&quot;Unauthorized!&quot;);
+}
 
 # deal with the end of the phase
 sub render : ActionClass('RenderView') {

Modified: trunk/lib/Parley/Controller/Site.pm
===================================================================
--- trunk/lib/Parley/Controller/Site.pm	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/lib/Parley/Controller/Site.pm	2008-03-20 20:19:17 UTC (rev 850)
@@ -12,29 +12,8 @@
 
 use Parley::App::Error qw( :methods );
 
-sub auto : Private {
-    my ($self, $c) = @_;
+# there are ACL rules in Parley.pm #
 
-    if (not $c-&gt;stash-&gt;{site_moderator}) {
-        parley_warn($c, $c-&gt;localize(q{SITE MODERATOR REQUIRED}));
-
-        $c-&gt;response-&gt;redirect(
-            $c-&gt;uri_for(
-                $c-&gt;config-&gt;{default_uri}
-            )
-        );
-        return 0;
-    }
-
-    return 1;
-}
-
-sub index : Private {
-    my ( $self, $c ) = @_;
-
-    $c-&gt;response-&gt;body('Matched Parley::Controller::Site in Site.');
-}
-
 sub ip_bans :Local {
     my ($self, $c) = @_;
 
@@ -227,6 +206,55 @@
     return;
 }
 
+sub fmodSaveHandler :Local {
+    my ($self, $c) = @_;
+    my ($fieldname, $return_data, $json);
+    my ($value, $person_id, $forum_id);
+
+    $return_data-&gt;{updated}     = 0;
+
+    eval {
+        $value      = $c-&gt;request-&gt;param('value');
+        $person_id  = $c-&gt;request-&gt;param('person');
+        $forum_id   = $c-&gt;request-&gt;param('forum');
+
+        $c-&gt;model('ParleyDB')-&gt;schema-&gt;txn_do(
+            sub {
+                $c-&gt;model('ParleyDB::ForumModerator')-&gt;update_or_create(
+                    {
+                        person_id       =&gt; $person_id,
+                        forum_id        =&gt; $forum_id,
+                        can_moderate    =&gt; $value,
+                    },
+                    {
+                        key =&gt; 'forum_moderator_person_key',
+                    }
+                );
+                $return_data-&gt;{updated} = 1;
+            }
+        )
+    };
+    # deal with any transaction errors
+    if ($@) {                                   # Transaction failed
+        die &quot;something terrible has happened!&quot;  #
+            if ($@ =~ /Rollback failed/);       # Rollback failed
+
+        $return_data-&gt;{error}{message} =
+            qq{Database transaction failed: $@};
+        $c-&gt;log-&gt;error( $@ );
+        $json = to_json($return_data);
+        $c-&gt;response-&gt;body( $json );
+        return;
+    }
+
+    # return some JSON
+    $json = to_json($return_data);
+    $c-&gt;response-&gt;body( $json );
+    $c-&gt;log-&gt;info( $json );
+    return;
+}
+
+
 sub saveBanHandler :Local {
     my ($self, $c) = @_;
     my ($fieldname, $return_data, $json);

Modified: trunk/lib/Parley/Schema/ForumModerator.pm
===================================================================
--- trunk/lib/Parley/Schema/ForumModerator.pm	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/lib/Parley/Schema/ForumModerator.pm	2008-03-20 20:19:17 UTC (rev 850)
@@ -9,6 +9,8 @@
 __PACKAGE__-&gt;load_components('PK::Auto', 'Core');
 __PACKAGE__-&gt;table('forum_moderator');
 __PACKAGE__-&gt;add_columns(
+    id =&gt; {},
+
     person_id =&gt; {
         data_type       =&gt; &quot;integer&quot;,
         default_value   =&gt; undef,
@@ -31,6 +33,8 @@
     },
 );
 
+__PACKAGE__-&gt;set_primary_key(qw/id/);
+
 __PACKAGE__-&gt;add_unique_constraint(
     'forum_moderator_person_key',
     ['person_id', 'forum_id']

Modified: trunk/lib/Parley/Schema/Person.pm
===================================================================
--- trunk/lib/Parley/Schema/Person.pm	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/lib/Parley/Schema/Person.pm	2008-03-20 20:19:17 UTC (rev 850)
@@ -170,6 +170,34 @@
     return ($rs-&gt;count == scalar(@roles) || 0);
 }
 
+sub check_any_user_role {
+    my $record = shift;
+    my @roles  = @_;
+
+    return
+        if (not @roles);
+
+    my ($schema, $rs);
+
+    $schema = $record-&gt;result_source()-&gt;schema();
+
+    $rs = $schema-&gt;resultset('Role')-&gt;search(
+        {
+            'map_user_role.person_id'   =&gt; $record-&gt;id(),
+            'me.name' =&gt; {
+                -in =&gt; \@roles,
+            },
+        },
+        {
+            prefetch =&gt; [
+                { 'map_user_role' =&gt; 'person' },
+            ],
+        },
+    );
+
+    return ($rs-&gt;count &gt; 0);
+}
+
 # suspend a user (and log a message at the same time)
 sub set_suspended {
     my ($record, $args) = @_;
@@ -258,28 +286,44 @@
 sub can_suspend_account {
     my $record = shift;
 
-    return $record-&gt;check_user_roles(
-        'site_moderator'
+    return $record-&gt;check_any_user_role(
+        'site_moderator', 'suspend_account'
     );
 }
+# thin wrapper around check_any_user_role() for convenience
+sub can_ip_ban {
+    my $record = shift;
 
+    return $record-&gt;check_any_user_role(
+        'site_moderator', 'ip_ban_posting', 'ip_ban_signup', 'ip_ban_login'
+    );
+}
+
+sub can_view_site_menu {
+    my $record = shift;
+
+    return $record-&gt;check_any_user_role(
+        'site_moderator', 'ip_ban_posting', 'ip_ban_signup', 'ip_ban_login'
+    );
+}
+
 sub can_moderate_forum {
     my $record = shift;
     my $forum_id = shift;
     my $schema = $record-&gt;result_source()-&gt;schema();
 
-    my $results = $schema-&gt;resultset('ForumModerator')-&gt;find(
+    my $results = $schema-&gt;resultset('ForumModerator')-&gt;search(
         {
             person_id       =&gt; $record-&gt;id(),
             forum_id        =&gt; $forum_id,
             can_moderate    =&gt; 1,
         },
         {
-            key     =&gt; 'forum_moderator_person_key',
+            #key     =&gt; 'forum_moderator_person_key',
         }
     );
 
-    if ($results) {
+    if ($results-&gt;count) {
         return 1;
     }
 

Modified: trunk/lib/Parley.pm
===================================================================
--- trunk/lib/Parley.pm	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/lib/Parley.pm	2008-03-20 20:19:17 UTC (rev 850)
@@ -27,6 +27,7 @@
     Authentication::Credential::Password
 
     Authorization::Roles
+    Authorization::ACL
 
     I18N
 /;
@@ -39,6 +40,66 @@
 # only show certain log levels in output
 __PACKAGE__-&gt;log (Catalyst::Log-&gt;new( @{__PACKAGE__-&gt;config-&gt;{log_levels}} ));
 
+
+# ---- START: ACL RULES ----
+
+#
+# /site
+#
+##__PACKAGE__-&gt;deny_access_unless(
+##    '/site/ip_bans',
+##    [$_]
+##)
+##for qw/ip_ban_posting site_moderator/;
+
+__PACKAGE__-&gt;deny_access_unless(
+    '/site/fmodSaveHandler',
+    [qw/site_moderator/]
+);
+__PACKAGE__-&gt;deny_access_unless(
+    '/site/ip_bans',
+    sub {
+        my $c = shift;
+        $c-&gt;check_any_user_role(
+            qw/site_moderator ip_ban_posting ip_ban_signup ip_ban_login/
+        )
+    }
+);
+__PACKAGE__-&gt;deny_access_unless(
+    '/site/roleSaveHandler',
+    [qw/site_moderator/]
+);
+__PACKAGE__-&gt;deny_access_unless(
+    '/site/saveBanHandler',
+    sub {
+        my $c = shift;
+        $c-&gt;check_any_user_role(
+            qw/site_moderator ip_ban_posting ip_ban_signup ip_ban_login/
+        )
+    }
+);
+__PACKAGE__-&gt;deny_access_unless(
+    '/site/services',
+    [qw/site_moderator/]
+);
+__PACKAGE__-&gt;deny_access_unless(
+    '/site/user',
+    [qw/site_moderator/]
+);
+__PACKAGE__-&gt;deny_access_unless(
+    '/site/users',
+    [qw/site_moderator/]
+);
+__PACKAGE__-&gt;deny_access_unless(
+    '/site/users_autocomplete',
+    [qw/site_moderator/]
+);
+
+
+# ---- END:   ACL RULES ----
+
+
+
 # I'm sure there's a (better) way to do this by overriding set()/get() in Class::Accessor
 {
     sub set_get {

Modified: trunk/root/base/menu/menubar
===================================================================
--- trunk/root/base/menu/menubar	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/base/menu/menubar	2008-03-20 20:19:17 UTC (rev 850)
@@ -110,19 +110,27 @@
                 &lt;/div&gt;                                        
             &lt;/li&gt;
             [% END %]
-            [% IF site_moderator %]
+            [% IF authed_user.can_view_site_menu %]
             &lt;li class=&quot;yuimenubaritem&quot;&gt;&lt;a class=&quot;yuimenubaritemlabel&quot; href=&quot;#&quot;&gt;[%l('Site')%]&lt;/a&gt;
                 &lt;div id=&quot;menu_site_moderate&quot; class=&quot;yuimenu&quot;&gt;
                     &lt;div class=&quot;bd&quot;&gt;                                        
                         &lt;ul&gt;
+                            [% IF authed_user.is_site_moderator %]
                             &lt;li class=&quot;yuimenuitem&quot;&gt;&lt;a class=&quot;yuimenuitemlabel&quot; href=&quot;terms/add&quot;&gt;[%l('Add T-and-Cs')%]&lt;/a&gt;&lt;/li&gt;
+                            [% END %]
                             &lt;li class=&quot;yuimenuitem&quot;&gt;&lt;a class=&quot;yuimenuitemlabel&quot; href=&quot;#&quot;&gt;[%l('Manage')%]&lt;/a&gt;
                                 &lt;div id=&quot;site&quot; class=&quot;yuimenu&quot;&gt;
                                     &lt;div class=&quot;bd&quot;&gt;
                                         &lt;ul class=&quot;first-of-type&quot;&gt;
+                                            [% IF authed_user.is_site_moderator %]
                                             &lt;li class=&quot;yuimenuitem&quot;&gt;&lt;a class=&quot;yuimenuitemlabel&quot; href=&quot;site/services&quot;&gt;[%l('Services')%]&lt;/a&gt;&lt;/li&gt;
+                                            [% END %]
+                                            [% IF authed_user.is_site_moderator %]
                                             &lt;li class=&quot;yuimenuitem&quot;&gt;&lt;a class=&quot;yuimenuitemlabel&quot; href=&quot;site/users&quot;&gt;[%l('Users')%]&lt;/a&gt;&lt;/li&gt;
+                                            [% END %]
+                                            [% IF authed_user.can_ip_ban %]
                                             &lt;li class=&quot;yuimenuitem&quot;&gt;&lt;a class=&quot;yuimenuitemlabel&quot; href=&quot;site/ip_bans&quot;&gt;[%l('IP Bans')%]&lt;/a&gt;&lt;/li&gt;
+                                            [% END %]
                                         &lt;/ul&gt;            
                                     &lt;/div&gt;
                                 &lt;/div&gt;                    

Modified: trunk/root/base/site/ip_bans
===================================================================
--- trunk/root/base/site/ip_bans	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/base/site/ip_bans	2008-03-20 20:19:17 UTC (rev 850)
@@ -1,13 +1,24 @@
 &lt;h1&gt;[%l('IP Bans')%]&lt;/h1&gt;
 [% WHILE (ban_type = ip_ban_types.next) %]
-&lt;h2 class=&quot;top_padded&quot;&gt;[% ban_type.description %]&lt;/h2&gt;
-    [% bans = ban_type.ip_bans_rs %]
+    [% role_name = 'ip_ban_' _ ban_type.name %]
+    [% has_role  = authed_user.check_any_user_role('site_moderator', role_name) %]
+    [% IF has_role %][% eclass=&quot;editable&quot; %][% ELSE %][% eclass=&quot;noneditable&quot; %][% END %]
+    [% bans      = ban_type.ip_bans_rs %]
+
+&lt;h2 class=&quot;top_padded&quot;&gt;
+    [% ban_type.description %]
+&lt;/h2&gt;
+    [% IF has_role %]
+    &lt;img src=&quot;/static/images/icons/page_edit.png&quot; width=&quot;16&quot; height=&quot;16&quot; /&gt;
+    [% ELSE %]
+    &lt;img src=&quot;/static/images/icons/lock.png&quot; width=&quot;16&quot; height=&quot;16&quot; /&gt;
+    [% END %]
     [% IF bans.count %]
         [% WHILE (ip_ban = bans.next) %]
-        &lt;span id=&quot;ipban_[%ip_ban.id%]&quot; class=&quot;editable&quot;&gt;[%ip_ban.ip_range%]&lt;/span&gt;
+        &lt;span id=&quot;ipban_[%ip_ban.id%]&quot; class=&quot;[%eclass%]&quot;&gt;[%ip_ban.ip_range%]&lt;/span&gt;
         [% END %]
     [% ELSE %]
-        &lt;span id=&quot;ipbannewtype_[%ban_type.id%]&quot; class=&quot;editable&quot;&gt;None&lt;/span&gt;
+        &lt;span id=&quot;ipbannewtype_[%ban_type.id%]&quot; class=&quot;[%eclass%]&quot;&gt;None&lt;/span&gt;
     [% END %]
 [% END %]
 

Modified: trunk/root/base/user/profile
===================================================================
--- trunk/root/base/user/profile	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/base/user/profile	2008-03-20 20:19:17 UTC (rev 850)
@@ -90,18 +90,19 @@
 
         [% SET dummy=available_forums.reset %]
         [% WHILE (forum = available_forums.next) %]
-            &lt;div class=&quot;yui-gf top_padded&quot;&gt;
+            &lt;div class=&quot;yui-gf top_padded forum_moderator_list&quot;&gt;
                 &lt;div class=&quot;yui-u first align_right&quot;&gt;
                 [%forum.name%]
                 &lt;/div&gt;
                 &lt;div class=&quot;yui-u&quot;&gt;
                 &lt;input
                     type=&quot;checkbox&quot;
+                    class=&quot;fmod_checkbox&quot;
                     name=&quot;moderate_forum&quot;
-                    id=&quot;moderate_forum&quot;
-                    value=&quot;[%forum.id%]&quot;
+                    id=&quot;moderateforum_[%forum.id%]&quot;
                     [%IF profiled_user.can_moderate_forum(forum.id)%]checked=&quot;true&quot;[% END %]
                 &gt;
+                    &lt;span id=&quot;status_[%forum.id%]&quot;&gt;&lt;/span&gt;
                 &lt;/div&gt;
             &lt;/div&gt;
         [% END %]
@@ -113,6 +114,11 @@
 
 
 &lt;script type=&quot;text/javascript&quot; src=&quot;[%c.uri_for('/static/script/user_suspend.js')%]&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot;&gt;
+    var person = {
+        id: [%profiled_user.id%]
+    };
+&lt;/script&gt;
 &lt;script type=&quot;text/javascript&quot; src=&quot;[%c.uri_for('/static/script/user_forum_moderate.js')%]&quot;&gt;&lt;/script&gt;
 
 &lt;div id=&quot;suspend_reason_dialog&quot; style=&quot;visibility:hidden;&quot;&gt;

Modified: trunk/root/static/css/parley-min.css
===================================================================
--- trunk/root/static/css/parley-min.css	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/static/css/parley-min.css	2008-03-20 20:19:17 UTC (rev 850)
@@ -1 +1 @@
-#hd{height:80px;line-height:80px;margin:0;padding-left:10px;background:#EEE url('/static/images/parley_logo.jpg') no-repeat left;color:#79B30B;}#hd h1{font-size:200%;text-align:left;}div#ft{background:#666;color:#FFF;font-size:77%;margin-top:20px;}div#ft p{border:none;margin-top:30px;padding:5px 10px 5px 10px;text-align:right;display:block;}div#ft a{color:#ccc;}div#user_information{line-height:1em;font-size:85%;color:#000;background-color:transparent;position:absolute;top:0;right:10px;height:70px;width:200px;padding-top:3px;text-align:center;}div#user_information .user_info_actions{margin-top:3px;}.caretfix{overflow:auto;}#bd h1{font-weight:bold;background:#666;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h2{font-weight:bold;background:#999;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h3{font-weight:bold;background:#eee;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;color:#79B30B;}a.nav:hover{background:#000;color:#fff!
 ;}a,a:link,a:visited,a:active{background:transparent;color:blue;text-decoration:none;}th{font-size:100%;text-align:left;font-weight:bold;}#login_dialog form{margin:0;padding:0;min-width:400px;max-width:600px;}#login_dialog form fieldset{/ * clear:both;note that this clear causes inputs to break to left in ie5.x mac,commented out */ padding:10px;margin:0;border:none;}#login_dialog form label{display:block;float:left;width:150px;padding:0;margin:5px 0 0;text-align:right;font-weight:bold;margin-bottom:0;}#login_dialog form input,form textarea{width:auto;margin:5px 0 0 10px;}#login_dialog form p{font-size:85%;}.row{border-top:1px dotted #666;border-bottom:1px dotted #666;}.row_odd{background:#eee;}.row_even{background:#ddd;}.admin_edited_post{color:#000;background:#ccc;padding:2px;padding-left:10px;padding-right:10px;border:1px dashed #000;margin-left:15px;font-size:93%;text-align:right;}.align_right{text-align:right;}.forum_description{font-size:93%;}.forum_lastpost{font-size:!
 85%;text-align:right;}.forum_lastpost_subject a{color:#333;col!
 or:#79B3
0B;}.forum_link{font-size:100%;font-weight:bold;}.forum_list{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_list td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.forum_mini_pager{font-size:85%;}.forum_mini_pager a{color:#666;}.forum_name{font-size:100%;text-align:left;font-weight:bold;margin-top:5px;}.forum_name a{color:#333;color:#79B30B;}.forum_postcount{font-size:85%;text-align:right;margin-top:5px;}.forum_view{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_view td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.help li{margin-top:25px;margin-right:25px;list-style-type:none;border-left:2px solid #666;padding-top:5px;padding-bottom:5px;padding-left:10px;background-color:#ddd;}.help li ul li,.help li ol li{margin-top:5px;margin-left:10px;list-style-type:disc;border-left:none;pa!
 dding-left:none;padding-top:none;padding-bottom:none;background-color:transparent;}.innerpost{margin-left:10px;padding:5px;overflow:auto;font-size:93%;}.moderator_list{font-size:77%;margin-bottom:5px;margin-top:5px;text-align:right;}.pager_advanced{font-size:77%;margin-bottom:5px;margin-top:5px;}.post{padding-top:5px;vertical-align:top;border-left:1px solid #ddd;}.post_created{text-align:right;font-size:85%;}.post_creator{font-weight:bold;font-style:italic;font-size:85%;}.post_edited_alert{font-weight:bold;font-style:italic;}.post_info{font-size:77%;line-height:1.1em;margin-top:10px;margin-bottom:2px;text-align:right;}.post_subject{font-weight:bold;}.quote{background-color:#F9FBFF;border:1px solid #333;font-size:85%;margin:0 0 2px 4px;padding:6px;width:85%;overflow:hidden;}.recently_updated{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.recently_updated td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px!
 ;padding-right:10px;}.reply_post_message{border:1px dashed #66!
 6;}.sear
ch_match_context{font-size:85%;}.search_results{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.search_results td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;}.site_terms{width:80%;margin-left:auto;margin-right:auto;margin-bottom:10px;padding:5px;border:1px solid #666;}.thread_add{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_add td{padding-top:4px;padding-bottom:4px;}.thread_add .input_text{width:450px;margin-left:10px;}.thread_add_topic{text-align:right;padding-right:5px;}.thread_add_message{text-align:right;vertical-align:top;padding-right:5px;}.thread_header{font-weight:bold;background:#666;padding:4px;text-align:left;}.thread_header a{color:#ccc;}.thread_info{margin:0;width:100%;border:none;padding:0;margin-bottom:10px;}.thread_info td{border:none;padding:0;}.thread_lastpost{font-size:85%;text-align:right!
 ;}.thread_post_row{border-top:1px solid #ddd;border-bottom:1px solid #ddd;}.thread_post_row td{margin-top:10px;margin-bottom:10px;}.thread_posts{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_recent_forum{float:right;font-size:85%;}.thread_recent_forum a{color:#333;}.thread_reply{font-size:93%;}.thread_reply tr{vertical-align:top;}.thread_reply td{padding-top:10px;padding-left:10px;}.thread_reply textarea{background-color:transparent;border:2px inset black;}.thread_subject a{font-size:93%;color:#333;color:#79B30B;}.thread_watch{margin-top:5px;font-size:77%;text-align:left;}.top_padded{margin-top:10px;}.info_column{min-width:80px;max-width:125px;}.topic_creator{display:block;font-size:85%;text-align:right;}.user_login form{width:350px;margin-left:auto;margin-right:auto;margin-top:20px;}.user_login p{margin-top:5px;margin-bottom:5px;}.user_permission_list{margin-left:auto;margin-right:auto;margin-top:15px;font-size:93%;width:100%;}.user_p!
 ermission_list td{vertical-align:top;border:1px dashed #ddd;bo!
 rder:non
e;line-height:150%;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;}.user_permission_list img{vertical-align:middle;}.user_post_info{background:#ccc;background:transparent;font-size:77%;margin-left:auto;margin-right:auto;text-align:center;vertical-align:top;width:110px;}a[href $='.jpg']{padding-left:20px;background:transparent url(/static/images/filetypes/image.png) no-repeat center left;}a[href $='.pdf']{padding-left:20px;background:transparent url(/static/images/filetypes/pdf.png) no-repeat center left;}#loader_wait.yui-overlay{position:fixed;float:right;top:10px;right:10px;border:none;text-align:right;}#preview_overlay{border:1px dashed #ccc;text-align:left;padding:0;}#thread_message{font-family:monospace;text-align:left;padding:0;background-color:#eee;font-size:93%;width:450px;}#ysearch{text-align:center;}#ysearchinput{position:static;width:20em;}#ysearchcontainer{text-align:left;width:20em;}.forumcode_code{font-family:monospace;border:1px solid #!
 333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;color:#ff0;background-color:#333;border:1px solid #666;white-space:pre;}.forumcode_pre{background-color:transparent;font-family:monospace;border:1px dashed #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;white-space:pre;}.forumcode_quote{background-color:#eee;font-family:monospace;font-style:italic;border:1px dotted #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;}.forumcode_quoting{font-weight:bold;margin-bottom:3px;}.yuimenuitem .disabled{color:#A6A6A6;cursor:default;}.yui-skin-sam .yui-navset .yui-nav,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav{border:solid #333;border-width:0 0 5px;Xposition:relative;zoom:1;}.yui-skin-sam .yui-navset .yui-content{background:transparent;}.yui-skin-sam .yui-navset .yui-nav a,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav a{background-image:none;background-color:#999;border:solid #a!
 3a3a3;border-width:0 1px;color:#fff;text-decoration:none;}.yui!
 -skin-sa
m .yui-navset .yui-nav .selected a,.yui-skin-sam .yui-navset .yui-nav .selected a:focus,.yui-skin-sam .yui-navset .yui-nav .selected a:hover{background:#333;color:#fff;}.yui-skin-sam .yui-navset .yui-nav a:hover,.yui-skin-sam .yui-navset .yui-nav a:focus{background:#666;color:#fff;outline:0;}
\ No newline at end of file
+#hd{height:80px;line-height:80px;margin:0;padding-left:10px;background:#EEE url('/static/images/parley_logo.jpg') no-repeat left;color:#79B30B;}#hd h1{font-size:200%;text-align:left;}div#ft{background:#666;color:#FFF;font-size:77%;margin-top:20px;}div#ft p{border:none;margin-top:30px;padding:5px 10px 5px 10px;text-align:right;display:block;}div#ft a{color:#ccc;}div#user_information{line-height:1em;font-size:85%;color:#000;background-color:transparent;position:absolute;top:0;right:10px;height:70px;width:200px;padding-top:3px;text-align:center;}div#user_information .user_info_actions{margin-top:3px;}.caretfix{overflow:auto;}#bd h1{font-weight:bold;background:#666;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h2{font-weight:bold;background:#999;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;}#bd h3{font-weight:bold;background:#eee;padding:4px;text-align:left;margin-top:5px;margin-bottom:5px;color:#79B30B;}a.nav:hover{background:#000;color:#fff!
 ;}a,a:link,a:visited,a:active{background:transparent;color:blue;text-decoration:none;}th{font-size:100%;text-align:left;font-weight:bold;}#login_dialog form{margin:0;padding:0;min-width:400px;max-width:600px;}#login_dialog form fieldset{/ * clear:both;note that this clear causes inputs to break to left in ie5.x mac,commented out */ padding:10px;margin:0;border:none;}#login_dialog form label{display:block;float:left;width:150px;padding:0;margin:5px 0 0;text-align:right;font-weight:bold;margin-bottom:0;}#login_dialog form input,form textarea{width:auto;margin:5px 0 0 10px;}#login_dialog form p{font-size:85%;}.row{border-top:1px dotted #666;border-bottom:1px dotted #666;}.row_odd{background:#eee;}.row_even{background:#ddd;}.admin_edited_post{color:#000;background:#ccc;padding:2px;padding-left:10px;padding-right:10px;border:1px dashed #000;margin-left:15px;font-size:93%;text-align:right;}.align_right{text-align:right;}.forum_description{font-size:93%;}.forum_lastpost{font-size:!
 85%;text-align:right;}.forum_lastpost_subject a{color:#333;col!
 or:#79B3
0B;}.forum_link{font-size:100%;font-weight:bold;}.forum_list{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_list td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.forum_mini_pager{font-size:85%;}.forum_mini_pager a{color:#666;}.forum_name{font-size:100%;text-align:left;font-weight:bold;margin-top:5px;}.forum_name a{color:#333;color:#79B30B;}.forum_postcount{font-size:85%;text-align:right;margin-top:5px;}.forum_view{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.forum_view td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;}.help li{margin-top:25px;margin-right:25px;list-style-type:none;border-left:2px solid #666;padding-top:5px;padding-bottom:5px;padding-left:10px;background-color:#ddd;}.help li ul li,.help li ol li{margin-top:5px;margin-left:10px;list-style-type:disc;border-left:none;pa!
 dding-left:none;padding-top:none;padding-bottom:none;background-color:transparent;}.innerpost{margin-left:10px;padding:5px;overflow:auto;font-size:93%;}.moderator_list{font-size:77%;margin-bottom:5px;margin-top:5px;text-align:right;}.pager_advanced{font-size:77%;margin-bottom:5px;margin-top:5px;}.post{padding-top:5px;vertical-align:top;border-left:1px solid #ddd;}.post_created{text-align:right;font-size:85%;}.post_creator{font-weight:bold;font-style:italic;font-size:85%;}.post_edited_alert{font-weight:bold;font-style:italic;}.post_info{font-size:77%;line-height:1.1em;margin-top:10px;margin-bottom:2px;text-align:right;}.post_subject{font-weight:bold;}.quote{background-color:#F9FBFF;border:1px solid #333;font-size:85%;margin:0 0 2px 4px;padding:6px;width:85%;overflow:hidden;}.recently_updated{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.recently_updated td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px!
 ;padding-right:10px;}.reply_post_message{border:1px dashed #66!
 6;}.sear
ch_match_context{font-size:85%;}.search_results{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.search_results td{vertical-align:top;border:1px dashed #ddd;border:none;line-height:120%;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;}.site_terms{width:80%;margin-left:auto;margin-right:auto;margin-bottom:10px;padding:5px;border:1px solid #666;}.thread_add{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_add td{padding-top:4px;padding-bottom:4px;}.thread_add .input_text{width:450px;margin-left:10px;}.thread_add_topic{text-align:right;padding-right:5px;}.thread_add_message{text-align:right;vertical-align:top;padding-right:5px;}.thread_header{font-weight:bold;background:#666;padding:4px;text-align:left;}.thread_header a{color:#ccc;}.thread_info{margin:0;width:100%;border:none;padding:0;margin-bottom:10px;}.thread_info td{border:none;padding:0;}.thread_lastpost{font-size:85%;text-align:right!
 ;}.thread_post_row{border-top:1px solid #ddd;border-bottom:1px solid #ddd;}.thread_post_row td{margin-top:10px;margin-bottom:10px;}.thread_posts{margin-left:auto;margin-right:auto;margin-top:15px;width:100%;font-size:93%;}.thread_recent_forum{float:right;font-size:85%;}.thread_recent_forum a{color:#333;}.thread_reply{font-size:93%;}.thread_reply tr{vertical-align:top;}.thread_reply td{padding-top:10px;padding-left:10px;}.thread_reply textarea{background-color:transparent;border:2px inset black;}.thread_subject a{font-size:93%;color:#333;color:#79B30B;}.thread_watch{margin-top:5px;font-size:77%;text-align:left;}.top_padded{margin-top:10px;}.topic_creator{display:block;font-size:85%;text-align:right;}.user_login form{width:350px;margin-left:auto;margin-right:auto;margin-top:20px;}.user_login p{margin-top:5px;margin-bottom:5px;}.user_permission_list{margin-left:auto;margin-right:auto;margin-top:15px;font-size:93%;width:100%;}.user_permission_list td{vertical-align:top;border:1!
 px dashed #ddd;border:none;line-height:150%;padding-left:10px;!
 padding-
right:10px;padding-top:5px;padding-bottom:5px;}.user_permission_list img{vertical-align:middle;}.forum_moderator_list div input{line-height:250%;background-color:red;padding-left:10px;padding-right:10px;padding-top:5px;padding-bottom:5px;height:150%;}.forum_moderator_list img{vertical-align:middle;}.user_post_info{background:#ccc;background:transparent;font-size:77%;margin-left:auto;margin-right:auto;text-align:center;vertical-align:top;width:110px;}a[href $='.jpg']{padding-left:20px;background:transparent url(/static/images/filetypes/image.png) no-repeat center left;}a[href $='.pdf']{padding-left:20px;background:transparent url(/static/images/filetypes/pdf.png) no-repeat center left;}#loader_wait.yui-overlay{position:fixed;float:right;top:10px;right:10px;border:none;text-align:right;}#preview_overlay{border:1px dashed #ccc;text-align:left;padding:0;}#thread_message{font-family:monospace;text-align:left;padding:0;background-color:#eee;font-size:93%;width:450px;}#ysearch{text!
 -align:center;}#ysearchinput{position:static;width:20em;}#ysearchcontainer{text-align:left;width:20em;}.forumcode_code{font-family:monospace;border:1px solid #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;color:#ff0;background-color:#333;border:1px solid #666;white-space:pre;}.forumcode_pre{background-color:transparent;font-family:monospace;border:1px dashed #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;white-space:pre;}.forumcode_quote{background-color:#eee;font-family:monospace;font-style:italic;border:1px dotted #333;font-size:85%;margin:15px 20px 15px 20px;padding:6px;width:85%;overflow:auto;}.forumcode_quoting{font-weight:bold;margin-bottom:3px;}.yuimenuitem .disabled{color:#A6A6A6;cursor:default;}.yui-skin-sam .yui-navset .yui-nav,.yui-skin-sam .yui-navset .yui-navset-top .yui-nav{border:solid #333;border-width:0 0 5px;Xposition:relative;zoom:1;}.yui-skin-sam .yui-navset .yui-content{background:tra!
 nsparent;}.yui-skin-sam .yui-navset .yui-nav a,.yui-skin-sam .!
 yui-navs
et .yui-navset-top .yui-nav a{background-image:none;background-color:#999;border:solid #a3a3a3;border-width:0 1px;color:#fff;text-decoration:none;}.yui-skin-sam .yui-navset .yui-nav .selected a,.yui-skin-sam .yui-navset .yui-nav .selected a:focus,.yui-skin-sam .yui-navset .yui-nav .selected a:hover{background:#333;color:#fff;}.yui-skin-sam .yui-navset .yui-nav a:hover,.yui-skin-sam .yui-navset .yui-nav a:focus{background:#666;color:#fff;outline:0;}
\ No newline at end of file

Modified: trunk/root/static/css/parley.css
===================================================================
--- trunk/root/static/css/parley.css	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/static/css/parley.css	2008-03-20 20:19:17 UTC (rev 850)
@@ -512,6 +512,14 @@
     vertical-align: middle;
 }
 
+.forum_moderator_list div input{
+    height: 150%;
+}
+.forum_moderator_list img {
+    vertical-align: middle;
+}
+
+
 .user_post_info {
     background:         #ccc;
     background:         transparent;

Added: trunk/root/static/images/icons/page_edit.png
===================================================================
(Binary files differ)


Property changes on: trunk/root/static/images/icons/page_edit.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/root/static/script/user_forum_moderate.js
===================================================================
--- trunk/root/static/script/user_forum_moderate.js	2008-03-19 21:52:43 UTC (rev 849)
+++ trunk/root/static/script/user_forum_moderate.js	2008-03-20 20:19:17 UTC (rev 850)
@@ -0,0 +1,77 @@
+(function () {
+    var YU  = YAHOO.util,
+        Dom = YAHOO.util.Dom;
+
+    var items = Dom.getElementsByClassName('fmod_checkbox');
+
+    update_forummod = function() {
+        var elID = this.id,
+            checked = (this.checked ? 1 : 0);
+        var forumID = elID.split('_')[1];
+        var statusDiv = Dom.get('status_' + forumID);
+
+        var handleSuccess = function(o) {
+            var data = eval('(' + o.responseText + ')');
+            o.argument.msg_node.innerHTML = '';
+
+            // show any returned errors
+            if (data.error) {
+                if (data.error.message!=undefined) {
+                    o.argument.msg_node.innerHTML = data.error.message;
+                }
+
+                // reset the checkbox
+                Dom.get(o.argument.cb_node).checked =
+                    (1 - o.argument.value);
+            }
+
+            // if we didn't update on the server, reset the checkbox
+            if (0 == data.updated) {
+                Dom.get(o.argument.cb_node).checked =
+                    (1 - o.argument.value);
+            }
+        };
+        var handleFailure = function(o) {
+            // show the status message
+            o.argument.msg_node.innerHTML = o.responseText;
+
+            // reset the checkbox
+            Dom.get(o.argument.cb_node).checked =
+                (1 - o.argument.value);
+        };
+
+        // where to post to
+        var sUrl = '/site/fmodSaveHandler';
+
+        // postdata is a query string ... how irksome!!
+        var postData =
+               'person='    + person.id
+            +  '&amp;forum='    + forumID
+            +  '&amp;value='    + checked
+        ;
+
+        // some visual feedback that something is happening
+        statusDiv.innerHTML = '&lt;img src=&quot;/static/images/loader-bar.gif&quot; /&gt;';
+
+        var request = YAHOO.util.Connect.asyncRequest(
+            'POST',
+            sUrl,
+            {
+                success:  handleSuccess,
+                failure:  handleFailure,
+                argument: {
+                    msg_node: statusDiv,
+                    cb_node:  elID,
+                    value:    checked
+                }
+            },
+            postData
+        );
+    };
+
+    YU.Event.addListener(
+        items,
+        'change',
+        update_forummod
+    );
+})();


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000737.html">[Parley-svn] r849 - / trunk/lib/Parley/Schema trunk/root/base	trunk/root/base/shared trunk/root/base/user trunk/root/static/css
</A></li>
	<LI>Next message: <A HREF="000739.html">[Parley-svn] r851 - / trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#738">[ date ]</a>
              <a href="thread.html#738">[ thread ]</a>
              <a href="subject.html#738">[ subject ]</a>
              <a href="author.html#738">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/parley-svn">More information about the Parley-svn
mailing list</a><br>
</body></html>
